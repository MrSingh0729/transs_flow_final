{% extends 'base.html' %}
{% load static %}

{% block title %}Operator Qualification Check Records{% endblock title %}

{% block content %}
<!-- Page Title -->
<h1 class="text-2xl font-bold text-gray-900 mb-6">Operator Qualification Check Records</h1>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ stats.today|default:"0" }}</div>
        <div class="metric-label">Today's Checks</div>
      </div>
      <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-day text-blue-600"></i>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ stats.week|default:"0" }}</div>
        <div class="metric-label">This Week</div>
      </div>
      <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-week text-indigo-600"></i>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ stats.total|default:"0" }}</div>
        <div class="metric-label">Total Records</div>
      </div>
      <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-database text-gray-600"></i>
      </div>
    </div>
  </div>
</div>

<!-- Search Bar -->
<div class="bg-white shadow-md rounded-xl p-4 mb-6">
  <form method="get" class="flex flex-col sm:flex-row gap-3">
    <div class="flex-1">
      <input type="text" name="q" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
             placeholder="Search by Employee ID, Name, Model, Line..." value="{{ request.GET.q }}">
    </div>
    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
      <i class="fas fa-search"></i> Search
    </button>
    {% if request.GET.q %}
    <a href="{% url 'operator_qualification_list' %}" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
      <i class="fas fa-times"></i> Clear
    </a>
    {% endif %}
  </form>
</div>

<!-- Records Table -->
<div class="bg-white shadow-md rounded-xl overflow-hidden">
  <div class="px-4 sm:px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between gap-3 sm:items-center">
    <h5 class="text-lg font-bold text-gray-900">Qualification Check Records</h5>
    <a href="{% url 'operator_qualification_create' %}" 
       class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center transition">
      <i class="fas fa-plus"></i> New Check
    </a>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shift</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Line</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Model</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Job Card</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Operator Status</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Training</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for record in records %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-3 sm:px-6 py-3 text-gray-900 font-medium">{{ record.date|date:"Y-m-d" }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700">
            <span class="px-2 py-1 text-xs rounded-full bg-gray-100">{{ record.shift }}</span>
          </td>
          <td class="px-3 sm:px-6 py-3">
            <div>
              <div class="text-gray-900 font-medium">{{ record.name }}</div>
              <div class="text-xs text-gray-500">{{ record.emp_id }}</div>
            </div>
          </td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden md:table-cell">{{ record.line }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden md:table-cell">{{ record.model }}</td>
          <td class="px-3 sm:px-6 py-3 hidden lg:table-cell">
            {% if record.key_station_job_card_status == 'Have' %}
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Have</span>
            {% elif record.key_station_job_card_status == 'Not Have' %}
              <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Not Have</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">NA</span>
            {% endif %}
          </td>
          <td class="px-3 sm:px-6 py-3">
            {% if record.key_station_operator_status == 'Old' %}
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Old</span>
            {% elif record.key_station_operator_status == 'New' %}
              <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">New</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Rotating</span>
            {% endif %}
          </td>
          <td class="px-3 sm:px-6 py-3">
            {% if record.pqe_training_and_verification_status == 'Done' %}
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Done</span>
            {% elif record.pqe_training_and_verification_status == 'Training Pending' %}
              <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Pending</span>
            {% elif record.pqe_training_and_verification_status == 'Already Done' %}
              <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Done</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800">Replace</span>
            {% endif %}
          </td>
          <td class="px-3 sm:px-6 py-3">
            <div class="flex gap-2">
              <a href="#" onclick="event.preventDefault(); showDetails({{ record.pk }})" 
                 class="text-blue-600 font-semibold text-xs sm:text-sm hover:underline">
                <i class="fas fa-eye"></i> View
              </a>
              {% if record.scanned_barcode_image %}
              <a href="{{ record.scanned_barcode_image.url }}" 
                 class="text-purple-600 font-semibold text-xs sm:text-sm hover:underline" 
                 title="View Scanned Image" target="_blank">
                <i class="fas fa-qrcode"></i>
              </a>
              {% endif %}
              {% if record.scanned_barcode_text %}
              <a href="{{ record.scanned_barcode_text }}" 
                 class="text-green-600 font-semibold text-xs sm:text-sm hover:underline" 
                 title="View Feishu Record" target="_blank">
                <i class="fas fa-link"></i>
              </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center py-6 text-gray-500">No records found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="mt-6 flex justify-center">
  <nav class="flex items-center space-x-1">
    {% if page_obj.has_previous %}
      <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-double-left"></i>
      </a>
      <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-left"></i>
      </a>
    {% endif %}

    <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-right"></i>
      </a>
      <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-double-right"></i>
      </a>
    {% endif %}
  </nav>
</div>
{% endif %}

<!-- Details Modal -->
<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-xl shadow-2xl w-[95%] sm:w-[90%] md:w-[80%] lg:w-[70%] max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center px-4 sm:px-6 py-4 border-b">
      <h2 class="text-lg sm:text-xl font-bold text-gray-800">Qualification Check Details</h2>
      <button onclick="closeDetails()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <div id="modalBody" class="p-4 sm:p-6">
      <p class="text-gray-500 text-center">Loading...</p>
    </div>
  </div>
</div>

<!-- CSS Styles -->
<style>
.metric-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid #e5e7eb;
  transition: all 0.3s ease;
}

.metric-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.metric-value {
  font-size: 2rem;
  font-weight: 700;
  color: #111827;
  line-height: 1;
}

.metric-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-top: 0.5rem;
}
</style>
{% endblock content %}

{% block extra_js %}
<script>
  function showDetails(pk) {
    const modal = document.getElementById('detailsModal');
    const modalBody = document.getElementById('modalBody');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modalBody.innerHTML = `<p class='text-gray-500 text-center'>Loading...</p>`;

    fetch(`/ipqc/operator-qualification/details/${pk}/`)
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        modalBody.innerHTML = buildDetailsUI(data);
      })
      .catch(error => {
        console.error('Error details:', error);
        modalBody.innerHTML = `<p class='text-red-500 text-center'>Error loading details: ${error.message}</p>`;
      });
  }

  function closeDetails() {
    const modal = document.getElementById('detailsModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function buildDetailsUI(data) {
    let html = '<div class="space-y-6">';
    
    // Basic Information Section
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-info-circle text-blue-500"></i> Basic Information
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
    `;
    
    const basicFields = [
      ['date', 'Date'], ['shift', 'Shift'], ['emp_id', 'Employee ID'],
      ['name', 'Name'], ['section', 'Section'], ['line', 'Line'],
      ['group', 'Group'], ['model', 'Model'], ['color', 'Color'],
    ];
    
    basicFields.forEach(([key, label]) => {
      if (data[key]) {
        html += `
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">${label}</div>
            <div class="font-semibold text-sm">${data[key]}</div>
          </div>`;
      }
    });
    
    html += '</div></div>';

    // Job Card Status
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-id-card text-purple-500"></i> Job Card Status
        </h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Key Station Name</div>
            <div class="font-semibold text-sm">${data.key_station_name}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Job Card Status</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.key_station_job_card_status)}</div>
          </div>
        </div>
      </div>
    `;

    // Operator Verification
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-user-check text-green-500"></i> Operator Verification
        </h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Operator Status</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.key_station_operator_status)}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Work Instruction</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.check_operator_work_instruction)}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">New/Rotating Status</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.new_or_rotating_operator_status)}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Training Status</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.pqe_training_and_verification_status)}</div>
          </div>
        </div>
      </div>
    `;

    // Summary
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-clipboard-check text-indigo-500"></i> Verification Summary
        </h3>
        <div class="bg-gray-50 p-3 rounded">
          <div class="text-sm whitespace-pre-wrap">${data.job_card_verification_summary || 'No summary provided'}</div>
        </div>
      </div>
    `;

    // Photos Section
    if (data.photos && data.photos.length > 0) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-camera text-blue-500"></i> Evidence Photos
          </h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
      `;
      
      data.photos.forEach(photo => {
        html += `
          <div class="border rounded-lg overflow-hidden hover:shadow-lg transition cursor-pointer"
               onclick="openPhotoPreview('${photo.url}', '${photo.label}')">
            <img src="${photo.url}" alt="${photo.label}" class="w-full h-40 object-cover">
            <div class="text-center py-2 text-xs text-gray-600 bg-gray-50">${photo.label}</div>
          </div>`;
      });
      
      html += '</div></div>';
    }

    // Feishu Link
    if (data.scanned_barcode_text) {
      html += `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
            <i class="fas fa-link text-blue-500"></i> Feishu Record
          </h3>
          <div class="flex items-center justify-between">
            <a href="${data.scanned_barcode_text}" target="_blank" class="text-blue-600 underline text-sm break-all pr-2">${data.scanned_barcode_text}</a>
            <button onclick="copyToClipboard('${data.scanned_barcode_text}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition flex-shrink-0">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
      `;
    }

    html += '</div>';
    return html;
  }

  function getStatusBadge(status) {
    let colorClass = 'bg-gray-100 text-gray-800';
    if (status === 'Have' || status === 'Done' || status === 'Old' || status === 'Trained') {
      colorClass = 'bg-green-100 text-green-800';
    } else if (status === 'Not Have' || status === 'Pending' || status === 'New' || status === 'Not Trained' || status === 'Training Pending') {
      colorClass = 'bg-yellow-100 text-yellow-800';
    } else if (status === 'Rotating' || status === 'Already Done') {
      colorClass = 'bg-blue-100 text-blue-800';
    } else if (status === 'Replace Operator') {
      colorClass = 'bg-orange-100 text-orange-800';
    }
    return `<span class="px-2 py-1 text-xs rounded-full ${colorClass}">${status}</span>`;
  }

  // Photo preview functions
  function openPhotoPreview(url, label) {
    if (document.getElementById('photoPreviewOverlay')) return;

    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';

    const overlay = document.createElement('div');
    overlay.id = 'photoPreviewOverlay';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
    overlay.style.backdropFilter = 'blur(4px)';

    const container = document.createElement('div');
    container.className = 'relative w-full max-w-4xl mx-auto';

    container.innerHTML = `
        <div class="bg-white rounded-lg overflow-hidden shadow-xl flex flex-col max-h-[90vh]">
            <div class="flex items-center justify-between px-4 py-3 bg-gray-100 border-b">
                <h2 id="photoPreviewLabel" class="text-sm sm:text-base font-semibold text-gray-800 truncate" style="max-width: 80%;">${escapeHtml(label)}</h2>
                <div class="flex items-center gap-2">
                    <a id="photoDownloadBtn" href="${url}" download class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-sm">
                        <i class="fas fa-download"></i> Download
                    </a>
                    <button id="photoCloseBtn" aria-label="Close preview" class="text-gray-700 hover:text-gray-900 text-2xl leading-none bg-transparent border-0">&times;</button>
                </div>
            </div>
            <div class="flex-1 flex items-center justify-center bg-black p-2">
                <img id="photoPreviewImg" src="${url}" alt="${escapeHtml(label)}" class="max-h-[80vh] w-auto object-contain rounded-md" />
            </div>
        </div>
    `;

    overlay.appendChild(container);
    document.body.appendChild(overlay);

    overlay.addEventListener('click', function (e) {
        if (e.target === overlay) closePhotoPreview();
    });

    const btn = document.getElementById('photoCloseBtn');
    btn.addEventListener('click', closePhotoPreview);

    function escHandler(e) {
        if (e.key === 'Escape') closePhotoPreview();
    }
    document.addEventListener('keydown', escHandler);
    overlay._escHandler = escHandler;
  }

  function closePhotoPreview() {
    const overlay = document.getElementById('photoPreviewOverlay');
    if (!overlay) return;

    if (overlay._escHandler) {
        document.removeEventListener('keydown', overlay._escHandler);
    }
    overlay.remove();
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
  }

  function escapeHtml(str) {
    if (!str && str !== 0) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showToast('URL copied to clipboard!');
    }, function() {
        showToast('Failed to copy URL', 'error');
    });
  }

  function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
      toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-full`;
      toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${message}`;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
          toast.classList.remove('translate-y-full');
      }, 100);
      
      setTimeout(() => {
          toast.classList.add('translate-y-full');
          setTimeout(() => toast.remove(), 300);
      }, 3000);
  }
</script>
{% endblock %}