{% extends 'base.html' %}
{% load static %}
{% block title %}My Profile{% endblock %}

{% block content %}
<div class="max-w-[1300px] mx-auto w-full p-4">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-user-circle text-blue-600 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">My Profile</h1>
                    <p class="text-sm text-gray-600">Manage your personal information</p>
                </div>
            </div>
            
            <button type="button" onclick="enableEdit()" id="editBtn" 
                    class="btn btn-secondary touch-target" 
                    title="Edit profile">
                <i class="fas fa-pen"></i>
                <span class="hidden sm:inline ml-2">Edit Profile</span>
            </button>
        </div>
    </div>

    <!-- Profile Card -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <!-- Profile Header -->
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 px-6 py-8 border-b border-gray-100">
            <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6">
                <!-- Avatar Section -->
                <div class="relative group">
                    <div class="w-24 h-24 rounded-2xl overflow-hidden bg-white border-4 border-white shadow-lg">
                        {% if request.user.profile_picture %}
                            <img src="{{ request.user.profile_picture.url }}" 
                                 alt="Profile picture" 
                                 class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                        {% else %}
                            <div class="w-full h-full bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center">
                                <i class="fas fa-user text-3xl text-blue-500"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-green-500 rounded-full border-4 border-white flex items-center justify-center">
                        <i class="fas fa-check text-white text-xs"></i>
                    </div>
                </div>

                <!-- User Info -->
                <div class="text-center sm:text-left flex-1">
                    <h2 class="text-2xl font-bold text-gray-900">{{ request.user.full_name|default:request.user.employee_id }}</h2>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 mt-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fas fa-id-badge mr-1"></i>
                            {{ request.user.employee_id|default:'EMP-' }}
                        </span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            <i class="fas fa-user-tag mr-1"></i>
                            {{ request.user.role|default:'Team Member' }}
                        </span>
                        {% if request.user.is_superuser %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <i class="fas fa-crown mr-1"></i>
                                Superuser
                            </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="flex gap-2">
                    <button type="button" onclick="showPasswordModal()" 
                            class="btn btn-secondary touch-target" 
                            title="Change password">
                        <i class="fas fa-key"></i>
                        <span class="hidden sm:inline ml-2">Password</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Form -->
        <form method="post" enctype="multipart/form-data" class="p-6" id="profileForm">
            {% csrf_token %}
            
            <!-- Form Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Full Name -->
                    <div class="form-group">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-user mr-2 text-gray-400"></i>Full Name
                        </label>
                        {{ form.full_name }}
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-envelope mr-2 text-gray-400"></i>Email Address
                        </label>
                        {{ form.email }}
                    </div>

                    <!-- Contact Number -->
                    <div class="form-group">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-phone mr-2 text-gray-400"></i>Contact Number
                        </label>
                        {{ form.contact_number }}
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Bio -->
                    <div class="form-group">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-align-left mr-2 text-gray-400"></i>Bio
                        </label>
                        {{ form.bio }}
                    </div>

                    <!-- Profile Picture Section -->
                    <div id="imageField" class="form-group hidden">
                        <label class="block text-sm font-bold text-gray-700 mb-3">
                            <i class="fas fa-camera mr-2 text-gray-400"></i>Profile Picture
                        </label>
                        
                        <!-- Current Picture Display -->
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                            <div class="flex items-start gap-4">
                                <!-- Current Image Preview -->
                                <div class="flex-shrink-0">
                                    <div class="w-20 h-20 rounded-xl overflow-hidden bg-white border-2 border-gray-200 shadow-sm">
                                        {% if request.user.profile_picture %}
                                            <img src="{{ request.user.profile_picture.url }}" 
                                                 alt="Current profile picture" 
                                                 class="w-full h-full object-cover">
                                        {% else %}
                                            <div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                                                <i class="fas fa-user text-gray-400 text-2xl"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- File Info and Actions -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-image text-gray-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-900">Current Picture</span>
                                        {% if request.user.profile_picture %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-check-circle mr-1"></i>Uploaded
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if request.user.profile_picture %}
                                        <p class="text-xs text-gray-500 mb-3 truncate">
                                            {{ request.user.profile_picture.name }}
                                        </p>
                                    {% endif %}
                                    
                                    <!-- File Upload -->
                                    <div class="relative">
                                        <div class="flex flex-wrap items-center gap-3">
                                            <label for="id_profile_picture" class="btn btn-secondary touch-target cursor-pointer mb-0">
                                                <i class="fas fa-upload mr-2"></i>
                                                <span>Choose New Picture</span>
                                                <span class="file-input-name hidden ml-2"></span>
                                            </label>
                                            <button type="button" onclick="clearFileInput()" 
                                                    class="text-sm text-red-600 hover:text-red-800 font-medium touch-target">
                                                <i class="fas fa-times-circle mr-1"></i>Clear
                                            </button>
                                        </div>
                                        {{ form.profile_picture }}
                                    </div>
                                    
                                    <!-- Help Text -->
                                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                                            <div class="text-xs text-blue-700">
                                                <p class="font-medium mb-1">Image Requirements:</p>
                                                <ul class="space-y-0.5 text-blue-600">
                                                    <li>• Square format (1:1 ratio)</li>
                                                    <li>• Minimum 400x400 pixels</li>
                                                    <li>• File size: Max 2MB</li>
                                                    <li>• Formats: JPG, PNG, WebP</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload Progress (Hidden by default) -->
                            <div id="uploadProgress" class="hidden mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-medium text-gray-700">Uploading...</span>
                                    <span class="text-xs text-gray-500" id="progressPercent">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" 
                                         id="progressBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Statistics -->
                    <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">
                            <i class="fas fa-chart-bar mr-2 text-gray-400"></i>Account Statistics
                        </h3>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Member Since</span>
                            <span class="text-sm font-bold text-gray-900">{{ request.user.date_joined|date:"M d, Y" }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Last Login</span>
                            <span class="text-sm font-bold text-gray-900">{{ request.user.last_login|date:"M d, Y H:i"|default:'Never' }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Account Status</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                                <i class="fas fa-check-circle mr-1"></i>Active
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex flex-col sm:flex-row justify-between items-center mt-8 pt-6 border-t border-gray-200 gap-4">
                <div id="saveActions" class="hidden flex gap-3">
                    <button type="submit" id="saveBtn" class="btn btn-primary touch-target">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="disableEdit()" class="btn btn-secondary touch-target">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>

                <div id="viewActions" class="flex gap-3">
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary touch-target">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>

                <div class="text-sm text-gray-500">
                    <i class="fas fa-lock mr-1"></i>
                    Your information is secure and encrypted
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Enhanced JavaScript -->
<script>
    function enableEdit() {
        const inputs = document.querySelectorAll("input:not([type='hidden']), textarea");
        const saveBtn = document.getElementById("saveBtn");
        const imageField = document.getElementById("imageField");
        const editBtn = document.getElementById("editBtn");
        const saveActions = document.getElementById("saveActions");
        const viewActions = document.getElementById("viewActions");

        // Enable inputs with animation
        inputs.forEach((input, index) => {
            setTimeout(() => {
                input.removeAttribute("readonly");
                input.classList.remove("bg-gray-100", "border-gray-200");
                input.classList.add("bg-white", "border-blue-400", "focus:border-blue-500", "shadow-sm");
                // Add focus effect
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('transform', 'scale-[1.02]');
                });
                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('transform', 'scale-[1.02]');
                });
            }, index * 50);
        });

        // Show elements with animation
        imageField.classList.remove("hidden");
        imageField.style.opacity = "0";
        setTimeout(() => {
            imageField.style.transition = "opacity 0.3s ease";
            imageField.style.opacity = "1";
        }, 100);

        saveActions.classList.remove("hidden");
        saveActions.style.opacity = "0";
        setTimeout(() => {
            saveActions.style.transition = "opacity 0.3s ease";
            saveActions.style.opacity = "1";
        }, 150);

        viewActions.classList.add("hidden");

        // Update edit button
        editBtn.innerHTML = `<i class="fas fa-times mr-2"></i>Cancel Edit`;
        editBtn.classList.remove("btn-secondary");
        editBtn.classList.add("bg-red-50", "border-red-200", "text-red-600", "hover:bg-red-100");
        editBtn.onclick = disableEdit;

        // Show success notification
        showNotification('Edit mode enabled', 'info');
    }

    function disableEdit() {
        const inputs = document.querySelectorAll("input:not([type='hidden']), textarea");
        const saveBtn = document.getElementById("saveBtn");
        const imageField = document.getElementById("imageField");
        const editBtn = document.getElementById("editBtn");
        const saveActions = document.getElementById("saveActions");
        const viewActions = document.getElementById("viewActions");

        // Disable inputs
        inputs.forEach(input => {
            input.setAttribute("readonly", true);
            input.classList.add("bg-gray-100", "border-gray-200");
            input.classList.remove("bg-white", "border-blue-400", "focus:border-blue-500", "shadow-sm");
        });

        // Hide elements with animation
        imageField.style.opacity = "0";
        setTimeout(() => {
            imageField.classList.add("hidden");
        }, 300);

        saveActions.style.opacity = "0";
        setTimeout(() => {
            saveActions.classList.add("hidden");
        }, 300);

        viewActions.classList.remove("hidden");

        // Reset edit button
        editBtn.innerHTML = `<i class="fas fa-pen mr-2"></i>Edit Profile`;
        editBtn.classList.remove("bg-red-50", "border-red-200", "text-red-600", "hover:bg-red-100");
        editBtn.classList.add("btn-secondary");
        editBtn.onclick = enableEdit;

        // Reset file input
        clearFileInput();
    }

    function showPasswordModal() {
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 max-w-md w-full transform transition-all duration-300 scale-95">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        <i class="fas fa-key mr-2 text-blue-500"></i>Request Change Password
                    </h3>
                    <button onclick="closeModal(this)" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mb-4">
                    Please proceed to request a password change. An administrator will process it shortly.
                </p>
                <div class="flex gap-3">
                    <a href="{% url 'password_change_request' %}" 
                       class="btn btn-primary flex-1 touch-target">
                        <i class="fas fa-arrow-right mr-2"></i>Proceed
                    </a>
                    <button onclick="closeModal(this.parentElement.parentElement)" 
                            class="btn btn-secondary touch-target">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Animate modal
        setTimeout(() => {
            modal.querySelector('.bg-white').classList.remove('scale-95');
            modal.querySelector('.bg-white').classList.add('scale-100');
        }, 10);
    }

    function closeModal(element) {
        const modal = element.closest('.fixed') || element.closest('.bg-black');
        modal.querySelector('.bg-white').classList.add('scale-95');
        modal.querySelector('.bg-white').classList.remove('scale-100');
        setTimeout(() => {
            modal.remove();
        }, 200);
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
        
        notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fas ${icon}"></i>
                <span class="font-medium">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
            notification.classList.add('translate-x-0');
        }, 10);
        
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function clearFileInput() {
        const fileInput = document.querySelector('input[type="file"]');
        const fileName = document.querySelector('.file-input-name');
        
        if (fileInput) {
            fileInput.value = '';
            if (fileName) {
                fileName.textContent = '';
                fileName.classList.add('hidden');
            }
            showNotification('File selection cleared', 'info');
        }
    }

    function simulateUploadProgress() {
        const progressContainer = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        
        if (progressContainer && progressBar && progressPercent) {
            progressContainer.classList.remove('hidden');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                        showNotification('Image uploaded successfully!', 'success');
                    }, 500);
                }
                
                progressBar.style.width = progress + '%';
                progressPercent.textContent = Math.round(progress) + '%';
            }, 200);
        }
    }

    // Initialize form with readonly state
    window.addEventListener('DOMContentLoaded', function () {
        const inputs = document.querySelectorAll("input:not([type='hidden']), textarea");
        
        inputs.forEach(input => {
            input.setAttribute("readonly", true);
            input.classList.add("bg-gray-100", "border-gray-200");
            
            // Add focus ring for readonly inputs
            input.addEventListener('focus', function() {
                if (this.hasAttribute('readonly')) {
                    this.classList.add('ring-2', 'ring-blue-200');
                }
            });
            input.addEventListener('blur', function() {
                if (this.hasAttribute('readonly')) {
                    this.classList.remove('ring-2', 'ring-blue-200');
                }
            });
        });

        // Enhanced file input styling and handling
        const fileInput = document.querySelector('input[type="file"]');
        
        if (fileInput) {
            fileInput.classList.add('hidden');
            
            fileInput.addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || '';
                const fileNameSpan = document.querySelector('.file-input-name');
                
                if (fileName && fileNameSpan) {
                    fileNameSpan.textContent = fileName.length > 20 ? 
                        fileName.substring(0, 20) + '...' : fileName;
                    fileNameSpan.classList.remove('hidden');
                    
                    // Simulate upload progress
                    simulateUploadProgress();
                } else if (fileNameSpan) {
                    fileNameSpan.classList.add('hidden');
                }
            });
        }

        // Style form fields
        const formFields = document.querySelectorAll('input:not([type="file"]):not([type="hidden"]), textarea');
        formFields.forEach(field => {
            field.classList.add('w-full', 'px-4', 'py-3', 'rounded-lg', 
                              'border', 'transition-all', 'duration-200',
                              'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-200');
        });
    });

    // Handle form submission
    document.querySelector('#profileForm').addEventListener('submit', function(e) {
        const submitBtn = document.querySelector('#saveBtn');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        
        // Reset button after 5 seconds (in case of redirect delay)
        setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }, 5000);
    });
</script>

<style>
/* Additional styles specific to profile page */
.form-group {
    transition: transform 0.2s ease;
}

.form-group:hover {
    transform: translateY(-1px);
}

/* Smooth transitions for all interactive elements */
.btn {
    transition: all 0.2s ease;
}

.btn:active {
    transform: scale(0.98);
}

/* Profile image hover effect */
.group:hover .group-hover\:scale-105 {
    transform: scale(1.05);
}

/* Notification animation */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Card hover effects */
.bg-white:hover {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

/* File input label styling */
label[for="id_profile_picture"] {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid #d1d5db;
    background-color: white;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
}

label[for="id_profile_picture"]:hover {
    background-color: #f9fafb;
    border-color: #0ea5e9;
    color: #0ea5e9;
}

/* Upload progress bar animation */
#progressBar {
    transition: width 0.3s ease;
}

/* Responsive adjustments */
@media (max-width: 640px) {
    .form-group .flex {
        flex-direction: column;
        gap: 1rem;
    }
    
    .form-group .flex-shrink-0 {
        margin: 0 auto;
    }
}
</style>
{% endblock %}