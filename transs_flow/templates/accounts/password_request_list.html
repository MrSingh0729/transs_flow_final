{% extends 'base.html' %}
{% load static %}
{% block title %}Password Change Requests{% endblock %}
 
{% block content %}
<div class="max-w-[1300px] mx-auto w-full p-4">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-key text-blue-600 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Password Change Requests</h1>
                    <p class="text-sm text-gray-600">Manage user password modification requests</p>
                </div>
            </div>
            
            <!-- Header Actions -->
            <div class="flex gap-2">
                <button onclick="exportData()" class="btn btn-secondary touch-target">
                    <i class="fas fa-download"></i>
                    <span class="hidden sm:inline ml-2">Export</span>
                </button>
                <button onclick="refreshData()" class="btn btn-secondary touch-target">
                    <i class="fas fa-sync-alt"></i>
                    <span class="hidden sm:inline ml-2">Refresh</span>
                </button>
            </div>
        </div>
    </div>
 
    <!-- Messages -->
    {% if messages %}
        <div class="mb-4 space-y-2">
            {% for message in messages %}
                <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg flex items-center gap-2 animate-pulse">
                    <i class="fas fa-info-circle"></i>
                    <span class="font-medium">{{ message }}</span>
                </div>
            {% endfor %}
        </div>
    {% endif %}
 
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">

        <!-- Pending -->
        <div class="metric-card">
            <div class="flex items-start justify-between">
                <div>
                    <div class="metric-value">{{ pending_count }}</div>
                    <div class="metric-label">Pending Requests</div>
                    <div class="metric-change {% if pending_change > 0 %}positive{% else %}negative{% endif %}">
                        <i class="fas fa-arrow-{% if pending_change > 0 %}up{% else %}down{% endif %} mr-1"></i>
                        {% if pending_change < 0 %}
                            {{ pending_change|floatformat:2|cut:"-" }}% from yesterday
                        {% else %}
                            {{ pending_change|floatformat:2 }}% from yesterday
                        {% endif %}
                    </div>
                </div>
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-600"></i>
                </div>
            </div>
        </div>

        <!-- Processed Today -->
        <div class="metric-card">
            <div class="flex items-start justify-between">
                <div>
                    <div class="metric-value">{{ processed_count }}</div>
                    <div class="metric-label">Processed Today</div>
                    <div class="metric-change {% if processed_change > 0 %}positive{% else %}negative{% endif %}">
                        <i class="fas fa-arrow-{% if processed_change > 0 %}up{% else %}down{% endif %} mr-1"></i>
                        {{ processed_change|floatformat:2 }}% vs yesterday
                    </div>
                </div>
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
            </div>
        </div>

        <!-- Avg Processing Time -->
        <div class="metric-card">
            <div class="flex items-start justify-between">
                <div>
                    <div class="metric-value">{{ avg_processing_time }}</div>
                    <div class="metric-label">Avg. Processing Time</div>
                    <div class="metric-change positive">
                        Calculated from approved requests
                    </div>
                </div>
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-tachometer-alt text-purple-600"></i>
                </div>
            </div>
        </div>

        <!-- Total Requests -->
        <div class="metric-card">
            <div class="flex items-start justify-between">
                <div>
                    <div class="metric-value">{{ total_requests }}</div>
                    <div class="metric-label">Total Requests</div>
                    <div class="metric-change positive">
                        Since system launch
                    </div>
                </div>
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-blue-600"></i>
                </div>
            </div>
        </div>

    </div>
 
    <!-- Search and Filter -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-6">
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- Search -->
            <div class="flex-1">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" 
                           id="searchInput"
                           placeholder="Search by employee ID or name..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200">
                </div>
            </div>
            
            <!-- Filters -->
            <div class="flex gap-2 flex-wrap">
                <select id="statusFilter" class="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <option value="">All Status</option>
                    <option value="PENDING">Pending</option>
                    <option value="APPROVED">Approved</option>
                    <option value="REJECTED">Rejected</option>
                </select>
                
                <select id="dateFilter" class="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
                
                <button onclick="applyFilters()" class="btn btn-primary touch-target">
                    <i class="fas fa-filter mr-2"></i>Apply Filters
                </button>
                
                <button onclick="clearFilters()" class="btn btn-secondary touch-target">
                    <i class="fas fa-times mr-2"></i>Clear
                </button>
            </div>
        </div>
    </div>
 
    <!-- Main Content -->
    <div class="space-y-6">
        <!-- Requests Table -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <!-- Table Header with Bulk Actions -->
            <div class="border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" 
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-sm text-gray-600">
                            <span id="selectedCount">0</span> selected
                        </span>
                    </div>
                    
                    <div id="bulkActions" class="hidden gap-2">
                        <button onclick="bulkApprove()" class="btn btn-primary btn-sm touch-target">
                            <i class="fas fa-check mr-1"></i>Approve Selected
                        </button>
                        <button onclick="bulkReject()" class="btn btn-secondary btn-sm touch-target">
                            <i class="fas fa-times mr-1"></i>Reject Selected
                        </button>
                    </div>
                </div>
            </div>
 
            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Employee</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Request Details</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Processing Info</th>
                            <th class="px-6 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="requestsTableBody">
                        {% for r in requests %}
                            <tr class="hover:bg-gray-50 transition-colors" data-id="{{ r.id }}">
                                <td class="px-6 py-4">
                                    <input type="checkbox" class="request-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                                           value="{{ r.id }}" onchange="updateSelectedCount()">
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                                            {% if r.profile_picture %}
                                                <img src="{{ r.profile_picture.url }}" alt="{{ r.full_name }}" 
                                                     class="w-full h-full rounded-full object-cover">
                                            {% else %}
                                                <i class="fas fa-user text-gray-400"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">{{ r.full_name }}</div>
                                            <div class="text-xs text-gray-500 font-mono">{{ r.employee_id }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm">
                                        <div class="text-gray-900 font-medium">Requested</div>
                                        <div class="text-gray-500 text-xs">{{ r.created_at|date:"M d, Y H:i" }}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    {% if r.status == 'PENDING' %}
                                        <span class="status-badge status-idle">
                                            <i class="fas fa-clock text-xs mr-1"></i>{{ r.get_status_display }}
                                        </span>
                                    {% elif r.status == 'APPROVED' %}
                                        <span class="status-badge status-running">
                                            <i class="fas fa-check-circle text-xs mr-1"></i>{{ r.get_status_display }}
                                        </span>
                                    {% elif r.status == 'REJECTED' %}
                                        <span class="status-badge status-stop">
                                            <i class="fas fa-times-circle text-xs mr-1"></i>{{ r.get_status_display }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4">
                                    {% if r.processed_at %}
                                        <div class="text-sm">
                                            <div class="text-gray-900">{{ r.processed_at|date:"M d, Y H:i" }}</div>
                                            <div class="text-gray-500 text-xs">by {{ r.processed_by }}</div>
                                        </div>
                                    {% else %}
                                        <span class="text-xs text-gray-400">Not processed</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-center">
                                    {% if r.status == 'PENDING' %}
                                        <div class="flex items-center justify-center gap-2">
                                            <button onclick="processRequest('{{ r.id }}', 'approve')" 
                                                    class="btn btn-primary btn-sm touch-target" title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div class="flex items-center justify-center gap-2">
                                            <button onclick="viewDetails('{{ r.id }}')" 
                                                    class="btn btn-secondary btn-sm touch-target" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button onclick="viewHistory('{{ r.id }}')" 
                                                    class="btn btn-secondary btn-sm touch-target" title="View History">
                                                <i class="fas fa-history"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6" class="px-6 py-12">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No requests found</h3>
                                        <p class="text-gray-500">There are no password change requests at the moment.</p>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
 
            <!-- Pagination -->
            {% if is_paginated %}
                <div class="border-t border-gray-200 px-4 py-3 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span class="font-medium">{{ page_obj.start_index }}</span> to 
                        <span class="font-medium">{{ page_obj.end_index }}</span> of 
                        <span class="font-medium">{{ page_obj.paginator.count }}</span> results
                    </div>
                    <div class="flex gap-1">
                        {% if page_obj.has_previous %}
                            <a href="?page=1" class="btn btn-secondary btn-sm touch-target">First</a>
                            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-secondary btn-sm touch-target">Previous</a>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="btn btn-primary btn-sm touch-target">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?page={{ num }}" class="btn btn-secondary btn-sm touch-target">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-secondary btn-sm touch-target">Next</a>
                            <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-secondary btn-sm touch-target">Last</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
 
        <!-- Recent Activity Timeline -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-history mr-2 text-blue-500"></i>Recent Activity
            </h3>
            <div class="space-y-4">
                {% for activity in recent_activities %}
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 bg-{{ activity.color }}-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-{{ activity.icon }} text-{{ activity.color }}-600 text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">{{ activity.message }}</p>
                            <p class="text-xs text-gray-500">{{ activity.timestamp|date:"M d, Y H:i" }}</p>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-history text-2xl mb-2"></i>
                        <p class="text-sm">No recent activity</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
 
<!-- JavaScript -->
<script>
let selectedRequests = new Set();
 
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.request-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        if (checkbox.checked) {
            selectedRequests.add(checkbox.value);
        } else {
            selectedRequests.delete(checkbox.value);
        }
    });
    
    updateSelectedCount();
}
 
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.request-checkbox:checked');
    selectedRequests.clear();
    checkboxes.forEach(checkbox => selectedRequests.add(checkbox.value));
    
    document.getElementById('selectedCount').textContent = selectedRequests.size;
    document.getElementById('bulkActions').classList.toggle('hidden', selectedRequests.size === 0);
}
 
function processRequest(id, action) {
    const url = "{% url 'admin_change_user_password' 0 %}".replace('0', id);
    if (action === 'reject') {
        if (confirm('Are you sure you want to reject this password change request?')) {
            window.location.href = url + '?action=reject';
        }
    } else {
        window.location.href = url;
    }
}
 
function bulkApprove() {
    if (confirm(`Are you sure you want to approve ${selectedRequests.size} requests?`)) {
        // Implement bulk approval logic
        showNotification('Processing bulk approval...', 'info');
        setTimeout(() => {
            showNotification('Requests approved successfully', 'success');
        }, 2000);
    }
}
 
function bulkReject() {
    if (confirm(`Are you sure you want to reject ${selectedRequests.size} requests?`)) {
        // Implement bulk rejection logic
        showNotification('Processing bulk rejection...', 'info');
        setTimeout(() => {
            showNotification('Requests rejected successfully', 'success');
        }, 2000);
    }
}
 
function viewDetails(id) {
    // Create modal with request details
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>Request Details
                </h3>
                <button onclick="closeModal(this)" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-sm text-gray-600">
                Loading request details...
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Fetch details via AJAX
    fetch(`/api/password-requests/${id}/`)
        .then(response => response.json())
        .then(data => {
            modal.querySelector('.text-sm').innerHTML = `
                <div class="space-y-3">
                    <div><strong>Employee:</strong> ${data.full_name}</div>
                    <div><strong>ID:</strong> ${data.employee_id}</div>
                    <div><strong>Requested:</strong> ${data.created_at}</div>
                    <div><strong>Status:</strong> ${data.status}</div>
                </div>
            `;
        });
}
 
function viewHistory(id) {
    showNotification('Loading request history...', 'info');
}
 
function exportData() {
    showNotification('Preparing export...', 'info');
    setTimeout(() => {
        window.location.href = '{% url "export_password_requests" %}';
    }, 1000);
}
 
function refreshData() {
    showNotification('Refreshing data...', 'info');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}
 
function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const date = document.getElementById('dateFilter').value;
    const search = document.getElementById('searchInput').value;
    
    let url = new URL(window.location);
    if (status) url.searchParams.set('status', status);
    if (date) url.searchParams.set('date', date);
    if (search) url.searchParams.set('search', search);
    
    window.location.href = url.toString();
}
 
function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('searchInput').value = '';
    
    const url = new URL(window.location);
    url.searchParams.delete('status');
    url.searchParams.delete('date');
    url.searchParams.delete('search');
    
    window.location.href = url.toString();
}
 
function closeModal(element) {
    const modal = element.closest('.fixed');
    modal.remove();
}
 
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
    notification.innerHTML = `
        <div class="flex items-center gap-2">
            <i class="fas ${icon}"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
        notification.classList.add('translate-x-0');
    }, 10);
    
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
 
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add search functionality
    document.getElementById('searchInput').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });
    
    // Auto-refresh every 30 seconds for pending requests
    setInterval(() => {
        const pendingCount = document.querySelectorAll('.status-idle').length;
        if (pendingCount > 0) {
            refreshData();
        }
    }, 30000);
});
</script>
 
<style>
/* Enhanced table styles */
.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
    min-height: 32px;
}
 
/* Checkbox custom styling */
input[type="checkbox"]:checked {
    background-color: #0ea5e9;
    border-color: #0ea5e9;
}
 
/* Loading animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
 
.fa-spin {
    animation: spin 1s linear infinite;
}
 
/* Enhanced empty state */
.text-center .w-16 {
    transition: transform 0.3s ease;
}
 
.text-center:hover .w-16 {
    transform: scale(1.1);
}
 
/* Pagination active state */
.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}