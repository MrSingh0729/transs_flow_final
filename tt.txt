transs_flow/accounts/admin.py:

from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import Employee

class EmployeeAdmin(UserAdmin):
    model = Employee
    # Replace 'username' with your USERNAME_FIELD
    list_display = ("employee_id", "full_name", "role", "department", "factory_code", "is_staff", "is_superuser")
    
    # Set fieldsets for admin create/edit page
    fieldsets = (
        (None, {"fields": ("employee_id", "password")}),
        ("Personal Info", {"fields": ("full_name", "role", "department", "factory_code", "factory_name", "country_code", "country_name")}),
        ("Permissions", {"fields": ("is_active", "is_staff", "is_superuser", "groups", "user_permissions")}),
        ("Important dates", {"fields": ("last_login",)}),
    )

    add_fieldsets = (
        (None, {
            "classes": ("wide",),
            "fields": ("employee_id", "full_name", "role", "department", "factory_code", "factory_name", "country_code", "country_name", "password1", "password2", "is_staff", "is_superuser"),
        }),
    )

    search_fields = ("employee_id", "full_name")
    ordering = ("employee_id",)  # <-- important fix
    filter_horizontal = ("groups", "user_permissions")

admin.site.register(Employee, EmployeeAdmin)



transs_flow/accounts/decorators.py:

from functools import wraps
from django.shortcuts import redirect
from core.models import Page, Assignment

def access_control(url_pattern, allowed_roles=None, allowed_departments=None):
    """
    Decorator to restrict access based on role, department, and factory_code
    """
    def decorator(view_func):
        @wraps(view_func)
        def wrapper(request, *args, **kwargs):
            if not request.user.is_authenticated:
                return redirect("login")

            user_role = getattr(request.user, "role", None)
            user_department = getattr(request.user, "department", None)
            user_factory_code = getattr(request.user, "factory_code", None)

            try:
                page = Page.objects.get(url_pattern=url_pattern)
            except Page.DoesNotExist:
                return redirect("no_access")

            # Check if assignment exists for this user
            if not Assignment.objects.filter(factory_code=user_factory_code, department=user_department, role=user_role, page=page).exists():
                return redirect("no_access")

            request.page = page
            return view_func(request, *args, **kwargs)
        return wrapper
    return decorator



transs_flow/accounts/forms.py:


from django import forms
from .models import Employee

class EmployeeForm(forms.ModelForm):
    password = forms.CharField(widget=forms.PasswordInput, required=False)  # optional for edit

    class Meta:
        model = Employee
        fields = [
            'employee_id', 'full_name', 'role', 'department',
            'factory_code', 'factory_name', 'country_code', 'country_name', 'password'
        ]



transs_flow/accounts/models.py:

from django.contrib.auth.models import AbstractBaseUser, BaseUserManager, PermissionsMixin
from django.db import models

class EmployeeManager(BaseUserManager):
    def create_user(self, employee_id, full_name, password=None, **extra_fields):
        if not employee_id:
            raise ValueError("Employee ID is required")
        user = self.model(employee_id=employee_id, full_name=full_name, **extra_fields)
        if password:
            user.set_password(password)
        user.save(using=self._db)
        return user
    
    def create_superuser(self, employee_id, full_name, password=None, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        return self.create_user(employee_id, full_name, password, **extra_fields)


class Employee(AbstractBaseUser, PermissionsMixin):
    employee_id = models.CharField(max_length=20, unique=True)
    full_name = models.CharField(max_length=100)
    role = models.CharField(max_length=50)
    department = models.CharField(max_length=50)
    factory_code = models.CharField(max_length=20)
    factory_name = models.CharField(max_length=100)
    country_code = models.CharField(max_length=10)
    country_name = models.CharField(max_length=50)

    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)

    objects = EmployeeManager()

    USERNAME_FIELD = "employee_id"
    REQUIRED_FIELDS = ["full_name"]

    def __str__(self):
        return f"{self.employee_id} - {self.full_name}"

transs_flow/accounts/role_decorators.py:


from functools import wraps
from django.core.exceptions import PermissionDenied
from django.shortcuts import redirect
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin


# ==============================
# âœ… FUNCTION-BASED VIEW DECORATOR
# ==============================
def role_required(allowed_roles=None, redirect_url='/no-permission/'):
    """
    Decorator to restrict view access based on user roles.
    - Default: Only ADMIN and SUPERUSER can access.
    - Example: @role_required(["IPQC", "QA"])
    """
    if allowed_roles is None:
        allowed_roles = []  # Default empty means only admin/superuser allowed

    def decorator(view_func):
        @wraps(view_func)
        @login_required
        def _wrapped_view(request, *args, **kwargs):
            user = request.user

            # Allow Superuser or Admin by default
            user_role = getattr(user, 'role', '').upper()
            if user.is_superuser or user_role == 'ADMIN':
                return view_func(request, *args, **kwargs)

            # If role is defined and matches
            if allowed_roles and user_role in [r.upper() for r in allowed_roles]:
                return view_func(request, *args, **kwargs)

            # Access denied â†’ redirect to custom page or raise 403
            if redirect_url:
                return redirect(redirect_url)
            raise PermissionDenied

        return _wrapped_view
    return decorator


# ==============================
# âœ… CLASS-BASED VIEW MIXIN
# ==============================
class RoleRequiredMixin(LoginRequiredMixin):
    """
    Mixin for class-based views to restrict access based on user roles.
    Usage:
      - allowed_roles = ["IPQC", "QA"]
      - Default allows only ADMIN and SUPERUSER
    """
    allowed_roles = []  # Override in view
    redirect_url = '/no-permission/'

    def dispatch(self, request, *args, **kwargs):
        user = request.user

        if not user.is_authenticated:
            return self.handle_no_permission()

        user_role = getattr(user, 'role', '').upper()

        # Allow Admin and Superuser by default
        if user.is_superuser or user_role == "ADMIN":
            return super().dispatch(request, *args, **kwargs)

        # Check allowed roles if defined
        if self.allowed_roles:
            if user_role in [role.upper() for role in self.allowed_roles]:
                return super().dispatch(request, *args, **kwargs)

        # Access denied
        if self.redirect_url:
            return redirect(self.redirect_url)
        raise PermissionDenied



transs_flow/accounts/urls.py:

from django.urls import path
from . import views

urlpatterns = [
    path("login/", views.login_view, name="login"),
    path("logout/", views.logout_view, name="logout"),
    path("", views.dashboard, name="dashboard"),

    # Superuser Employee management
    path("employees/", views.employee_list, name="employee_list"),
    path("employees/create/", views.employee_create, name="employee_create"),
    path("employees/edit/<int:pk>/", views.employee_edit, name="employee_edit"),
    path("employees/delete/<int:pk>/", views.employee_delete, name="employee_delete"),
]


transs_flow/accounts/views.py:


from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from .forms import EmployeeForm
from .models import Employee
from django.http import HttpResponseForbidden

# ----------------- Auth -----------------
def login_view(request):
    if request.method == "POST":
        employee_id = request.POST.get("employee_id")
        password = request.POST.get("password")

        user = authenticate(request, employee_id=employee_id, password=password)

        if user is not None:
            login(request, user)

            # ðŸ”¹ Role-based redirection
            if user.is_superuser or getattr(user, 'role', '').lower() == "admin" or getattr(user, 'role', '').upper() == "PQE":
                return redirect('dashboard')
            elif getattr(user, 'role', '').upper() == "IPQC":
                return redirect('ipqc_home')
            else:
                # Default redirect (if no role matches)
                return redirect('dashboard')

        else:
            return render(request, "accounts/login.html", {"error": "Invalid credentials"})

    return render(request, "accounts/login.html")

def logout_view(request):
    logout(request)
    return redirect('login')

# ----------------- Dashboard -----------------
@login_required
def dashboard(request):
    # Check if user is superuser or has role 'admin'
    if not (request.user.is_superuser or getattr(request.user, 'role', '').lower() == 'admin' or getattr(request.user, 'role', '').upper() == 'PQE'):
        return HttpResponseForbidden("You are not authorized to view this page.")

    total_employees = Employee.objects.count()

    context = {
        "total_employees": total_employees,
    }
    return render(request, "accounts/dashboard.html", context)

# ----------------- Employee CRUD -----------------
@login_required
def employee_list(request):
    employees = Employee.objects.all()
    return render(request, "accounts/employee_list.html", {"employees": employees})

@login_required
def employee_create(request):
    title = "Create"  # Add this so template can use {{ title }}
    
    if request.method == "POST":
        form = EmployeeForm(request.POST)
        if form.is_valid():
            data = form.cleaned_data
            Employee.objects.create_user(
                employee_id=data['employee_id'],
                full_name=data['full_name'],
                password=data['password'],
                role=data['role'],
                department=data['department'],
                factory_code=data['factory_code'],
                factory_name=data['factory_name'],
                country_code=data['country_code'],
                country_name=data['country_name']
            )
            return redirect('employee_list')
    else:
        form = EmployeeForm()
    
    return render(
        request,
        "accounts/employee_create.html",
        {
            "form": form,
            "title": title  # Pass title to template
        }
    )

@login_required
def employee_edit(request, pk):
    employee = get_object_or_404(Employee, pk=pk)
    if request.method == "POST":
        form = EmployeeForm(request.POST, instance=employee)
        if form.is_valid():
            emp = form.save(commit=False)
            password = form.cleaned_data.get('password')
            if password:
                emp.set_password(password)
            emp.save()
            return redirect('employee_list')
    else:
        form = EmployeeForm(instance=employee)
    return render(request, "accounts/employee_edit.html", {"form": form, "employee": employee})

@login_required
def employee_delete(request, pk):
    employee = get_object_or_404(Employee, pk=pk)
    
    if request.method == "POST":
        # User confirmed deletion
        employee.delete()
        return redirect('employee_list')
    
    # Render confirmation page
    return render(request, "accounts/employee_delete.html", {"employee": employee})


transs_flow/ipqc/templatetags/custom_filters.py:

# your_app/templatetags/custom_filters.py
from django import template

register = template.Library()

@register.filter
def split(value):
    return value.split()


@register.filter
def add_attr(value, arg):
    """Add attributes to form field based on condition"""
    try:
        attr, val = arg.split(':')
        if value.value():  # If field has a value, add the attribute
            return value.as_widget(attrs={attr: val})
    except:
        return value
    
@register.filter   
def endswith(value, arg):
    """Check if string ends with substring"""
    if isinstance(value, str):
        return value.endswith(arg)
    return False


@register.filter(name='attr')
def attr(field, arg):
    """Adds an HTML attribute to a form field."""
    attrs = {}
    if '=' in arg:
        key, val = arg.split('=', 1)
        attrs[key] = val
    else:
        attrs[arg] = True
    return field.as_widget(attrs=attrs)



transs_flow/ipqc/templatetags/esd_tags.py:

from django import template
from django.utils import timezone
from datetime import timedelta
from ..models import ESDComplianceChecklist

register = template.Library()

@register.filter
def esd_compliance_status(record):
    """
    Calculate ESD compliance status based on audit fields
    Returns dict with pass_count, fail_count, na_count, and status
    """
    # List of all audit choice fields
    audit_fields = [
        'epa_clothes', 'forbid_wear_out', 'no_accessories', 'clothes_clean',
        'collar_cover', 'all_buttons_closed', 'clothes_length', 'watch_expose',
        'hair_cap', 'slipper_check', 'wristband_check', 'pre_line_check',
        'wrist_touch_skin', 'no_touch_pcba', 'alert_plug_out',
        'trolley_grounding', 'device_grounded', 'grounding_points_tight',
        'ion_fan_distance', 'ion_fan_direction', 'gloves_condition',
        'mat_grounded', 'audit_label_valid', 'esds_box', 'table_no_source',
        'tools_audit', 'temp_humidity', 'tray_voltage'
    ]
    
    pass_count = 0
    fail_count = 0
    na_count = 0
    
    for field_name in audit_fields:
        field_value = getattr(record, field_name, 'NA')
        if field_value == 'PASS':
            pass_count += 1
        elif field_value == 'FAIL':
            fail_count += 1
        elif field_value == 'NA':
            na_count += 1
    
    # Determine overall status
    if fail_count > 0:
        status = 'Non-Compliant'
        status_class = 'status-non-compliant'
        icon = 'fas fa-times-circle'
    elif na_count > pass_count:
        status = 'Partial'
        status_class = 'status-partial'
        icon = 'fas fa-exclamation-circle'
    else:
        status = 'Compliant'
        status_class = 'status-compliant'
        icon = 'fas fa-check-circle'
    
    return {
        'pass_count': pass_count,
        'fail_count': fail_count,
        'na_count': na_count,
        'status': status,
        'status_class': status_class,
        'icon': icon
    }

@register.simple_tag
def esd_stats_dashboard():
    """
    Get ESD stats for dashboard
    """
    today = timezone.now().date()
    week_start = today - timedelta(days=today.weekday())
    
    today_count = ESDComplianceChecklist.objects.filter(date=today).count()
    week_count = ESDComplianceChecklist.objects.filter(date__gte=week_start).count()
    total_count = ESDComplianceChecklist.objects.all().count()
    
    return {
        'today': today_count,
        'week': week_count,
        'total': total_count
    }


    transs_flow/ipqc/templatetags/forms_extras.py:

    from django import template

register = template.Library()

@register.filter
def get_field(form, field_name):
    return form[field_name]


@register.filter(name='add_attr')
def add_attr(field, attr):
    attrs = attr.split(':')
    return field.as_widget(attrs={attrs[0]: attrs[1]})


transs_flow/ipqc/admin.py:

from django.contrib import admin
from .models import (
    IPQCWorkInfo,
    DynamicForm,
    DynamicFormField,
    DynamicFormSubmission,
    IPQCAssemblyAudit,
    BTBFitmentChecksheet,
    AssDummyTest,
    IPQCDisassembleCheckList,
)

# --- IPQC Work Info ---
@admin.register(IPQCWorkInfo)
class IPQCWorkInfoAdmin(admin.ModelAdmin):
    list_display = ('date', 'shift', 'emp_id', 'name', 'section', 'line', 'model')
    list_filter = ('shift', 'section', 'line', 'model')
    search_fields = ('emp_id', 'name', 'model')

# --- Dynamic Form & Fields ---
class DynamicFormFieldInline(admin.TabularInline):
    model = DynamicFormField
    extra = 1

@admin.register(DynamicForm)
class DynamicFormAdmin(admin.ModelAdmin):
    list_display = ('title', 'description', 'lark_bitable_table_id', 'created_at')
    inlines = [DynamicFormFieldInline]
    search_fields = ('title', 'description', 'lark_bitable_table_id')

@admin.register(DynamicFormSubmission)
class DynamicFormSubmissionAdmin(admin.ModelAdmin):
    list_display = ('form', 'submitted_by', 'created_at')
    list_filter = ('form', 'submitted_by')
    search_fields = ('form__title', 'submitted_by__username')

# --- IPQC Assembly Audit ---
@admin.register(IPQCAssemblyAudit)
class IPQCAssemblyAuditAdmin(admin.ModelAdmin):
    list_display = ('date', 'shift', 'emp_id', 'name', 'section', 'line', 'model', 'color')
    list_filter = ('shift', 'section', 'line', 'model')
    search_fields = ('emp_id', 'name', 'model')

# --- BTB Fitment Checksheet ---
@admin.register(BTBFitmentChecksheet)
class BTBFitmentChecksheetAdmin(admin.ModelAdmin):
    list_display = ('date', 'shift', 'emp_id', 'name', 'line', 'model', 'grand_total')
    list_filter = ('shift', 'line', 'model')
    search_fields = ('emp_id', 'name', 'model')

# --- Ass Dummy Test ---
@admin.register(AssDummyTest)
class AssDummyTestAdmin(admin.ModelAdmin):
    list_display = ('date', 'shift', 'emp_id', 'name', 'line', 'group', 'test_item', 'result')
    list_filter = ('shift', 'line', 'group', 'result')
    search_fields = ('emp_id', 'name', 'model', 'test_item')

# --- IPQC Disassemble Checklist ---
@admin.register(IPQCDisassembleCheckList)
class IPQCDisassembleCheckListAdmin(admin.ModelAdmin):
    list_display = ('date', 'shift', 'emp_id', 'name', 'line', 'model', 'color')
    list_filter = ('shift', 'line', 'model')
    search_fields = ('emp_id', 'name', 'model')



transs_flow/ipqc/forms.py:

from django import forms
from django.db import models 
from .models import IPQCWorkInfo, DynamicForm, DynamicFormField, IPQCAssemblyAudit, BTBFitmentChecksheet, AssDummyTest, IPQCDisassembleCheckList, NCIssueTracking, ESDComplianceChecklist, DustCountCheck, TestingFirstArticleInspection, OperatorQualificationCheck, FORM_CHOICES, FORM_APPROVAL, FAI_SITUATION_CHOICES, FORM_RESULT_CHOICES
from django.db import connections
from django.utils import timezone
import mimetypes



class WorkInfoForm(forms.ModelForm):
    class Meta:
        model = IPQCWorkInfo
        fields = ['date', 'shift', 'section', 'line', 'group', 'model', 'color']
        widgets = {
            'date': forms.DateInput(attrs={'type': 'date', 'class': 'w-full p-2 border rounded'}),
            'shift': forms.Select(choices=[('A', 'A'), ('B', 'B'), ('C', 'C')], attrs={'class': 'w-full p-2 border rounded'}),
            'section': forms.TextInput(attrs={'class': 'w-full p-2 border rounded'}),
            'line': forms.TextInput(attrs={'class': 'w-full p-2 border rounded'}),
            'group': forms.TextInput(attrs={'class': 'w-full p-2 border rounded'}),
            'model': forms.TextInput(attrs={'class': 'w-full p-2 border rounded'}),
            'color': forms.TextInput(attrs={'class': 'w-full p-2 border rounded'}),
        }

# class WorkInfoForm(forms.ModelForm):
#     class Meta:
#         model = IPQCWorkInfo
#         fields = ['date', 'shift', 'section', 'line', 'group', 'model', 'color', 'status']
#         widgets = {
#             'date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
#             'shift': forms.Select(choices=IPQCWorkInfo.SHIFT_CHOICES, attrs={'class': 'form-control'}),
#             'section': forms.TextInput(attrs={'class': 'form-control'}),
#             'line': forms.TextInput(attrs={'class': 'form-control'}),
#             'group': forms.TextInput(attrs={'class': 'form-control'}),
#             'model': forms.TextInput(attrs={'class': 'form-control'}),
#             'color': forms.TextInput(attrs={'class': 'form-control'}),
#             'status': forms.TextInput(attrs={'class': 'form-control', 'readonly': 'readonly'}),
#         }
        


def get_model_choices():
    """Fetch model names dynamically from defaultdb.model_description"""
    try:
        with connections['defaultdb'].cursor() as cursor:
            cursor.execute("SELECT model_name FROM model_description ORDER BY model_name ASC;")
            rows = cursor.fetchall()
        return [(r[0], r[0]) for r in rows]  # (value, label)
    except Exception:
        return []

LINE_CHOICES = [(f"L{i}", f"L{i}") for i in range(1, 16)]
GROUP_CHOICES = [(f"A{i}", f"A{i}") for i in range(1, 16)]

class WorkInfoForm(forms.ModelForm):
    model = forms.ChoiceField(
        choices=[],
        widget=forms.Select(attrs={'class': 'form-control select2', 'placeholder': 'Search Model'}),
        required=True
    )
    line = forms.ChoiceField(
        choices=LINE_CHOICES,
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    group = forms.ChoiceField(
        choices=GROUP_CHOICES,
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    class Meta:
        model = IPQCWorkInfo
        fields = ['date', 'shift', 'section', 'line', 'group', 'model', 'color']
        widgets = {
            'date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'shift': forms.Select(choices=IPQCWorkInfo.SHIFT_CHOICES, attrs={'class': 'form-control'}),
            'section': forms.Select(attrs={'class': 'form-control'}, choices=IPQCWorkInfo.SECTION_CHOICES),
            'color': forms.TextInput(attrs={'class': 'form-control'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # dynamically load model list every time form is rendered
        self.fields['model'].choices = get_model_choices()


class DynamicFormCreateForm(forms.ModelForm):
    class Meta:
        model = DynamicForm
        fields = ['title', 'description', 'lark_bitable_table_id']

class DynamicFormFieldForm(forms.ModelForm):
    class Meta:
        model = DynamicFormField
        fields = ['label', 'field_type', 'required', 'options', 'order']
        
        
# List of fields that require the special UI with a remark button
FIELDS_WITH_REMARKS = [
    'mach_epa_check', 'mach_screw_torque', 'mach_sholdering_temp',
    'mach_light', 'mach_fixture_clean', 'mach_jig_label', 'mach_teflon',
    'mach_press_params', 'mach_glue_params', 'mach_eq_move_notify',
    'mach_feeler_gauge', 'mach_hot_cold_press', 'mach_ion_fan',
    'mach_cleanroom_eq', 'mach_rti_check', 'mach_current_test', 'mach_pal_qr',
    'mach_auto_screw', 'mat_key_check', 'mat_special_stop', 'mat_improved_monitor',
    'mat_result_check', 'mat_battery_issue', 'mat_ipa_check', 'mat_thermal_gel',
    'mat_verification', 'meth_sop_seq', 'meth_distance_sensor', 'meth_rear_camera',
    'meth_material_handling', 'meth_guideline_doc', 'meth_operation_doc',
    'meth_defective_feedback', 'meth_line_record', 'meth_no_self_repair',
    'meth_battery_fix', 'meth_line_change', 'meth_trail_run', 'meth_dummy_conduct',
    'env_prod_monitor', 'env_5s', 'trc_flow_chart', 'fai_check',
    'defect_monitor', 'spot_check', 'auto_screw_sample'
]
 
class  IPQCAssemblyAuditForm(forms. ModelForm):
    class Meta:
        model = IPQCAssemblyAudit
        fields = '__all__'
        exclude = ['created_at']
        widgets = {
            'remarks': forms. Textarea(attrs={'rows': 4, 'class': 'form-control'}),
            'wo_input_qty': forms. NumberInput(attrs={'class': 'form-control'}),
        }
 
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        # Dynamically add remark fields
        for field_name in FIELDS_WITH_REMARKS:
            self.fields[f'remark_{field_name}'] = forms. CharField(
            label=f"Remark for {self.fields[field_name].label}",
            required=False,
            widget=forms. Textarea(attrs={'rows': 2, 'class': 'form-control'})
            )
 
        # Add 'form-control' class and set readonly fields
        readonly_fields = [
            'date', 'shift', 'emp_id', 'name', 'section', 
            'line', 'group', 'model', 'color', 'pqe_tl_sign'
        ]
 
        for field_name, field in self.fields.items():
            if  not  isinstance(field.widget, forms. CheckboxInput):
                field.widget.attrs['class'] = 'form-control'
            
            if field_name in readonly_fields:
                field.widget.attrs['readonly'] = True
                
                
 
class BTBFitmentChecksheetForm(forms.ModelForm):
    class Meta:
        model = BTBFitmentChecksheet
        exclude = ['created_by', 'created_at', 
                   'input_total', 'cam_btb_total', 'lcd_fitment_total', 'main_fpc_total', 'battery_total', 'finger_printer_total',
                   'total_9', 'total_10', 'total_11', 'total_12', 'total_1', 'total_2', 'total_3', 'total_4', 'total_5', 'total_6',
                   'grand_total']
        
        widgets = {
            'date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'shift': forms.DateInput(attrs={'type': 'shift', 'class': 'form-control'}),
            'emp_id': forms.DateInput(attrs={'type': 'emp_id', 'class': 'form-control'}),
            'name': forms.TextInput(attrs={'class': 'form-control'}),
            'line': forms.TextInput(attrs={'class': 'line','class':  'form-control'}),
            'group': forms.TextInput(attrs={'class': 'group','class': 'form-control'}),
            'model': forms.TextInput(attrs={'class': 'model','class': 'form-control'}),
            'color': forms.TextInput(attrs={'class': 'color','class': 'form-control'}),
            'frequency': forms.TextInput(attrs={'class': 'form-control'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        # --- Logic to make auto-populated fields read-only ---
        auto_populated_fields = ['date', 'shift', 'emp_id', 'name', 'line', 'group', 'model', 'color']
        for field_name in auto_populated_fields:
            if self.initial.get(field_name):
                field = self.fields.get(field_name)
                if field:
                    field.widget.attrs['readonly'] = True
                    field.widget.attrs['class'] += ' bg-light'
        
        # --- Logic for other field types ---
        for field_name, field in self.fields.items():
            if isinstance(field, forms.IntegerField):
                field.widget = forms.NumberInput(attrs={'class': 'form-control form-control-sm text-center', 'min': '0', 'value': '0'})
            
            # --- UPDATED: Add a custom class to Textarea fields ---
            elif isinstance(field, models.TextField):
                field.widget = forms.Textarea(attrs={
                    'class': 'form-control form-control-sm remark-field', # <-- Custom class added here
                    'rows': '2', 
                    'placeholder': 'Add remark...',
                    # The 'style' attribute has been removed
                })
                
                
class AssDummyTestForm(forms.ModelForm):
    class Meta:
        model = AssDummyTest
        fields = [
            'date', 'shift', 'emp_id', 'name', 'area', 'section', 'line', 'group',
            'model', 'color', 'test_stage', 'test_item',
            'operator_name', 'operator_id', 'result', 'cause', 'measure',
            'll_confirm', 'remark'
        ]
        widgets = {
            'date': forms.DateInput(attrs={'class': 'form-control'}),
            'shift': forms.TextInput(attrs={'class': 'form-control'}),
            'emp_id': forms.TextInput(attrs={'class': 'form-control'}),
            'name': forms.TextInput(attrs={'class': 'form-control'}),
            'area': forms.TextInput(attrs={'class': 'form-control'}),
            'section': forms.TextInput(attrs={'class': 'form-control'}),
            'line': forms.TextInput(attrs={'class': 'form-control'}),
            'group': forms.TextInput(attrs={'class': 'form-control'}),
            'model': forms.TextInput(attrs={'class': 'form-control'}),
            'color': forms.TextInput(attrs={'class': 'form-control'}),
            'test_stage': forms.TextInput(attrs={'class': 'form-control'}),
            'test_item': forms.TextInput(attrs={'class': 'form-control'}),
            'operator_name': forms.TextInput(attrs={'class': 'form-control'}),
            'operator_id': forms.TextInput(attrs={'class': 'form-control'}),
            'result': forms.Select(attrs={'class': 'form-control'}),
            'cause': forms.Textarea(attrs={'class': 'form-control', 'rows': 2}),
            'measure': forms.Textarea(attrs={'class': 'form-control', 'rows': 2}),
            'll_confirm': forms.Textarea(attrs={'class': 'form-control', 'rows': 2}),
            'remark': forms.Textarea(attrs={'class': 'form-control', 'rows': 2}),
        }
        
        
class IPQCDisassembleCheckListForm(forms.ModelForm):
    class Meta:
        model = IPQCDisassembleCheckList
        fields = '__all__'

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # --- Make work info fields readonly ---
        readonly_fields = [
            'date', 'shift', 'emp_id', 'name',
            'section', 'line', 'group', 'model', 'color'
        ]
        for field_name in readonly_fields:
            self.fields[field_name].widget.attrs['readonly'] = True
            self.fields[field_name].widget.attrs['class'] = 'form-control-plaintext'

        # --- Add styling to all dropdowns and inputs ---
        for field_name, field in self.fields.items():
            if field_name not in readonly_fields:
                if isinstance(field.widget, forms.Select):
                    field.widget.attrs.update({'class': 'form-select'})
                elif isinstance(field.widget, forms.FileInput):
                    field.widget.attrs.update({'class': 'form-control', 'accept': 'image/*'})
                else:
                    field.widget.attrs.update({'class': 'form-control'})

        # --- Add placeholders for text fields ---
        self.fields['defect_cause'].widget.attrs['placeholder'] = "Describe cause of defect (if any)..."
        self.fields['pqe'].widget.attrs['placeholder'] = "Enter PQE name"
        self.fields['pe'].widget.attrs['placeholder'] = "Enter PE name"
        self.fields['apd_ll'].widget.attrs['placeholder'] = "Enter APD LL name"

    def clean(self):
        """
        Custom validation:
        - If any 'Not OK' field is selected, require supporting image proof or remarks.
        """
        cleaned_data = super().clean()
        
        # Get all image fields from the model
        image_fields = [
            'color_match_photo', 'cam_lens_photo', 'key_photo', 
            'screw_photo', 'housing_photo', 'proof_label_photo',
            'assembly_overview_photo', 'defect_photo'
        ]

        # Check if any field marked as "Not OK"
        not_ok_fields = []
        for field_name, value in cleaned_data.items():
            if isinstance(value, str) and value == 'Not OK':
                not_ok_fields.append(field_name)

        # If 'Not OK' found, require at least one image or remark
        if not_ok_fields:
            has_image = False
            for img_field in image_fields:
                if img_field in cleaned_data and cleaned_data.get(img_field):
                    has_image = True
                    break
            
            remarks = cleaned_data.get('defect_cause')
            if not has_image and not remarks:
                raise forms.ValidationError(
                    "Please provide a defect image or description for all 'Not OK' items."
                )

        return cleaned_data
        
        
class NCIssueTrackingForm(forms.ModelForm):
    class Meta:
        model = NCIssueTracking
        fields = [
            # Work Info
            "date", "shift", "emp_id", "name", "section", "line", "group", "model", "color",
            
            # Issue Tracking
            "stage", "time", "issue", "three_why", "solution",
            "operator_name", "operator_id", "responsible_dept", "responsible_person",
            "close_time", "status", "remark",
        ]
        widgets = {
            # Work Info
            "date": forms.DateInput(attrs={"type": "date", "class": "form-control"}),
            "shift": forms.TextInput(attrs={"class": "form-control"}),
            "emp_id": forms.TextInput(attrs={"class": "form-control"}),
            "name": forms.TextInput(attrs={"class": "form-control"}),
            "section": forms.TextInput(attrs={"class": "form-control"}),
            "line": forms.TextInput(attrs={"class": "form-control"}),
            "group": forms.TextInput(attrs={"class": "form-control"}),
            "model": forms.TextInput(attrs={"class": "form-control"}),
            "color": forms.TextInput(attrs={"class": "form-control"}),

            # Issue Tracking
            "stage": forms.TextInput(attrs={"class": "form-control"}),

            # Change 'time' to datetime-local to store timestamp easily
            "time": forms.DateTimeInput(attrs={"type": "datetime-local", "class": "form-control"}),

            "issue": forms.Textarea(attrs={"class": "form-control", "rows": 3}),
            "three_why": forms.Textarea(attrs={"class": "form-control", "rows": 3}),
            "solution": forms.Textarea(attrs={"class": "form-control", "rows": 3}),
            "operator_name": forms.TextInput(attrs={"class": "form-control"}),
            "operator_id": forms.TextInput(attrs={"class": "form-control"}),
            "responsible_dept": forms.TextInput(attrs={"class": "form-control"}),
            "responsible_person": forms.TextInput(attrs={"class": "form-control"}),

            # Close Time as datetime-local
            "close_time": forms.DateTimeInput(attrs={"type": "datetime-local", "class": "form-control"}),

            "status": forms.TextInput(attrs={"class": "form-control"}),
            "remark": forms.Textarea(attrs={"class": "form-control", "rows": 2}),
        }
 
    
class ESDComplianceChecklistForm(forms.ModelForm):
    class Meta:
        model = ESDComplianceChecklist
        # Note: Photo fields are not in the main audit list anymore, but they are still in 'fields'
        fields = [
            # --- Basic Info ---
            'date', 'shift', 'emp_id', 'name', 'line', 'group', 'model', 'color',

            # --- 1. Clothing Rules ---
            'epa_clothes', 'forbid_wear_out', 'no_accessories', 'clothes_clean',
            'collar_cover', 'all_buttons_closed', 'clothes_length', 'watch_expose',
            'hair_cap',

            # --- 2. Wristband and Slipper ---
            'slipper_check', 'wristband_check', 'pre_line_check', 'wrist_touch_skin',

            # --- 3. Handling Rules ---
            'no_touch_pcba', 'alert_plug_out',

            # --- 4. Grounding and Equipment ---
            'trolley_grounding', 'device_grounded', 'grounding_points_tight',
            'ion_fan_distance', 'ion_fan_direction',

            # --- 5. Consumables ---
            'gloves_condition', 'mat_grounded', 'audit_label_valid',

            # --- 6. Material Handling ---
            'esds_box', 'table_no_source',

            # --- 7. Tools & Environment ---
            'tools_audit', 'temp_humidity', 'tray_voltage',
            
            # --- Environmental Readings (Numerical Inputs) ---
            'temperature_value', 'humidity_value', 'tray_voltage_value',

            # --- Photo Fields ---
            'epa_clothes_photo', 'hair_cap_photo', 'wristband_photo', 'trolley_photo',
            'ion_fan_photo', 'mat_photo', 'table_photo', 'photo_overview',

            # --- Remarks ---
            'remark',
        ]
        widgets = {
            # --- Basic Info (Readonly) ---
            'date': forms.DateInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none bg-gray-50', 'readonly': True}),
            'shift': forms.TextInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none bg-gray-50', 'readonly': True}),
            'emp_id': forms.TextInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none bg-gray-50', 'readonly': True}),
            'name': forms.TextInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none bg-gray-50', 'readonly': True}),
            'line': forms.TextInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none bg-gray-50', 'readonly': True}),
            'group': forms.TextInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none bg-gray-50', 'readonly': True}),
            'model': forms.TextInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none bg-gray-50', 'readonly': True}),
            'color': forms.TextInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none bg-gray-50', 'readonly': True}),

            # --- Select Fields (Audit Options) ---
            'epa_clothes': forms.Select(attrs={'class': 'status-select'}),
            'forbid_wear_out': forms.Select(attrs={'class': 'status-select'}),
            'no_accessories': forms.Select(attrs={'class': 'status-select'}),
            'clothes_clean': forms.Select(attrs={'class': 'status-select'}),
            'collar_cover': forms.Select(attrs={'class': 'status-select'}),
            'all_buttons_closed': forms.Select(attrs={'class': 'status-select'}),
            'clothes_length': forms.Select(attrs={'class': 'status-select'}),
            'watch_expose': forms.Select(attrs={'class': 'status-select'}),
            'hair_cap': forms.Select(attrs={'class': 'status-select'}),
            'slipper_check': forms.Select(attrs={'class': 'status-select'}),
            'wristband_check': forms.Select(attrs={'class': 'status-select'}),
            'pre_line_check': forms.Select(attrs={'class': 'status-select'}),
            'wrist_touch_skin': forms.Select(attrs={'class': 'status-select'}),
            'no_touch_pcba': forms.Select(attrs={'class': 'status-select'}),
            'alert_plug_out': forms.Select(attrs={'class': 'status-select'}),
            'trolley_grounding': forms.Select(attrs={'class': 'status-select'}),
            'device_grounded': forms.Select(attrs={'class': 'status-select'}),
            'grounding_points_tight': forms.Select(attrs={'class': 'status-select'}),
            'ion_fan_distance': forms.Select(attrs={'class': 'status-select'}),
            'ion_fan_direction': forms.Select(attrs={'class': 'status-select'}),
            'gloves_condition': forms.Select(attrs={'class': 'status-select'}),
            'mat_grounded': forms.Select(attrs={'class': 'status-select'}),
            'audit_label_valid': forms.Select(attrs={'class': 'status-select'}),
            'esds_box': forms.Select(attrs={'class': 'status-select'}),
            'table_no_source': forms.Select(attrs={'class': 'status-select'}),
            'tools_audit': forms.Select(attrs={'class': 'status-select'}),
            'temp_humidity': forms.Select(attrs={'class': 'status-select'}),
            'tray_voltage': forms.Select(attrs={'class': 'status-select'}),

            # --- Numerical Inputs ---
            'temperature_value': forms.NumberInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none', 'step': '0.01', 'placeholder': 'e.g., 22.50'}),
            'humidity_value': forms.NumberInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none', 'step': '0.01', 'placeholder': 'e.g., 45.00'}),
            'tray_voltage_value': forms.NumberInput(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none', 'step': '0.01', 'placeholder': 'e.g., -15.50'}),

            # --- Textarea ---
            'remark': forms.Textarea(attrs={'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-sky-500 focus:outline-none', 'rows': 4, 'placeholder': 'Enter any detailed remarks here...'}),
            
            # --- File Inputs (LIVE CAMERA CAPTURE) ---
            # The 'capture="environment"' attribute tells mobile browsers to open the rear camera.
            'epa_clothes_photo': forms.FileInput(attrs={'accept': 'image/*', 'capture': 'environment', 'class': 'w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100'}),
            'hair_cap_photo': forms.FileInput(attrs={'accept': 'image/*', 'capture': 'environment', 'class': 'w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100'}),
            'wristband_photo': forms.FileInput(attrs={'accept': 'image/*', 'capture': 'environment', 'class': 'w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100'}),
            'trolley_photo': forms.FileInput(attrs={'accept': 'image/*', 'capture': 'environment', 'class': 'w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100'}),
            'ion_fan_photo': forms.FileInput(attrs={'accept': 'image/*', 'capture': 'environment', 'class': 'w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100'}),
            'mat_photo': forms.FileInput(attrs={'accept': 'image/*', 'capture': 'environment', 'class': 'w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100'}),
            'table_photo': forms.FileInput(attrs={'accept': 'image/*', 'capture': 'environment', 'class': 'w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100'}),
            'photo_overview': forms.FileInput(attrs={'accept': 'image/*', 'capture': 'environment', 'class': 'w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100'}),
        }
        
class DustCountCheckForm(forms.ModelForm):
    class Meta:
        model = DustCountCheck
        fields = [
            'date', 'shift', 'emp_id', 'name', 'line', 'group', 'model', 'color',
            'micrometer_0_3', 'micrometer_0_5', 'micrometer_1_0',
            'checked_by', 'verified_by', 'remark'
        ]

        widgets = {
            # --- Basic Info (read-only) ---
            'date': forms.DateInput(attrs={'class': 'form-control', 'readonly': True}),
            'shift': forms.TextInput(attrs={'class': 'form-control', 'readonly': True}),
            'emp_id': forms.TextInput(attrs={'class': 'form-control', 'readonly': True}),
            'name': forms.TextInput(attrs={'class': 'form-control', 'readonly': True}),
            'line': forms.TextInput(attrs={'class': 'form-control', 'readonly': True}),
            'group': forms.TextInput(attrs={'class': 'form-control', 'readonly': True}),
            'model': forms.TextInput(attrs={'class': 'form-control', 'readonly': True}),
            'color': forms.TextInput(attrs={'class': 'form-control', 'readonly': True}),

            # --- Particle measurements ---
            'micrometer_0_3': forms.NumberInput(attrs={'class': 'form-control', 'min': 0}),
            'micrometer_0_5': forms.NumberInput(attrs={'class': 'form-control', 'min': 0}),
            'micrometer_1_0': forms.NumberInput(attrs={'class': 'form-control', 'min': 0}),

            # --- Checked & Verified By ---
            'checked_by': forms.TextInput(attrs={'class': 'form-control'}),
            'verified_by': forms.TextInput(attrs={'class': 'form-control'}),

            # --- Remarks ---
            'remark': forms.Textarea(attrs={'class': 'form-control', 'rows': 3, 'placeholder': 'Any remarks...'}),
        }
        

class  TestingFirstArticleInspectionForm(forms. ModelForm):
    """Comprehensive FAI form with validation and file handling for the updated model."""
    
    class Meta:
        model = TestingFirstArticleInspection
        fields = '__all__'
        widgets = {
            'date': forms. DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            # 'power_consumption_test': forms. Textarea(attrs={'class': 'form-control', 'rows': 2}),
            # 'high_temp_simul_test': forms. Textarea(attrs={'class': 'form-control', 'rows': 2}),
        }
    
    def __init__(self, *args, user=None, **kwargs):
        super().__init__(*args, **kwargs)
        self.user = user
        
        # Set 'form-control' class for all fields by default
        for field_name, field in self.fields.items():
            if hasattr(field, 'widget'):
                field.widget.attrs['class'] = 'form-control'
 
        # Dynamically set widgets for fields with specific choices
        self.fields['first_article_type'].widget = forms. Select(choices=FAI_SITUATION_CHOICES, attrs={'class': 'form-control'})
        self.fields['qe_confirm_status'].widget = forms. Select(choices=FORM_APPROVAL, attrs={'class': 'form-control'})
 
        # Set widgets for standard check and result fields
        for field_name, field in self.fields.items():
            if field_name.endswith('_check') and not field_name.endswith('_evidence'):
                field.widget = forms. Select(choices=FORM_CHOICES, attrs={'class': 'form-control status-select'})
                if field_name.endswith('_result'):
                    field.widget = forms. Select(choices=FORM_RESULT_CHOICES, attrs={'class': 'form-control status-select'})
 
        # Set specific fields as required
        required_fields = [
            'date', 'shift', 'emp_id', 'name', 'section', 'line', 'group', 'model', 'color',
            'production_work_order_no', 'first_article_type', 'sample_serial_number', 
            'imei_number', 'visual_functional_result', 'reliability_result'
        ]
        for field_name in required_fields:
            if field_name in self.fields:
                self.fields[field_name].required = True
 
    def clean_date(self):
        """Ensure the inspection date is not in the future."""
        date = self.cleaned_data.get('date')
        if date and date > timezone.now().date():
            raise forms. ValidationError("Inspection date cannot be in the future.")
        return date
 
    def clean_imei_number(self):
        """Validate IMEI format."""
        imei = self.cleaned_data.get('imei_number')
        if imei:
            imei_stripped = imei.replace(' ', '')
            if len(imei_stripped) != 15 or not imei_stripped.isdigit():
                raise forms. ValidationError("IMEI must be exactly 15 digits.")
            return imei_stripped
        return imei
 
    def validate_image_file(self, image_file, max_size=5*1024*1024):
        """Validate an uploaded image file for size, type, and dimensions."""
        if not image_file:
            return None
        if image_file.size > max_size:
            raise forms. ValidationError(f"Image file size cannot exceed {max_size//(1024*1024)}MB.")
        allowed_types = ['image/jpeg', 'image/png', 'image/jpg', 'image/bmp']
        file_type = mimetypes.guess_type(image_file.name)[0]
        if file_type not in allowed_types:
            raise forms. ValidationError("Only JPEG, PNG, and BMP image formats are allowed.")
        try:
            from PIL import Image
            img = Image. open(image_file)
            img.verify()
        except Exception:
            raise forms. ValidationError("Invalid or corrupted image file.")
        return image_file
 
    
 
    # --- Individual Field Validation for Evidence Files ---
    def clean_label_check_evidence(self): return self.validate_image_file(self.cleaned_data.get('label_check_evidence'))
    def clean_label_position_check_evidence(self): return self.validate_image_file(self.cleaned_data.get('label_position_check_evidence'))
    def clean_logo_check_evidence(self): return self.validate_image_file(self.cleaned_data.get('logo_check_evidence'))
    def clean_assembly_battery_check_evidence(self): return self.validate_image_file(self.cleaned_data.get('assembly_battery_check_evidence'))
    def clean_boot_time_test_evidence(self): return self.validate_image_file(self.cleaned_data.get('boot_time_test_evidence'))
    def clean_camera_front_test_evidence(self): return self.validate_image_file(self.cleaned_data.get('camera_front_test_evidence'))
    def clean_camera_back_test_evidence(self): return self.validate_image_file(self.cleaned_data.get('camera_back_test_evidence'))
    def clean_camera_dark_test_evidence(self): return self.validate_image_file(self.cleaned_data.get('camera_dark_test_evidence'))
    def clean_high_temp_camera_test_evidence(self): return self.validate_image_file(self.cleaned_data.get('high_temp_camera_test_evidence'))
    def clean_imei_photo(self): return self.validate_image_file(self.cleaned_data.get('imei_photo'))
 
    def clean(self):
        """Custom cross-field validation."""
        cleaned_data = super().clean()
        visual_result = cleaned_data.get('visual_functional_result')
        reliability_result = cleaned_data.get('reliability_result')
        if (visual_result == 'UNQUALIFIED' or reliability_result == 'UNQUALIFIED') and not cleaned_data.get('inspector_name'):
            self.add_error('inspector_name', "Inspector name is required when a result is 'Unqualified'.")
        return cleaned_data
 
    def save(self, commit=True):
        """Override save to auto-populate inspector name."""
        instance = super().save(commit=False)

        user = self.user  # âœ… use self.user, not self.request.user
        if user and not instance.inspector_name:
            inspector_name = (
                getattr(user, 'full_name', None)
                or getattr(user, 'name', None)
                or getattr(user, 'username', None)
                or str(user)
            )
            instance.inspector_name = inspector_name  # âœ… actually assign it

        if commit:
            instance.save()
        return instance
    
class OperatorQualificationCheckForm(forms.ModelForm):
    class Meta:
        model = OperatorQualificationCheck
        fields = '__all__'
        widgets = {
            'date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'job_card_verification_summary': forms.Textarea(attrs={'rows': 3, 'class': 'form-control'}),
            'scanned_barcode_text': forms.URLInput(attrs={'class': 'form-control', 'readonly': 'readonly'}),
            'scanned_barcode_image': forms.ClearableFileInput(attrs={'class': 'form-control-file'}),
            'key_station_name': forms.TextInput(attrs={'class': 'form-control'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Add Bootstrap classes
        for field in self.fields.values():
            if field.widget.__class__.__name__ not in ['CheckboxInput', 'RadioSelect']:
                field.widget.attrs['class'] = field.widget.attrs.get('class', '') + ' form-control'

        # Read-only fields
        readonly_fields = ['emp_id','name','date','shift','section','line','group','model','color']
        for field in readonly_fields:
            if field in self.fields:
                self.fields[field].widget.attrs['readonly'] = True



transs_flow/ipqc/models.py:


from django.db import models
from django.contrib.auth.models import User
from django.utils import timezone
from django.conf import settings
import os
import uuid

# class IPQCWorkInfo(models.Model):
    
#     SHIFT_CHOICES = [
#         ('Day', 'Day'),
#         ('Night', 'Night'),
#     ]
    
#     date = models.DateField()
#     shift = models.CharField(max_length=20, choices=SHIFT_CHOICES)
#     emp_id = models.CharField(max_length=20)
#     name = models.CharField(max_length=100)
#     section = models.CharField(max_length=50)
#     line = models.CharField(max_length=20)
#     group = models.CharField(max_length=20)
#     model = models.CharField(max_length=50)
#     color = models.CharField(max_length=50)
#     created_at = models.DateTimeField(default=timezone.now)

#     def __str__(self):
#         return f"{self.date} - {self.emp_id} - {self.model}"
    
#     def save(self, *args, **kwargs):
#         if not self.created_at:
#             self.created_at = timezone.now()
#         super().save(*args, **kwargs)

class IPQCWorkInfo(models.Model):
    
    SHIFT_CHOICES = [
        ('Day', 'Day'),
        ('Night', 'Night'),
    ]
    
    SECTION_CHOICES = [
        ('Assembly', 'Assembly'),
        ('NT', 'NT'),
        ('SMT', 'SMT'),
    ]
    
    emp_id = models.CharField(max_length=20, null=True, blank=True)
    name = models.CharField(max_length=100, null=True, blank=True)
    date = models.DateField()
    shift = models.CharField(max_length=20)
    section = models.CharField(max_length=50)
    line = models.CharField(max_length=50)
    group = models.CharField(max_length=50)
    model = models.CharField(max_length=100)
    color = models.CharField(max_length=50)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.date} - {self.emp_id} - {self.model})"
        
        
        
        
FIELD_TYPES = [
    ('text', 'Text'),
    ('number', 'Number'),
    ('date', 'Date'),
    ('select', 'Select'),
    ('checkbox', 'Checkbox'),
]

class DynamicForm(models.Model):
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True, null=True)
    lark_bitable_table_id = models.CharField(max_length=200)  # Table ID to sync
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title


class DynamicFormField(models.Model):
    form = models.ForeignKey(DynamicForm, on_delete=models.CASCADE, related_name="fields")
    label = models.CharField(max_length=200)
    field_type = models.CharField(max_length=20, choices=FIELD_TYPES)
    required = models.BooleanField(default=True)
    options = models.TextField(blank=True, null=True)  # comma separated for select fields
    order = models.PositiveIntegerField(default=0)

    class Meta:
        ordering = ['order']

    def __str__(self):
        return f"{self.form.title} - {self.label}"


class DynamicFormSubmission(models.Model):
    form = models.ForeignKey(DynamicForm, on_delete=models.CASCADE)
    submitted_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    data = models.JSONField()  # store submitted values
    created_at = models.DateTimeField(auto_now_add=True)

# Define the choices for the audit fields
AUDIT_CHOICES = [
    ('OK', 'OK'),
    ('NOT_OK', 'Not OK'),
    ('NA', 'NA'),
]
 
class  IPQCAssemblyAudit(models. Model):
    # Basic Info
    date = models. DateField(default=timezone.now, verbose_name="Date")
    shift = models. CharField(max_length=50, verbose_name="Shift", blank=True, null=True)
    name = models. CharField(max_length=100, verbose_name="IPQC Name", blank=True, null=True)
    emp_id = models. CharField(max_length=50, verbose_name="Employee ID", blank=True, null=True)
    section = models. CharField(max_length=100, verbose_name="Section", blank=True, null=True)
    group = models. CharField(max_length=100, verbose_name="Group", blank=True, null=True)
    line = models. CharField(max_length=100, verbose_name="Line", blank=True, null=True)
    model = models. CharField(max_length=100, verbose_name="Model", blank=True, null=True)
    color = models. CharField(max_length=50, default="Unknown", verbose_name="Colour", blank=True, null=True)
    created_at = models. DateTimeField(auto_now_add=True)

    # MACHINE
    mach_epa_check = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify EPA complianceâ€”antistatic gear and proper grounding.")
    mach_screw_torque = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check screwdriver torque (<0.9 kgf/cmÂ²) per SOP.")
    mach_sholdering_temp = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check soldering temp per SOP.")
    mach_light = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Ensure CTQ light level 800â€“1200 Lux.")
    mach_fixture_clean = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Fixtures/machines clean and free from dirt; verify 5 samples visually.")
    mach_jig_label = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Jig label matches model; maintenance label valid.")
    mach_teflon = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Teflon on fixture not raised, creased, or damaged.")
    mach_press_params = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Pressing pressure/time within limit.")
    mach_glue_params = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check glue parameters and alignment per SOP.")
    mach_eq_move_notify = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Report any jig/equipment movement or change to PQE.")
    mach_feeler_gauge = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check feeler gauge twice per shift.")
    mach_hot_cold_press = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify hot/cold press parameters.")
    mach_ion_fan = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Ion fan facing work area, 30â€“40 cm distance.")
    mach_cleanroom_eq = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check cleanroom equipment and checklist compliance.")
    mach_rti_check = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="RTI: Verify QR, SN, and software per BOM.")
    mach_current_test = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Current test parameters match standard; limits OK.")
    mach_pal_qr = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="PAL: Verify QR print, SN match, no duplicates.")
    mach_auto_screw = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Auto screw: teaching per SOP; no loose/missing screws (5 pcs/hr).")

    # MATERIAL
    mat_key_check = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check key materials every 2 hrs (Mainboard, LCM, FPC, etc.); all others once per shift.")
    mat_special_stop = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify stopped/suspended materials (date code, batch, supplier) are not in use.")
    mat_improved_monitor = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Monitor use of improved/deviation materials per document and inform PQE.")
    mat_result_check = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check assembly resultsâ€”no shift, lift, missing or loose screws (5 pcs/sample).")
    mat_battery_issue = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="If battery leaks, smokes, or burnsâ€”inform PQE immediately.")
    mat_ipa_check = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify IPA use per SOP (0.5 ml for battery/PCBA); container labeled.")
    mat_thermal_gel = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check thermal gel weight, position, and route per model/SOP.")
    mat_verification = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify materials match BOM/SOP and correct quantity/location used.")

    # METHOD
    meth_sop_seq = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify SOP sequence, process completeness, and tool availability.")
    meth_distance_sensor = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check distance sensor jig height = 2.25 cm Â± tolerance.")
    meth_rear_camera = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check rear camera seal/cushion after battery cover and TRC repair.")
    meth_material_handling = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify material handling, storage, and stacking per document.")
    meth_guideline_doc = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Ensure valid SOP/OPL displayed; remove expired or unused documents.")
    meth_operation_doc = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Follow only approved documents; no verbal or unauthorized changes.")
    meth_defective_feedback = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Report defects to PQE; supervise segregation and rework as required.")
    meth_line_record = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify line reports/checksheets are properly filled and equipment OK.")
    meth_no_self_repair = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="No self-repair or fixture modification by production staff.")
    meth_battery_fix = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check inbuilt battery fixed properly before cover installation.")
    meth_line_change = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="For line/model change, verify all materials within 3 hrs; clear old stock.")
    meth_trail_run = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="During trial/new line start, monitor 4M1E, fill readiness sheet, and check 5 pcs.")
    meth_dummy_conduct = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Conduct dummy checks for key stages, new changes, or top defects daily.")

    # ENVIRONMENT
    env_prod_monitor = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check temp (16â€“28Â°C), humidity (45â€“75%), and environment twice per shift per spec.")
    env_5s = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify 5S compliance (Sort, Set, Shine, Standardize, Sustain) in assembly area.")

    # TRC / FAI / DEFECT / SPOT CHECK
    trc_flow_chart = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Ensure flow chart available; verify MES defect entry and 5S at TRC station.")
    fai_check = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Check FAI: function, appearance, material per BOM/SOP, SW version, labels, and tests.")
    defect_monitor = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Verify key station defect records and ensure defect rate within limits.")
    spot_check = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Spot check boards/semi-finished units to confirm MES entry (Online/TRC).")
    auto_screw_sample = models.CharField(max_length=200, blank=True, null=True, choices=AUDIT_CHOICES, verbose_name="Hourly check 4 auto-screw samples before Seg-1/RQC; ensure no dent or mark.")

    # Manual Input Fields
    manufacture = models. CharField(max_length=100, blank=True, null=True)
    work_order = models. CharField(max_length=100, blank=True, null=True)
    brand = models. CharField(max_length=50, blank=True, null=True)
    material_code = models. CharField(max_length=50, blank=True, null=True)
    wo_input_qty = models. IntegerField(blank=True, null=True, verbose_name="WO / Input Qty")
    
    # TOP 3 DEFECTS & REMARKS
    top3_defects = models. CharField(max_length=200, blank=True, null=True, verbose_name="Top 3 defects")
    remarks = models. TextField(blank=True, null=True, verbose_name="Remarks")
    
        # Signatures
    ipqc_sign = models. CharField(max_length=100, blank=True, null=True, verbose_name="IPQC Sign")
    pqe_tl_sign = models. CharField(max_length=100, blank=True, null=True, verbose_name="PQE/TL Sign")
    
    def __str__(self):
        return f"{self.model} - {self.date} - {self.emp_id}"
    
    
    
    
    
class  BTBFitmentChecksheet(models. Model):
    # --- Header Information ---
    date = models.DateField(verbose_name="Date")
    shift = models.CharField(max_length=20, verbose_name="Shift")
    emp_id = models.CharField(max_length=20, verbose_name="Employee ID")
    name = models.CharField(max_length=100, verbose_name="Employee Name")
    line = models.CharField(max_length=20, verbose_name="Line")
    group = models.CharField(max_length=20, verbose_name="Group")
    model = models.CharField(max_length=50, verbose_name="Model")
    color = models.CharField(max_length=50, verbose_name="Colour")
    frequency = models. CharField(max_length=50, default="Per Hour", verbose_name="Frequency")
    created_by = models. ForeignKey(
    settings. AUTH_USER_MODEL, 
    on_delete=models. CASCADE, 
            verbose_name="Submitted By"
        )
    created_at = models. DateTimeField(auto_now_add=True)
    
        # --- Data Grid Fields ---
        
    # CAM BTB
    input_9 = models. IntegerField(default=0, verbose_name="Input - 9:00")
    input_10 = models. IntegerField(default=0, verbose_name="Input - 10:00")
    input_11 = models. IntegerField(default=0, verbose_name="Input - 11:00")
    input_12 = models. IntegerField(default=0, verbose_name="Input - 12:00")
    input_1 = models. IntegerField(default=0, verbose_name="Input - 1:00")
    input_2 = models. IntegerField(default=0, verbose_name="Input - 2:00")
    input_3 = models. IntegerField(default=0, verbose_name="Input - 3:00")
    input_4 = models. IntegerField(default=0, verbose_name="Input - 4:00")
    input_5 = models. IntegerField(default=0, verbose_name="Input - 5:00")
    input_6 = models. IntegerField(default=0, verbose_name="Input - 6:00")
    input_total = models. IntegerField(default=0, verbose_name="Input - Total", editable=False)
    
    
        # CAM BTB
    cam_btb_9 = models. IntegerField(default=0, verbose_name="CAM BTB - 9:00")
    cam_btb_10 = models. IntegerField(default=0, verbose_name="CAM BTB - 10:00")
    cam_btb_11 = models. IntegerField(default=0, verbose_name="CAM BTB - 11:00")
    cam_btb_12 = models. IntegerField(default=0, verbose_name="CAM BTB - 12:00")
    cam_btb_1 = models. IntegerField(default=0, verbose_name="CAM BTB - 1:00")
    cam_btb_2 = models. IntegerField(default=0, verbose_name="CAM BTB - 2:00")
    cam_btb_3 = models. IntegerField(default=0, verbose_name="CAM BTB - 3:00")
    cam_btb_4 = models. IntegerField(default=0, verbose_name="CAM BTB - 4:00")
    cam_btb_5 = models. IntegerField(default=0, verbose_name="CAM BTB - 5:00")
    cam_btb_6 = models. IntegerField(default=0, verbose_name="CAM BTB - 6:00")
    cam_btb_total = models. IntegerField(default=0, verbose_name="CAM BTB - Total", editable=False)
    
        # LCD Fitment
    lcd_fitment_9 = models. IntegerField(default=0, verbose_name="LCD Fitment - 9:00")
    lcd_fitment_10 = models. IntegerField(default=0, verbose_name="LCD Fitment - 10:00")
    lcd_fitment_11 = models. IntegerField(default=0, verbose_name="LCD Fitment - 11:00")
    lcd_fitment_12 = models. IntegerField(default=0, verbose_name="LCD Fitment - 12:00")
    lcd_fitment_1 = models. IntegerField(default=0, verbose_name="LCD Fitment - 1:00")
    lcd_fitment_2 = models. IntegerField(default=0, verbose_name="LCD Fitment - 2:00")
    lcd_fitment_3 = models. IntegerField(default=0, verbose_name="LCD Fitment - 3:00")
    lcd_fitment_4 = models. IntegerField(default=0, verbose_name="LCD Fitment - 4:00")
    lcd_fitment_5 = models. IntegerField(default=0, verbose_name="LCD Fitment - 5:00")
    lcd_fitment_6 = models. IntegerField(default=0, verbose_name="LCD Fitment - 6:00")
    lcd_fitment_total = models. IntegerField(default=0, verbose_name="LCD Fitment - Total", editable=False)
    
        # MAIN FPC
    main_fpc_9 = models. IntegerField(default=0, verbose_name="MAIN FPC - 9:00")
    main_fpc_10 = models. IntegerField(default=0, verbose_name="MAIN FPC - 10:00")
    main_fpc_11 = models. IntegerField(default=0, verbose_name="MAIN FPC - 11:00")
    main_fpc_12 = models. IntegerField(default=0, verbose_name="MAIN FPC - 12:00")
    main_fpc_1 = models. IntegerField(default=0, verbose_name="MAIN FPC - 1:00")
    main_fpc_2 = models. IntegerField(default=0, verbose_name="MAIN FPC - 2:00")
    main_fpc_3 = models. IntegerField(default=0, verbose_name="MAIN FPC - 3:00")
    main_fpc_4 = models. IntegerField(default=0, verbose_name="MAIN FPC - 4:00")
    main_fpc_5 = models. IntegerField(default=0, verbose_name="MAIN FPC - 5:00")
    main_fpc_6 = models. IntegerField(default=0, verbose_name="MAIN FPC - 6:00")
    main_fpc_total = models. IntegerField(default=0, verbose_name="MAIN FPC - Total", editable=False)
        
        # Battery
    battery_9 = models. IntegerField(default=0, verbose_name="Battery - 9:00")
    battery_10 = models. IntegerField(default=0, verbose_name="Battery - 10:00")
    battery_11 = models. IntegerField(default=0, verbose_name="Battery - 11:00")
    battery_12 = models. IntegerField(default=0, verbose_name="Battery - 12:00")
    battery_1 = models. IntegerField(default=0, verbose_name="Battery - 1:00")
    battery_2 = models. IntegerField(default=0, verbose_name="Battery - 2:00")
    battery_3 = models. IntegerField(default=0, verbose_name="Battery - 3:00")
    battery_4 = models. IntegerField(default=0, verbose_name="Battery - 4:00")
    battery_5 = models. IntegerField(default=0, verbose_name="Battery - 5:00")
    battery_6 = models. IntegerField(default=0, verbose_name="Battery - 6:00")
    battery_total = models. IntegerField(default=0, verbose_name="Battery - Total", editable=False)
    
        # Finger Printer
    finger_printer_9 = models. IntegerField(default=0, verbose_name="Finger Printer - 9:00")
    finger_printer_10 = models. IntegerField(default=0, verbose_name="Finger Printer - 10:00")
    finger_printer_11 = models. IntegerField(default=0, verbose_name="Finger Printer - 11:00")
    finger_printer_12 = models. IntegerField(default=0, verbose_name="Finger Printer - 12:00")
    finger_printer_1 = models. IntegerField(default=0, verbose_name="Finger Printer - 1:00")
    finger_printer_2 = models. IntegerField(default=0, verbose_name="Finger Printer - 2:00")
    finger_printer_3 = models. IntegerField(default=0, verbose_name="Finger Printer - 3:00")
    finger_printer_4 = models. IntegerField(default=0, verbose_name="Finger Printer - 4:00")
    finger_printer_5 = models. IntegerField(default=0, verbose_name="Finger Printer - 5:00")
    finger_printer_6 = models. IntegerField(default=0, verbose_name="Finger Printer - 6:00")
    finger_printer_total = models. IntegerField(default=0, verbose_name="Finger Printer - Total", editable=False)
    
        # --- Row Totals (Calculated) ---
    total_9 = models. IntegerField(default=0, verbose_name="Total - 9:00", editable=False)
    total_10 = models. IntegerField(default=0, verbose_name="Total - 10:00", editable=False)
    total_11 = models. IntegerField(default=0, verbose_name="Total - 11:00", editable=False)
    total_12 = models. IntegerField(default=0, verbose_name="Total - 12:00", editable=False)
    total_1 = models. IntegerField(default=0, verbose_name="Total - 1:00", editable=False)
    total_2 = models. IntegerField(default=0, verbose_name="Total - 2:00", editable=False)
    total_3 = models. IntegerField(default=0, verbose_name="Total - 3:00", editable=False)
    total_4 = models. IntegerField(default=0, verbose_name="Total - 4:00", editable=False)
    total_5 = models. IntegerField(default=0, verbose_name="Total - 5:00", editable=False)
    total_6 = models. IntegerField(default=0, verbose_name="Total - 6:00", editable=False)
        
        # --- Grand Total (Calculated) ---
    
    remark_input = models.TextField(blank=True, null=True, verbose_name="Remark - Input")
    remark_cam_btb = models.TextField(blank=True, null=True, verbose_name="Remark - CAM BTB")
    remark_lcd_fitment = models.TextField(blank=True, null=True, verbose_name="Remark - LCD Fitment")
    remark_main_fpc = models.TextField(blank=True, null=True, verbose_name="Remark - MAIN FPC")
    remark_battery = models.TextField(blank=True, null=True, verbose_name="Remark - Battery")
    remark_finger_printer = models.TextField(blank=True, null=True, verbose_name="Remark - Finger Printer")

    grand_total = models. IntegerField(default=0, verbose_name="Grand Total", editable=False)
    
    def __str__(self):
        return f"{self.model} - {self.date}"

    def save(self, *args, **kwargs):
        # Safely convert to int (treat None or '' as 0)
        def safe_int(val):
            try:
                return int(val or 0)
            except (TypeError, ValueError):
                return 0

        # --- Column Totals (Exclude Input) ---
        self.cam_btb_total = sum([safe_int(getattr(self, f'cam_btb_{h}')) for h in [9,10,11,12,1,2,3,4,5,6]])
        self.lcd_fitment_total = sum([safe_int(getattr(self, f'lcd_fitment_{h}')) for h in [9,10,11,12,1,2,3,4,5,6]])
        self.main_fpc_total = sum([safe_int(getattr(self, f'main_fpc_{h}')) for h in [9,10,11,12,1,2,3,4,5,6]])
        self.battery_total = sum([safe_int(getattr(self, f'battery_{h}')) for h in [9,10,11,12,1,2,3,4,5,6]])
        self.finger_printer_total = sum([safe_int(getattr(self, f'finger_printer_{h}')) for h in [9,10,11,12,1,2,3,4,5,6]])

        # --- Input Total (Separate) ---
        self.input_total = sum([safe_int(getattr(self, f'input_{h}')) for h in [9,10,11,12,1,2,3,4,5,6]])

        # --- Row Totals (Sum all defect columns only, exclude input if you want) ---
        for h in [9,10,11,12,1,2,3,4,5,6]:
            setattr(self, f'total_{h}', 
                    safe_int(getattr(self, f'cam_btb_{h}')) 
                + safe_int(getattr(self, f'lcd_fitment_{h}'))
                + safe_int(getattr(self, f'main_fpc_{h}'))
                + safe_int(getattr(self, f'battery_{h}'))
                + safe_int(getattr(self, f'finger_printer_{h}'))
            )

        # --- Grand Total (Exclude Input) ---
        self.grand_total = (
            self.cam_btb_total
            + self.lcd_fitment_total
            + self.main_fpc_total
            + self.battery_total
            + self.finger_printer_total
        )

        super().save(*args, **kwargs)
        
        
class AssDummyTest(models.Model):
    date = models.DateField()
    shift = models.CharField(max_length=50)
    emp_id = models.CharField(max_length=50)
    name = models.CharField(max_length=100)
    area = models.CharField(max_length=100)
    section = models.CharField(max_length=100)        # <-- Must exist
    line = models.CharField(max_length=100)
    group = models.CharField(max_length=100)
    model = models.CharField(max_length=100)
    color = models.CharField(max_length=50)
    test_stage = models.CharField(max_length=100, verbose_name="Test Stage")
    test_item = models.CharField(max_length=200, verbose_name="Test Item")
    operator_name = models.CharField(max_length=100, verbose_name="Operator Name")
    operator_id = models.CharField(max_length=50, verbose_name="Operator ID")
    
    RESULT_CHOICES = [
        ('Pass', 'Pass'),
        ('Fail', 'Fail'),
        ('NA', 'NA'),
    ]
    result = models.CharField(max_length=10, choices=RESULT_CHOICES, verbose_name="Test Result")
    
    cause = models.TextField(blank=True, null=True, verbose_name="Cause of Failure")
    measure = models.TextField(blank=True, null=True, verbose_name="Corrective Measure")
    ll_confirm = models.TextField(verbose_name="Line Leader Confirm")
    remark = models.TextField(blank=True, null=True, verbose_name="Remark")

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.date} - {self.line} - {self.group} - {self.test_item}"
    
    
class IPQCDisassembleCheckList(models.Model):
    
    FORM_CHOICES = [
        ('OK', 'OK'),
        ('Not OK', 'Not OK'),
        ('NA', 'NA'),
    ]

    # --- Work Info ---
    date = models.DateField(verbose_name="Date")
    shift = models.CharField(max_length=10, verbose_name="Shift")
    emp_id = models.CharField(max_length=20, verbose_name="Employee ID")
    name = models.CharField(max_length=100, verbose_name="Employee Name")
    section = models.CharField(max_length=100, verbose_name="Section")
    line = models.CharField(max_length=100, verbose_name="Line")
    group = models.CharField(max_length=100, verbose_name="Group")
    model = models.CharField(max_length=100, verbose_name="Model")
    color = models.CharField(max_length=50, verbose_name="Color")

    # --- Appearance / Assembly Quality ---
    color_match = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Color matches reference or not")
    color_match_photo = models.ImageField(upload_to='ipqc_disassemble/color_match/', blank=True, null=True)

    cam_lens_assembly = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Camera lens assembled correctly")
    cam_lens_cleanliness = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Camera lens clean (no dust/fingerprint)")
    cam_lens_photo = models.ImageField(upload_to='ipqc_disassemble/camera_lens/', blank=True, null=True)

    key_feel = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Key hand feeling OK")
    key_alignment = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Keys aligned and no tilt or gap")
    key_photo = models.ImageField(upload_to='ipqc_disassemble/keys/', blank=True, null=True)

    screw_missing = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="All screws present (no missing)")
    screw_loose = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="No loose screws")
    screw_spec = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Screw specification correct")
    screw_photo = models.ImageField(upload_to='ipqc_disassemble/screw/', blank=True, null=True)

    front_housing_damage = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Front housing damage/scratch/gap or not")
    back_housing_damage = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Back housing damage/scratch/gap or not")
    housing_snap_fit = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Front/back housing snap joints fitted properly")
    housing_photo = models.ImageField(upload_to='ipqc_disassemble/housing/', blank=True, null=True)

    proof_label_position = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Waterproof label positioned correctly")
    proof_label_photo = models.ImageField(upload_to='ipqc_disassemble/proof_label/', blank=True, null=True)

    # --- Assembly as per SOP ---
    tp_sop = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Touch Panel assembled as per SOP")
    mic_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Mic soldering as per SOP")
    led_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="LED soldering as per SOP")
    lcd_stick = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="LCD sticking/soldering as per SOP")
    speaker_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Speaker soldering as per SOP")
    motor_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Motor soldering as per SOP")
    key_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Key soldering as per SOP")
    sim_subboard_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="SIM sub-board soldering as per SOP")
    subboard_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Subboard soldering as per SOP")
    camera_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Camera soldering as per SOP")
    receiver_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Receiver soldering as per SOP")

    # --- Component & Connection Check ---
    coaxial_line = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Coaxial line assembled correctly")
    antenna_shrapnel = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Mainboard antenna shrapnel OK")
    antenna_fpc = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Antenna FPC assembled properly")
    conductive_fabric = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Conductive fabric positioned as per SOP")
    insulation_paste = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Insulation paste positioned correctly")
    ins_paste_cover = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Insulation paste fully covers all pins")

    lcd_fpc_defect = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="LCD FPC indentation/scald or not")
    tp_fpc_defect = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="TP FPC indentation/scald or not")
    key_fpc_solder = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Key FPC soldering OK")
    keypad_defect = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Keypad FPC has no burn/indentation")

    mainboard_component_ok = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Mainboard all components OK")

    solder_splash = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="No solder splash or foreign material inside device")
    foam_stick = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Foam stick positioned correctly")
    cam_glue = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Camera back glue not torn off")
    led_position = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="LED centered correctly")

    # --- Glue / Fixture Validation ---
    jig_fixture_test = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Jig/fixture impression test done & verified glue activation")
    glue_location = models.CharField(max_length=10, choices=FORM_CHOICES, verbose_name="Thermal/battery/deco glue on correct location")
    glue_weight_1 = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True, verbose_name="Measured glue weight pcs 1 (g)")
    glue_weight_2 = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True, verbose_name="Measured glue weight pcs 2 (g)")
    glue_weight_3 = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True, verbose_name="Measured glue weight pcs 3 (g)")

    # --- Validation Photos ---
    assembly_overview_photo = models.ImageField(upload_to='ipqc_disassemble/overview/', blank=True, null=True)
    defect_photo = models.ImageField(upload_to='ipqc_disassemble/defects/', blank=True, null=True)

    # --- IMEI & Remarks ---
    imei1 = models.CharField(max_length=20, blank=True, null=True, verbose_name="IMEI 1")
    imei2 = models.CharField(max_length=20, blank=True, null=True, verbose_name="IMEI 2")
    defect_cause = models.TextField(blank=True, null=True, verbose_name="Defect Cause Analysis / Remark")
    pqe = models.CharField(max_length=100, blank=True, null=True, verbose_name="PQE")
    pe = models.CharField(max_length=100, blank=True, null=True, verbose_name="PE")
    apd_ll = models.CharField(max_length=100, blank=True, null=True, verbose_name="APD LL")

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.date} - {self.model} - {self.name}"

class NCIssueTracking(models.Model):
    # --- Work Info (existing fields) ---
    date = models.DateField(verbose_name="Date")
    shift = models.CharField(max_length=10, verbose_name="Shift")
    emp_id = models.CharField(max_length=20, verbose_name="Employee ID")
    name = models.CharField(max_length=100, verbose_name="Employee Name")
    section = models.CharField(max_length=100, verbose_name="Section")
    line = models.CharField(max_length=100, verbose_name="Line")
    group = models.CharField(max_length=100, verbose_name="Group")
    model = models.CharField(max_length=100, verbose_name="Model")
    color = models.CharField(max_length=50, verbose_name="Color")

    # --- Issue Tracking Fields ---
    stage = models.CharField(max_length=100, verbose_name="Stage")
    time = models.DateTimeField(verbose_name="Time of Issue")  
    issue = models.TextField(verbose_name="Issue")
    three_why = models.TextField(verbose_name="3 Why")
    solution = models.TextField(verbose_name="Solution")
    operator_name = models.CharField(max_length=100, verbose_name="Operator Name")
    operator_id = models.CharField(max_length=50, verbose_name="Operator ID")
    responsible_dept = models.CharField(max_length=100, verbose_name="Responsible Dept.")
    responsible_person = models.CharField(max_length=100, verbose_name="Responsible Person")
    close_time = models.DateTimeField(verbose_name="Close Time", blank=True, null=True)
    status = models.CharField(max_length=50, verbose_name="Status")
    remark = models.TextField(verbose_name="Remark", blank=True, null=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.date} - {self.model} - {self.issue[:20]}"

from django.db import models

AUDIT_CHOICES = [
    ('YES', 'Yes'),
    ('NO', 'No'),
    ('NA', 'Not Applicable'),
]

SHIFT_CHOICES = [
    ('Day', 'Day'),
    ('Night', 'Night'),
]

class ESDComplianceChecklist(models.Model):
    date = models.DateField(verbose_name="Date")
    shift = models.CharField(max_length=10, choices=SHIFT_CHOICES, verbose_name="Shift")
    emp_id = models.CharField(max_length=20, verbose_name="Employee ID")
    name = models.CharField(max_length=100, verbose_name="Employee Name")
    line = models.CharField(max_length=100, verbose_name="Line")
    group = models.CharField(max_length=100, verbose_name="Group")
    model = models.CharField(max_length=100, verbose_name="Model")
    color = models.CharField(max_length=50, verbose_name="Color")

    # --- ESD Compliance Checklist ---

    # 1. Clothing Rules
    epa_clothes = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Enter EPA must wear ESD clothes")
    epa_clothes_photo = models.ImageField(upload_to='esd_audit/clothes/', blank=True, null=True, verbose_name="Photo Evidence - ESD Clothes")

    forbid_wear_out = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Forbid to wear ESD clothes out of workshop")
    no_accessories = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Accessories not allowed on ESD clothes")

    clothes_clean = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="ESD clothes should be clean and tidy")

    collar_cover = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Non-ESD collar not allowed to cover ESD clothes")
    all_buttons_closed = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="All buttons of ESD clothes should be buckled")
    clothes_length = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Non-ESD clothes should not be longer than ESD clothes")
    watch_expose = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Watch or accessories should not be exposed")

    hair_cap = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Hair should not be exposed outside ESD cap")
    hair_cap_photo = models.ImageField(upload_to='esd_audit/haircap/', blank=True, null=True, verbose_name="Photo Evidence - ESD Cap")

    # 2. Wristband and Slipper
    slipper_check = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Daily check ESD slipper")
    wristband_check = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Daily check ESD wrist band")
    pre_line_check = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Before line start, check if wrist band works")
    wrist_touch_skin = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Wrist band should touch skin fully")
    wristband_photo = models.ImageField(upload_to='esd_audit/wristband/', blank=True, null=True, verbose_name="Photo Evidence - Wrist Band Check")

    # 3. Handling Rules
    no_touch_pcba = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Not allowed to touch PCBA/PCB or ESDS without protection")
    alert_plug_out = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Alert should trigger when ESD wristband unplugged")

    # 4. Grounding and Equipment
    trolley_grounding = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="All trolleys should have grounding cable")
    trolley_photo = models.ImageField(upload_to='esd_audit/trolley/', blank=True, null=True, verbose_name="Photo Evidence - Trolley Grounding")

    device_grounded = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="All electronic devices grounded properly")
    grounding_points_tight = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Grounding points tight and secure")

    ion_fan_distance = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Ion fan distance > 30cm from ESDS")
    ion_fan_direction = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Ion fan directed towards ESDS/PCBA")
    ion_fan_photo = models.ImageField(upload_to='esd_audit/ionfan/', blank=True, null=True, verbose_name="Photo Evidence - Ion Fan Setup")

    # 5. Consumables
    gloves_condition = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Gloves/finger coats not broken or dirty")
    mat_grounded = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="ESD mat grounded and within effective date")
    mat_photo = models.ImageField(upload_to='esd_audit/mat/', blank=True, null=True, verbose_name="Photo Evidence - ESD Mat")

    audit_label_valid = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="All ESD audit labels within effective date")

    # 6. Material Handling
    esds_box = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="All ESDS stored in ESD box/transportation box")
    table_no_source = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Working table has no ESD source within 30cm of ESDS/PCBA")
    table_photo = models.ImageField(upload_to='esd_audit/table/', blank=True, null=True, verbose_name="Photo Evidence - Working Table")

    # 7. Tools & Environment
    tools_audit = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Hot air gun and soldering iron audited daily")
    temp_humidity = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Temperature and humidity within SPEC")
    tray_voltage = models.CharField(max_length=10, choices=AUDIT_CHOICES, default='NA', verbose_name="Friction voltage for tray < Â±100V")

    # Environmental readings
    temperature_value = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True, verbose_name="Actual Temperature (Â°C)")
    humidity_value = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True, verbose_name="Actual Humidity (%)")
    tray_voltage_value = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True, verbose_name="Measured Tray Voltage (V)")

    # Remarks and Tracking
    remark = models.TextField(verbose_name="Remarks", blank=True, null=True)
    photo_overview = models.ImageField(upload_to='esd_audit/overview/', blank=True, null=True, verbose_name="Overview Photo for Spot Validation")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.date} - {self.line} - {self.name}"



class DustCountCheck(models.Model):
    date = models.DateField(verbose_name="Date")
    shift = models.CharField(max_length=10, verbose_name="Shift")
    emp_id = models.CharField(max_length=20, verbose_name="Employee ID")
    name = models.CharField(max_length=100, verbose_name="Employee Name")
    line = models.CharField(max_length=100, verbose_name="Line")
    group = models.CharField(max_length=100, verbose_name="Group")
    model = models.CharField(max_length=100, verbose_name="Model")
    color = models.CharField(max_length=50, verbose_name="Color")
    
    # Measurements in particles per cubic meter (or as appropriate)
    micrometer_0_3 = models.PositiveIntegerField(verbose_name="â‰¥0.3 micrometer")
    micrometer_0_5 = models.PositiveIntegerField(verbose_name="â‰¥0.5 micrometer")
    micrometer_1_0 = models.PositiveIntegerField(verbose_name="â‰¥1.0 micrometer")
    
    checked_by = models.CharField(max_length=100, verbose_name="Checked By")
    verified_by = models.CharField(max_length=100, verbose_name="Verified By")
    
    remark = models.TextField(verbose_name="Remarks", blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.date} - Checked: {self.checked_by} - Verified: {self.verified_by}"
    

# --- Choice options ---
FORM_RESULT_CHOICES = [
    ('MEET_REQ', 'Meet Requirement'),
    ('QUALIFIED', 'Qualified'),
    ('UNQUALIFIED', 'Unqualified'),
    ('CONDITIONAL_ACC', 'Conditional Acceptance'),
]

FORM_CHOICES = [
    ('OK', 'OK'),
    ('Not OK', 'Not OK'),
    ('NA', 'Not Applicable'),
]

FORM_APPROVAL = [
    ('APPROVED', 'Approved'),
    ('REJECTED', 'Rejected'),
    ('PENDING', 'Pending'),
]

# First article actual situation choices
FAI_SITUATION_CHOICES = [
    ('NORMAL_WORK_ORDER_PROD', 'Normal work order production'),
    ('CHANGE_LINE', 'Change line'),
    ('MODEL_CHANGE', 'Change model'),
    ('CHANGE_MATERIAL', 'Change color/material/software'),
    ('PROD_RETURN_NORMAL', 'Production return to normal after abnormal'),
    ('SPECIAL_OR_REWORK_ORDER', 'Special or rework order'),
]

def fai_evidence_upload_path(instance, filename):
    """Generate unique path for FAI evidence files"""
    return os.path.join(
        'fai_evidence', 
        f"{instance.id}_{instance.model_color}_{timezone.now().strftime('%Y%m%d')}_{filename}"
    )

class  TestingFirstArticleInspection(models. Model):
    """
    Comprehensive First Article Inspection (FAI) model with all inspection criteria
    and evidence management for visual, functional, and reliability checks.
    """
    
    class Meta: # <--- ONLY ONE Meta class
        db_table = 'ipqc_testing_first_article_inspection'
        verbose_name = "First Article Inspection"
        verbose_name_plural = "First Article Inspections"
        ordering = ['-date', '-created_at']
 
    # --- Core Information ---
    date = models. DateField(verbose_name="Date")
    shift = models. CharField(max_length=10, verbose_name="Shift")
    emp_id = models. CharField(max_length=20, verbose_name="Employee ID")
    name = models. CharField(max_length=100, verbose_name="Employee Name")
    section = models. CharField(max_length=100, verbose_name="Section")
    line = models. CharField(max_length=100, verbose_name="Line")
    group = models. CharField(max_length=100, verbose_name="Group")
    model = models. CharField(max_length=100, verbose_name="Model")
    color = models. CharField(max_length=50, verbose_name="Color")
        
        # --- Production Info ---
    production_work_order_no = models. CharField(max_length=100, verbose_name="Production Work Order No.")
    first_article_type = models. CharField(max_length=100, choices=FAI_SITUATION_CHOICES, verbose_name="First Article Type")
        
        # --- Order & Software Checks ---
    software_ver_check = models. CharField(max_length=20, verbose_name="Check if software version is the latest version")
    android_ver_check = models. CharField(max_length=20, verbose_name="Check if OS version is the latest version")
    memory_inbuilt_check = models. CharField(max_length=20, choices=FORM_CHOICES, verbose_name="Result")
    order_confirm_check = models. CharField(max_length=20, choices=FORM_CHOICES, verbose_name="Confirm if inspection information is consistent with actual shipment requirements")
        
        # --- Labels Checks ---
    label_check = models. CharField(max_length=20, choices=FORM_CHOICES, verbose_name="check with BOM list ,if there's missing, pasted in wrong place etc")
    label_check_evidence = models. ImageField(upload_to='fai/label/', blank=True, null=True, verbose_name="Label Photo")
    label_position_check = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Label position should meet the requirements of the SOP ")
    label_position_check_evidence = models. ImageField(upload_to='fai/label/', blank=True, null=True, verbose_name="Position Photo")
        
        # --- Visual Inspection ---
    visual_inspection_handset = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Visual Handset Appearance Check")
    logo_check = models. TextField(max_length=100, choices=FORM_CHOICES, verbose_name="Logo Check is right or not")
    logo_check_evidence = models. ImageField(upload_to='fai/visual/', blank=True, null=True, verbose_name="Logo Photo")
    assembly_battery_check = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Assembly of battery cover/surface shell/bottom case has no segment difference and is not too tight or loose")
    assembly_battery_check_evidence = models. ImageField(upload_to='fai/visual/', blank=True, null=True, verbose_name="Assembly Photo")
    net_color_check = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Check if there is net cover with the handset and its colour is consistent")
    tp_with_key_check = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Press the top, bottom, left, right, receiver, menu key of TP, check if the TP is defective")
    screw_check = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Check if there's screw missing or untigtened")
        
        # --- Functional Tests ---
    tp_with_charge_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="No TP drift or display abnormality during charger on/off.")
    charge_15min_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Actual 15min Charging Test")
    boot_time_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Boot Bright Screen Time Test (<2s)")
    boot_time_test_evidence = models. ImageField(upload_to='fai/function/', blank=True, null=True, verbose_name="Boot time evidence image")
    init_settings_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Initialization Settings & Function Test")
    buttons_keys_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Buttons/Side Keys Feel Test")
    touch_screen_pen_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Touch Screen Pen/Drift Test")
    calling_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Calling Test (with/without earphone)")
        
        # --- Additional Functions ---
    bluetooth_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Bluetooth Function Test")
    flashlight_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Flashlight/Induction Lamp Test")
    camera_flash_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Photo flash is normal")
    camera_photo_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Front/Rear Camera Photo Test")
    camera_front_test_evidence = models. ImageField(upload_to='fai/camera/', blank=True, null=True, verbose_name="Front Camera Photo Evidence")
    camera_back_test_evidence = models. ImageField(upload_to='fai/camera/', blank=True, null=True, verbose_name="Back Camera Photo Evidence")
    camera_dark_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Camera in Dark Condition Test")
    camera_dark_test_evidence = models. ImageField(upload_to='fai/camera/', blank=True, null=True, verbose_name="Dark Condition Photo")
    camera_long_distance_check = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Long Distance (8W:50cm; 30W:60cm; 200W FF:3m; 500W+:3â€“5m)")
    highlight_defect_check = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="High-Light (800â€“1200Lux) â€“ Check White Screen, Exposure, Distortion")
        
        # --- Multimedia test & Other special function test  ---
    multimedia_play_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Can play MP3, MP4 normally")
    fm_play_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Can search & play FM normally")
    tv_fn_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="TV function is normal")
    taping_fn_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Taping function is normal")
    shaking_screen_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Shaking screen function is normal")
    wifi_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="WIFI function is normal")
    gravity_sensor_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Gravity sensor function is normal")
    light_distance_sensor_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Light sensor, distance sensor function is normal")
    hall_fn_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Hall function is normal")
    qr_scan_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="QR code test, Scane the QR code and check should be same with device SN")
    ram_rom_cap_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="check if T card capacityï¼ŒRAM capacityï¼Œ ROM capacity are normal")
    mode_switch_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Different mode can be switch normally")
    touch_in_dev_opt_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Touch test in Developer options")
    mac_add_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Check MAC address")
    otg_fn_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="OTG function is normal")
        
        # --- Reliability Test ---
    tcard_sim_plug_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="T-Card/SIM Plug/Pull Test (10 cycles)")
    focus_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Auto-focus clarity test at â‰¥10 cm distance")
    front_back_cam_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Front/Back camera photo test (10 shots each)")
    slight_drop_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Slight Drop Test (7 cm, 6 sides Ã— 20 drops = 120; no cover loss, call/power stable, no paint damage)")
    slight_touch_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Charging function & USB port stability test (touch 5Ã—, no charge breaks)")
    coumpling_rf_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="â€œGSM900/1800 power & interference test (CMD55, call/touch/earphone check)")
    power_consumption_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Power Consumption Test (standby, startup, BT, vibration, backlight, MP3/MP4 with dual SIM)")
    high_temp_simul_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="High temperature simulation test: Half-day batches tested by IPQC; issues retested and reported to PQE, who alerts departments and stops the line if needed")
    factory_reset_fn_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Post- factory reset function check â€“ photo, video, BT, download")
    sar_value_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="*SAR value check via #07# and device manual")
    factory_reset_call_noise_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Post- factory reset check Call interface key noise and sound quality test")
    factory_reset_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Test model, select 'factory reset', input '234', click 'ENTER', reset handset and do the visual inspection.")
        
        # --- High Temperature Tests ---
    high_temp_boot_check = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Boot-up test (4Ã— total, 2Ã— with & 2Ã— without battery; check display after high-temp)")
    high_temp_engi_mode_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name=" The engineering model test content completely")
    high_temp_call_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Call function test (dial 198, check connection, receiver & mic sound quality)")
    high_temp_charging_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="Post-chamber charging test (verify charging function & battery display)")
    high_temp_camera_test = models. CharField(max_length=100, choices=FORM_CHOICES, verbose_name="High Temp Camera Test: Camera function test (front/rear preview, capture, flash, album browse & delete)")
    high_temp_camera_test_evidence = models. ImageField(upload_to='fai/temp/', blank=True, null=True, verbose_name="Camera Test Photo")
        
        # --- Final Results ---
    shutdown_test = models. CharField(max_length=100, verbose_name="Check if it shutdown under user guide interface after production line restore factory settings ")
    sample_serial_number = models. CharField(max_length=100, verbose_name="Sample Serial Number")
    imei_number = models. CharField(max_length=100, verbose_name="IMEI Number")
    imei_photo = models. ImageField(upload_to='fai/sample/', blank=True, null=True, verbose_name="IMEI Verification Photo")
    visual_functional_result = models. CharField(max_length=30, choices=FORM_RESULT_CHOICES, verbose_name="Visual & Functional Test Result")
    reliability_result = models. CharField(max_length=30, choices=FORM_RESULT_CHOICES, verbose_name="Reliability Test Result")
    inspector_name = models. CharField(max_length=100, blank=True, null=True, verbose_name="Inspector Name")
    qe_confirm_name = models. CharField(max_length=100, blank=True, null=True, verbose_name="QE Confirm Name")
    qe_confirm_status = models. CharField(max_length=100, choices=FORM_APPROVAL, blank=True, null=True, verbose_name="QE Confirm Status")
    
    public_token = models. UUIDField(default=uuid.uuid4, unique=True, editable=False)
    public_url = models. URLField(max_length=255, null=True, blank=True)
    remarks = models. TextField(blank=True, null=True, verbose_name="Remarks")
    created_at = models. DateTimeField(auto_now_add=True)
    updated_at = models. DateTimeField(auto_now=True)
 
    def __str__(self):
        return f"FAI: {self.date} - {self.emp_id} - {self.model}"
    
    def get_public_url(self, request=None):
        """Generates the absolute public URL for QE confirmation."""
        from django.urls import reverse
        # Use the public update URL name
        path = reverse('testing_fai_public_update', args=[str(self.public_token)])
        return request.build_absolute_uri(path) if request else path

class OperatorQualificationCheck(models.Model):
    JOB_CARD_STATUS = [
        ('Have', 'Have'),
        ('Not Have', 'NO'),
        ('NA', 'Not Applicable'),
    ]
    TRAINING_STATUS = [
        ('Done', 'Done'),
        ('Pending', 'Pending'),
        ('NA', 'Not Applicable'),
    ]
    OPERATOR_STATUS = [
        ('Old', 'Old'),
        ('New', 'New'),
        ('Rotating', 'Rotating'),
    ]
    PQE_INFO_STATUS = [
        ('Training Pending', 'Training Pending'),
        ('Already Done', 'Already Done'),
        ('Replace Operator', 'Replace Operator'),
    ]
    PQE_TRAINING_STATUS = [
        ('Done', 'Done'),
        ('Training Pending', 'Training Pending'),
        ('Already Done', 'Already Done'),
        ('Replace Operator', 'Replace Operator'),
    ]
    OPERATOR_QUALIFICATION = [
        ('Trained', 'Trained'),
        ('Not Trained', 'Not Trained'),
        ('Replace Operator', 'Replace Operator'),
    ]
    
    # Basic Information
    emp_id = models.CharField(max_length=20, null=True, blank=True)
    name = models.CharField(max_length=100, null=True, blank=True)
    date = models.DateField()
    shift = models.CharField(max_length=20)
    section = models.CharField(max_length=50)
    line = models.CharField(max_length=50)
    group = models.CharField(max_length=50)
    model = models.CharField(max_length=100)
    color = models.CharField(max_length=50)
    
    # Job Card Scanning
    key_station_name = models.TextField(verbose_name="Select/Write the key station Name")
    key_station_job_card_status = models.CharField(max_length=50, choices=JOB_CARD_STATUS, verbose_name="Check whether the key station operator has a job card, if not, it is considered a new operator")
    scanned_barcode_image = models.ImageField(upload_to='ipqc/manpower/barcode_scans/', blank=True, null=True, verbose_name="Optional scan snapshot (image)", help_text="Image captured during scanning, optional")
    scanned_barcode_text = models.URLField(max_length=500, blank=True, null=True, verbose_name="Scanned Job Card URL", help_text="Auto-filled from barcode scan")
    
    # Verification Fields
    key_station_operator_status = models.CharField(max_length=50, choices=OPERATOR_STATUS, verbose_name="Select Key station operator status: old/new/rotating operator")
    new_or_rotating_operator_status = models.CharField(max_length=50, choices=PQE_INFO_STATUS, verbose_name="IPQC monitoring for new or rotating operators at specific stations (e.g., BTB, TRC)")
    check_operator_work_instruction = models.CharField(max_length=50, choices=OPERATOR_QUALIFICATION, verbose_name="Check whether the operator has a work instruction, if not, it is considered a new operator, and the PQE should be notified for training")
    operator_job_card_image = models.ImageField(upload_to='ipqc/manpower/jobcard/', blank=True, null=True, verbose_name="Upload operator job card image for record")
    pqe_training_and_verification_status = models.CharField(max_length=50, choices=PQE_TRAINING_STATUS, verbose_name="Summary: PQE training and verification process (5 cycles, 5 samples, Dummy test)")
    job_card_verification_summary = models.TextField(verbose_name="Summary: Verify operator job card; if missing, monitor and perform Dummy test")

    created_at = models.DateTimeField(auto_now_add=True)
    feishu_record_data = models.JSONField(blank=True, null=True, verbose_name="Feishu Record Data")
    
    class Meta:
        verbose_name = "Operator Qualification Procedure"
        verbose_name_plural = "Operator Qualification Procedures"
        ordering = ["-created_at"]

    def __str__(self):
        return f"{self.date} - {self.emp_id} - {self.model}"









from django.db.models.signals import post_save
from django.dispatch import receiver
from .services import sync_btb_fitment_to_bitable, sync_dummy_test_to_bitable, sync_dessembly_checklist_to_bitable, sync_ipqc_assembly_audit_to_bitable, sync_nc_issue_tracking_to_bitable, sync_esd_compliance_to_bitable, sync_dust_measurement_to_bitable, sync_testing_fai_to_bitable, update_testing_fai_in_bitable

@receiver(post_save, sender=BTBFitmentChecksheet)
def sync_to_bitable_after_save(sender, instance, created, **kwargs):
    if created:
        sync_btb_fitment_to_bitable(instance)
           
@receiver(post_save, sender=AssDummyTest)
def sync_to_bitable_after_save(sender, instance, created, **kwargs):
    if created:
        sync_dummy_test_to_bitable(instance)
        
@receiver(post_save, sender=IPQCDisassembleCheckList)
def sync_to_bitable_after_save(sender, instance, created, **kwargs):
    if created:
        sync_dessembly_checklist_to_bitable(instance)

@receiver(post_save, sender=IPQCAssemblyAudit)
def sync_to_bitable_after_save(sender, instance, created, **kwargs):
    if created:
        sync_ipqc_assembly_audit_to_bitable(instance)

@receiver(post_save, sender=NCIssueTracking)
def sync_to_bitable_after_save(sender, instance, created, **kwargs):
    if created:
        sync_nc_issue_tracking_to_bitable(instance)

@receiver(post_save, sender=ESDComplianceChecklist)
def sync_to_bitable_after_save(sender, instance, created, **kwargs):
    if created:
        sync_esd_compliance_to_bitable(instance)

@receiver(post_save, sender=DustCountCheck)
def sync_to_bitable_after_save(sender, instance, created, **kwargs):
    if created:
        sync_dust_measurement_to_bitable(instance)
        
@receiver(post_save, sender=TestingFirstArticleInspection)
def sync_to_bitable_after_save(sender, instance, created, **kwargs):
    """Sync to Lark Bitable after save"""
    if created:
        # Create new record in Bitable when a new FAI record is created
        sync_testing_fai_to_bitable(instance)
    else:
        # Update existing record when QE updates public fields
        update_testing_fai_in_bitable(instance)
        
        
        
        



transs_flow/ipqc/services.py:

import requests
from datetime import datetime
import pytz
from django.conf import settings

def get_lark_access_token():
    """Get Lark access token"""
    url = "https://open.larkoffice.com/open-apis/auth/v3/tenant_access_token/internal/"
    headers = {"Content-Type": "application/json"}
    data = {
        "app_id": getattr(settings, "LARK_APP_ID", None),
        "app_secret": getattr(settings, "LARK_APP_SECRET", None)
    }

    try:
        response = requests.post(url, headers=headers, json=data)
        response.raise_for_status()
        json_data = response.json()
        # print("ðŸª¶ Access token response:", json_data)
        return json_data.get("tenant_access_token")
    except Exception as e:
        print("âŒ Token error:", e)
        return None


def date_to_ms(date_obj):
    """Convert datetime.date or ISO date string to milliseconds since epoch (IST)"""
    ist = pytz.timezone('Asia/Kolkata')

    if isinstance(date_obj, str):
        # Convert ISO string to date object
        date_obj = datetime.strptime(date_obj, "%Y-%m-%d").date()

    ist_datetime = ist.localize(datetime.combine(date_obj, datetime.min.time()))
    return int(ist_datetime.timestamp() * 1000)


# def write_to_bitable(work_info):
#     """Write work info to Lark Bitable"""
#     token = get_lark_access_token()
#     if not token:
#         print("âŒ No token received")
#         return False, "Failed to get Lark access token"

#     url = (
#         f"https://open.larkoffice.com/open-apis/bitable/v1/apps/"
#         f"{getattr(settings, 'LARK_BITABLE_APP_TOKEN_QA')}/tables/"
#         f"{getattr(settings, 'LARK_TABLE_IPQC_WORK_INFO')}/records"
#     )

#     headers = {
#         "Authorization": f"Bearer {token}",
#         "Content-Type": "application/json"
#     }

#     data = {
#         "fields": {
#             "Date": date_to_ms(work_info.date),
#             "Shift": work_info.shift,
#             "Emp_ID": work_info.emp_id,
#             "Name": work_info.name,
#             "Section": work_info.section,
#             "Line": work_info.line,
#             "Group": work_info.group,
#             "Model": work_info.model,
#             "Color": work_info.color,
#         }
#     }

#     # print("ðŸ“¤ Sending to Lark Bitable:", data)

#     try:
#         response = requests.post(url, headers=headers, json=data)
#         resp_json = response.json()
#         # print("ðŸ“¥ Response from Lark:", resp_json)

#         if response.status_code == 200 and resp_json.get("code") == 0:
#             return True, "Successfully synced to Lark Bitable"

#         return False, resp_json.get("msg", response.text)
#     except Exception as e:
#         # print("âŒ Exception:", e)
#         return False, f"Error syncing to Lark Bitable: {str(e)}"


def write_to_bitable(work_info):
    """Write work info to Lark Bitable"""
    token = get_lark_access_token()
    if not token:
        return False, "Failed to get Lark access token"

    url = (
        f"https://open.larkoffice.com/open-apis/bitable/v1/apps/"
        f"{getattr(settings, 'LARK_BITABLE_APP_TOKEN_QA')}/tables/"
        f"{getattr(settings, 'LARK_TABLE_IPQC_WORK_INFO')}/records"
    )

    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    data = {
        "fields": {
            "Date": date_to_ms(work_info.date),
            "Shift": work_info.shift,
            "Emp_ID": work_info.emp_id,
            "Name": work_info.name,
            "Section": work_info.section,
            "Line": work_info.line,
            "Group": work_info.group,
            "Model": work_info.model,
            "Color": work_info.color,
        }
    }

    try:
        response = requests.post(url, headers=headers, json=data)
        resp_json = response.json()

        if response.status_code == 200 and resp_json.get("code") == 0:
            return True, "Successfully synced to Lark Bitable"
        return False, resp_json.get("msg", response.text)
    except Exception as e:
        return False, f"Error syncing to Lark Bitable: {str(e)}"



def write_to_bitable_dynamic(table_id, data):
    """Write any model data to Lark Bitable table"""
    token = get_lark_access_token()
    if not token:
        return False, "Failed to get Lark access token"

    url = (
        f"https://open.larkoffice.com/open-apis/bitable/v1/apps/"
        f"{getattr(settings, 'LARK_BITABLE_APP_TOKEN_QA')}/tables/{table_id}/records"
    )

    # Convert datetime fields to ms
    for key, value in data.items():
        if isinstance(value, datetime):
            ist = pytz.timezone('Asia/Kolkata')
            # Only localize naive datetimes
            if value.tzinfo is None:
                value = ist.localize(value)
            data[key] = int(value.timestamp() * 1000)

    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    payload = {"fields": data}

    try:
        response = requests.post(url, headers=headers, json=payload)
        resp_json = response.json()
        if response.status_code == 200 and resp_json.get("code") == 0:
            return True, "Successfully synced to Lark Bitable"
        return False, resp_json.get("msg", response.text)
    except Exception as e:
        return False, f"Error syncing to Lark Bitable: {str(e)}"
    
    
    

def safe_int(val):
    """Convert value to integer safely."""
    try:
        return int(val or 0)
    except (TypeError, ValueError):
        return 0

def sync_btb_fitment_to_bitable(instance):
    """
    Sync a single BTB Fitment Checksheet record to Lark Bitable.
    """
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping Bitable sync.")
        return False, "No access token"

    table_id = getattr(settings, "LARK_TABLE_BTB_FITMENT_CHECKSHEET", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False, "Table ID missing"

    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{settings.LARK_BITABLE_APP_TOKEN_QA}/tables/{table_id}/records"

    # Build fields dict
    fields = {
        # Text fields
        "Date": date_to_ms(instance.date),
        "Shift": instance.shift or "",
        "Employee ID": instance.emp_id or "",
        "Employee Name": instance.name or "",
        "Line": instance.line or "",
        "Group": instance.group or "",
        "Model": instance.model or "",
        "Colour": instance.color or "",
        "Frequency": instance.frequency or "",
        "Submitted By": instance.name or "",
        "Created At": date_to_ms(instance.created_at),

        # Numeric fields
        "Input - 9:00": safe_int(instance.input_9),
        "Input - 10:00": safe_int(instance.input_10),
        "Input - 11:00": safe_int(instance.input_11),
        "Input - 12:00": safe_int(instance.input_12),
        "Input - 1:00": safe_int(instance.input_1),
        "Input - 2:00": safe_int(instance.input_2),
        "Input - 3:00": safe_int(instance.input_3),
        "Input - 4:00": safe_int(instance.input_4),
        "Input - 5:00": safe_int(instance.input_5),
        "Input - 6:00": safe_int(instance.input_6),
        "Input - Total": safe_int(instance.input_total),

        "CAM BTB - 9:00": safe_int(instance.cam_btb_9),
        "CAM BTB - 10:00": safe_int(instance.cam_btb_10),
        "CAM BTB - 11:00": safe_int(instance.cam_btb_11),
        "CAM BTB - 12:00": safe_int(instance.cam_btb_12),
        "CAM BTB - 1:00": safe_int(instance.cam_btb_1),
        "CAM BTB - 2:00": safe_int(instance.cam_btb_2),
        "CAM BTB - 3:00": safe_int(instance.cam_btb_3),
        "CAM BTB - 4:00": safe_int(instance.cam_btb_4),
        "CAM BTB - 5:00": safe_int(instance.cam_btb_5),
        "CAM BTB - 6:00": safe_int(instance.cam_btb_6),
        "CAM BTB - Total": safe_int(instance.cam_btb_total),

        "LCD Fitment - 9:00": safe_int(instance.lcd_fitment_9),
        "LCD Fitment - 10:00": safe_int(instance.lcd_fitment_10),
        "LCD Fitment - 11:00": safe_int(instance.lcd_fitment_11),
        "LCD Fitment - 12:00": safe_int(instance.lcd_fitment_12),
        "LCD Fitment - 1:00": safe_int(instance.lcd_fitment_1),
        "LCD Fitment - 2:00": safe_int(instance.lcd_fitment_2),
        "LCD Fitment - 3:00": safe_int(instance.lcd_fitment_3),
        "LCD Fitment - 4:00": safe_int(instance.lcd_fitment_4),
        "LCD Fitment - 5:00": safe_int(instance.lcd_fitment_5),
        "LCD Fitment - 6:00": safe_int(instance.lcd_fitment_6),
        "LCD Fitment - Total": safe_int(instance.lcd_fitment_total),

        "MAIN FPC - 9:00": safe_int(instance.main_fpc_9),
        "MAIN FPC - 10:00": safe_int(instance.main_fpc_10),
        "MAIN FPC - 11:00": safe_int(instance.main_fpc_11),
        "MAIN FPC - 12:00": safe_int(instance.main_fpc_12),
        "MAIN FPC - 1:00": safe_int(instance.main_fpc_1),
        "MAIN FPC - 2:00": safe_int(instance.main_fpc_2),
        "MAIN FPC - 3:00": safe_int(instance.main_fpc_3),
        "MAIN FPC - 4:00": safe_int(instance.main_fpc_4),
        "MAIN FPC - 5:00": safe_int(instance.main_fpc_5),
        "MAIN FPC - 6:00": safe_int(instance.main_fpc_6),
        "MAIN FPC - Total": safe_int(instance.main_fpc_total),

        "Battery - 9:00": safe_int(instance.battery_9),
        "Battery - 10:00": safe_int(instance.battery_10),
        "Battery - 11:00": safe_int(instance.battery_11),
        "Battery - 12:00": safe_int(instance.battery_12),
        "Battery - 1:00": safe_int(instance.battery_1),
        "Battery - 2:00": safe_int(instance.battery_2),
        "Battery - 3:00": safe_int(instance.battery_3),
        "Battery - 4:00": safe_int(instance.battery_4),
        "Battery - 5:00": safe_int(instance.battery_5),
        "Battery - 6:00": safe_int(instance.battery_6),
        "Battery - Total": safe_int(instance.battery_total),

        "Finger Printer - 9:00": safe_int(instance.finger_printer_9),
        "Finger Printer - 10:00": safe_int(instance.finger_printer_10),
        "Finger Printer - 11:00": safe_int(instance.finger_printer_11),
        "Finger Printer - 12:00": safe_int(instance.finger_printer_12),
        "Finger Printer - 1:00": safe_int(instance.finger_printer_1),
        "Finger Printer - 2:00": safe_int(instance.finger_printer_2),
        "Finger Printer - 3:00": safe_int(instance.finger_printer_3),
        "Finger Printer - 4:00": safe_int(instance.finger_printer_4),
        "Finger Printer - 5:00": safe_int(instance.finger_printer_5),
        "Finger Printer - 6:00": safe_int(instance.finger_printer_6),
        "Finger Printer - Total": safe_int(instance.finger_printer_total),

        "Total - 9:00": safe_int(instance.total_9),
        "Total - 10:00": safe_int(instance.total_10),
        "Total - 11:00": safe_int(instance.total_11),
        "Total - 12:00": safe_int(instance.total_12),
        "Total - 1:00": safe_int(instance.total_1),
        "Total - 2:00": safe_int(instance.total_2),
        "Total - 3:00": safe_int(instance.total_3),
        "Total - 4:00": safe_int(instance.total_4),
        "Total - 5:00": safe_int(instance.total_5),
        "Total - 6:00": safe_int(instance.total_6),

        # Remarks (Text)
        "Remark - Input": instance.remark_input or "",
        "Remark - CAM BTB": instance.remark_cam_btb or "",
        "Remark - LCD Fitment": instance.remark_lcd_fitment or "",
        "Remark - MAIN FPC": instance.remark_main_fpc or "",
        "Remark - Battery": instance.remark_battery or "",
        "Remark - Finger Printer": instance.remark_finger_printer or "",

        # Grand Total (Text)
        "Grand Total": instance.grand_total,
    }

    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    try:
        response = requests.post(url, headers=headers, json={"fields": fields})
        resp_json = response.json()
        if response.status_code == 200 and resp_json.get("code") == 0:
            print(f"âœ… Record synced successfully: {resp_json.get('data', {}).get('record_id')}")
            return True, "Synced successfully"
        else:
            print("âŒ Bitable sync failed:", resp_json)
            return False, resp_json
    except Exception as e:
        print("âŒ Exception syncing to Bitable:", str(e))
        return False, str(e)
    
    
def sync_dummy_test_to_bitable(instance):
    """
    Sync a single BTB Fitment Checksheet record to Lark Bitable.
    """
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping Bitable sync.")
        return False, "No access token"

    table_id = getattr(settings, "LARK_TABLE_BUMMY_CHECKSHEET", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False, "Table ID missing"

    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{settings.LARK_BITABLE_APP_TOKEN_QA}/tables/{table_id}/records"

    # Build fields dict
    fields = {
        # Text / Boolean fields
        "Date": date_to_ms(instance.date),
        "Shift": instance.shift or "",
        "Emp ID": instance.emp_id or "",
        "Name": instance.name or "",
        "Area": instance.area or "",
        "Section": instance.section or "",
        "Line": instance.line or "",
        "Group": instance.group or "",
        "Model": instance.model or "",
        "Color": instance.color or "",
        "Test Stage": instance.test_stage or "",
        "Test Item": instance.test_item or "",
        "Operator Name": instance.operator_name or "",
        "Operator ID": instance.operator_id or "",
        "Result": instance.result or "",
        "Cause": instance.cause or "",
        "Measure": instance.measure or "",
        "LL Confirm": "Yes" if instance.ll_confirm else "No",  # âœ… Convert boolean to string
        "Remark": instance.remark or "",
        "Created At": date_to_ms(instance.created_at),
        "Updated At": date_to_ms(instance.updated_at),
    }
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    try:
        response = requests.post(url, headers=headers, json={"fields": fields})
        resp_json = response.json()
        if response.status_code == 200 and resp_json.get("code") == 0:
            print(f"âœ… Record synced successfully: {resp_json.get('data', {}).get('record_id')}")
            return True, "Synced successfully"
        else:
            print("âŒ Bitable sync failed:", resp_json)
            return False, resp_json
    except Exception as e:
        print("âŒ Exception syncing to Bitable:", str(e))
        return False, str(e)
    
    
def sync_dessembly_checklist_to_bitable(instance):
    """
    Sync a single BTB Fitment Checksheet record to Lark Bitable.
    """
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping Bitable sync.")
        return False, "No access token"

    table_id = getattr(settings, "LARK_TABLE_DESSEMBLE_CHECKLIST", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False, "Table ID missing"

    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{settings.LARK_BITABLE_APP_TOKEN_QA}/tables/{table_id}/records"

    # Build fields dict
    fields = {
        # Work Info
        "Date": date_to_ms(instance.date),
        "Shift": instance.shift or "",
        "Employee ID": instance.emp_id or "",
        "Employee Name": instance.name or "",
        "Section": instance.section or "",
        "Line": instance.line or "",
        "Group": instance.group or "",
        "Model": instance.model or "",
        "Color": instance.color or "",

        # Test Fields (OK / Not OK / NA)
        "Colour Match": instance.color_match or "",
        "TP SOP": instance.tp_sop or "",
        "Camera Lens": instance.cam_lens or "",
        "Key Feel": instance.key_feel or "",
        "Screw Check": instance.screw_check or "",
        "Front Housing": instance.front_housing or "",
        "Back Housing": instance.back_housing or "",
        "Proof Label": instance.proof_label or "",
        "Mic SOP": instance.mic_sop or "",
        "LED SOP": instance.led_sop or "",
        "Coaxial Line": instance.coaxial or "",
        "LCD SOP": instance.lcd_sop or "",
        "Speaker SOP": instance.speaker_sop or "",
        "Motor SOP": instance.motor_sop or "",
        "Key SOP": instance.key_sop or "",
        "SIM Subboard": instance.sim_subboard or "",
        "Subboard SOP": instance.subboard_sop or "",
        "Antenna Shrapnel": instance.antenna_shrapnel or "",
        "Conductive Fabric": instance.conductive_fabric or "",
        "Insulation Paste": instance.insulation_paste or "",
        "Camera SOP": instance.camera_sop or "",
        "Mainboard OK": instance.mainboard_ok or "",
        "Antenna FPC": instance.antenna_fpc or "",
        "Front Accessory": instance.front_acc or "",
        "LCD Fabric": instance.lcd_fabric or "",
        "Receiver SOP": instance.receiver_sop or "",
        "LCD FPC Defect": instance.lcd_fpc_defect or "",
        "TP FPC Defect": instance.tp_fpc_defect or "",
        "Key FPC Solder": instance.key_fpc_solder or "",
        "Keypad Defect": instance.keypad_defect or "",
        "Solder Splash": instance.solder_splash or "",
        "Foam Stick": instance.foam_stick or "",
        "Camera Glue": instance.cam_glue or "",
        "Paste Cover": instance.ins_paste_cover or "",
        "LED Position": instance.led_position or "",
        "Jig/Fixture Test": instance.jig_fixture_test or "",
        "Glue Location": instance.glue_location or "",

        # IMEI & Remarks
        "IMEI 1": instance.imei1 or "",
        "IMEI 2": instance.imei2 or "",
        "Defect cause analysis": instance.defect_cause or "",
        "PQE": instance.pqe or "",
        "PE": instance.pe or "",
        "APD LL": instance.apd_ll or "",

        # System Fields
        "Created At": date_to_ms(instance.created_at),
        "Updated At": date_to_ms(instance.updated_at),
    }
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    try:
        response = requests.post(url, headers=headers, json={"fields": fields})
        resp_json = response.json()
        if response.status_code == 200 and resp_json.get("code") == 0:
            print(f"âœ… Record synced successfully: {resp_json.get('data', {}).get('record_id')}")
            return True, "Synced successfully"
        else:
            print("âŒ Bitable sync failed:", resp_json)
            return False, resp_json
    except Exception as e:
        print("âŒ Exception syncing to Bitable:", str(e))
        return False, str(e)
    
    
    
def sync_ipqc_assembly_audit_to_bitable(instance):
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping sync.")
        return False, "No access token"

    table_id = getattr(settings, "LARK_TABLE_ASSEMBLY_AUDIT", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False, "Table ID missing"

    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{settings.LARK_BITABLE_APP_TOKEN_QA}/tables/{table_id}/records"

    fields = {
        # --- BASIC INFO ---
        "Date": date_to_ms(instance.date),
        "Shift": instance.shift or "",
        "IPQC Name": instance.name or "",
        "Employee ID": instance.emp_id or "",
        "Section": instance.section or "",
        "Group": instance.group or "",
        "Line": instance.line or "",
        "Model": instance.model or "",
        "Colour": instance.color or "",
        "Created At": date_to_ms(instance.created_at),

        # --- MAN ---
        "Job Card Availability": instance.man_job_card or "",
        "BTB Monitoring Guideline": instance.man_btb_mon or "",

        # --- MACHINE ---
        "EPA Check": instance.mach_epa_check or "",
        "Screw Torque": instance.mach_screw_torque or "",
        "Light Illuminance": instance.mach_light or "",
        "Fixture Cleanliness": instance.mach_fixture_clean or "",
        "Jig Label Validity": instance.mach_jig_label or "",
        "Teflon Condition": instance.mach_teflon or "",
        "Press Parameters": instance.mach_press_params or "",
        "Glue Parameters": instance.mach_glue_params or "",
        "Equipment Move Notification": instance.mach_eq_move_notify or "",
        "Feeler Gauge Check": instance.mach_feeler_gauge or "",
        "Hot/Cold Press Parameters": instance.mach_hot_cold_press or "",
        "Ion Fan Position": instance.mach_ion_fan or "",
        "Clean Room Equipment": instance.mach_cleanroom_eq or "",
        "RTI Check": instance.mach_rti_check or "",
        "Current Test Parameters": instance.mach_current_test or "",
        "PAL QR Check": instance.mach_pal_qr or "",
        "Automatic Screwing": instance.mach_auto_screw or "",

        # --- MATERIAL ---
        "Key Material Check": instance.mat_key_check or "",
        "Special Stop Material": instance.mat_special_stop or "",
        "Improved Material Monitor": instance.mat_improved_monitor or "",
        "Material Result Check": instance.mat_result_check or "",
        "Battery Issue Handling": instance.mat_battery_issue or "",
        "IPA Usage Check": instance.mat_ipa_check or "",
        "Thermal Gel Check": instance.mat_thermal_gel or "",
        "Material Verification": instance.mat_verification or "",

        # --- METHOD ---
        "SOP Sequence Verification": instance.meth_sop_seq or "",
        "Distance Sensor Height": instance.meth_distance_sensor or "",
        "Rear Camera Seal Check": instance.meth_rear_camera or "",
        "Material Handling": instance.meth_material_handling or "",
        "Guideline Document": instance.meth_guideline_doc or "",
        "Operation Document": instance.meth_operation_doc or "",
        "Defective Feedback Process": instance.meth_defective_feedback or "",
        "Line Record Verification": instance.meth_line_record or "",
        "No Self Repair": instance.meth_no_self_repair or "",
        "Battery Fix Check": instance.meth_battery_fix or "",
        "Line Change Verification": instance.meth_line_change or "",
        "Trial Run Monitoring": instance.meth_trail_run or "",
        "Dummy Conduct Check": instance.meth_dummy_conduct or "",

        # --- ENVIRONMENT ---
        "Production Environment Monitoring": instance.env_prod_monitor or "",
        "5S Check": instance.env_5s or "",

        # --- TRC / FAI / DEFECT / SPOT CHECK ---
        "TRC Flow Chart": instance.trc_flow_chart or "",
        "FAI Check": instance.fai_check or "",
        "Defect Monitoring": instance.defect_monitor or "",
        "Spot Check": instance.spot_check or "",
        "Auto Screw Sampling": instance.auto_screw_sample or "",

        # --- MANUAL INPUT ---
        "Manufacture": instance.manufacture or "",
        "Work Order": instance.work_order or "",
        "Brand": instance.brand or "",
        "Material Code": instance.material_code or "",
        "WO / Input Qty": instance.wo_input_qty or "",

        # --- TOP 3 DEFECTS & REMARKS ---
        "Top 3 Defects": instance.top3_defects or "",
        "Remarks": instance.remarks or "",

        # --- SIGNATURES ---
        "IPQC Sign": instance.ipqc_sign or "",
        "PQE/TL Sign": instance.pqe_tl_sign or "",
    }

    payload = {"fields": fields}
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    response = requests.post(url, headers=headers, json={"fields": fields})
    res_json = response.json()
    if response.status_code == 200 and res_json.get("code") == 0:
        print("âœ… Synced successfully to Bitable.")
    else:
        print(f"âš ï¸ Sync failed: {res_json}")
        
        
        
def sync_nc_issue_tracking_to_bitable(instance):
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping sync.")
        return False, "No access token"

    table_id = getattr(settings, "LARK_TABLE_NC_ISSUE_TRACKING", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False, "Table ID missing"

    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{settings.LARK_BITABLE_APP_TOKEN_QA}/tables/{table_id}/records"

    fields = {
        # Work Info
        "Date": date_to_ms(instance.date),
        "Shift": instance.shift or "",
        "Employee ID": instance.emp_id or "",
        "Employee Name": instance.name or "",
        "Section": instance.section or "",
        "Line": instance.line or "",
        "Group": instance.group or "",
        "Model": instance.model or "",
        "Color": instance.color or "",

        # Issue Tracking
        "Stage": instance.stage or "",
        "Time": date_to_ms(instance.date),  # timestamp from TimeField
        "Issue": instance.issue or "",
        "3 Why": instance.three_why or "",
        "Solution": instance.solution or "",
        "Operator Name": instance.operator_name or "",
        "Operator ID": instance.operator_id or "",
        "Responsible Dept.": instance.responsible_dept or "",
        "Responsible Person": instance.responsible_person or "",
        "Close Time": date_to_ms(instance.close_time) if instance.close_time else "",
        "Status": instance.status or "",
        "Remark": instance.remark or "",

        # System Fields
        "Created At": date_to_ms(instance.created_at),
        "Updated At": date_to_ms(instance.updated_at),
    }

    payload = {"fields": fields}
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    response = requests.post(url, headers=headers, json={"fields": fields})
    res_json = response.json()
    if response.status_code == 200 and res_json.get("code") == 0:
        print("âœ… Synced successfully to Bitable.")
    else:
        print(f"âš ï¸ Sync failed: {res_json}")
        
def sync_esd_compliance_to_bitable(instance):
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping sync.")
        return False, "No access token"

    table_id = getattr(settings, "LARK_TABLE_ESD_COMPLIANCE", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False, "Table ID missing"

    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{settings.LARK_BITABLE_APP_TOKEN_QA}/tables/{table_id}/records"

    fields = {
        "Date": date_to_ms(instance.date),
        "Shift": instance.shift,
        "Employee ID": instance.emp_id,
        "Name": instance.name,
        "Line": instance.line,
        "Group": instance.group,
        "Model": instance.model,
        "Color": instance.color,
        "EPA Wear ESD Clothes": str(instance.epa_clothes),
        "No ESD Clothes Outside": str(instance.forbid_wear_out),
        "No Accessories on Clothes": str(instance.no_accessories),
        "Clothes Clean & Tidy": str(instance.clothes_clean),
        "Collar & Button Rules": str(instance.collar_rules),
        "Hair Inside Cap": str(instance.hair_cap),
        "Check Slipper & Band": str(instance.slipper_band),
        "Wrist Band Precheck": str(instance.pre_line_check),
        "Wrist Band Touch Skin": str(instance.wrist_touch_skin),
        "No Touch PCBA/ESDS": str(instance.no_touch_pcba),
        "Alert When Plug Out": str(instance.alert_plug_out),
        "Trolley Grounded": str(instance.trolley_grounding),
        "Ion Fan Distance OK": str(instance.ion_fan_distance),
        "Ion Fan Direction OK": str(instance.ion_fan_direction),
        "Audit Label Valid": str(instance.audit_label_valid),
        "Devices Grounded": str(instance.device_grounded),
        "Gloves/Fingers OK": str(instance.gloves_condition),
        "Mat Grounded": str(instance.mat_grounded),
        "ESDS in ESD Box": str(instance.esds_box),
        "Table No ESD Source": str(instance.table_no_source),
        "Tools Daily Audit": str(instance.tools_audit),
        "Temp & Humidity SPEC": str(instance.temp_humidity),
        "Tray Voltage < Â±100V": str(instance.tray_voltage),
        "Remark": instance.remark or "",
        "Created At": date_to_ms(instance.created_at),
        "Updated At": date_to_ms(instance.updated_at),
    }

    payload = {"fields": fields}
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    response = requests.post(url, headers=headers, json={"fields": fields})
    res_json = response.json()
    if response.status_code == 200 and res_json.get("code") == 0:
        print("âœ… Synced successfully to Bitable.")
    else:
        print(f"âš ï¸ Sync failed: {res_json}")
        
def sync_dust_measurement_to_bitable(instance):
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping sync.")
        return False, "No access token"

    table_id = getattr(settings, "LARK_TABLE_DUST_MEASUREMENT", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False, "Table ID missing"

    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{settings.LARK_BITABLE_APP_TOKEN_QA}/tables/{table_id}/records"

    fields = {
        "Date": date_to_ms(instance.date),
        "Shift": instance.shift,
        "Employee ID": instance.emp_id,
        "Name": instance.name,
        "Line": instance.line,
        "Group": instance.group,
        "Model": instance.model,
        "Color": instance.color,
        "â‰¥0.3 micrometer": instance.micrometer_0_3,
        "â‰¥0.5 micrometer": instance.micrometer_0_5,
        "â‰¥1.0 micrometer": instance.micrometer_1_0,
        "Checked By": instance.checked_by,
        "Verified By": instance.verified_by,
        "Remark": instance.remark or "",
        "Created At": date_to_ms(instance.created_at),
        "Updated At": date_to_ms(instance.updated_at),
    }

    payload = {"fields": fields}
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    response = requests.post(url, headers=headers, json={"fields": fields})
    res_json = response.json()
    if response.status_code == 200 and res_json.get("code") == 0:
        print("âœ… Synced successfully to Bitable.")
    else:
        print(f"âš ï¸ Sync failed: {res_json}")
        
 
       
def sync_testing_fai_to_bitable(instance):
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping sync.")
        return False, "No access token"

    table_id = getattr(settings, "LARK_TABLE_TESTING_FAI", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False, "Table ID missing"

    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{settings.LARK_BITABLE_APP_TOKEN_QA}/tables/{table_id}/records"

    fields = {
        "Date": date_to_ms(instance.date),
        "Shift": instance.shift,
        "Employee ID": instance.emp_id,
        "Employee Name": instance.name,
        "Section": instance.section,
        "Line": instance.line,
        "Group": instance.group,
        "Model": instance.model,
        "Color": instance.color,
        "Production Work Order No": instance.production_work_order_no,
        "First Article Type": instance.first_article_type,
        "Software Version Check": instance.software_ver_check,
        "Android Version Check": instance.android_ver_check,
        "Memory Inbuilt Check Result": instance.memory_inbuilt_check,
        "Order Confirmation Check": instance.order_confirm_check,
        "Label Check": instance.label_check,
        # "Label Photo": instance.label_check_evidence.url if instance.label_check_evidence else "",
        "Label Position Check": instance.label_position_check,
        # "Label Position Photo": instance.label_position_check_evidence.url if instance.label_position_check_evidence else "",
        "Visual Handset Appearance Check": instance.visual_inspection_handset,
        "Logo Check": instance.logo_check,
        # "Logo Photo": instance.logo_check_evidence.url if instance.logo_check_evidence else "",
        "Battery Assembly Check": instance.assembly_battery_check,
        # "Battery Assembly Photo": instance.assembly_battery_check_evidence.url if instance.assembly_battery_check_evidence else "",
        "Net Color Check": instance.net_color_check,
        "TP Key Function Check": instance.tp_with_key_check,
        "Screw Check": instance.screw_check,
        "TP Charge Test": instance.tp_with_charge_test,
        "15-Min Charge Test": instance.charge_15min_test,
        "Boot Time Test": instance.boot_time_test,
        # "Boot Time Evidence": instance.boot_time_test_evidence.url if instance.boot_time_test_evidence else "",
        "Initialization & Settings Test": instance.init_settings_test,
        "Button & Key Feel Test": instance.buttons_keys_test,
        "Touch Screen Pen Test": instance.touch_screen_pen_test,
        "Calling Test": instance.calling_test,
        "Bluetooth Function Test": instance.bluetooth_test,
        "Flashlight/Induction Test": instance.flashlight_test,
        "Camera Flash Test": instance.camera_flash_test,
        "Front/Rear Camera Test": instance.camera_photo_test,
        # "Front Camera Photo": instance.camera_front_test_evidence.url if instance.camera_front_test_evidence else "",
        # "Rear Camera Photo": instance.camera_back_test_evidence.url if instance.camera_back_test_evidence else "",
        "Camera Dark Test": instance.camera_dark_test,
        # "Camera Dark Photo": instance.camera_dark_test_evidence.url if instance.camera_dark_test_evidence else "",
        "Long Distance Camera Check": instance.camera_long_distance_check,
        "High Light Defect Check": instance.highlight_defect_check,
        "Multimedia Play Test": instance.multimedia_play_test,
        "FM Play Test": instance.fm_play_test,
        "TV Function Test": instance.tv_fn_test,
        "Taping Function Test": instance.taping_fn_test,
        "Shaking Screen Test": instance.shaking_screen_test,
        "WiFi Function Test": instance.wifi_test,
        "Gravity Sensor Test": instance.gravity_sensor_test,
        "Light & Distance Sensor Test": instance.light_distance_sensor_test,
        "Hall Function Test": instance.hall_fn_test,
        "QR Code Scan Test": instance.qr_scan_test,
        "RAM/ROM/T Card Capacity Test": instance.ram_rom_cap_test,
        "Mode Switch Test": instance.mode_switch_test,
        "Touch in Developer Options Test": instance.touch_in_dev_opt_test,
        "MAC Address Check": instance.mac_add_test,
        "OTG Function Test": instance.otg_fn_test,
        "T-Card/SIM Plug-Pull Test": instance.tcard_sim_plug_test,
        "Auto Focus Clarity Test": instance.focus_test,
        "Front/Back Camera Photo Test": instance.front_back_cam_test,
        "Slight Drop Test": instance.slight_drop_test,
        "Charging & USB Stability Test": instance.slight_touch_test,
        "Coupling RF Test": instance.coumpling_rf_test,
        "Power Consumption Test": instance.power_consumption_test,
        "High Temperature Simulation Test": instance.high_temp_simul_test,
        "Post Factory Reset Function Test": instance.factory_reset_fn_test,
        "SAR Value Test": instance.sar_value_test,
        "Post Factory Reset Call Noise Test": instance.factory_reset_call_noise_test,
        "Factory Reset Visual Test": instance.factory_reset_test,
        "High Temp Boot Test": instance.high_temp_boot_check,
        "High Temp Engineering Mode Test": instance.high_temp_engi_mode_test,
        "High Temp Call Test": instance.high_temp_call_test,
        "High Temp Charging Test": instance.high_temp_charging_test,
        "High Temp Camera Test": instance.high_temp_camera_test,
        "High Temp Camera Photo": instance.high_temp_camera_test_evidence.url if instance.high_temp_camera_test_evidence else "",
        "Shutdown Behavior Test": instance.shutdown_test,
        "Sample Serial Number": instance.sample_serial_number,
        "IMEI Number": instance.imei_number,
        # "IMEI Photo": instance.imei_photo.url if instance.imei_photo else "",
        "Visual & Functional Result": instance.visual_functional_result,
        "Reliability Test Result": instance.reliability_result,
        # "Inspector Name": instance.inspector_name or "",
        # "QE Confirm Name": instance.qe_confirm_name or "",
        # "QE Confirm Status": instance.qe_confirm_status or "",
        "Public Token": str(instance.public_token),
        "Remarks": instance.remarks,
        # "Public URL": {"link": instance.public_url} if instance.public_url else None,
        # "Created At": date_to_ms(instance.created_at),
        # "Updated At": date_to_ms(instance.updated_at),
    }


    payload = {"fields": fields}
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    response = requests.post(url, headers=headers, json={"fields": fields})
    res_json = response.json()
    if response.status_code == 200 and res_json.get("code") == 0:
        print("âœ… Synced successfully to Bitable.")
    else:
        print(f"âš ï¸ Sync failed: {res_json}")
        
        
def update_testing_fai_in_bitable(instance):
    """Update existing record in Lark Bitable based on Public Token"""
    token = get_lark_access_token()
    if not token:
        print("âŒ No access token, skipping update.")
        return False

    table_id = getattr(settings, "LARK_TABLE_TESTING_FAI", None)
    if not table_id:
        print("âŒ Table ID missing in settings.")
        return False

    app_token = getattr(settings, "LARK_BITABLE_APP_TOKEN_QA", None)
    url = f"https://open.larkoffice.com/open-apis/bitable/v1/apps/{app_token}/tables/{table_id}/records"

    headers = {"Authorization": f"Bearer {token}"}

    # âœ… Step 1: Fetch all records from table
    res = requests.get(url, headers=headers)
    data = res.json()

    if data.get("code") != 0:
        print("âš ï¸ Failed to fetch records:", data)
        return False

    records = data.get("data", {}).get("items", [])
    public_token = str(instance.public_token).strip()

    # âœ… Step 2: Find matching record in Bitable
    matching_record = None
    for record in records:
        bitable_token = str(record.get("fields", {}).get("Public Token", "")).strip()
        if bitable_token == public_token:
            matching_record = record
            break

    if not matching_record:
        print(f"âš ï¸ No matching record found in Bitable for token: {public_token}")
        return False

    record_id = matching_record.get("record_id")
    if not record_id:
        print("âš ï¸ Record ID missing in matching record.")
        return False

    # âœ… Step 3: Update QE fields
    update_fields = {
        "QE Confirm Name": instance.qe_confirm_name or "",
        "QE Confirm Status": instance.qe_confirm_status or "",
        "Public URL": instance.public_url or "",
    }

    update_url = f"{url}/{record_id}"
    update_res = requests.put(
        update_url,
        headers={**headers, "Content-Type": "application/json"},
        json={"fields": update_fields},
    )

    update_data = update_res.json()
    if update_data.get("code") == 0:
        print(f"âœ… Updated QE fields successfully in Bitable for token: {public_token}")
        return True
    else:
        print(f"âš ï¸ Failed to update QE fields in Bitable: {update_data}")
        return False


transs_flow/ipqc/urls.py:


from django.urls import path
from . import views

urlpatterns = [
    # Home and AJAX URLs
    path('', views.home_view, name='ipqc_home'),
    path('ajax/get-models/', views.ajax_get_models, name='ajax_get_models'),
    path('ajax/get-lines/', views.ajax_get_lines, name='ajax_get_lines'),
    path('ajax/get-groups/', views.ajax_get_groups, name='ajax_get_groups'),
    # Work Info URLs
    path('work-info/', views.work_info_view, name='ipqc_work_info'),
    path('info_dash/', views.info_dash, name='info_dash'),
    # Dynamic Form URLs
    path('dynamic-form/create/', views.create_dynamic_form, name='create_dynamic_form'),
    path('dynamic-form/<int:form_id>/', views.fill_dynamic_form, name='dynamic_form'),
    path('dynamic-form/<int:form_id>/dashboard/', views.dynamic_form_dashboard, name='dynamic_form_dashboard'),
    # ESD Compliance Checklist URLs
    path('esd-compliance-checklist/', views.ESDComplianceCheckListView.as_view(), name='esd_compliance_checklist_list'),
    path('esd-compliance-checklist/add/', views.ESDComplianceChecklistCreateView.as_view(), name='esd_compliance_checklist_add'),
    path('esd-compliance-checklist/details/<int:pk>/', views.esd_compliance_checklist_details, name='esd_compliance_checklist_details'),
    # Disassemble Checklist URLs
    path('disassemble/add/', views.IPQCDisassembleCheckListCreateView.as_view(), name='ipqc_disassemble_add'),
    path('disassemble/', views.IPQCDisassembleCheckListView.as_view(), name='ipqc_disassemble_list'),
    path('disassemble/details/<int:pk>/', views.IPQCDisassembleDetailView.as_view(), name='ipqc_disassemble_detail'),
    # Testing FAI management URLs
    path('testing/fai/list/', views. TestingFirstArticleInspectionListView.as_view(), name='testing_fai_list'),
    path('testing/fai/create/', views. TestingFirstArticleInspectionCreateView.as_view(), name='testing_fai_create'),
    path('testing/fai/<int:pk>/', views. TestingFirstArticleInspectionDetailView.as_view(), name='testing_fai_detail'),
    path('testing/fai/<int:pk>/download/<str:evidence_type>/', views.download_testing_fai_evidence, name='testing_download_fai_evidence'),
    path('testing/fai/public/update/<uuid:public_token>/', views.testing_fai_public_qe_update_view, name='testing_fai_public_update'),
    # New URL for the JSON details view for the modal
    path('testing/fai/details/<int:pk>/', views. TestingFAIDetailsJsonView.as_view(), name='testing_fai_details_json'),
    # Operator Qualification Check URLs
    path('operator-qualification/create/', views.OperatorQualificationCheckCreateView.as_view(), name='operator_qualification_create'), 
    path('operator-qualification/list/', views.OperatorQualificationCheckListView.as_view(), name='operator_qualification_list'),
    path('operator-qualification/details/<int:pk>/', views.operator_qualification_detail, name='operator_qualification_detail'),

    # --- NEW URLS FOR LIST, UPDATE, DELETE ---
    path('assembly-audit/create/', views. IPQCAssemblyAuditCreateView.as_view(), name='ipqc_assembly_audit_create'),
    path('assembly-audit/list/', views.IPQCAssemblyAuditListView.as_view(), name='ipqc_audit_list'),
    path('assembly-audit/<int:pk>/edit/', views.IPQCAssemblyAuditUpdateView.as_view(), name='ipqc_assembly_audit_update'),
    path('assembly-audit/<int:pk>/delete/', views.IPQCAssemblyAuditDeleteView.as_view(), name='ipqc_assembly_audit_delete'),
    path('btb-checksheet/create/', views. BTBFitmentChecksheetCreateView.as_view(), name='btb_checksheet_create'),
    path('btb-checksheet/list/', views. BTBFitmentChecksheetListView.as_view(), name='btb_checksheet_list'),
    path('btb/checksheet/<int:pk>/', views.BTBFitmentChecksheetDetailView.as_view(), name='btb_checksheet_detail'),
    path('ass-dummy-test/create/', views.AssyDummyTestCreate.as_view(), name='ass_dummy_test_create'),
    path('ass-dummy-test/list/', views.AssDummyTestListView.as_view(), name='ass_dummy_test_list'),
    path('nc-issue-tracking/', views.NCIssueTrackingListView.as_view(), name='nc_issue_tracking_list'),
    path('nc-issue-tracking/create/', views.NCIssueTrackingCreateView.as_view(), name='nc_issue_tracking_create'),
    path('dust-count/add/', views.DustCountCreateView.as_view(), name='dust_count_checklist_add'),
    path('dust-count/list/', views.DustCountListView.as_view(), name='dust_count_checklist_list'),
    path('bitable/webhook/', views.lark_bitable_webhook, name='lark_bitable_webhook'),

]


transs_flow/ipqc/views.py:


from django.contrib.auth.decorators import login_required
from django.shortcuts import render, redirect, get_object_or_404
from django.shortcuts import redirect, get_object_or_404
from django.contrib import messages
from django.utils import timezone
from django import forms
import json
from accounts.models import Employee
from .forms import WorkInfoForm, IPQCAssemblyAuditForm, FIELDS_WITH_REMARKS, BTBFitmentChecksheetForm, AssDummyTestForm, IPQCDisassembleCheckListForm, NCIssueTrackingForm, ESDComplianceChecklistForm, DustCountCheckForm, TestingFirstArticleInspectionForm, OperatorQualificationCheckForm
from .services import write_to_bitable, write_to_bitable_dynamic, date_to_ms
from datetime import timedelta, datetime, date
from .models import IPQCWorkInfo, DynamicForm, DynamicFormField, DynamicFormSubmission, IPQCAssemblyAudit, BTBFitmentChecksheet, AssDummyTest, IPQCDisassembleCheckList, NCIssueTracking, ESDComplianceChecklist, DustCountCheck, TestingFirstArticleInspection, OperatorQualificationCheck
import pandas as pd
from django.urls import reverse_lazy
from django.views.generic import CreateView, ListView, UpdateView, DeleteView, View
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import DetailView
from accounts.role_decorator import RoleRequiredMixin, role_required
from django.db.models import Q
from django.db import models
from django.views.decorators.csrf import csrf_exempt
from django.http import JsonResponse, Http404
from django.db import connections
from django.views.decorators.http import require_GET
from django.conf import settings
from django.http import HttpResponse
import os
from django.urls import reverse
 
# ==============================================================================
# EXISTING FUNCTION-BASED VIEWS (UNCHANGED)
# ==============================================================================

# --- Fetch models dynamically from your DB ---
def ajax_get_models(request):
    q = request.GET.get('q', '').strip()
    try:
        with connections['defaultdb'].cursor() as cursor:
            cursor.execute("""
                SELECT model_name 
                FROM model_description 
                WHERE model_name LIKE %s 
                ORDER BY model_name ASC
                LIMIT 20;
            """, [f"%{q}%"])
            rows = cursor.fetchall()
        data = [{'id': r[0], 'text': r[0]} for r in rows]
    except Exception as e:
        data = []
    return JsonResponse(data, safe=False)


# --- Static list for lines (L1â€“L15) ---
def ajax_get_lines(request):
    q = request.GET.get('q', '').strip().upper()
    lines = [f"L{i}" for i in range(1, 16)]
    filtered = [l for l in lines if q in l]
    return JsonResponse([{'id': l, 'text': l} for l in filtered], safe=False)


# --- Static list for groups (A1â€“A15) ---
def ajax_get_groups(request):
    q = request.GET.get('q', '').strip().upper()
    groups = [f"A{i}" for i in range(1, 16)]
    filtered = [g for g in groups if q in g]
    return JsonResponse([{'id': g, 'text': g} for g in filtered], safe=False)
 
@login_required
@role_required(["IPQC"])
def work_info_view(request):
    emp_id = getattr(request.user, 'employee_id', None)
    full_name = getattr(request.user, 'full_name', None)

    # --- Safety: fallback if missing in user model ---
    if not emp_id or not full_name:
        try:
            employee = Employee.objects.get(user=request.user)
            emp_id = employee.employee_id
            full_name = employee.full_name
        except Employee.DoesNotExist:
            messages.error(request, "Employee record not found for this user.")
            return redirect('ipqc_home')

    today = timezone.localdate()
    start_of_week = today - timedelta(days=today.weekday())
    end_of_week = start_of_week + timedelta(days=6)

    today_records = IPQCWorkInfo.objects.filter(date=today, emp_id=emp_id).count()
    week_records = IPQCWorkInfo.objects.filter(date__range=[start_of_week, end_of_week], emp_id=emp_id).count()
    total_records = IPQCWorkInfo.objects.filter(emp_id=emp_id).count()
    recent_records = IPQCWorkInfo.objects.filter(emp_id=emp_id).order_by('-created_at')[:5]

    if request.method == 'POST':
        form = WorkInfoForm(request.POST)
        if form.is_valid():
            work_info = form.save(commit=False)

            # Always attach employee info
            work_info.emp_id = emp_id
            work_info.name = full_name
            work_info.created_at = timezone.now()

            work_info.save()

            success, message = write_to_bitable(work_info)
            if success:
                messages.success(request, 'Work info saved and synced to Lark Bitable!')
            else:
                messages.warning(request, f'Work info saved but failed to sync: {message}')

            return redirect('ipqc_home')
    else:
        form = WorkInfoForm()

    line_list = [f"L{i}" for i in range(1, 16)]
    group_list = [f"A{i}" for i in range(1, 16)]

    context = {
        'first_name': full_name.split()[0] if full_name else "",
        'designation': getattr(request.user, "role", ""),
        'form': form,
        'user_emp_id': emp_id,
        'user_name': full_name,
        'today_records': today_records,
        'week_records': week_records,
        'total_records': total_records,
        'recent_records': recent_records,
        'start_of_week': start_of_week,
        'end_of_week': end_of_week,
        'line_list': line_list,
        'group_list': group_list,
    }

    return render(request, 'ipqc/work_info.html', context)

@csrf_exempt
def lark_bitable_webhook(request):
    """Webhook endpoint for Lark Bitable automation trigger"""
    if request.method != 'POST':
        return JsonResponse({"error": "Invalid method"}, status=405)

    try:
        payload = json.loads(request.body.decode('utf-8'))
        fields = payload.get('fields', {})
        
        emp_id = fields.get('Emp_ID')
        model_name = fields.get('Model')
        date = fields.get('Date')
        status = fields.get('Status')

        if not all([emp_id, model_name, date, status]):
            return JsonResponse({"error": "Missing required fields"}, status=400)

        # Convert date if it's in timestamp (ms)
        if isinstance(date, int):
            date = datetime.fromtimestamp(date / 1000).date()

        # Update corresponding record
        updated = IPQCWorkInfo.objects.filter(emp_id=emp_id, model=model_name, date=date).update(status=status)

        if updated:
            return JsonResponse({"message": "Status updated successfully"})
        else:
            return JsonResponse({"error": "Record not found"}, status=404)

    except Exception as e:
        return JsonResponse({"error": str(e)}, status=500)

@login_required
@role_required(["IPQC"])
def home_view(request):
    user = request.user
    emp_id = getattr(user, 'employee_id', None)

    now = timezone.localtime()  # current local datetime
    today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
    today = now.date()
    start_of_week = today - timedelta(days=today.weekday())
    start_of_month = today.replace(day=1)

    # Define the time range (8 AM today â†’ 8 AM next day)
    if now < today_8am:
        # Before 8 AM â†’ window is yesterday 8 AM â†’ today 8 AM
        start_time = today_8am - timedelta(days=1)
        end_time = today_8am
    else:
        # After 8 AM â†’ window is today 8 AM â†’ tomorrow 8 AM
        start_time = today_8am
        end_time = today_8am + timedelta(days=1)

    # âœ… Check if created_at is within current 8AMâ€“8AM window
    has_filled = IPQCWorkInfo.objects.filter(
        emp_id=emp_id,
        created_at__gte=start_time,
        created_at__lt=end_time
    ).exists()

    if not has_filled:
        messages.warning(
            request,
            "âš ï¸ You haven't filled your Work Info for the current period (8 AM to next day 8 AM). Please fill it before proceeding."
        )
        return redirect('ipqc_work_info')

    is_admin = user.is_superuser or getattr(user, 'role', '').lower() == 'admin'
    
    # Set filters for non-admin users - Fix this part
    base_filter = {}
    if not is_admin and emp_id:
        # Use inspector_name field instead of emp_id for FAI records
        base_filter['inspector_name'] = getattr(user, 'full_name', '') or user.username

    # Work Info counts
    work_info_today = IPQCWorkInfo.objects.filter(date=today, emp_id=emp_id).count()
    work_info_week = IPQCWorkInfo.objects.filter(date__range=[start_of_week, today], emp_id=emp_id).count()
    work_info_month = IPQCWorkInfo.objects.filter(date__range=[start_of_month, today], emp_id=emp_id).count()

    # Assembly Audit counts
    audit_today = IPQCAssemblyAudit.objects.filter(date=today, emp_id=emp_id).count()
    audit_week = IPQCAssemblyAudit.objects.filter(date__range=[start_of_week, today], emp_id=emp_id).count()
    audit_month = IPQCAssemblyAudit.objects.filter(date__range=[start_of_month, today], emp_id=emp_id).count()

    # ESD Compliance counts
    esd_today = ESDComplianceChecklist.objects.filter(date=today, emp_id=emp_id).count()
    esd_week = ESDComplianceChecklist.objects.filter(date__range=[start_of_week, today], emp_id=emp_id).count()
    esd_month = ESDComplianceChecklist.objects.filter(date__range=[start_of_month, today], emp_id=emp_id).count()

    # IPQC Disassemble counts
    disassemble_today = IPQCDisassembleCheckList.objects.filter(date=today, emp_id=emp_id).count()
    disassemble_week = IPQCDisassembleCheckList.objects.filter(date__range=[start_of_week, today], emp_id=emp_id).count()
    disassemble_month = IPQCDisassembleCheckList.objects.filter(date__range=[start_of_month, today], emp_id=emp_id).count()

    # FAI counts - Fix this part
    fai_today = TestingFirstArticleInspection.objects.filter(date=today, **base_filter).count()
    fai_week = TestingFirstArticleInspection.objects.filter(date__range=[start_of_week, today], **base_filter).count()
    fai_month = TestingFirstArticleInspection.objects.filter(date__range=[start_of_month, today], **base_filter).count()

    recent_audits = IPQCAssemblyAudit.objects.filter(emp_id=emp_id).order_by('-created_at')[:5]
    dynamic_forms = DynamicForm.objects.all().order_by('-created_at')

    full_name = getattr(user, 'full_name', '') or f"{user.first_name} {user.last_name}".strip()

    context = {
        'Full_Name': full_name,
        'designation': getattr(user, "role", ""),
        'is_admin': is_admin,
        'dynamic_forms': dynamic_forms,
        
        # Work Info counts
        'work_info_today': work_info_today,
        'work_info_week': work_info_week,
        'work_info_month': work_info_month,
        
        # Audit counts
        'audit_today': audit_today,
        'audit_week': audit_week,
        'audit_month': audit_month,
        
        # ESD counts
        'esd_today': esd_today,
        'esd_week': esd_week,
        'esd_month': esd_month,
        
        # Disassemble counts
        'disassemble_today': disassemble_today,
        'disassemble_week': disassemble_week,
        'disassemble_month': disassemble_month,
        
        # FAI counts
        'fai_today': fai_today,
        'fai_week': fai_week,
        'fai_month': fai_month,
        
        'recent_audits': recent_audits,
    }

    return render(request, 'ipqc/home.html', context)
 
@login_required
@role_required(["IPQC", "QA"])
def info_dash(request):
    emp_id = request.user.employee_id  # Use the correct Employee ID field
 
    today = timezone.localdate()  # safer than timezone.now().date()
    start_of_week = today - timedelta(days=today.weekday())  # Monday
    end_of_week = start_of_week + timedelta(days=6)  # Sunday
 
    # Filter data by logged-in employee ID
    today_records = IPQCWorkInfo.objects. filter(date=today, emp_id=emp_id).count()
    week_records = IPQCWorkInfo.objects. filter(
    date__range=[start_of_week, end_of_week],
    emp_id=emp_id
    ).count()
    total_records = IPQCWorkInfo.objects. filter(emp_id=emp_id).count()
    recent_records = IPQCWorkInfo.objects. filter(
    emp_id=emp_id,
    date__range=[start_of_week, end_of_week]  # optional if you only want recent this week
    ).order_by('-created_at')[:5]
 
    context = {
        'first_name': request.user.full_name.split()[0],
        'designation': request.user.role,
        'today_records': today_records,
        'week_records': week_records,
        'total_records': total_records,
        'recent_records': recent_records,
    }
    return render(request, 'ipqc/info_dash.html', context)
 
 
@login_required
@role_required()
def fill_dynamic_form(request, form_id):
    form_obj = get_object_or_404(DynamicForm, id=form_id)
    fields = form_obj.fields. all()
 
    # ---------------- Get today's IPQC Work Info ----------------
    work_info_today = IPQCWorkInfo.objects. filter(
        emp_id=request.user.employee_id,
        date=timezone.localdate()
    ).order_by('-created_at').first()
 
    if not work_info_today:
        messages.warning(request, "Please fill your IPQC Work Info for today before submitting dynamic forms.")
        return redirect('ipqc_work_info')  # redirect only once here
 
    # ---------------- Pre-fill Work Info Data ----------------
    prefill_work_info = {
        'Emp_ID': work_info_today.emp_id,
        'Name': work_info_today.name,
        'Section': work_info_today.section,
        'Line': work_info_today.line,
        'Group': work_info_today.group,
        'Model': work_info_today.model,
        'Color': work_info_today.color,
        'Date': work_info_today.date,
        'Shift': work_info_today.shift
    }
 
    # ---------------- Build Dynamic Form ----------------
    CustomForm = type('CustomForm', (forms. Form,), {})
 
    # Add prefilled IPQC fields
    for key, value in prefill_work_info.items():
        if key == 'Date':
            CustomForm.base_fields[key] = forms. DateField(
                initial=value,
            widget=forms. DateInput(attrs={'type': 'date'}),
                required=True
            )
        else:
            CustomForm.base_fields[key] = forms. CharField(initial=value, required=True)
 
    # Add dynamic form fields
    for field in fields:
        if field.field_type == 'text':
            CustomForm.base_fields[field.label] = forms. CharField(required=field.required)
        elif field.field_type == 'number':
            CustomForm.base_fields[field.label] = forms. IntegerField(required=field.required)
        elif field.field_type == 'date':
            CustomForm.base_fields[field.label] = forms. DateField(
            widget=forms. DateInput(attrs={'type': 'date'}),
                required=field.required
            )
        elif field.field_type == 'select':
            choices = [(opt.strip(), opt.strip()) for opt in (field.options or "").split(',')]
            CustomForm.base_fields[field.label] = forms. ChoiceField(choices=choices, required=field.required)
        elif field.field_type == 'checkbox':
            CustomForm.base_fields[field.label] = forms. BooleanField(required=field.required)
 
    # ---------------- Handle Submission ----------------
    if request.method == 'POST':
        form = CustomForm(request. POST)
        if form.is_valid():
            cleaned_data = form.cleaned_data
 
            # Dynamic form submission
            dynamic_data = {k: v for k, v in cleaned_data.items() if k not in prefill_work_info}
            submission = DynamicFormSubmission.objects.create(
                form=form_obj,
                submitted_by=request.user,
                data=dynamic_data
            )
 
            # IPQC Work Info (already exists, just update if changed)
            ipqc_data = {k: v for k, v in cleaned_data.items() if k in prefill_work_info}
            for field, value in ipqc_data.items():
                setattr(work_info_today, field.lower(), value)
            work_info_today.save()
 
            # Combine both and send to Lark
            combined_data = {**ipqc_data, **dynamic_data}
            if 'Date' in combined_data and isinstance(combined_data['Date'], (datetime, date)):
                combined_data['Date'] = date_to_ms(combined_data['Date'])
 
            success, message = write_to_bitable_dynamic(form_obj.lark_bitable_table_id, combined_data)
            messages.success(
                request,
                f"Form submitted! {message if success else 'Saved locally to MySQL.'}"
            )
            return redirect('ipqc_home')
    else:
        form = CustomForm()
 
    return render(request, 'ipqc/dynamic_form.html', {
        'form': form,
        'form_obj': form_obj,
        'work_info_today': work_info_today
    })
 
 
@login_required
@role_required()
def create_dynamic_form(request):
    if request.method == "POST":
        title = request. POST.get("title").strip()
        description = request. POST.get("description")
        lark_bitable_table_id = request. POST.get("lark_bitable_table_id")
        fields_data = request. POST.get("fields_data") # JSON string
 
        # Check if title already exists
        if DynamicForm.objects. filter(title__iexact=title).exists():
            messages.error(request, f"A form with the title '{title}' already exists.")
            return redirect('create_dynamic_form')
 
        if not fields_data:
            messages.error(request, "Please add at least one field.")
            return redirect('create_dynamic_form')
 
        try:
            fields = json.loads(fields_data)
        except:
            messages.error(request, "Invalid field data.")
            return redirect('create_dynamic_form')
 
        dynamic_form = DynamicForm.objects.create(
            title=title,
            description=description,
            lark_bitable_table_id=lark_bitable_table_id
        )
 
        for idx, field in enumerate(fields):
            DynamicFormField.objects.create(
                form=dynamic_form,
                label=field.get("label"),
                field_type=field.get("type"),
                required=field.get("required", True),
                order=idx
            )
 
        messages.success(request, "Dynamic form created successfully!")
        return redirect('ipqc_home')
 
    return render(request, "ipqc/create_dynamic_form.html")
 
 
@login_required
@role_required()
def dynamic_form_dashboard(request, form_id):
    form_obj = get_object_or_404(DynamicForm, id=form_id)
    submissions = DynamicFormSubmission.objects. filter(form=form_obj)
 
    # Convert to DataFrame for analysis (optional)
    df = pd. DataFrame([s.data for s in submissions])
    df['submitted_by'] = [s.submitted_by.full_name for s in submissions]
    df['created_at'] = [s.created_at for s in submissions]
 
    # Example metrics
    total_submissions = len(df)
    latest_submission = df['created_at']. max() if  not df.empty else  None
 
    # Example field-level stats (only for numeric fields)
    numeric_summary = {}
    for col in df.columns:
        if pd.api.types.is_numeric_dtype(df[col]):
            numeric_summary[col] = {
                'mean': round(df[col].mean(), 2),
                'max': df[col]. max(),
                'min': df[col]. min(),
            }
 
    context = {
        "form_obj": form_obj,
        'total_submissions': total_submissions,
        "latest_submission": latest_submission,
        "numeric_summary": numeric_summary,
        "data_json": df.to_json(orient='records') if not df.empty else '[]'
    }
 
    return render(request, "ipqc/dynamic_dashboard.html", context)
 
 
# ==============================================================================
# IPQC ASSEMBLY AUDIT VIEWS (NEW & UPDATED)
# ==============================================================================
 
# --- Mixin to define permission test for editing/deleting ---
class UserCanEditAuditMixin(UserPassesTestMixin):
    def test_func(self):
        """Check if the user is an admin or the owner of the audit."""
        audit = self.get_object()
        user = self.request.user
        if user.is_superuser or user.role.lower() == 'admin':
            return True
        # Check ownership by comparing emp_id
        return audit.emp_id == user.employee_id
 
 
# --- LIST VIEW ---
class IPQCAssemblyAuditListView(RoleRequiredMixin, LoginRequiredMixin, ListView):
    allowed_roles = ["IPQC"]
    model = IPQCAssemblyAudit
    template_name = 'ipqc/audit_list.html'
    context_object_name = 'audits'  # Name for the list in the template
    paginate_by = 10  # Optional: for pagination
 
    def get_queryset(self):
        """Filter records based on user role and employee_id."""
        user = self.request.user
        if user.is_superuser or user.role.lower() == 'admin':
            return IPQCAssemblyAudit.objects. all()
        else:
            return IPQCAssemblyAudit.objects. filter(emp_id=user.employee_id)
 
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['is_admin'] = self.request.user.is_superuser or self.request.user.role.lower() == 'admin'
        return context
 
 
# --- CREATE VIEW (UPDATED) ---
class IPQCAssemblyAuditCreateView(RoleRequiredMixin, LoginRequiredMixin, CreateView):
    allowed_roles = ["IPQC"]
    model = IPQCAssemblyAudit
    form_class = IPQCAssemblyAuditForm
    template_name = 'ipqc/ipqc_assembly_audit_form.html'
    success_url = reverse_lazy('ipqc_audit_list') # Redirect to list page after creation
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)
 
    def get_initial(self):
        initial = super().get_initial()
        emp_id = getattr(self.request.user, 'employee_id', None)
 
        # Pre-fill PQE/TL signature with logged-in user's name
        initial['ipqc_sign'] = getattr(self.request.user, 'full_name', self.request.user.employee_id)
 
        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects. filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date, 'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id, 'name': latest_work_info.name,
                    'section': latest_work_info.section, 'line': latest_work_info.line,
                    'group': latest_work_info.group, 'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "No Work Information found. Some fields may be empty.")
        
        return initial
 
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        form = context['form']
        
        # Each item is a tuple: (main_field, remark_field)
        # context['man_fields'] = [(form['man_job_card'], form['remark_man_job_card']), (form['man_btb_mon'], form['remark_man_btb_mon'])]
        context['machine_fields'] = [
            form['mach_epa_check'], form['mach_screw_torque'], form['mach_sholdering_temp'], form['mach_light'], form['mach_fixture_clean'],
            form['mach_jig_label'], form['mach_teflon'], form['mach_press_params'], form['mach_glue_params'],
            form['mach_eq_move_notify'], form['mach_feeler_gauge'], form['mach_hot_cold_press'], form['mach_ion_fan'],
            form['mach_cleanroom_eq'], form['mach_rti_check'], form['mach_current_test'], form['mach_pal_qr'],
            form['mach_auto_screw'],
        ]

        context['material_fields'] = [
            form['mat_key_check'], form['mat_special_stop'], form['mat_improved_monitor'], form['mat_result_check'],
            form['mat_battery_issue'], form['mat_ipa_check'], form['mat_thermal_gel'], form['mat_verification'],
        ]

        context['method_fields'] = [
            form['meth_sop_seq'], form['meth_distance_sensor'], form['meth_rear_camera'], form['meth_material_handling'],
            form['meth_guideline_doc'], form['meth_operation_doc'], form['meth_defective_feedback'], form['meth_line_record'],
            form['meth_no_self_repair'], form['meth_battery_fix'], form['meth_line_change'], form['meth_trail_run'],
            form['meth_dummy_conduct'],
        ]

        context['environment_fields'] = [
            form['env_prod_monitor'], form['env_5s'],
        ]

        context['trc_fields'] = [
            form['trc_flow_chart'], form['fai_check'], form['defect_monitor'], form['spot_check'], form['auto_screw_sample'],
        ]

        return context
 
    def form_valid(self, form):
        # --- KEY CHANGE: Assign employee_id and name from the logged-in user ---
        form.instance.emp_id = self.request.user.employee_id
        form.instance.name = self.request.user.full_name
        form.instance.remarks = self.request.POST.get('remarks', '').strip()
        
        messages.success(self.request, "Audit record created successfully!")
        return super().form_valid(form)
 
 
# --- UPDATE VIEW ---
class IPQCAssemblyAuditUpdateView(RoleRequiredMixin, LoginRequiredMixin, UserCanEditAuditMixin, UpdateView):
    allowed_roles = ["IPQC"]
    model = IPQCAssemblyAudit
    form_class = IPQCAssemblyAuditForm
    template_name = 'ipqc/ipqc_assembly_audit_update_form.html'
    success_url = reverse_lazy('ipqc_audit_list')
 
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['is_update'] = True
        # Re-use the same context preparation as the create view
        form = context['form']
        # context['man_fields'] = [(form['man_job_card'], form['remark_man_job_card']), (form['man_btb_mon'], form['remark_man_btb_mon'])]
        # ... (add all other field lists here, same as in CreateView) ...
        context['machine_fields'] = [
            form['mach_epa_check'], form['mach_screw_torque'], form['mach_sholdering_temp'] ,form['mach_light'], form['mach_fixture_clean'],
            form['mach_jig_label'], form['mach_teflon'], form['mach_press_params'], form['mach_glue_params'],
            form['mach_eq_move_notify'], form['mach_feeler_gauge'], form['mach_hot_cold_press'], form['mach_ion_fan'],
            form['mach_cleanroom_eq'], form['mach_rti_check'], form['mach_current_test'], form['mach_pal_qr'],
            form['mach_auto_screw'],
        ]

        context['material_fields'] = [
            form['mat_key_check'], form['mat_special_stop'], form['mat_improved_monitor'], form['mat_result_check'],
            form['mat_battery_issue'], form['mat_ipa_check'], form['mat_thermal_gel'], form['mat_verification'],
        ]

        context['method_fields'] = [
            form['meth_sop_seq'], form['meth_distance_sensor'], form['meth_rear_camera'], form['meth_material_handling'],
            form['meth_guideline_doc'], form['meth_operation_doc'], form['meth_defective_feedback'], form['meth_line_record'],
            form['meth_no_self_repair'], form['meth_battery_fix'], form['meth_line_change'], form['meth_trail_run'],
            form['meth_dummy_conduct'],
        ]

        context['environment_fields'] = [
            form['env_prod_monitor'], form['env_5s'],
        ]

        context['trc_fields'] = [
            form['trc_flow_chart'], form['fai_check'], form['defect_monitor'], form['spot_check'], form['auto_screw_sample'],
        ]

        return context
 
    def form_valid(self, form):
       
        form.instance.remarks = self.request.POST.get('remarks', '').strip()
 
        messages.success(self.request, "Audit record updated successfully!")
        return super().form_valid(form)
 
 
# --- DELETE VIEW ---
class IPQCAssemblyAuditDeleteView(RoleRequiredMixin, LoginRequiredMixin, UserCanEditAuditMixin, DeleteView):
    allowed_roles = ["IPQC"]
    model = IPQCAssemblyAudit
    template_name = 'ipqc/confirm_delete.html'
    success_url = reverse_lazy('ipqc_audit_list')
 
    def delete(self, request, *args, **kwargs):
        messages.success(request, "Audit record deleted successfully.")
        return super().delete(request, *args, **kwargs)
    
    
    
class BTBFitmentChecksheetCreateView(RoleRequiredMixin, LoginRequiredMixin, CreateView):
    allowed_roles = ["IPQC"]
    model = BTBFitmentChecksheet
    form_class = BTBFitmentChecksheetForm
    template_name = 'ipqc/btb_checksheet_form.html'
    success_url = reverse_lazy('btb_checksheet_list')

    # List of hours to use in template
    HOURS = ['9','10','11','12','1','2','3','4','5','6']
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)

    def get_initial(self):
        initial = super().get_initial()
        emp_id = getattr(self.request.user, 'employee_id', None)
 
        # Pre-fill PQE/TL signature with logged-in user's name
        initial['pqe_tl_sign'] = getattr(self.request.user, 'full_name', self.request.user.employee_id)
 
        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects. filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date, 'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id, 'name': latest_work_info.name,
                    'section': latest_work_info.section, 'line': latest_work_info.line,
                    'group': latest_work_info.group, 'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "No Work Information found. Some fields may be empty.")
        
        return initial

    # Pass hours to template context
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        hours = ['9','10','11','12','1','2','3','4','5','6']
        context['hours'] = hours
        # Prepare a dict of all fields per hour
        fields = {}
        for hour in hours:
            fields[hour] = {
                'input': f'input_{hour}',
                'cam_btb': f'cam_btb_{hour}',
                'lcd_fitment': f'lcd_fitment_{hour}',
                'main_fpc': f'main_fpc_{hour}',
                'battery': f'battery_{hour}',
                'finger_printer': f'finger_printer_{hour}',
            }
        context['hour_fields'] = fields
        return context

    def form_valid(self, form):
        # Check user authentication
        if not self.request.user.is_authenticated:
            messages.error(self.request, "You must be logged in to submit this form.")
            return self.form_invalid(form)

        # Ensure the user exists in the database
        try:
            user = self.request.user
            if not user.pk or not user.is_active:
                raise ValueError("Current user is invalid.")
        except Exception:
            messages.error(self.request, "Current user is invalid. Please contact admin.")
            return self.form_invalid(form)

        # Load aggregated data safely
        aggregated_data_json = self.request.POST.get('aggregated_data', '{}')
        try:
            aggregated_data = json.loads(aggregated_data_json)
        except json.JSONDecodeError:
            messages.error(self.request, "There was an error processing the form data. Please try again.")
            return self.form_invalid(form)

        # Set all fields from aggregated_data
        for key, value in aggregated_data.items():
            if hasattr(form.instance, key):
                setattr(form.instance, key, value)

        # Assign the valid user
        form.instance.created_by = user

        messages.success(self.request, "BTB Fitment Checksheet submitted successfully!")
        return super().form_valid(form)

class BTBFitmentChecksheetListView(RoleRequiredMixin, LoginRequiredMixin, ListView):
    allowed_roles = ["IPQC"]
    model = BTBFitmentChecksheet
    template_name = 'ipqc/btb_checksheet_list.html'
    context_object_name = 'checksheets'
    paginate_by = 10
 
    def get_queryset(self):
        user = self.request.user
        if user.is_superuser or user.role.lower() == 'admin':
            return BTBFitmentChecksheet.objects. all()
        else:
            return BTBFitmentChecksheet.objects. filter(created_by=user)
        
        
class BTBFitmentChecksheetDetailView(RoleRequiredMixin, LoginRequiredMixin, DetailView):
    allowed_roles = ["IPQC"]
    model = BTBFitmentChecksheet
    template_name = 'ipqc/btb_checksheet_detail.html'
    context_object_name = 'sheet' # This lets you use {{ sheet }} in the template

    def get_context_data(self, **kwargs):
        # Call the base implementation first to get a context
        context = super().get_context_data(**kwargs)
        # You can add extra context here if needed
        return context
    
class AssyDummyTestCreate(RoleRequiredMixin, LoginRequiredMixin, CreateView):
    allowed_roles = ["IPQC"]
    model = AssDummyTest
    form_class = AssDummyTestForm
    template_name = 'ipqc/ass_dummy_test_form.html'
    success_url = reverse_lazy('ass_dummy_test_list')
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)

    def get_initial(self):
        """Prefill form fields based on logged-in user and latest work info."""
        initial = super().get_initial()
        user = self.request.user

        # Prefill PQE/TL signature
        initial['pqe_tl_sign'] = getattr(user, 'full_name', getattr(user, 'employee_id', ''))

        emp_id = getattr(user, 'employee_id', None)
        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects.filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date,
                    'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id,
                    'name': latest_work_info.name,
                    'section': latest_work_info.section,
                    'line': latest_work_info.line,
                    'group': latest_work_info.group,
                    'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "No Work Information found. Some fields may be empty.")
        return initial

    def form_valid(self, form):
        """Process aggregated JSON data and assign the logged-in user."""
        user = self.request.user

        # Safely load aggregated_data JSON from POST
        aggregated_data_json = self.request.POST.get('aggregated_data', '{}')
        try:
            aggregated_data = json.loads(aggregated_data_json)
        except json.JSONDecodeError:
            messages.error(self.request, "Error processing form data. Please try again.")
            return self.form_invalid(form)

        # Safely set fields from aggregated_data, excluding sensitive fields
        sensitive_fields = {'id', 'pk', 'created_by', 'updated_at', 'created_at'}
        for key, value in aggregated_data.items():
            if hasattr(form.instance, key) and key not in sensitive_fields:
                setattr(form.instance, key, value)

        # Assign the logged-in user as creator
        form.instance.created_by = user

        messages.success(self.request, "BTB Fitment Checksheet submitted successfully!")
        return super().form_valid(form)
    
    
class AssDummyTestListView(RoleRequiredMixin, LoginRequiredMixin, ListView):
    allowed_roles = ["IPQC"]            # only IPQC role can access
    model = AssDummyTest
    template_name = 'ipqc/ass_dummy_test_list.html'
    context_object_name = 'tests'       # this is used in the template instead of object_list
    ordering = ['-date', '-id']         # latest records first
    paginate_by = 25                    # optional: pagination
    
    
class IPQCDisassembleCheckListCreateView(RoleRequiredMixin, LoginRequiredMixin, CreateView):
    allowed_roles = ["IPQC"]
    model = IPQCDisassembleCheckList
    form_class = IPQCDisassembleCheckListForm
    template_name = 'ipqc/ipqc_disassemble_form.html'
    success_url = reverse_lazy('ipqc_disassemble_list')
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)

    def get_initial(self):
        """Prefill form fields based on latest work info for logged-in user."""
        initial = super().get_initial()
        user = self.request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects.filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date,
                    'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id,
                    'name': latest_work_info.name,
                    'section': latest_work_info.section,
                    'line': latest_work_info.line,
                    'group': latest_work_info.group,
                    'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "âš ï¸ No Work Information found. Some fields may be empty.")
        else:
            messages.warning(self.request, "âš ï¸ Employee ID missing. Please ensure your profile is complete.")
        return initial

    def form_valid(self, form):
        """Handle form submission successfully."""
        # Track who submitted (if model supports it)
        if hasattr(form.instance, 'created_by'):
            form.instance.created_by = self.request.user

        messages.success(self.request, "âœ… IPQC Disassemble Checklist submitted successfully!")
        return super().form_valid(form)

    def form_invalid(self, form):
        """Custom invalid form handler with clearer error reporting."""
        messages.error(self.request, "âŒ Please correct the highlighted errors before submitting.")
        return super().form_invalid(form)

class IPQCDisassembleCheckListView(RoleRequiredMixin, LoginRequiredMixin, ListView):
    allowed_roles = ["IPQC"]
    model = IPQCDisassembleCheckList
    template_name = 'ipqc/ipqc_disassemble_list.html'
    context_object_name = 'records'
    paginate_by = 20  # Show 20 records per page

    def get_queryset(self):
        """Enable search and filtering by multiple parameters."""
        queryset = super().get_queryset().order_by('-created_at')
        query = self.request.GET.get('q', '').strip()
        if query:
            queryset = queryset.filter(
                Q(name__icontains=query) |
                Q(emp_id__icontains=query) |
                Q(model__icontains=query) |
                Q(color__icontains=query)
            )
        return queryset
    
    def get_overall_status(self):
        """
        Calculate overall status based on all checkpoint fields
        Returns: 'PASS', 'FAIL', or 'MIXED'
        """
        # Get all choice fields (skip non-choice fields)
        choice_fields = [field.name for field in self._meta.fields 
                        if field.choices and field.name not in ['created_by']]
        
        ok_count = 0
        not_ok_count = 0
        total_checked = 0
        
        for field_name in choice_fields:
            value = getattr(self, field_name)
            if value == 'OK':
                ok_count += 1
                total_checked += 1
            elif value == 'Not OK':
                not_ok_count += 1
                total_checked += 1
        
        if total_checked == 0:
            return 'MIXED'
        elif not_ok_count == 0:
            return 'PASS'
        elif ok_count == 0:
            return 'FAIL'
        else:
            return 'MIXED'

    def get_context_data(self, **kwargs):
        """Add statistics for dashboard display."""
        context = super().get_context_data(**kwargs)
        
        # Calculate statistics
        from django.utils import timezone
        from datetime import timedelta
        import datetime
        
        today = timezone.now().date()
        week_start = today - datetime.timedelta(days=today.weekday())
        
        # Get all records
        all_records = self.model.objects.all()
        
        # Calculate statistics
        stats = {
            'today': all_records.filter(created_at__date=today).count(),
            'week': all_records.filter(created_at__date__gte=week_start).count(),
            'total': all_records.count(),
        }
        
        # Add stats to context
        context['ipqc_disassemble_stats'] = stats
        
        # Additional context for dashboard
        context['total_records'] = stats['total']
        context['recent_submissions'] = self.model.objects.order_by('-created_at')[:5]
        
        return context
    
class IPQCDisassembleDetailView(DetailView):
    model = IPQCDisassembleCheckList
    
    def get(self, request, *args, **kwargs):
        try:
            record = self.get_object()
            
            # Prepare basic info
            data = {
                # Basic Information
                'date': record.date.strftime('%Y-%m-%d'),
                'shift': record.shift,
                'emp_id': record.emp_id,
                'name': record.name,
                'section': record.section,
                'line': record.line,
                'group': record.group,
                'model': record.model,
                'color': record.color,
                
                # Appearance / Assembly Quality
                'color_match': record.color_match,
                'cam_lens_assembly': record.cam_lens_assembly,
                'cam_lens_cleanliness': record.cam_lens_cleanliness,
                'key_feel': record.key_feel,
                'key_alignment': record.key_alignment,
                'screw_missing': record.screw_missing,
                'screw_loose': record.screw_loose,
                'screw_spec': record.screw_spec,
                'front_housing_damage': record.front_housing_damage,
                'back_housing_damage': record.back_housing_damage,
                'housing_snap_fit': record.housing_snap_fit,
                'proof_label_position': record.proof_label_position,
                
                # Assembly as per SOP
                'tp_sop': record.tp_sop,
                'mic_solder': record.mic_solder,
                'led_solder': record.led_solder,
                'lcd_stick': record.lcd_stick,
                'speaker_solder': record.speaker_solder,
                'motor_solder': record.motor_solder,
                'key_solder': record.key_solder,
                'sim_subboard_solder': record.sim_subboard_solder,
                'subboard_solder': record.subboard_solder,
                'camera_solder': record.camera_solder,
                'receiver_solder': record.receiver_solder,
                
                # Component & Connection Check
                'coaxial_line': record.coaxial_line,
                'antenna_shrapnel': record.antenna_shrapnel,
                'antenna_fpc': record.antenna_fpc,
                'conductive_fabric': record.conductive_fabric,
                'insulation_paste': record.insulation_paste,
                'ins_paste_cover': record.ins_paste_cover,
                'lcd_fpc_defect': record.lcd_fpc_defect,
                'tp_fpc_defect': record.tp_fpc_defect,
                'key_fpc_solder': record.key_fpc_solder,
                'keypad_defect': record.keypad_defect,
                'mainboard_component_ok': record.mainboard_component_ok,
                'solder_splash': record.solder_splash,
                'foam_stick': record.foam_stick,
                'cam_glue': record.cam_glue,
                'led_position': record.led_position,
                
                # Glue / Fixture Validation
                'jig_fixture_test': record.jig_fixture_test,
                'glue_location': record.glue_location,
                'glue_weight_1': str(record.glue_weight_1) if record.glue_weight_1 else None,
                'glue_weight_2': str(record.glue_weight_2) if record.glue_weight_2 else None,
                'glue_weight_3': str(record.glue_weight_3) if record.glue_weight_3 else None,
                
                # Final fields
                'defect_cause': record.defect_cause,
                'imei1': record.imei1,
                'imei2': record.imei2,
                'pqe': record.pqe,
                'pe': record.pe,
                'apd_ll': record.apd_ll,
                'created_at': record.created_at.strftime('%Y-%m-%d %H:%M:%S'),
                
                # Photos array
                'photos': []
            }
            
            # Add photo URLs
            photo_fields = [
                ('color_match_photo', 'Color Match Photo'),
                ('cam_lens_photo', 'Camera Lens Photo'),
                ('key_photo', 'Keys Photo'),
                ('screw_photo', 'Screw Photo'),
                ('housing_photo', 'Housing Photo'),
                ('proof_label_photo', 'Proof Label Photo'),
                ('assembly_overview_photo', 'Assembly Overview'),
                ('defect_photo', 'Defect Photo'),
            ]
            
            for field_name, label in photo_fields:
                photo = getattr(record, field_name)
                if photo:
                    data['photos'].append({
                        'label': label,
                        'url': photo.url
                    })
            
            return JsonResponse(data)
            
        except Exception as e:
            # Log the error for debugging
            import logging
            logger = logging.getLogger(__name__)
            logger.error(f"Error loading IPQC Disassemble details: {str(e)}")
            
            return JsonResponse({'error': str(e)}, status=500)    

    
class NCIssueTrackingCreateView(RoleRequiredMixin, LoginRequiredMixin, CreateView):
    allowed_roles = ["IPQC"]
    model = NCIssueTracking
    form_class = NCIssueTrackingForm
    template_name = 'ipqc/nc_issue_tracking_form.html'
    success_url = reverse_lazy('nc_issue_tracking_list')
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)

    def get_initial(self):
        """Prefill form fields based on logged-in user and latest work info."""
        initial = super().get_initial()
        user = self.request.user

        emp_id = getattr(user, 'employee_id', None)
        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects.filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date,
                    'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id,
                    'name': latest_work_info.name,
                    'section': latest_work_info.section,
                    'line': latest_work_info.line,
                    'group': latest_work_info.group,
                    'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "âš ï¸ No Work Information found. Some fields may be empty.")
        return initial

    def form_valid(self, form):
        """Handle form submission and save safely."""
        user = self.request.user

        # Safely load aggregated data JSON (if sent from frontend)
        aggregated_data_json = self.request.POST.get('aggregated_data', '{}')
        try:
            aggregated_data = json.loads(aggregated_data_json)
        except json.JSONDecodeError:
            messages.error(self.request, "Error processing form data. Please try again.")
            return self.form_invalid(form)

        # Avoid overwriting sensitive fields
        sensitive_fields = {'id', 'pk', 'created_at', 'updated_at'}
        for key, value in aggregated_data.items():
            if hasattr(form.instance, key) and key not in sensitive_fields:
                setattr(form.instance, key, value)

        # Optionally track who created the record (if field exists)
        if hasattr(form.instance, 'created_by'):
            form.instance.created_by = user

        messages.success(self.request, "âœ… IPQC Disassemble Checklist submitted successfully!")
        return super().form_valid(form)
    
    
class NCIssueTrackingListView(RoleRequiredMixin, LoginRequiredMixin, ListView):
    allowed_roles = ["IPQC"]
    model = NCIssueTracking
    template_name = 'ipqc/nc_issue_tracking_list.html'
    context_object_name = 'records'
    paginate_by = 20  # show 20 per page

    def get_queryset(self):
        """Optional search and filter by date, model, or employee."""
        queryset = super().get_queryset().order_by('-created_at')
        query = self.request.GET.get('q', '').strip()
        if query:
            queryset = queryset.filter(
                Q(name__icontains=query) |
                Q(emp_id__icontains=query) |
                Q(model__icontains=query) |
                Q(color__icontains=query)
            )
        return queryset
    
class ESDComplianceChecklistCreateView(RoleRequiredMixin, LoginRequiredMixin, CreateView):
    allowed_roles = ["IPQC"]
    model = ESDComplianceChecklist
    form_class = ESDComplianceChecklistForm
    template_name = 'ipqc/esd_compliance_checklist_form.html'
    success_url = reverse_lazy('esd_compliance_checklist_list')
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)

    def get_initial(self):
        """Prefill form fields based on logged-in user and latest work info."""
        initial = super().get_initial()
        user = self.request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects.filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date,
                    'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id,
                    'name': latest_work_info.name,
                    'line': latest_work_info.line,
                    'group': latest_work_info.group,
                    'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "âš ï¸ No Work Information found. Some fields may be empty.")
        else:
            messages.warning(self.request, "âš ï¸ No Employee ID found for current user.")

        return initial

    def form_valid(self, form):
        """Save form normally and attach creator info if applicable."""
        if hasattr(form.instance, 'created_by'):
            form.instance.created_by = self.request.user
        response = super().form_valid(form)
        messages.success(self.request, "âœ… ESD Compliance Checklist submitted successfully!")
        return response

class ESDComplianceCheckListView(RoleRequiredMixin, LoginRequiredMixin, ListView):
    allowed_roles = ["IPQC", "admin", "superuser"]
    model = ESDComplianceChecklist
    template_name = 'ipqc/esd_compliance_checklist_list.html'
    context_object_name = 'records'
    paginate_by = 10

    def get_queryset(self):
        queryset = super().get_queryset().order_by('-date', '-created_at')
        search_query = self.request.GET.get('q')

        if search_query:
            queryset = queryset.filter(
                Q(name__icontains=search_query) |
                Q(emp_id__icontains=search_query) |
                Q(line__icontains=search_query) |
                Q(model__icontains=search_query)
            )

        return queryset
    
    def get_overall_status(self):
        audit_fields = [f.name for f in self._meta.fields if f.choices]
        
        ok_count = 0
        not_ok_count = 0
        na_count = 0
        
        for field_name in audit_fields:
            value = getattr(self, field_name)
            if value == 'OK':
                ok_count += 1
            elif value == 'NOT_OK':
                not_ok_count += 1
            elif value == 'NA':
                na_count += 1

        if not_ok_count > 0:
            return 'FAIL'
        if ok_count > 0 and na_count > 0:
            return 'MIXED'
        if ok_count > 0:
            return 'PASS'
            
        return 'N/A'

    def __str__(self):
        return f"{self.date} - {self.line} - {self.name}"
    
    def get_context_data(self, **kwargs):
        # Call the base implementation first to get the existing context
        context = super().get_context_data(**kwargs)
        
        # We use the base model's queryset for stats, so search doesn't affect the counts
        base_queryset = self.model.objects.all()
        
        # Get today's date
        today = timezone.now().date()
        
        # Calculate statistics
        context['total_records'] = base_queryset.count()
        context['today_records'] = base_queryset.filter(date=today).count()
        
        # Calculate the start of the current week (Monday is day 0)
        start_of_week = today - timedelta(days=today.weekday())
        context['week_records'] = base_queryset.filter(date__gte=start_of_week).count()
        
        # The updated context is returned automatically
        return context

@require_GET
def esd_compliance_checklist_details(request, pk):
    """AJAX endpoint to fetch ESD checklist details in a structured format."""
    record = get_object_or_404(ESDComplianceChecklist, pk=pk)
    
    def get_verbose_name(field_name):
        try:
            return record._meta.get_field(field_name).verbose_name
        except:
            return field_name.replace('_', ' ').title()

    # --- Basic Info ---
    basic_info = {
        'date': {'label': 'Date', 'value': record.date.strftime('%d-%m-%Y')},
        'shift': {'label': 'Shift', 'value': record.shift},
        'emp_id': {'label': 'Employee ID', 'value': record.emp_id},
        'name': {'label': 'Employee Name', 'value': record.name},
        'line': {'label': 'Line', 'value': record.line},
        'group': {'label': 'Group', 'value': record.group},
        'model': {'label': 'Model', 'value': record.model},
        'color': {'label': 'Color', 'value': record.color},
    }
    
    sections = {
        'clothing': {
            'title': 'Clothing Rules', 'icon': 'fa-tshirt',
            'fields': [
                'epa_clothes', 'forbid_wear_out', 'no_accessories', 'clothes_clean',
                'collar_cover', 'all_buttons_closed', 'clothes_length', 'watch_expose', 'hair_cap'
            ]
        },
        'wristband': {
            'title': 'Wristband & Slipper', 'icon': 'fa-hand-paper',
            'fields': ['slipper_check', 'wristband_check', 'pre_line_check', 'wrist_touch_skin']
        },
        'handling': {
            'title': 'Handling Rules', 'icon': 'fa-hand-sparkles',
            'fields': ['no_touch_pcba', 'alert_plug_out']
        },
        'grounding': {
            'title': 'Grounding & Equipment', 'icon': 'fa-plug',
            'fields': ['trolley_grounding', 'device_grounded', 'grounding_points_tight', 'ion_fan_distance', 'ion_fan_direction']
        },
        'consumables': {
            'title': 'Consumables', 'icon': 'fa-box',
            'fields': ['gloves_condition', 'mat_grounded', 'audit_label_valid']
        },
        'material': {
            'title': 'Material Handling', 'icon': 'fa-boxes',
            'fields': ['esds_box', 'table_no_source']
        },
        'tools': {
            'title': 'Tools & Environment', 'icon': 'fa-tools',
            'fields': ['tools_audit', 'temp_humidity', 'tray_voltage']
        }
    }
    
    compliance_data = {}
    for key, section in sections.items():
        compliance_data[key] = {
            'title': section['title'],
            'icon': section['icon'],
            'items': []
        }
        for field_name in section['fields']:
            compliance_data[key]['items'].append({
                'label': get_verbose_name(field_name),
                'value': getattr(record, field_name),
            })

    readings = {
        'temperature_value': {'label': 'Temperature (Â°C)', 'value': record.temperature_value},
        'humidity_value': {'label': 'Humidity (%)', 'value': record.humidity_value},
        'tray_voltage_value': {'label': 'Tray Voltage (V)', 'value': record.tray_voltage_value},
    }
    
    photo_fields = {
        'epa_clothes_photo': 'EPA Clothes',
        'hair_cap_photo': 'Hair Cap',
        'wristband_photo': 'Wristband',
        'trolley_photo': 'Trolley Grounding',
        'ion_fan_photo': 'Ion Fan',
        'mat_photo': 'ESD Mat',
        'table_photo': 'Working Table',
        'photo_overview': 'Overview'
    }
    available_photos = []
    for field, label in photo_fields.items():
        photo = getattr(record, field)
        if photo:
            url = photo.url if photo.url.startswith('/media/') else f"{settings.MEDIA_URL}{photo}"
            available_photos.append({'url': url, 'label': label})

    # --- ROBUST MODIFICATION ---
    # Try to get the status, but don't crash if the method is missing.
    overall_status = 'N/A'
    if hasattr(record, 'get_overall_status'):
        overall_status = record.get_overall_status()
    # --- END OF MODIFICATION ---

    data = {
        'basic_info': basic_info,
        'compliance': compliance_data,
        'readings': readings,
        'photos': available_photos,
        'remark': record.remark,
        'overall_status': overall_status,
        'created_at': record.created_at.strftime('%Y-%m-%d %H:%M:%S'),
    }
    return JsonResponse(data)
    
class DustCountCreateView(RoleRequiredMixin, LoginRequiredMixin, CreateView):
    allowed_roles = ["IPQC"]
    model = DustCountCheck
    form_class = DustCountCheckForm
    template_name = 'ipqc/dust_count_checklist_form.html'
    success_url = reverse_lazy('dust_count_checklist_list')
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)

    def get_initial(self):
        """Prefill form fields based on logged-in user and latest work info."""
        initial = super().get_initial()
        user = self.request.user
        emp_id = getattr(user, 'employee_id', None)
        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects.filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date,
                    'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id,
                    'name': latest_work_info.name,
                    'section': latest_work_info.section,
                    'line': latest_work_info.line,
                    'group': latest_work_info.group,
                    'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "âš ï¸ No Work Information found. Some fields may be empty.")
        return initial

    def form_valid(self, form):
        """Save the form normally and set created_by if needed."""
        if hasattr(form.instance, 'created_by'):
            form.instance.created_by = self.request.user
        response = super().form_valid(form)
        messages.success(self.request, "âœ… ESD Compliance Checklist submitted successfully!")
        return response

class DustCountListView(ListView):
    model = DustCountCheck
    template_name = 'ipqc/dust_count_checklist_list.html'
    context_object_name = 'records'
    paginate_by = 10  # optional, for pagination

    def get_queryset(self):
        queryset = super().get_queryset().order_by('-date', '-created_at')
        search_query = self.request.GET.get('q')
        if search_query:
            queryset = queryset.filter(
                Q(name__icontains=search_query) |
                Q(emp_id__icontains=search_query) |
                Q(line__icontains=search_query)
            )
        return queryset
    
class TestingFirstArticleInspectionCreateView(LoginRequiredMixin, CreateView):
    model = TestingFirstArticleInspection
    form_class = TestingFirstArticleInspectionForm
    template_name = 'ipqc/testing_fai_form.html'
    success_url = reverse_lazy('testing_fai_list')
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)
    
    def get_initial(self):
        initial = super().get_initial()
        user = self.request.user
        emp_id = getattr(user, 'employee_id', None)
        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects. filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date, 'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id, 'name': latest_work_info.name,
                    'section': getattr(latest_work_info, 'section', ''), 'line': latest_work_info.line,
                    'group': latest_work_info.group, 'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "âš ï¸ No pre-filled work information found.")
        initial['inspector_name'] = getattr(user, 'full_name', None) or user.username
        return initial
    
    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs
    
    def form_valid(self, form):
        response = super().form_valid(form)
        instance = self. object  # Get the saved record
        public_link = self.request.build_absolute_uri(reverse('testing_fai_public_update', args=[str(instance.public_token)]))
        instance.public_url = public_link
        instance.save(update_fields=['public_url'])
        messages.success(self.request, f"âœ… Record created! QE link generated.")
        return response
    
    def form_invalid(self, form):
        messages.error(self.request, "âŒ Error creating FAI record. Please check the form for errors.")
        return super().form_invalid(form)
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['page_title'] = 'First Article Inspection (FAI)'
        context['breadcrumbs'] = [
            {'name': 'dashboard', 'url': reverse_lazy('ipqc_home')},
            {'name': 'FAI List', 'url': reverse_lazy('testing_fai_list')},
            {'name': 'New FAI', 'url': reverse_lazy('testing_fai_create')},
        ]
        return context
 
class TestingFirstArticleInspectionListView(LoginRequiredMixin, ListView):
    model = TestingFirstArticleInspection
    template_name = 'ipqc/testing_fai_list.html'
    context_object_name = 'fai_records'
    paginate_by = 10
    ordering = ['-date', '-created_at']
 
    def get_queryset(self):
        user = self.request.user
        queryset = super().get_queryset()
        search_query = self.request.GET.get('q')

        if search_query:
            queryset = queryset.filter(
                Q(inspector_name__icontains=search_query) |
                Q(model__icontains=search_query) |
                Q(color__icontains=search_query) |
                Q(imei_number__icontains=search_query)
            )

        if user.is_superuser or user.groups.filter(name__in=['Admin', 'QA']).exists():
            return queryset
        else:
            inspector_name = getattr(user, 'full_name', None) or getattr(user, 'name', None) or getattr(user, 'username', None) or str(user)
            return queryset.filter(inspector_name=inspector_name)
 
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Add statistics - call get_queryset() without arguments to respect permissions
        queryset_for_stats = self.get_queryset()
        
        # Add statistics
        today = timezone.now().date()
        week_start = today - timezone.timedelta(days=today.weekday())
        
        context.update({
            'page_title': 'FAI Records',
            'fai_stats': {
                'today': queryset_for_stats.filter(date=today).count(),
                'week': queryset_for_stats.filter(date__gte=week_start).count(),
                'total': queryset_for_stats.count(),
            },
            'breadcrumbs': [
                {'name': 'Dashboard', 'url': reverse_lazy('ipqc_home')}, 
                {'name': 'FAI List', 'url': '#'}
            ]
        })
        return context
 
class TestingFirstArticleInspectionDetailView(LoginRequiredMixin, DetailView):
    model = TestingFirstArticleInspection
    template_name = 'ipqc/testing_fai_detail.html'
    context_object_name = 'fai_record'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context.update({
            'page_title': f'FAI Detail - {self.object.model}',
            'breadcrumbs': [
                {'name': 'dashboard', 'url': reverse_lazy('ipqc_home')},
                {'name': 'FAI List', 'url': reverse_lazy('testing_fai_list')},
                {'name': f'{self.object.model}', 'url': '#'}
            ]
        })
        return context
 
def download_testing_fai_evidence(request, pk, evidence_type):
    """Download an evidence file, checking for permissions."""
    fai = get_object_or_404(TestingFirstArticleInspection, pk=pk)
    if not (request.user.is_superuser or 
 request.user.groups. filter(name__in=['Admin', 'QA']).exists() or
            fai.inspector_name == (request.user.full_name() or request.user.username)):
        raise Http404("Permission denied.")
 
    evidence_fields = {
        'label_photo': fai.label_check_evidence, 'label_position_photo': fai.label_position_check_evidence,
        'logo_photo': fai.logo_check_evidence, 'assembly_photo': fai.assembly_battery_check_evidence,
        'boot_video': fai.boot_time_test_evidence, 'cam_front_photo': fai.camera_front_test_evidence,
        'cam_back_photo': fai.camera_back_test_evidence, 'cam_dark_photo': fai.camera_dark_test_evidence,
        'temp_cam_photo': fai.high_temp_camera_test_evidence, 'imei_photo': fai.imei_photo,
    }
    file = evidence_fields.get(evidence_type)
    if not file or not file.name:
        raise Http404("Evidence file not found.")
    
    response = HttpResponse(file.read(), content_type='application/octet-stream')
    response['Content-Disposition'] = f'attachment; filename="{os.path.basename(file.name)}"'
    return response
 

def testing_fai_public_qe_update_view(request, public_token):
    """Public form for QE to fill name and approval status"""
    fai_record = get_object_or_404(TestingFirstArticleInspection, public_token=public_token)
    if request.method == "POST":
        qe_name = request. POST.get("qe_confirm_name")
        qe_status = request. POST.get("qe_confirm_status")
        if qe_name and qe_status:
            fai_record.qe_confirm_name = qe_name
            fai_record.qe_confirm_status = qe_status
            if not fai_record.public_url:
                fai_record.public_url = request.build_absolute_uri(reverse('testing_fai_public_update', args=[str(fai_record.public_token)]))
            fai_record.save(update_fields=["qe_confirm_name", "qe_confirm_status", "public_url"])
            messages.success(request, "âœ… QE confirmation submitted successfully.")
            return redirect(request.path)
        else:
            messages.error(request, "âš ï¸ Please fill all required fields.")
    return render(request, "ipqc/testing_fai_public_qe_update.html", {"fai_record": fai_record})
 
class TestingFAIDetailsJsonView(LoginRequiredMixin, DetailView):
    """Returns FAI record details as JSON for the modal."""
    model = TestingFirstArticleInspection
    
    def render_to_response(self, context, **response_kwargs):
        obj = self.get_object()
        data = {
            'date': obj.date.strftime('%Y-%m-%d'),
            'Shift': obj.shift, 'EMP_ID': obj.emp_id, 'Name': obj.name,
            'section': obj.section, 'line': obj.line, 'group': obj.group,
            'model': obj.model, 'color': obj.color,
            'production_work_order_no': obj.production_work_order_no,
            'first_article_type': obj.get_first_article_type_display(),
            'visual_functional_result': obj.visual_functional_result,
            'reliability_result': obj.reliability_result,
            'qe_confirm_name': obj.qe_confirm_name,
            'qe_confirm_status': obj.qe_confirm_status,
            'inspector_name': obj.inspector_name,
            'sample_serial_number': obj.sample_serial_number,
            'imei_number': obj.imei_number,
            'public_url': obj.public_url,
            'created_at': obj.created_at.strftime('%Y-%m-%d %H:%M'),
            'photos': []
        }
        # Add all check results dynamically
        for field in obj._meta.fields:
            if field.name.endswith(('_check', '_test')) and field.choices:
                data[field.name] = getattr(obj, field.name)
        
        # Add evidence photos
        photo_labels = {
            'label_check_evidence': 'Label Check Photo',
            'label_position_check_evidence': 'Label Position Photo',
            'logo_check_evidence': 'Logo Photo',
            'assembly_battery_check_evidence': 'Assembly Photo',
            'camera_front_test_evidence': 'Front Camera Photo',
            'camera_back_test_evidence': 'Back Camera Photo',
            'camera_dark_test_evidence': 'Dark Condition Photo',
            'high_temp_camera_test_evidence': 'High Temp Camera Photo',
            'imei_photo': 'IMEI Verification Photo'
        }
        for field_name, label in photo_labels.items():
            file = getattr(obj, field_name)
            if file:
                data['photos'].append({'url': file.url, 'label': label})
 
        return JsonResponse(data)

class OperatorQualificationCheckCreateView(CreateView):
    model = OperatorQualificationCheck
    form_class = OperatorQualificationCheckForm
    template_name = "ipqc/operator_qualification_form.html"
    success_url = reverse_lazy("operator_qualification_list")
    
    def dispatch(self, request, *args, **kwargs):
        """Check if user filled Work Info for today before allowing access."""
        user = request.user
        emp_id = getattr(user, 'employee_id', None)

        if emp_id:
            now = timezone.localtime()
            today = now.date()

            # Define today's 8 AM range (same as your home_view logic)
            today_8am = now.replace(hour=8, minute=0, second=0, microsecond=0)
            start_time = today_8am - timedelta(days=1) if now < today_8am else today_8am
            end_time = start_time + timedelta(days=1)

            has_filled = IPQCWorkInfo.objects.filter(
                emp_id=emp_id,
                created_at__range=[start_time, end_time]
            ).exists()

            if not has_filled:
                messages.warning(request, "âš ï¸ You haven't filled your Work Info for today. Please fill it before proceeding.")
                return redirect('ipqc_work_info')

        return super().dispatch(request, *args, **kwargs)

    def get_initial(self):
        initial = super().get_initial()
        user = self.request.user
        emp_id = getattr(user, 'employee_id', None)
        if emp_id:
            try:
                latest_work_info = IPQCWorkInfo.objects.filter(emp_id=emp_id).latest('created_at')
                initial.update({
                    'date': latest_work_info.date, 'shift': latest_work_info.shift,
                    'emp_id': latest_work_info.emp_id, 'name': latest_work_info.name,
                    'section': getattr(latest_work_info, 'section', ''), 'line': latest_work_info.line,
                    'group': latest_work_info.group, 'model': latest_work_info.model,
                    'color': latest_work_info.color,
                })
            except IPQCWorkInfo.DoesNotExist:
                messages.warning(self.request, "âš ï¸ No pre-filled work information found.")
        return initial

    def form_valid(self, form):
        """Save the scanned Feishu URL in DB."""
        scanned_url = self.request.POST.get("scanned_result")
        if scanned_url:
            form.instance.scanned_barcode_text = scanned_url
            messages.success(self.request, "âœ… QR/Barcode scanned and saved successfully.")
        else:
            messages.warning(self.request, "âš ï¸ No QR/Barcode scanned.")
        return super().form_valid(form)

    def get_context_data(self, **kwargs):
        """Pass scanned URL to template for preview link."""
        context = super().get_context_data(**kwargs)
        scanned_url = self.request.GET.get("scanned_url")
        if scanned_url:
            context["scanned_url"] = scanned_url
        return context

class OperatorQualificationCheckListView(ListView):
    model = OperatorQualificationCheck
    template_name = 'ipqc/operator_qualification_list.html'
    context_object_name = 'records'
    ordering = ['-created_at']
    paginate_by = 10

    def get_queryset(self):
        queryset = super().get_queryset()
        q = self.request.GET.get('q')
        if q:
            queryset = queryset.filter(
                models.Q(emp_id__icontains=q) |
                models.Q(name__icontains=q) |
                models.Q(model__icontains=q) |
                models.Q(color__icontains=q) |
                models.Q(line__icontains=q)
            )
        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Statistics
        today = timezone.now().date()
        week_ago = today - timedelta(days=7)
        
        context['stats'] = {
            'today': OperatorQualificationCheck.objects.filter(date=today).count(),
            'week': OperatorQualificationCheck.objects.filter(date__gte=week_ago).count(),
            'total': OperatorQualificationCheck.objects.count(),
        }
        
        return context

def operator_qualification_detail(request, pk):
    """AJAX view to get record details for modal"""
    record = get_object_or_404(OperatorQualificationCheck, pk=pk)
    
    data = {
        'date': record.date.strftime('%Y-%m-%d'),
        'shift': record.shift,
        'emp_id': record.emp_id,
        'name': record.name,
        'section': record.section,
        'line': record.line,
        'group': record.group,
        'model': record.model,
        'color': record.color,
        'key_station_name': record.key_station_name,
        'key_station_job_card_status': record.key_station_job_card_status,
        'key_station_operator_status': record.key_station_operator_status,
        'new_or_rotating_operator_status': record.new_or_rotating_operator_status,
        'check_operator_work_instruction': record.check_operator_work_instruction,
        'pqe_training_and_verification_status': record.pqe_training_and_verification_status,
        'job_card_verification_summary': record.job_card_verification_summary,
        'scanned_barcode_text': record.scanned_barcode_text,
        'created_at': record.created_at.strftime('%Y-%m-%d %H:%M'),
    }
    
    # Add photos if available
    photos = []
    if record.scanned_barcode_image:
        photos.append({
            'url': record.scanned_barcode_image.url,
            'label': 'Scanned Barcode Image'
        })
    if record.operator_job_card_image:
        photos.append({
            'url': record.operator_job_card_image.url,
            'label': 'Operator Job Card'
        })
    data['photos'] = photos
    
    return JsonResponse(data)


transs_flow/templates/accounts/dashboards.html:

	{% extends 'base.html' %}
	{% block title %}Account Home{% endblock %}
	{% block content %}
	<div class="space-y-6">
	    <!-- Header Stats -->
	    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
	        <!-- Total Employees -->
	        <div class="metric-card">
	            <div class="flex items-start justify-between">
	                <div>
	                    <div class="metric-value">{{ total_employees }}</div>
	                    <div class="metric-label">Total Employees</div>
	                </div>
	                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
	                    <i class="fas fa-users text-blue-600 text-xl"></i>
	                </div>
	            </div>
	        </div>
	        <!-- Active Users -->
	        <div class="metric-card">
	            <div class="flex items-start justify-between">
	                <div>
	                    <div class="metric-value">{{ total_employees }}</div>
	                    <div class="metric-label">Active Now</div>
	                    <div class="metric-change positive">
	                        <i class="fas fa-circle text-xs mr-1"></i>All online
	                    </div>
	                </div>
	                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
	                    <i class="fas fa-user-check text-green-600 text-xl"></i>
	                </div>
	            </div>
	        </div>
	        <!-- Today's Activity -->
	        <div class="metric-card">
	            <div class="flex items-start justify-between">
	                <div>
	                    <div class="metric-value">{{ today_records }}</div>
	                    <div class="metric-label">Today's Activity</div>
	                    <div class="metric-change positive">
	                        <i class="fas fa-arrow-up mr-1"></i>Records
	                    </div>
	                </div>
	                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
	                    <i class="fas fa-chart-line text-purple-600 text-xl"></i>
	                </div>
	            </div>
	        </div>
	        <!-- System Status -->
	        <div class="metric-card">
	            <div class="flex items-start justify-between">
	                <div>
	                    <div class="metric-value">Online</div>
	                    <div class="metric-label">System Status</div>
	                    <div class="metric-change positive">
	                        <i class="fas fa-check-circle mr-1"></i>Operational
	                    </div>
	                </div>
	                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
	                    <i class="fas fa-server text-green-600 text-xl"></i>
	                </div>
	            </div>
	        </div>
	    </div>
	    <!-- Quick Actions -->
	    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
	        <h2 class="text-lg font-bold mb-6 text-gray-900">
	            <i class="fas fa-rocket mr-2 text-blue-500"></i>
	            Quick Actions
	        </h2>
	        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
	            <a href="{% url 'employee_create' %}" class="quick-action">
	                <i class="fas fa-user-plus text-blue-500"></i>
	                <div class="label">Add Employee</div>
	                <div class="desc">Create new employee</div>
	            </a>
	            <a href="{% url 'create_dynamic_form' %}" class="quick-action">
	                <i class="fas fa-wpforms text-purple-500"></i>
	                <div class="label">Create Form</div>
	                <div class="desc">Design new form</div>
	            </a>
	            <a href="#" class="quick-action">
	                <i class="fas fa-download text-green-500"></i>
	                <div class="label">Export Data</div>
	                <div class="desc">Download reports</div>
	            </a>
	            <a href="#" class="quick-action">
	                <i class="fas fa-cog text-gray-500"></i>
	                <div class="label">Settings</div>
	                <div class="desc">System configuration</div>
	            </a>
	        </div>
	    </div>
	    <!-- Recent Activity -->
	    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
	        <h2 class="text-lg font-bold mb-6 text-gray-900">
	            <i class="fas fa-history mr-2 text-purple-500"></i>
	            Recent Activity
	        </h2>
	        <div class="space-y-4">
	            {% for activity in recent_activities %}
	                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors border border-gray-200">
	                    <div class="flex items-center">
	                        <div class="w-3 h-3 bg-{{ activity.color|default:'blue' }}-500 rounded-full"></div>
	                        <div class="ml-4">
	                            <p class="text-sm font-medium text-gray-900">{{ activity.title }}</p>
	                            <p class="text-xs text-gray-500">{{ activity.timestamp }}</p>
	                        </div>
	                    </div>
	                    <span class="text-xs font-medium px-2 py-1 bg-gray-200 text-gray-700 rounded-full">
	                        {{ activity.status }}
	                    </span>
	                </div>
	            {% empty %}
	                <div class="text-center py-8 text-gray-500">
	                    <i class="fas fa-inbox text-4xl mb-3 block text-gray-300"></i>
	                    <div class="text-lg font-medium">No recent activity</div>
	                    <div class="text-sm mt-1">Check back later for updates</div>
	                </div>
	            {% endfor %}
	        </div>
	    </div>
	</div>
	{% endblock %}


transs_flow/templates/accounts/employee_create.html:

{% extends 'base.html' %}
{% block title %}Add New Employee{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-user-plus mr-3 text-blue-500"></i>
            Add New Employee
        </h1>
        <p class="text-gray-600 mt-2">Create a new user account for the manufacturing system</p>
    </div>

    <!-- Creation Form -->
    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <!-- Personal Information -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-id-card mr-2 text-blue-500"></i>
                    Personal Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Employee ID *</label>
                        <input type="text" name="employee_id" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Enter unique employee ID">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                        <input type="text" name="full_name" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Enter full name">
                    </div>
                </div>
            </div>

            <!-- Job Information -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-briefcase mr-2 text-purple-500"></i>
                    Job Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                        <select name="role" required
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                            <option value="">Select Role</option>
                            <option value="IPQC">IPQC</option>
                            <option value="QA">QA</option>
                            <option value="Admin">Admin</option>
                            <option value="Supervisor">Supervisor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Department *</label>
                        <input type="text" name="department" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Enter department">
                    </div>
                </div>
            </div>

            <!-- Factory Information -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-industry mr-2 text-green-500"></i>
                    Factory Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Factory Code *</label>
                        <input type="text" name="factory_code" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Enter factory code">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Factory Name *</label>
                        <input type="text" name="factory_name" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Enter factory name">
                    </div>
                </div>
            </div>

            <!-- Location Information -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-globe mr-2 text-blue-500"></i>
                    Location Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Country Code *</label>
                        <input type="text" name="country_code" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Enter country code">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Country Name *</label>
                        <input type="text" name="country_name" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Enter country name">
                    </div>
                </div>
            </div>

            <!-- System Permissions -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-shield-alt mr-2 text-orange-500"></i>
                    System Permissions
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <input type="checkbox" name="is_active" checked
                               class="w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500">
                        <label class="ml-2 text-sm text-gray-700">Active Employee</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_staff" 
                               class="w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500">
                        <label class="ml-2 text-sm text-gray-700">Staff Access</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_superuser" 
                               class="w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500">
                        <label class="ml-2 text-sm text-gray-700">Superuser Access</label>
                    </div>
                </div>
            </div>

            <!-- Password -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-key mr-2 text-pink-500"></i>
                    Security Credentials
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" name="password" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Enter secure password">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password *</label>
                        <input type="password" name="password2" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Confirm password">
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Password must be at least 8 characters with uppercase, lowercase, numbers and special characters
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center pt-4">
                <button type="submit" 
                        class="btn btn-primary px-8 py-3">
                    <i class="fas fa-user-plus mr-2"></i>
                    Create Employee Account
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

transs_flow/templates/accounts/employee_edit.html:

{% extends 'base.html' %}
{% block title %}Edit Employee{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-user-edit mr-3 text-blue-500"></i>
                    Edit Employee: {{ employee.full_name }}
                </h1>
                <p class="text-gray-600 mt-1">Update employee information and permissions</p>
            </div>
            <a href="{% url 'employee_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to List
            </a>
        </div>
    </div>

    <!-- Edit Form -->
    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <!-- Personal Information -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-id-card mr-2 text-blue-500"></i>
                    Personal Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Employee ID</label>
                        <input type="text" name="employee_id" value="{{ employee.employee_id }}" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" name="full_name" value="{{ employee.full_name }}" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    </div>
                </div>
            </div>

            <!-- Job Information -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-briefcase mr-2 text-purple-500"></i>
                    Job Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select name="role" required
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                            <option value="">Select Role</option>
                            <option value="IPQC" {% if employee.role == 'IPQC' %}selected{% endif %}>IPQC</option>
                            <option value="QA" {% if employee.role == 'QA' %}selected{% endif %}>QA</option>
                            <option value="Admin" {% if employee.role == 'Admin' %}selected{% endif %}>Admin</option>
                            <option value="Supervisor" {% if employee.role == 'Supervisor' %}selected{% endif %}>Supervisor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <input type="text" name="department" value="{{ employee.department }}" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    </div>
                </div>
            </div>

            <!-- Factory Information -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-industry mr-2 text-green-500"></i>
                    Factory Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Factory Code</label>
                        <input type="text" name="factory_code" value="{{ employee.factory_code }}" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Factory Name</label>
                        <input type="text" name="factory_name" value="{{ employee.factory_name }}" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    </div>
                </div>
            </div>

            <!-- Location Information -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-globe mr-2 text-blue-500"></i>
                    Location Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Country Code</label>
                        <input type="text" name="country_code" value="{{ employee.country_code }}" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Country Name</label>
                        <input type="text" name="country_name" value="{{ employee.country_name }}" required
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    </div>
                </div>
            </div>

            <!-- System Permissions -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-shield-alt mr-2 text-orange-500"></i>
                    System Permissions
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <input type="checkbox" name="is_active" {% if employee.is_active %}checked{% endif %} 
                               class="w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500">
                        <label class="ml-2 text-sm text-gray-700">Active Employee</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_staff" {% if employee.is_staff %}checked{% endif %} 
                               class="w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500">
                        <label class="ml-2 text-sm text-gray-700">Staff Access</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_superuser" {% if employee.is_superuser %}checked{% endif %} 
                               class="w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500">
                        <label class="ml-2 text-sm text-gray-700">Superuser Access</label>
                    </div>
                </div>
            </div>

            <!-- Password Section -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-900">
                    <i class="fas fa-key mr-2 text-pink-500"></i>
                    Password Management
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                        <input type="password" name="password" 
                               class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                               placeholder="Leave blank to keep current password">
                    </div>
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        Leave blank to keep current password. Enter new password only if you want to change it.
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 pt-4">
                <button type="submit" 
                        class="btn btn-primary">
                    <i class="fas fa-save mr-2"></i>
                    Update Employee
                </button>
                <a href="{% url 'employee_list' %}" 
                   class="btn btn-secondary">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

transs_flow/templates/accounts/employee_list.html:

	{% extends 'base.html' %}
	{% block title %}Employee Management{% endblock %}
	{% block content %}
	<div class="space-y-6">
	    <!-- Header -->
	    <div class="mb-6">
	        <div class="flex items-center justify-between">
	            <div>
	                <h1 class="text-2xl font-bold text-gray-900">
	                    <i class="fas fa-users mr-3 text-blue-500"></i>
	                    Employee Management
	                </h1>
	                <p class="text-gray-600 mt-1">Manage employee accounts and permissions</p>
	            </div>
	            <a href="{% url 'employee_create' %}" class="btn btn-primary">
	                <i class="fas fa-user-plus mr-2"></i>
	                Add New Employee
	            </a>
	        </div>
	    </div>
	    <!-- Search Bar -->
	    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
	        <div class="flex items-center space-x-4">
	            <div class="flex-1 relative">
	                <input type="text" id="searchInput" placeholder="Search employees..." 
	                       class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 pl-10"
	                       onkeyup="filterTable()">
	                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
	            </div>
	            <button class="btn btn-secondary">
	                <i class="fas fa-filter"></i>
	            </button>
	        </div>
	    </div>
	    <!-- Employee Table -->
	    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
	        <div class="overflow-x-auto">
	            <table class="w-full" id="employeeTable">
	                <thead class="bg-gray-50 border-b border-gray-200">
	                    <tr>
	                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
	                            <i class="fas fa-hashtag mr-1"></i> ID
	                        </th>
	                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
	                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Role</th>
	                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Department</th>
	                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Factory</th>
	                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
	                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
	                    </tr>
	                </thead>
	                <tbody class="divide-y divide-gray-200">
	                    {% for employee in employees %}
	                        <tr class="hover:bg-gray-50 transition-colors">
	                            <td class="px-4 py-3 text-sm font-mono text-gray-900">{{ employee.employee_id }}</td>
	                            <td class="px-4 py-3 text-sm text-gray-900">
	                                <div class="flex items-center">
	                                    <div class="w-2 h-2 bg-{{ employee.is_active|yesno:'green' }}-500 rounded-full mr-2"></div>
	                                    {{ employee.full_name }}
	                                </div>
	                            </td>
	                            <td class="px-4 py-3 text-sm text-gray-900">
	                                <span class="status-badge status-idle">{{ employee.role }}</span>
	                            </td>
	                            <td class="px-4 py-3 text-sm text-gray-900">{{ employee.department }}</td>
	                            <td class="px-4 py-3 text-sm text-gray-900">{{ employee.factory_code }}</td>
	                            <td class="px-4 py-3 text-center">
	                                {% if employee.is_active %}
	                                    <span class="status-badge status-running">Active</span>
	                                {% else %}
	                                    <span class="status-badge status-stop">Inactive</span>
	                                {% endif %}
	                            </td>
	                            <td class="px-4 py-3 text-center">
	                                <div class="flex items-center justify-center space-x-2">
	                                    <a href="{% url 'employee_edit' employee.id %}" 
	                                       class="text-blue-600 hover:text-blue-800 transition-colors"
	                                       title="Edit Employee">
	                                        <i class="fas fa-edit"></i>
	                                    </a>
	                                    <a href="{% url 'employee_delete' employee.id %}" 
	                                       class="text-red-600 hover:text-red-800 transition-colors"
	                                       title="Delete Employee"
	                                       onclick="return confirm('Delete {{ employee.full_name }}?')">
	                                        <i class="fas fa-trash"></i>
	                                    </a>
	                                </div>
	                            </td>
	                        </tr>
	                    {% empty %}
	                        <tr>
	                            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
	                                <i class="fas fa-inbox text-4xl mb-3 block text-gray-300"></i>
	                                <div class="text-lg font-medium">No employees found</div>
	                                <div class="text-sm mt-1">Create your first employee to get started</div>
	                            </td>
	                        </tr>
	                    {% endfor %}
	                </tbody>
	            </table>
	        </div>
	    </div>
	</div>
	<script>
	    function filterTable() {
	        const input = document.getElementById('searchInput');
	        const filter = input.value.toLowerCase();
	        const rows = document.querySelectorAll('#employeeTable tbody tr');
	        rows.forEach(row => {
	            const text = row.textContent.toLowerCase();
	            if (text.includes(filter)) {
	                row.style.display = '';
	            } else {
	                row.style.display = 'none';
	            }
	        });
	    }
	</script>
	{% endblock %}

transs_flow/templates/accounts/login.html:

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transs Flow - Manufacturing Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ====== CSS Variables ====== */
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --darker: #0f172a;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-light: #64748b;
            --light: #f8fafc;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --border: #cbd5e1;
            --sidebar-width: 280px;
            --header-height: 73px;
            --transition-speed: 0.3s;
        }

        /* ====== Base Styles ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            overflow-x: hidden;
            font-size: 15px;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        }

        /* ====== Login Container ====== */
        .login-container {
            width: 100%;
            max-width: 450px;
            padding: 2rem;
        }

        .login-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        /* ====== Logo Section ====== */
        .logo-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            box-shadow: 0 8px 20px rgba(14, 165, 233, 0.25);
        }

        .logo i {
            font-size: 2.5rem;
            color: white;
        }

        .app-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .app-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* ====== Form Styles ====== */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .input-icon {
            position: relative;
        }

        .input-icon i {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* ====== Button Styles ====== */
        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        /* ====== Alert Styles ====== */
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* ====== Footer ====== */
        .login-footer {
            text-align: center;
            margin-top: 2rem;
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .login-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }

        /* ====== Animations ====== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        /* ====== Responsive Design ====== */
        @media (max-width: 480px) {
            .login-container {
                padding: 1rem;
            }
            
            .login-card {
                padding: 1.5rem;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .logo i {
                font-size: 2rem;
            }
            
            .app-title {
                font-size: 1.5rem;
            }
        }

        /* ====== Focus Styles for Accessibility ====== */
        button:focus,
        input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="login-container fade-in">
        <div class="login-card">
            <!-- Logo Section -->
            <div class="logo-section">
                <div class="logo">
                    <i class="fas fa-industry"></i>
                </div>
                <h1 class="app-title">Transs Flow</h1>
                <p class="app-subtitle">Manufacturing Control System</p>
            </div>

            <!-- Login Form -->
            <form method="post">
                {% csrf_token %}
                
                <!-- Error Message -->
                {% if error %}
                <div class="alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>{{ error }}</span>
                </div>
                {% endif %}
                
                <!-- Employee ID -->
                <div class="form-group">
                    <label for="employee_id" class="form-label">
                        <i class="fas fa-id-badge mr-2"></i>Employee ID
                    </label>
                    <div class="input-icon">
                        <input type="text" 
                               id="employee_id" 
                               name="employee_id" 
                               class="form-input" 
                               placeholder="Enter your employee ID"
                               required>
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                
                <!-- Password -->
                <div class="form-group">
                    <label for="password" class="form-label">
                        <i class="fas fa-lock mr-2"></i>Password
                    </label>
                    <div class="input-icon">
                        <input type="password" 
                               id="password" 
                               name="password" 
                               class="form-input" 
                               placeholder="Enter your password"
                               required>
                        <i class="fas fa-eye-slash" id="togglePassword"></i>
                    </div>
                </div>
                
                <!-- Remember Me -->
                <div class="form-group">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="form-checkbox">
                        <span class="text-sm">Remember me</span>
                    </label>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" class="btn-login">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Sign In
                </button>
            </form>

            <!-- Footer -->
            <div class="login-footer">
                <p>Â© 2025 Transs Industries. All rights reserved.</p>
                <p class="mt-2">
                    <a href="#">Forgot Password?</a> | 
                    <a href="#">Help & Support</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Password visibility toggle
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            // Toggle icon
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Form submission animation
        const loginForm = document.querySelector('form');
        loginForm.addEventListener('submit', function() {
            const submitBtn = document.querySelector('.btn-login');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Authenticating...';
            submitBtn.disabled = true;
        });

        // Input focus effects
        const inputs = document.querySelectorAll('.form-input');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.querySelector('i').style.color = 'var(--primary)';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.querySelector('i').style.color = 'var(--text-light)';
            });
        });
    </script>
</body>
</html>

transs_flow/templates/ipqc/ass_dummy_test_form.html

{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Ass Dummy Test{% endblock %}
{% block content %}
<style>
/* --- Responsive progress bar styles --- */
.audit-form { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 16px; 
    width: 100%; 
}

.step-indicator { 
    background: white; 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    padding: 16px 12px; 
    margin-bottom: 20px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
}

.step-progress { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 12px; 
    position: relative; 
}

.step-progress::before { 
    content: ''; 
    position: absolute; 
    top: 50%; 
    left: 0; 
    right: 0; 
    height: 2px; 
    background: var(--border); 
    z-index: 0; 
}

.step-progress-line { 
    position: absolute; 
    top: 50%; 
    left: 0; 
    height: 2px; 
    background: var(--primary); 
    z-index: 1; 
    transition: width 0.3s ease; 
    transform: translateY(-50%); 
}

.step-item { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    position: relative; 
    z-index: 2; 
    cursor: pointer; 
    flex-shrink: 0; 
}

.step-circle { 
    width: 40px; 
    height: 40px; 
    border-radius: 50%; 
    border: 3px solid var(--border); 
    background: white; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: 700; 
    font-size: 14px; 
    color: var(--text-light); 
    transition: all 0.3s ease; 
}

.step-circle.active { 
    background: var(--primary); 
    color: white; 
    border-color: var(--primary); 
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); 
}

.step-circle.completed { 
    background: var(--success); 
    color: white; 
    border-color: var(--success); 
}

.step-label { 
    font-size: 11px; 
    color: var(--text-secondary); 
    text-align: center; 
    margin-top: 6px; 
    font-weight: 500; 
    white-space: nowrap; 
}

@media (max-width: 640px) {
    .step-label { display: none; }
    .step-circle { width: 36px; height: 36px; font-size: 13px; }
    .step-item { flex-shrink: 1; }
}

.form-section { 
    background: white; 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    padding: 20px 16px; 
    margin-bottom: 20px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
}

.section-header { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    margin-bottom: 16px; 
    padding-bottom: 12px; 
    border-bottom: 1px solid var(--border); 
}

.section-title { 
    font-size: 18px; 
    font-weight: 700; 
    color: var(--text-primary); 
    display: flex; 
    align-items: center; 
    gap: 10px; 
}

.section-icon { 
    width: 36px; 
    height: 36px; 
    border-radius: 8px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
}

.form-grid { 
    display: grid; 
    gap: 16px; 
    width: 100%; 
}

.form-group { 
    display: flex; 
    flex-direction: column; 
    width: 100%; 
}

.form-group label { 
    display: block; 
    font-size: 14px; 
    font-weight: 600; 
    color: var(--text-primary); 
    margin-bottom: 6px; 
}

.form-group input, .form-group select, .form-group textarea { 
    width: 100%; 
    padding: 12px; 
    background: white; 
    border: 2px solid var(--border); 
    border-radius: 8px; 
    color: var(--text-primary); 
    font-size: 14px; 
    transition: all 0.2s ease; 
    font-family: inherit; 
    box-sizing: border-box; 
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
    outline: none; 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); 
}

.form-group input[readonly] { 
    background: var(--bg-secondary); 
    cursor: not-allowed; 
    color: var(--text-secondary); 
}

.form-group .is-invalid {
    border-color: var(--danger) !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.status-select { 
    border-radius: 8px; 
    font-weight: 500; 
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); 
    background-repeat: no-repeat; 
    background-position: right 12px center; 
    background-size: 20px; 
    padding-right: 44px; 
    appearance: none; 
}

.status-select[value="OK"] { 
    border-color: var(--success); 
    background-color: rgba(34, 197, 94, 0.05); 
}

.status-select[value="Not OK"] { 
    border-color: var(--danger); 
    background-color: rgba(239, 68, 68, 0.05); 
}

.status-select[value="NA"] { 
    border-color: var(--text-light); 
    background-color: rgba(100, 116, 139, 0.05); 
}

.status-select[value="QUALIFIED"] { 
    border-color: var(--success); 
    background-color: rgba(34, 197, 94, 0.05); 
}

.status-select[value="UNQUALIFIED"] { 
    border-color: var(--danger); 
    background-color: rgba(239, 68, 68, 0.05); 
}

.form-group textarea { 
    resize: vertical; 
    min-height: 80px; 
}

.bottom-nav { 
    position: sticky; 
    bottom: 0; 
    background: white; 
    border-top: 1px solid var(--border); 
    padding: 16px; 
    box-shadow: 0 -2px 8px rgba(0,0,0,0.05); 
}

.nav-content { 
    max-width: 1200px; 
    margin: 0 auto; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    flex-wrap: wrap; 
    gap: 12px; 
}

.progress-text { 
    font-size: 14px; 
    color: var(--text-secondary); 
    font-weight: 500; 
}

.nav-buttons { 
    display: flex; 
    gap: 8px; 
    flex-wrap: wrap; 
}

.nav-btn { 
    padding: 10px 16px; 
    border-radius: 8px; 
    font-weight: 600; 
    font-size: 13px; 
    border: none; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    gap: 6px; 
    min-width: 80px; 
}

.nav-btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
}

.nav-btn-secondary { 
    background: white; 
    color: var(--text-secondary); 
    border: 2px solid var(--border); 
}

.nav-btn-primary { 
    background: var(--primary); 
    color: white; 
}

.nav-btn-success { 
    background: var(--success); 
    color: white; 
}

.error-message { 
    color: var(--danger); 
    font-size: 12px; 
    margin-top: 4px; 
}

.alert { 
    padding: 12px 16px; 
    margin-bottom: 20px; 
    border-radius: 8px; 
    border: 1px solid transparent; 
}

.alert-danger { 
    color: #721c24; 
    background-color: #f8d7da; 
    border-color: #f5c6cb; 
}

.alert-success { 
    color: #155724; 
    background-color: #d4edda; 
    border-color: #c3e6cb; 
}

.alert-warning { 
    color: #856404; 
    background-color: #fff3cd; 
    border-color: #ffeaa7; 
}

/* New styles for success section */
.success-section {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: 1px solid #c3e6cb;
    color: #155724;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 24px;
    text-align: center;
}
.success-section h2 {
    margin-bottom: 16px;
    color: #0f5132;
}
.url-display-box {
    background: white;
    border: 1px dashed #a9dcb5;
    padding: 12px;
    border-radius: 8px;
    margin-top: 16px;
    word-break: break-all;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}
.url-display-box p {
    margin: 0;
    font-size: 0.9em;
    color: #0f5132;
    flex-grow: 1;
}

@media (min-width: 768px) {
    .form-grid { 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 20px; 
    }
    .form-section { 
        padding: 24px; 
        margin-bottom: 24px; 
    }
    .section-title { 
        font-size: 20px; 
    }
}
</style>

<!-- Messages and errors -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}
{% if form.non_field_errors %}
    <div class="alert alert-danger">
        <strong>Error:</strong>
        <ul>
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div class="audit-form">
    <!-- This section will only be shown after a successful POST -->
    {% if form.instance.public_url %}
    <div class="success-section">
        <h2><i class="fas fa-check-circle"></i> Ass Dummy Test Record Created Successfully!</h2>
        <p>The record has been saved. You can now share the following link for reference.</p>
        <div class="url-display-box">
            <p id="publicUrl">{{ form.instance.public_url }}</p>
            <button class="nav-btn nav-btn-primary" onclick="copyPublicUrl()">
                <i class="fas fa-copy"></i> Copy Link
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Step Progress Indicator -->
    <div class="step-indicator">
        <div class="step-progress">
            <div class="step-progress-line" id="progressLine" style="width: 0%;"></div>
            <div class="step-item" onclick="goToStep(1)">
                <div class="step-circle active" id="step1">1</div>
                <div class="step-label">Work Info</div>
            </div>
            <div class="step-item" onclick="goToStep(2)">
                <div class="step-circle" id="step2">2</div>
                <div class="step-label">Test Details</div>
            </div>
        </div>
        <div class="progress-text">
            Step <span id="currentStep">1</span> of 2
        </div>
    </div>

    <form method="post" id="dummyTestForm" enctype="multipart/form-data" onsubmit="return validateForm()">
        {% csrf_token %}

        <!-- STEP 1: Work Information (Read-Only) -->
        <div class="form-section" id="step1-content">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-sky-100">
                        <i class="fas fa-info-circle text-sky-600"></i>
                    </div>
                    Work Information
                    <span class="badge bg-secondary ms-3">Auto-filled from your latest Work Info</span>
                </h2>
                <div class="step-circle active">1</div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
                    {{ form.date|attr:"readonly" }}
                    {% if form.date.errors %}<div class="error-message">{{ form.date.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.shift.id_for_label }}">{{ form.shift.label }}</label>
                    {{ form.shift|attr:"readonly" }}
                    {% if form.shift.errors %}<div class="error-message">{{ form.shift.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.emp_id.id_for_label }}">{{ form.emp_id.label }}</label>
                    {{ form.emp_id|attr:"readonly" }}
                    {% if form.emp_id.errors %}<div class="error-message">{{ form.emp_id.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                    {{ form.name|attr:"readonly" }}
                    {% if form.name.errors %}<div class="error-message">{{ form.name.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.section.id_for_label }}">{{ form.section.label }}</label>
                    {{ form.section|attr:"readonly" }}
                    {% if form.section.errors %}<div class="error-message">{{ form.section.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.line.id_for_label }}">{{ form.line.label }}</label>
                    {{ form.line|attr:"readonly" }}
                    {% if form.line.errors %}<div class="error-message">{{ form.line.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.group.id_for_label }}">{{ form.group.label }}</label>
                    {{ form.group|attr:"readonly" }}
                    {% if form.group.errors %}<div class="error-message">{{ form.group.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.model.id_for_label }}">{{ form.model.label }}</label>
                    {{ form.model|attr:"readonly" }}
                    {% if form.model.errors %}<div class="error-message">{{ form.model.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.color.id_for_label }}">{{ form.color.label }}</label>
                    {{ form.color|attr:"readonly" }}
                    {% if form.color.errors %}<div class="error-message">{{ form.color.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>

        <!-- STEP 2: Test Details (Fillable) -->
        <div class="form-section" id="step2-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-orange-100">
                        <i class="fas fa-flask text-orange-600"></i>
                    </div>
                    Dummy Test Details
                </h2>
                <div class="step-circle">2</div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.area.id_for_label }}">{{ form.area.label }}</label>
                    {{ form.area|attr:"required" }}
                    {% if form.area.errors %}<div class="error-message">{{ form.area.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.test_stage.id_for_label }}">{{ form.test_stage.label }}</label>
                    {{ form.test_stage|attr:"required" }}
                    {% if form.test_stage.errors %}<div class="error-message">{{ form.test_stage.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.test_item.id_for_label }}">{{ form.test_item.label }}</label>
                    {{ form.test_item|attr:"required" }}
                    {% if form.test_item.errors %}<div class="error-message">{{ form.test_item.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.operator_name.id_for_label }}">{{ form.operator_name.label }}</label>
                    {{ form.operator_name|attr:"required" }}
                    {% if form.operator_name.errors %}<div class="error-message">{{ form.operator_name.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.operator_id.id_for_label }}">{{ form.operator_id.label }}</label>
                    {{ form.operator_id|attr:"required" }}
                    {% if form.operator_id.errors %}<div class="error-message">{{ form.operator_id.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.result.id_for_label }}">{{ form.result.label }}</label>
                    {{ form.result|attr:"required" }}
                    {% if form.result.errors %}<div class="error-message">{{ form.result.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.cause.id_for_label }}">{{ form.cause.label }}</label>
                    {{ form.cause|attr:"required" }}
                    {% if form.cause.errors %}<div class="error-message">{{ form.cause.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.measure.id_for_label }}">{{ form.measure.label }}</label>
                    {{ form.measure|attr:"required" }}
                    {% if form.measure.errors %}<div class="error-message">{{ form.measure.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.ll_confirm.id_for_label }}">{{ form.ll_confirm.label }}</label>
                    {{ form.ll_confirm|attr:"required" }}
                    {% if form.ll_confirm.errors %}<div class="error-message">{{ form.ll_confirm.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="{{ form.remark.id_for_label }}">{{ form.remark.label }}</label>
                    {{ form.remark }}
                    {% if form.remark.errors %}<div class="error-message">{{ form.remark.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>
    </form>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-content">
            <div class="progress-text">
                Section <span id="currentSection">1</span> of 2
            </div>
            <div class="nav-buttons">
                <button type="button" onclick="previousStep()" id="prev-btn" class="nav-btn nav-btn-secondary" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" onclick="nextStep()" id="next-btn" class="nav-btn nav-btn-primary">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="submit" form="dummyTestForm" id="submit-btn" class="nav-btn nav-btn-success" disabled>
                    <i class="fas fa-check"></i> Submit Test
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1; 
const totalSteps = 2;

function updateStepIndicator() {
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    document.getElementById('progressLine').style.width = progressPercentage + '%';
    document.getElementById('currentStep').textContent = currentStep;
    document.getElementById('currentSection').textContent = currentStep;
    
    for (let i = 1; i <= totalSteps; i++) {
        const stepCircle = document.getElementById(`step${i}`); 
        const stepContent = document.getElementById(`step${i}-content`);
        
        if (stepCircle) { 
            stepCircle.classList.remove('active', 'completed');
            if (i < currentStep) { 
                stepCircle.classList.add('completed'); 
                stepCircle.innerHTML = 'âœ“'; 
            }
            else if (i === currentStep) { 
                stepCircle.classList.add('active'); 
                stepCircle.innerHTML = i; 
            }
            else { 
                stepCircle.innerHTML = i; 
            }
        }
        
        if (stepContent) { 
            stepContent.style.display = i === currentStep ? 'block' : 'none'; 
        }
    }
    
    document.getElementById('prev-btn').disabled = currentStep === 1;
    document.getElementById('next-btn').disabled = currentStep === totalSteps;
    document.getElementById('submit-btn').disabled = currentStep !== totalSteps;
    
    document.querySelector('.audit-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function goToStep(step) { 
    if (step >= 1 && step <= totalSteps) { 
        currentStep = step; 
        updateStepIndicator(); 
    } 
}

function nextStep() { 
    if (currentStep < totalSteps) { 
        currentStep++; 
        updateStepIndicator(); 
    } 
}

function previousStep() { 
    if (currentStep > 1) { 
        currentStep--; 
        updateStepIndicator(); 
    } 
}

function validateForm() {
    // Clear previous validation styles and messages
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    const existingErrorDiv = document.getElementById('form-validation-error');
    if (existingErrorDiv) {
        existingErrorDiv.remove();
    }

    // Validate required fields, step by step
    for (let step = 1; step <= totalSteps; step++) {
        const currentStepDiv = document.getElementById(`step${step}-content`);
        if (!currentStepDiv) continue;

        let stepHasError = false;
        const requiredFields = currentStepDiv.querySelectorAll('input[required], select[required], textarea[required]');

        for (const field of requiredFields) {
            // Skip readonly fields as they are pre-filled
            if (field.hasAttribute('readonly')) {
                continue;
            }
            
            let isEmpty = false;
            if (field.type === 'file') {
                isEmpty = !field.files || field.files.length === 0;
            } else { // Covers text, number, select, textarea
                isEmpty = !field.value || field.value.trim() === '';
            }

            if (isEmpty) {
                field.classList.add('is-invalid');
                stepHasError = true;
            }
        }

        // If current step has any errors, jump to it and stop validation
        if (stepHasError) {
            const stepName = document.querySelector(`#step${step}-content .section-title`).textContent.trim();
            const errorMessage = `Error in Step ${step}: Please fill in all required fields marked in red.`;
            
            let errorDiv = document.createElement('div'); 
            errorDiv.id = 'form-validation-error';
            errorDiv.className = 'alert alert-danger'; 
            document.querySelector('.audit-form').insertBefore(
                errorDiv, 
                document.querySelector('.step-indicator')
            );
            errorDiv.innerHTML = `<strong>${errorMessage}</strong>`; 
            
            goToStep(step);
            return false; // Stop form submission
        }
    }

    // If all validations pass
    return true; 
}

// Function to copy the public URL
function copyPublicUrl() {
    const urlText = document.getElementById('publicUrl').innerText;
    navigator.clipboard.writeText(urlText).then(() => {
        alert('Public URL copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy URL: ', err);
    });
}

// Add dynamic styling for select fields
document.addEventListener('DOMContentLoaded', function() { 
    updateStepIndicator();
    
    // Add status-select class to result field
    const resultSelect = document.querySelector('select[name="result"]');
    if (resultSelect) {
        resultSelect.classList.add('status-select');
        
        // Update styling based on value change
        resultSelect.addEventListener('change', function() {
            // Remove all status classes
            this.classList.remove('status-ok', 'status-not-ok', 'status-na');
            
            // Add class based on selected value
            if (this.value === 'OK') {
                this.style.borderColor = 'var(--success)';
                this.style.backgroundColor = 'rgba(34, 197, 94, 0.05)';
            } else if (this.value === 'Not OK') {
                this.style.borderColor = 'var(--danger)';
                this.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
            } else if (this.value === 'NA') {
                this.style.borderColor = 'var(--text-light)';
                this.style.backgroundColor = 'rgba(100, 116, 139, 0.05)';
            }
        });
    }
});
</script>
{% endblock content %}

transs_flow/templates/ipqc/ass_dummy_test_list.html

{% extends 'base.html' %}
{% load static %}

{% block title %}Ass Dummy List{% endblock title %}

{% block content %}
<div class="pc-container">
    <div class="pc-content">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="card-title mb-0">All Ass Dummy Tests</h4>
                    </div>
                    <div class="card-body">

                        <!-- Display Django messages -->
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <div class="table-responsive mt-3">
                            <table class="table table-bordered table-hover table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Shift</th>
                                        <th>Emp ID</th>
                                        <th>Name</th>
                                        <th>Area</th>
                                        <th>Section</th>
                                        <th>Line</th>
                                        <th>Group</th>
                                        <th>Model</th>
                                        <th>Color</th>
                                        <th>Test Stage</th>
                                        <th>Test Item</th>
                                        <th>Operator Name</th>
                                        <th>Operator ID</th>
                                        <th>Result</th>
                                        <th>Cause</th>
                                        <th>Measure</th>
                                        <th>LL Confirm</th>
                                        <th>Remark</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for test in tests %}
                                        <tr>
                                            <td>{{ test.date }}</td>
                                            <td>{{ test.shift }}</td>
                                            <td>{{ test.emp_id }}</td>
                                            <td>{{ test.name }}</td>
                                            <td>{{ test.area }}</td>
                                            <td>{{ test.section }}</td>
                                            <td>{{ test.line }}</td>
                                            <td>{{ test.group }}</td>
                                            <td>{{ test.model }}</td>
                                            <td>{{ test.color }}</td>
                                            <td>{{ test.test_stage }}</td>
                                            <td>{{ test.test_item }}</td>
                                            <td>{{ test.operator_name }}</td>
                                            <td>{{ test.operator_id }}</td>
                                            <td>{{ test.result }}</td>
                                            <td>{{ test.cause }}</td>
                                            <td>{{ test.measure }}</td>
                                            <td>{{ test.ll_confirm }}</td>
                                            <td>{{ test.remark }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="19" class="text-center">No records found.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    // Bootstrap tooltip initialization if needed
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock extra_js %}


transs_flow/templates/ipqc/audit_list.html

{% extends 'base.html' %}
{% block title %}Audit List{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-clipboard-check mr-3 text-purple-500"></i>
                    Assembly Audit History
                </h1>
                <p class="text-gray-600 mt-1">View and manage assembly audit records</p>
            </div>
            <a href="{% url 'ipqc_assembly_audit_create' %}" 
               class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>
                New Audit
            </a>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
        <h2 class="text-lg font-bold mb-4 text-gray-900">
            <i class="fas fa-filter mr-2 text-blue-500"></i>
            Filter Audits
        </h2>
        <form method="get" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                    <input type="date" name="start_date" value="{{ request.GET.start_date }}"
                           class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                    <input type="date" name="end_date" value="{{ request.GET.end_date }}"
                           class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select name="status" 
                           class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                        <option value="">All</option>
                        <option value="OK" {% if request.GET.status == 'OK' %}selected{% endif %}>OK</option>
                        <option value="NOT_OK" {% if request.GET.status == 'NOT_OK' %}selected{% endif %}>Not OK</option>
                        <option value="NA" {% if request.GET.status == 'NA' %}selected{% endif %}>N/A</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="submit" class="btn btn-secondary w-full">
                        <i class="fas fa-search mr-2"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Audit Table -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-calendar mr-1"></i> Date
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-user mr-1"></i> Name
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-building mr-1"></i> Section
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-sitemap mr-1"></i> Line
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Model</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-cube mr-1"></i> Status
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for audit in audits %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 text-sm text-gray-900">{{ audit.date|date:'Y-m-d' }}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                    {{ audit.emp_id }}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-900">{{ audit.section }}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">{{ audit.line }}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">{{ audit.model }}</td>
                            <td class="px-4 py-3 text-center">
                                {% if audit.get_overall_status == 'OK' %}
                                    <span class="status-badge status-running">OK</span>
                                {% elif audit.get_overall_status == 'NOT_OK' %}
                                    <span class="status-badge status-stop">Not OK</span>
                                {% else %}
                                    <span class="status-badge status-idle">N/A</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center space-x-2">
                                    <a href="{% url 'ipqc_assembly_audit_update' audit.id %}" 
                                       class="text-blue-600 hover:text-blue-800 transition-colors"
                                       title="Edit Audit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'ipqc_audit_list' audit.id %}" 
                                       class="text-green-600 hover:text-green-800 transition-colors"
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'ipqc_assembly_audit_delete' audit.id %}" 
                                       class="text-red-600 hover:text-red-800 transition-colors"
                                       title="Delete Audit"
                                       onclick="return confirm('Delete audit from {{ audit.date }}?')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3 block text-gray-300"></i>
                                <div class="text-lg font-medium">No audit records found</div>
                                <div class="text-sm mt-1">Try adjusting your filters or create a new audit</div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <div class="flex items-center justify-between mt-6">
            <div class="text-sm text-gray-700">
                Showing <span class="font-medium">{{ page_obj.start_index }}</span> to 
                <span class="font-medium">{{ page_obj.end_index }}</span> of 
                <span class="font-medium">{{ page_obj.paginator.count }}</span> results
            </div>
            <div class="flex space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" 
                       class="btn btn-secondary">
                        <i class="fas fa-chevron-left mr-2"></i>
                        Previous
                    </a>
                {% endif %}
                
                <div class="flex items-center px-4 py-2 text-sm text-gray-700">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </div>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" 
                       class="btn btn-secondary">
                        Next
                        <i class="fas fa-chevron-right ml-2"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

transs_flow/templates/ipqc/btb_checksheet_detail.html

{% extends 'base.html' %}
{% load static %}
{% block title %}BTB Detail - {{ sheet.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Styling for the remark display divs */
    .remark-display {
        min-height: 50px;
        padding: 5px;
        white-space: pre-wrap; /* Preserves line breaks in remarks */
    }
    /* --- Mobile & Tablet Responsive Styles (same as form) --- */
    @media (max-width: 767.98px) {
        .table, .table tbody, .table tr, .table td { display: block; width: 100% !important; }
        .table thead { display: none; }
        .table tr { border: 1px solid #ccc; border-radius: 5px; margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .table td { border: none; border-bottom: 1px solid #eee; text-align: right; padding-left: 50%; position: relative; }
        .table td:before { content: attr(data-label) ": "; position: absolute; left: 15px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: #333; }
        .table td:first-child { background-color: #007bff; color: white; text-align: center; font-weight: bold; font-size: 1.1em; padding: 12px 5px; border-bottom: 2px solid #0056b3; }
        .table td:first-child:before { content: "" !important; }
        .table td.total-cell { text-align: center; padding-left: 15px; font-weight: bold; background-color: #f8f9fa; border-bottom: none; }
        .table td.total-cell:before { content: "Row Total: "; }
        .table tr.table-info { border: 1px solid #b8daff; background-color: #d1ecf1; border-radius: 5px; margin-bottom: 1.5rem; }
        .table tr.table-info td { text-align: left; padding-left: 15px; border-bottom: 1px solid #bee5eb; }
        .table tr.table-info td:before { display: none; }
        .table tr.table-info td:first-child { background-color: transparent; color: #0c5460; padding: 10px 5px; }
        .table tr.table-primary { border: 1px solid #b8daff; background-color: #cfe2ff; border-radius: 5px; }
        .table tr.table-primary td { text-align: left; padding-left: 15px; border-bottom: none; }
        .table tr.table-primary td:before { display: none; }
        .table tr.table-primary td:first-child { background-color: #007bff; color: white; font-size: 1.1em; padding: 12px 5px; }
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="pc-container">
    <div class="pc-content">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">BTB Checksheet for {{ sheet.name }} ({{ sheet.date|date:"Y-m-d" }})</h4>
                        <a href="{% url 'btb_checksheet_list' %}" class="btn btn-secondary">Back to List</a>
                    </div>
                    <div class="card-body">
                        
                        <!-- Header Information Display -->
                        <div class="row mb-4 g-2 align-items-end">
                            <div class="col-md-2"><strong>Date:</strong> {{ sheet.date|date:"Y-m-d" }}</div>
                            <div class="col-md-1"><strong>Shift:</strong> {{ sheet.shift }}</div>
                            <div class="col-md-1"><strong>Emp ID:</strong> {{ sheet.emp_id }}</div>
                            <div class="col-md-2"><strong>Model:</strong> {{ sheet.name }}</div>
                            <div class="col-md-1"><strong>Line:</strong> {{ sheet.line }}</div>
                            <div class="col-md-1"><strong>Group:</strong> {{ sheet.group }}</div>
                            <div class="col-md-1"><strong>Color:</strong> {{ sheet.color }}</div>
                            <div class="col-md-3"><strong>Frequency:</strong> {{ sheet.frequency }}</div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-sm text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th rowspan="2">Time</th>
                                        <th colspan="6">Issue</th>
                                        <th rowspan="2">Total</th>
                                    </tr>
                                    <tr>
                                        <th>Input</th>
                                        <th>CAM BTB</th>
                                        <th>LCD fitment</th>
                                        <th>MAIN FPC</th>
                                        <th>Battery</th>
                                        <th>Finger printer</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data Rows Displaying Data -->
                                    <tr><td>9:00</td><td data-label="Input">{{ sheet.input_9 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_9 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_9 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_9 }}</td><td data-label="Battery">{{ sheet.battery_9 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_9 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_9 }}</td></tr>
                                    <tr><td>10:00</td><td data-label="Input">{{ sheet.input_10 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_10 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_10 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_10 }}</td><td data-label="Battery">{{ sheet.battery_10 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_10 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_10 }}</td></tr>
                                    <tr><td>11:00</td><td data-label="Input">{{ sheet.input_11 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_11 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_11 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_11 }}</td><td data-label="Battery">{{ sheet.battery_11 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_11 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_11 }}</td></tr>
                                    <tr><td>12:00</td><td data-label="Input">{{ sheet.input_12 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_12 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_12 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_12 }}</td><td data-label="Battery">{{ sheet.battery_12 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_12 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_12 }}</td></tr>
                                    <tr><td>1:00</td><td data-label="Input">{{ sheet.input_1 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_1 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_1 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_1 }}</td><td data-label="Battery">{{ sheet.battery_1 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_1 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_1 }}</td></tr>
                                    <tr><td>2:00</td><td data-label="Input">{{ sheet.input_2 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_2 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_2 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_2 }}</td><td data-label="Battery">{{ sheet.battery_2 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_2 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_2 }}</td></tr>
                                    <tr><td>3:00</td><td data-label="Input">{{ sheet.input_3 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_3 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_3 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_3 }}</td><td data-label="Battery">{{ sheet.battery_3 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_3 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_3 }}</td></tr>
                                    <tr><td>4:00</td><td data-label="Input">{{ sheet.input_4 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_4 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_4 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_4 }}</td><td data-label="Battery">{{ sheet.battery_4 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_4 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_4 }}</td></tr>
                                    <tr><td>5:00</td><td data-label="Input">{{ sheet.input_5 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_5 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_5 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_5 }}</td><td data-label="Battery">{{ sheet.battery_5 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_5 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_5 }}</td></tr>
                                    <tr><td>6:00</td><td data-label="Input">{{ sheet.input_6 }}</td><td data-label="CAM BTB">{{ sheet.cam_btb_6 }}</td><td data-label="LCD fitment">{{ sheet.lcd_fitment_6 }}</td><td data-label="MAIN FPC">{{ sheet.main_fpc_6 }}</td><td data-label="Battery">{{ sheet.battery_6 }}</td><td data-label="Finger printer">{{ sheet.finger_printer_6 }}</td><td class="table-secondary total-cell" data-label="Row Total">{{ sheet.total_6 }}</td></tr>

                                    <!-- Remark Row -->
                                    <tr class="table-info">
                                        <td>Remark</td>
                                        <td data-label="Input"><div class="remark-display">{{ sheet.remark_input|default:"-" }}</div></td>
                                        <td data-label="CAM BTB"><div class="remark-display">{{ sheet.remark_cam_btb|default:"-" }}</div></td>
                                        <td data-label="LCD fitment"><div class="remark-display">{{ sheet.remark_lcd_fitment|default:"-" }}</div></td>
                                        <td data-label="MAIN FPC"><div class="remark-display">{{ sheet.remark_main_fpc|default:"-" }}</div></td>
                                        <td data-label="Battery"><div class="remark-display">{{ sheet.remark_battery|default:"-" }}</div></td>
                                        <td data-label="Finger printer"><div class="remark-display">{{ sheet.remark_finger_printer|default:"-" }}</div></td>
                                        <td colspan="2"></td>
                                    </tr>
                                    <!-- Total Row -->
                                    <tr class="table-primary fw-bold">
                                        <td>Total</td>
                                        <td data-label="Input">{{ sheet.input_total }}</td>
                                        <td data-label="CAM BTB">{{ sheet.cam_btb_total }}</td>
                                        <td data-label="LCD fitment">{{ sheet.lcd_fitment_total }}</td>
                                        <td data-label="MAIN FPC">{{ sheet.main_fpc_total }}</td>
                                        <td data-label="Battery">{{ sheet.battery_total }}</td>
                                        <td data-label="Finger printer">{{ sheet.finger_printer_total }}</td>
                                        <td data-label="Grand Total">{{ sheet.grand_total }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

transs_flow/templates/ipqc/btb_checksheet_form.html

	{% extends 'base.html' %}
	{% block title %}BTB Checksheet{% endblock %}
	{% block content %}
	<div class="space-y-6">
	    <!-- Header -->
	    <div class="mb-6">
	        <h1 class="text-2xl font-bold text-gray-900">
	            <i class="fas fa-clipboard-check mr-3 text-blue-500"></i>
	            BTB Fitment Checksheet
	        </h1>
	        <p class="text-gray-600 mt-1">BTB (Board-to-Board) Fitment Quality Control</p>
	    </div>
	    <form method="post" id="btbForm" class="space-y-6">
	        {% csrf_token %}
	        <!-- Basic Info -->
	        <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
	            <h2 class="text-lg font-bold mb-4 text-gray-900">
	                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
	                Basic Information
	            </h2>
	            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
	                    <input type="date" name="date" value="{{ form.date.value|date:'Y-m-d' }}" readonly
	                           class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-700">
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
	                    <input type="text" name="shift" value="{{ form.shift.value }}" readonly
	                           class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-700">
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Line</label>
	                    <input type="text" name="line" value="{{ form.line.value }}" readonly
	                           class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-700">
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
	                    <input type="text" name="model" value="{{ form.model.value }}" readonly
	                           class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-700">
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Frequency</label>
	                    <input type="text" name="frequency" value="{{ form.frequency.value }}" 
	                           class="w-full px-3 py-2 bg-white border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
	                </div>
	            </div>
	        </div>
	        <!-- Data Entry Grid -->
	        <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
	            <h2 class="text-lg font-bold mb-6 text-gray-900">
	                <i class="fas fa-th mr-2 text-purple-500"></i>
	                Hourly Data Entry
	            </h2>
	            <!-- Hour Headers -->
	            <div class="grid grid-cols-7 gap-2 mb-4 text-center">
	                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Hour</div>
	                <div class="text-xs font-semibold text-blue-600 uppercase tracking-wider">Input</div>
	                <div class="text-xs font-semibold text-green-600 uppercase tracking-wider">CAM BTB</div>
	                <div class="text-xs font-semibold text-blue-600 uppercase tracking-wider">LCD Fit</div>
	                <div class="text-xs font-semibold text-yellow-600 uppercase tracking-wider">Main FPC</div>
	                <div class="text-xs font-semibold text-orange-600 uppercase tracking-wider">Battery</div>
	                <div class="text-xs font-semibold text-pink-600 uppercase tracking-wider">Finger Print</div>
	            </div>
	            <!-- Data Rows -->
	            {% for hour in hours %}
	                <div class="grid grid-cols-7 gap-2 mb-2">
	                    <div class="bg-gray-50 p-2 rounded text-center">
	                        <span class="text-sm font-bold text-gray-700">{{ hour }}:00</span>
	                    </div>
	                    <input type="number" name="input_{{ hour }}" min="0" value="0"
	                           class="w-full px-2 py-2 bg-white border border-blue-300 rounded text-center text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
	                           onchange="calculateTotals()">
	                    <input type="number" name="cam_btb_{{ hour }}" min="0" value="0"
	                           class="w-full px-2 py-2 bg-white border border-green-300 rounded text-center text-gray-900 focus:ring-2 focus:ring-green-500 focus:border-green-500"
	                           onchange="calculateTotals()">
	                    <input type="number" name="lcd_fitment_{{ hour }}" min="0" value="0"
	                           class="w-full px-2 py-2 bg-white border border-blue-300 rounded text-center text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
	                           onchange="calculateTotals()">
	                    <input type="number" name="main_fpc_{{ hour }}" min="0" value="0"
	                           class="w-full px-2 py-2 bg-white border border-yellow-300 rounded text-center text-gray-900 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
	                           onchange="calculateTotals()">
	                    <input type="number" name="battery_{{ hour }}" min="0" value="0"
	                           class="w-full px-2 py-2 bg-white border border-orange-300 rounded text-center text-gray-900 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
	                           onchange="calculateTotals()">
	                    <input type="number" name="finger_printer_{{ hour }}" min="0" value="0"
	                           class="w-full px-2 py-2 bg-white border border-pink-300 rounded text-center text-gray-900 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
	                           onchange="calculateTotals()">
	                </div>
	            {% endfor %}
	            <!-- Total Row -->
	            <div class="grid grid-cols-7 gap-2 mt-4 pt-4 border-t border-gray-200">
	                <div class="bg-gray-100 p-2 rounded">
	                    <span class="text-sm font-bold text-gray-900">TOTAL</span>
	                </div>
	                <div class="bg-blue-50 p-2 rounded">
	                    <span id="input_total" class="text-sm font-bold text-blue-700">0</span>
	                </div>
	                <div class="bg-green-50 p-2 rounded">
	                    <span id="cam_btb_total" class="text-sm font-bold text-green-700">0</span>
	                </div>
	                <div class="bg-blue-50 p-2 rounded">
	                    <span id="lcd_fitment_total" class="text-sm font-bold text-blue-700">0</span>
	                </div>
	                <div class="bg-yellow-50 p-2 rounded">
	                    <span id="main_fpc_total" class="text-sm font-bold text-yellow-700">0</span>
	                </div>
	                <div class="bg-orange-50 p-2 rounded">
	                    <span id="battery_total" class="text-sm font-bold text-orange-700">0</span>
	                </div>
	                <div class="bg-pink-50 p-2 rounded">
	                    <span id="finger_printer_total" class="text-sm font-bold text-pink-700">0</span>
	                </div>
	                <div class="bg-gray-100 p-2 rounded">
	                    <span id="grand_total" class="text-lg font-bold text-gray-900">0</span>
	                </div>
	            </div>
	        </div>
	        <!-- Remarks Section -->
	        <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
	            <h2 class="text-lg font-bold mb-4 text-gray-900">
	                <i class="fas fa-comment-alt mr-2 text-purple-500"></i>
	                Remarks
	            </h2>
	            <div class="space-y-4">
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Input Remarks</label>
	                    <textarea name="remark_input" rows="3" 
	                              class="w-full px-4 py-3 bg-white border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
	                              placeholder="Enter input related remarks..."></textarea>
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">CAM BTB Remarks</label>
	                    <textarea name="remark_cam_btb" rows="3" 
	                              class="w-full px-4 py-3 bg-white border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-gray-900"
	                              placeholder="Enter CAM BTB related remarks..."></textarea>
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">LCD Fitment Remarks</label>
	                    <textarea name="remark_lcd_fitment" rows="3" 
	                              class="w-full px-4 py-3 bg-white border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
	                              placeholder="Enter LCD fitment related remarks..."></textarea>
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Main FPC Remarks</label>
	                    <textarea name="remark_main_fpc" rows="3" 
	                              class="w-full px-4 py-3 bg-white border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 text-gray-900"
	                              placeholder="Enter main FPC related remarks..."></textarea>
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Battery Remarks</label>
	                    <textarea name="remark_battery" rows="3" 
	                              class="w-full px-4 py-3 bg-white border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-gray-900"
	                              placeholder="Enter battery related remarks..."></textarea>
	                </div>
	                <div>
	                    <label class="block text-sm font-medium text-gray-700 mb-1">Finger Printer Remarks</label>
	                    <textarea name="remark_finger_printer" rows="3" 
	                              class="w-full px-4 py-3 bg-white border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-gray-900"
	                              placeholder="Enter finger printer related remarks..."></textarea>
	                </div>
	            </div>
	        </div>
	        <!-- Submit Button -->
	        <div class="flex justify-center mt-8">
	            <button type="submit" 
	                    class="btn btn-primary px-8 py-3 text-white font-semibold rounded-lg hover:bg-blue-700 transform transition-all duration-200 shadow-md hover:shadow-lg">
	                <i class="fas fa-save mr-2"></i>
	                Submit BTB Checksheet
	            </button>
	        </div>
	    </form>
	</div>
	<script>
	    function calculateTotals() {
	        const hours = ['9','10','11','12','1','2','3','4','5','6'];
	        let inputTotal = 0;
	        let camBtbTotal = 0;
	        let lcdFitmentTotal = 0;
	        let mainFpcTotal = 0;
	        let batteryTotal = 0;
	        let fingerPrinterTotal = 0;
	        let grandTotal = 0;
	        hours.forEach(hour => {
	            inputTotal += parseInt(document.querySelector(`input[name="input_${hour}"]`).value) || 0;
	            camBtbTotal += parseInt(document.querySelector(`input[name="cam_btb_${hour}"]`).value) || 0;
	            lcdFitmentTotal += parseInt(document.querySelector(`input[name="lcd_fitment_${hour}"]`).value) || 0;
	            mainFpcTotal += parseInt(document.querySelector(`input[name="main_fpc_${hour}"]`).value) || 0;
	            batteryTotal += parseInt(document.querySelector(`input[name="battery_${hour}"]`).value) || 0;
	            fingerPrinterTotal += parseInt(document.querySelector(`input[name="finger_printer_${hour}"]`).value) || 0;
	        });
	        grandTotal = camBtbTotal + lcdFitmentTotal + mainFpcTotal + batteryTotal + fingerPrinterTotal;
	        document.getElementById('input_total').textContent = inputTotal;
	        document.getElementById('cam_btb_total').textContent = camBtbTotal;
	        document.getElementById('lcd_fitment_total').textContent = lcdFitmentTotal;
	        document.getElementById('main_fpc_total').textContent = mainFpcTotal;
	        document.getElementById('battery_total').textContent = batteryTotal;
	        document.getElementById('finger_printer_total').textContent = fingerPrinterTotal;
	        document.getElementById('grand_total').textContent = grandTotal;
	        // Add animation effect
	        ['input_total', 'cam_btb_total', 'lcd_fitment_total', 'main_fpc_total', 
	         'battery_total', 'finger_printer_total', 'grand_total'].forEach(id => {
	            const element = document.getElementById(id);
	            element.style.transform = 'scale(1.1)';
	            element.style.transition = 'transform 0.2s ease';
	            setTimeout(() => {
	                element.style.transform = 'scale(1)';
	            }, 200);
	        });
	    }
	</script>
	{% endblock %}

transs_flow/templates/ipqc/btb_checksheet_list.html

{% extends 'base.html' %}
{% block title %}BTB Records{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Stats -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-clipboard-check mr-3 text-green-600"></i>
            BTB Fitment Records
        </h1>
        <p class="text-gray-600 mt-1">View and manage BTB checksheet records</p>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-6">
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="metric-value">{{ total_records }}</div>
                        <div class="metric-label">Total Records</div>
                    </div>
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-database text-blue-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="metric-value">{{ today_records }}</div>
                        <div class="metric-label">Today</div>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-day text-green-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="metric-value">{{ avg_defect_rate }}%</div>
                        <div class="metric-label">Avg Defect Rate</div>
                    </div>
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-pie text-purple-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="metric-value">{{ top_model }}</div>
                        <div class="metric-label">Top Model</div>
                    </div>
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-star text-orange-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="metric-value">{{ top_line }}</div>
                        <div class="metric-label">Top Line</div>
                    </div>
                    <div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-industry text-pink-600"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
        <h2 class="text-lg font-bold mb-4 text-gray-900">
            <i class="fas fa-filter mr-2 text-blue-500"></i>
            Filter Records
        </h2>
        <form method="get" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                    <input type="date" name="start_date" value="{{ request.GET.start_date }}"
                           class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                    <input type="date" name="end_date" value="{{ request.GET.end_date }}"
                           class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                    <input type="text" name="model_filter" value="{{ request.GET.model_filter }}"
                           class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                           placeholder="Filter by model">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                    <select name="shift_filter" 
                            class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                        <option value="">All Shifts</option>
                        <option value="Day" {% if request.GET.shift_filter == 'Day' %}selected{% endif %}>Day</option>
                        <option value="Night" {% if request.GET.shift_filter == 'Night' %}selected{% endif %}>Night</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-center space-x-4">
                <button type="submit" 
                        class="btn btn-primary">
                    <i class="fas fa-search mr-2"></i>
                    Apply Filters
                </button>
                <a href="?" class="btn btn-secondary">
                    <i class="fas fa-times mr-2"></i>
                    Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Records Table -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-calendar mr-1"></i> Date
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-user mr-1"></i> Created By
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-cube mr-1"></i> Model
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-sitemap mr-1"></i> Line
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <i class="fas fa-calculator mr-1"></i> Total Defects
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for record in records %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 text-sm text-gray-900">{{ record.date|date:'Y-m-d' }}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                    {{ record.created_by.full_name }}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-900">{{ record.model }}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">{{ record.line }}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="status-badge status-stop">{{ record.grand_total }}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center space-x-2">
                                    <a href="{% url 'btb_checksheet_detail' record.id %}" 
                                       class="text-blue-600 hover:text-blue-800 transition-colors"
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'btb_checksheet_export' record.id %}" 
                                       class="text-green-600 hover:text-green-800 transition-colors"
                                       title="Export to Excel">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3 block text-gray-300"></i>
                                <div class="text-lg font-medium">No BTB records found</div>
                                <div class="text-sm mt-1">Try adjusting your filters or create a new record</div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

transs_flow/templates/ipqc/confirm_delete.html

{% extends 'base.html' %}
{% block title %}Delete Audit{% endblock %}
{% block content %}
<div class="pc-container">
    <div class="pc-content">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h4 class="card-title">Confirm Deletion</h4>
                    </div>
                    <div class="card-body">
                        <p>Are you sure you want to delete the audit record for <strong>{{ audit.model }}</strong> on <strong>{{ audit.date|date:"Y-m-d" }}</strong>?</p>
                        <p>This action cannot be undone.</p>
                        <form method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Yes, Delete</button>
                            <a href="{% url 'ipqc_audit_list' %}" class="btn btn-secondary">Cancel</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

transs_flow/templates/ipqc/create_dynamic_form.html

<!-- templates/ipqc/create_dynamic_form.html -->
{% extends 'base.html' %}
{% block title %}Create Dynamic Form{% endblock %}
{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold glow-text">
            <i class="fas fa-wpforms mr-3 text-purple-400"></i>
            Create Dynamic Form
        </h1>
        <p class="text-gray-400 mt-2">Create custom forms for flexible data collection</p>
    </div>
    <!-- Form Creator -->
    <div class="holographic-card rounded-xl p-6">
        <form method="post" id="dynamicForm" class="space-y-6">
            {% csrf_token %}
            <!-- Basic Information -->
            <div class="holographic-card rounded-lg p-6">
                <h2 class="text-lg font-bold mb-4 text-white">
                    <i class="fas fa-info-circle mr-2 text-cyan-400"></i>
                    Form Information
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Form Title *</label>
                        <input type="text" name="title" required
                               class="w-full px-4 py-3 bg-gray-700 border border-cyan-500 rounded-lg focus:ring-2 focus:ring-cyan-500 text-white"
                               placeholder="Enter form title">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                        <textarea name="description" rows="3"
                                  class="w-full px-4 py-3 bg-gray-700 border border-cyan-500 rounded-lg focus:ring-2 focus:ring-cyan-500 text-gray-400"
                                  placeholder="Describe the form purpose"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Lark Bitable Table ID</label>
                        <input type="text" name="lark_bitable_table_id" required
                               class="w-full px-4 py-3 bg-gray-700 border border-cyan-500 rounded-lg focus:ring-2 focus:ring-cyan-500 text-white"
                               placeholder="Enter Lark Bitable table ID">
                    </div>
                </div>
            </div>
            <!-- Dynamic Fields Section -->
            <div class="holographic-card rounded-lg p-6">
                <h2 class="text-lg font-bold mb-4 text-white">
                    <i class="fas fa-layer-group mr-2 text-green-400"></i>
                    Form Fields
                </h2>
                <div id="fieldsContainer" class="space-y-4">
                    <!-- Initial Field -->
                    <div class="flex items-center space-x-4 p-4 bg-gray-800 rounded-lg">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Field Label</label>
                            <input type="text" id="fieldLabel" placeholder="e.g., Employee Name"
                                   class="flex-1 px-4 py-3 bg-gray-700 border border-cyan-500 rounded-lg focus:ring-2 focus:ring-cyan-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Field Type</label>
                            <select id="fieldType" onchange="updateFieldOptions()"
                                    class="px-4 py-3 bg-gray-700 border border-cyan-500 rounded-lg focus:ring-2 focus:ring-cyan-500 text-white">
                                <option value="">Select Type</option>
                                <option value="text">Text</option>
                                <option value="number">Number</option>
                                <option value="date">Date</option>
                                <option value="select">Dropdown</option>
                                <option value="checkbox">Checkbox</option>
                                <option value="textarea">Textarea</option>
                            </select>
                        </div>
                        <button type="button" onclick="addField()" 
                                class="cyber-button px-4 py-2 text-white rounded-lg hover:scale-105 transition-all duration-200">
                            <i class="fas fa-plus mr-2"></i>
                            Add Field
                        </button>
                    </div>
                </div>
                <!-- Field Options (shown when type is select) -->
                <div id="fieldOptions" class="hidden mt-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Options (comma-separated)</label>
                    <textarea id="fieldOptionsText" rows="3"
                              class="w-full px-4 py-3 bg-gray-700 border border-cyan-500 rounded-lg focus:ring-2 focus:ring-cyan-500 text-gray-400"
                              placeholder="Option1,Option2,Option3"></textarea>
                </div>
            </div>
            <!-- Hidden Fields Storage -->
            <input type="hidden" id="fieldsData" name="fields_data">
            <!-- Submit Button -->
            <div class="flex justify-center pt-8">
                <button type="submit" 
                        class="cyber-button px-8 py-4 text-white font-semibold rounded-lg hover:scale-105 transform transition-all duration-200">
                    <i class="fas fa-save mr-2"></i>
                    Create Dynamic Form
                </button>
            </div>
        </form>
    </div>
</div>
<script>
    let fieldCount = 0;
    let fields = [];
    function addField() {
        const label = document.getElementById('fieldLabel').value;
        const type = document.getElementById('fieldType').value;
        const optionsDiv = document.getElementById('fieldOptions');
        if (!label || !type) {
            alert('Please enter field label and select type');
            return;
        }
        const field = {
            label: label,
            type: type,
            options: type === 'select' ? document.getElementById('fieldOptionsText').value.split(',').map(opt => opt.trim()) : []
        };
        fields.push(field);
        fieldCount++;
        // Add visual field representation
        addFieldVisual(field);
        // Reset form
        document.getElementById('fieldLabel').value = '';
        document.getElementById('fieldType').value = '';
        document.getElementById('fieldOptionsText').value = '';
        updateFieldOptions();
        // Update hidden field data
        document.getElementById('fieldsData').value = JSON.stringify(fields);
    }
    function removeField(index) {
        fields.splice(index, 1);
        fieldCount--;
        refreshFields();
    }
    function updateFieldOptions() {
        const type = document.getElementById('fieldType').value;
        const optionsDiv = document.getElementById('fieldOptions');
        if (type === 'select') {
            optionsDiv.classList.remove('hidden');
        } else {
            optionsDiv.classList.add('hidden');
        }
    }
    function addFieldVisual(field) {
        const container = document.getElementById('fieldsContainer');
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'flex items-center justify-between p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors';
        const labelSpan = document.createElement('span');
        labelSpan.className = 'text-sm font-medium text-cyan-400';
        labelSpan.textContent = field.label;
        const typeSpan = document.createElement('span');
        typeSpan.className = 'px-2 py-1 bg-purple-500 bg-opacity-20 text-purple-400 rounded-full text-xs';
        typeSpan.textContent = field.type.toUpperCase();
        const optionsSpan = document.createElement('span');
        optionsSpan.className = 'text-xs text-gray-400';
        optionsSpan.textContent = field.options.length > 0 ? `(${field.options.length} options)` : '';
        const removeBtn = document.createElement('button');
        removeBtn.className = 'text-red-400 hover:text-red-300 ml-2';
        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
        removeBtn.onclick = () => {
            const index = Array.from(container.children).indexOf(fieldDiv);
            removeField(index);
        };
        const moveUpBtn = document.createElement('button');
        moveUpBtn.className = 'text-gray-400 hover:text-gray-300';
        moveUpBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
        moveUpBtn.onclick = () => {
            const index = Array.from(container.children).indexOf(fieldDiv);
            if (index > 0) {
                const temp = fields[index];
                fields[index] = fields[index - 1];
                fields[index - 1] = temp;
                refreshFields();
            }
        };
        const moveDownBtn = document.createElement('button');
        moveDownBtn.className = 'text-gray-400 hover:text-gray-300';
        moveDownBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
        moveDownBtn.onclick = () => {
            const index = Array.from(container.children).indexOf(fieldDiv);
            if (index < fields.length - 1) {
                const temp = fields[index];
                fields[index] = fields[index + 1];
                fields[index + 1] = temp;
                refreshFields();
            }
        };
        labelSpan.appendChild(typeSpan);
        labelSpan.appendChild(optionsSpan);
        labelSpan.appendChild(removeBtn);
        labelSpan.appendChild(moveUpBtn);
        labelSpan.appendChild(moveDownBtn);
        fieldDiv.appendChild(labelSpan);
        fieldDiv.appendChild(typeSpan);
        container.insertBefore(fieldDiv, container.firstChild);
    }
    function refreshFields() {
        const container = document.getElementById('fieldsContainer');
        container.innerHTML = '';
        fields.forEach((field, index) => {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'flex items-center justify-between p-4 bg-gray-800 rounded-lg';
            fieldDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="text-sm font-medium text-cyan-400">${index + 1}. ${field.label}</span>
                    <span class="px-2 py-1 bg-purple-500 bg-opacity-20 text-purple-400 rounded-full text-xs">${field.type.toUpperCase()}</span>
                    <span class="text-xs text-gray-400">${field.options.length > 0 ? `(${field.options.length} options)` : ''}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" onclick="addField()" class="text-green-400 hover:text-green-300">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" onclick="removeField(${index})" class="text-red-400 hover:text-red-300">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(fieldDiv);
        });
    }
</script>
{% endblock %}

transs_flow/templates/ipqc/dust_count_checklist_form.html

{% extends 'base.html' %}
{% load static %}

{% block title %}Dust Checklist{% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">
    <div class="row justify-content-center">
      <div class="col-lg-10 col-xl-8">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h4 class="card-title mb-0">Dust Count Checklist</h4>
          </div>
          <div class="card-body">
            <form method="post">
              {% csrf_token %}
              <div class="accordion" id="dustAccordion">

                <!-- BASIC INFO -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingBasic">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic" aria-expanded="true" aria-controls="collapseBasic">
                      Basic Information
                    </button>
                  </h2>
                  <div id="collapseBasic" class="accordion-collapse collapse show" aria-labelledby="headingBasic">
                    <div class="accordion-body row g-3">
                      {% for field in form %}
                        {% if field.name in 'date shift emp_id name line group model color' %}
                          <div class="col-md-6 mb-3">
                            <label class="form-label">{{ field.label }}</label>
                            {{ field }}
                            <div class="invalid-feedback d-block">{{ field.errors }}</div>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                </div>

                <!-- PARTICLE MEASUREMENTS -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingMeasurements">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMeasurements" aria-expanded="false" aria-controls="collapseMeasurements">
                      Particle Measurements
                    </button>
                  </h2>
                  <div id="collapseMeasurements" class="accordion-collapse collapse" aria-labelledby="headingMeasurements">
                    <div class="accordion-body row g-3">
                      {% for field in form %}
                        {% if field.name in 'micrometer_0_3 micrometer_0_5 micrometer_1_0 checked_by verified_by remark' %}
                          <div class="col-md-6 mb-3">
                            <label class="form-label">{{ field.label }}</label>
                            {{ field }}
                            <div class="invalid-feedback d-block">{{ field.errors }}</div>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                </div>

              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="submit" class="btn btn-success btn-lg">Submit Checklist</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


transs_flow/templates/ipqc/dust_count_checklist_list.html

{% extends 'base.html' %}
{% load static %}

{% block title %}Dust List{% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Dust Count Checklist</h4>
        <a href="{% url 'dust_count_checklist_add' %}" class="btn btn-primary">Add New Record</a>
      </div>
      <div class="card-body">
        <form method="get" class="mb-3 d-flex gap-2">
          <input type="text" name="q" class="form-control" placeholder="Search by Name, Emp ID, Line..." value="{{ request.GET.q }}">
          <button type="submit" class="btn btn-secondary">Search</button>
        </form>

        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                <th>Shift</th>
                <th>Emp ID</th>
                <th>Name</th>
                <th>Line</th>
                <th>Group</th>
                <th>Model</th>
                <th>Color</th>
                <th>â‰¥0.3Î¼m</th>
                <th>â‰¥0.5Î¼m</th>
                <th>â‰¥1.0Î¼m</th>
                <th>Checked By</th>
                <th>Verified By</th>
                <th>Created At</th>
              </tr>
            </thead>
            <tbody>
              {% for record in records %}
                <tr>
                  <td>{{ record.date }}</td>
                  <td>{{ record.shift }}</td>
                  <td>{{ record.emp_id }}</td>
                  <td>{{ record.name }}</td>
                  <td>{{ record.line }}</td>
                  <td>{{ record.group }}</td>
                  <td>{{ record.model }}</td>
                  <td>{{ record.color }}</td>
                  <td>{{ record.micrometer_0_3 }}</td>
                  <td>{{ record.micrometer_0_5 }}</td>
                  <td>{{ record.micrometer_1_0 }}</td>
                  <td>{{ record.checked_by }}</td>
                  <td>{{ record.verified_by }}</td>
                  <td>{{ record.created_at|date:"d-m-Y H:i" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="14" class="text-center">No records found.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if is_paginated %}
          <nav class="mt-3">
            <ul class="pagination justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo; Prev</a></li>
              {% endif %}
              <li class="page-item disabled"><a class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</a></li>
              {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next &raquo;</a></li>
              {% endif %}
            </ul>
          </nav>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}


transs_flow/templates/ipqc/dynamic_dashboard.html

{% extends 'base.html' %}
{% block title %}{{ form_obj.title }} Dashboard{% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">
    <div class="container mt-4">
      <h3>{{ form_obj.title }} Dashboard</h3>
      <p class="text-muted">{{ form_obj.description }}</p>

      <div class="row">
        <div class="col-md-4">
          <div class="card p-3 mb-3 shadow-sm">
            <h5>Total Submissions</h5>
            <h2>{{ total_submissions }}</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 mb-3 shadow-sm">
            <h5>Latest Submission</h5>
            <p>{{ latest_submission|date:"d M Y H:i" }}</p>
          </div>
        </div>
      </div>

      <h5 class="mt-4">Field Statistics</h5>
      {% for field, stats in numeric_summary.items %}
        <div class="card p-3 mb-2">
          <strong>{{ field }}</strong> â€” Mean: {{ stats.mean }}, Max: {{ stats.max }}, Min: {{ stats.min }}
        </div>
      {% empty %}
        <p class="text-muted">No numeric fields found.</p>
      {% endfor %}

      <h5 class="mt-4">Live Data</h5>
      <table class="table table-bordered">
        <thead>
          <tr>
            {% for col in numeric_summary.keys %}
              <th>{{ col }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody id="data-table-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const data = JSON.parse('{{ data_json|escapejs }}');
const tbody = document.getElementById("data-table-body");
if (tbody && data.length) {
  data.forEach(row => {
    const tr = document.createElement("tr");
    Object.values(row).forEach(val => {
      const td = document.createElement("td");
      td.textContent = val ?? "";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}
</script>
{% endblock %}


transs_flow/templates/ipqc/dynamic_form.html

{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Fill Dynamic Form{% endblock title %}

{% block content %}
<div class="pc-container">
    <div class="pc-content">
        <div class="row">
            <div class="container mt-4">
                <h3>{{ form_obj.title }}</h3>
                {% if form_obj.description %}
                    <p class="text-muted">{{ form_obj.description }}</p>
                {% endif %}

                <form method="post">
                    {% csrf_token %}

                    <!-- Today's IPQC Work Info -->
                    <h5>Today's IPQC Work Info</h5>
                    <div class="card p-3 mb-4">
                        <div class="row">
                            {% for field in form %}
                                {% if field.name in "Emp_ID Name Section Line Group Model Color" %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">{{ field.label }}</label>
                                        {{ field|add_class:"form-control" }}
                                        {% if field.errors %}
                                            <div class="text-danger">{{ field.errors }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Dynamic Form Fields -->
                    <h5>Dynamic Form Fields</h5>
                    <div class="card p-3 mb-3">
                        <div class="row">
                            {% for field in form %}
                                {% if field.name not in "Emp_ID Name Section Line Group Model Color" %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">{{ field.label }}</label>
                                        {{ field|add_class:"form-control" }}
                                        {% if field.errors %}
                                            <div class="text-danger">{{ field.errors }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Submit Form</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


transs_flow/templates/ipqc/esd_compliance_checklist_form.html

{% extends 'base.html' %}
{% load static %}
{% block title %}ESD Form{% endblock %}
{% block content %}
<style>
/* --- MODIFIED STYLE BLOCK FOR RESPONSIVE PROGRESS BAR --- */
.audit-form { max-width: 1200px; margin: 0 auto; padding: 16px; width: 100%; }
.step-indicator { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.step-progress { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; position: relative; }
/* MODIFIED: Removed 'min-width' and 'overflow-x: auto' to allow responsiveness */
.step-progress::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: var(--border); z-index: 0; }
.step-progress-line { position: absolute; top: 50%; left: 0; height: 2px; background: var(--primary); z-index: 1; transition: width 0.3s ease; transform: translateY(-50%); }
.step-item { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; cursor: pointer; flex-shrink: 0; }
.step-circle { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--border); background: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: var(--text-light); transition: all 0.3s ease; }
.step-circle.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
.step-circle.completed { background: var(--success); color: white; border-color: var(--success); }
.step-label { font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: 6px; font-weight: 500; white-space: nowrap; }

/* --- NEW: Media Query for Responsiveness --- */
@media (max-width: 640px) {
    .step-label {
        display: none; /* Hide text labels on small screens */
    }
    .step-circle {
        width: 36px;
        height: 36px;
        font-size: 13px;
    }
    .step-item {
        flex-shrink: 1; /* Allow items to shrink slightly if needed */
    }
}

.form-section { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.section-title { font-size: 18px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
.section-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.form-grid { display: grid; gap: 16px; width: 100%; }
.form-group { display: flex; flex-direction: column; width: 100%; }
.form-group label { display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: white; border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; transition: all 0.2s ease; font-family: inherit; box-sizing: border-box; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
.form-group input[readonly] { background: var(--bg-secondary); cursor: not-allowed; color: var(--text-secondary); }
.status-select { border-radius: 8px; font-weight: 500; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px; padding-right: 44px; appearance: none; }
.status-select[value="OK"] { border-color: var(--success); background-color: rgba(34, 197, 94, 0.05); }
.status-select[value="NOT_OK"] { border-color: var(--danger); background-color: rgba(239, 68, 68, 0.05); }
.status-select[value="NA"] { border-color: var(--text-light); background-color: rgba(100, 116, 139, 0.05); }
.form-group textarea { resize: vertical; min-height: 80px; }
.bottom-nav { position: sticky; bottom: 0; background: white; border-top: 1px solid var(--border); padding: 16px; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); }
.nav-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
.progress-text { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
.nav-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
.nav-btn { padding: 10px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; border: none; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; min-width: 80px; }
.nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.nav-btn-secondary { background: white; color: var(--text-secondary); border: 2px solid var(--border); }
.nav-btn-primary { background: var(--primary); color: white; }
.nav-btn-success { background: var(--success); color: white; }
@media (min-width: 768px) {
    .form-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .form-section { padding: 24px; margin-bottom: 24px; }
    .section-title { font-size: 20px; }
}
</style>
<div class="audit-form">
    <!-- Step Progress Indicator -->
    <div class="step-indicator">
        <div class="step-progress">
            <div class="step-progress-line" id="progressLine" style="width: 0%;"></div>
            <div class="step-item" onclick="goToStep(1)"><div class="step-circle active" id="step1">1</div><div class="step-label">Basic Info</div></div>
            <div class="step-item" onclick="goToStep(2)"><div class="step-circle" id="step2">2</div><div class="step-label">Personal Equipment</div></div>
            <div class="step-item" onclick="goToStep(3)"><div class="step-circle" id="step3">3</div><div class="step-label">Workbench</div></div>
            <div class="step-item" onclick="goToStep(4)"><div class="step-circle" id="step4">4</div><div class="step-label">Handling & Tools</div></div>
            <div class="step-item" onclick="goToStep(5)"><div class="step-circle" id="step5">5</div><div class="step-label">Photos</div></div>
            <div class="step-item" onclick="goToStep(6)"><div class="step-circle" id="step6">6</div><div class="step-label">Final</div></div>
        </div>
        <div class="progress-text">Step <span id="currentStep">1</span> of 6</div>
    </div>
    <!-- Form Container -->
    <form method="post" id="esdForm" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Step 1: Basic Information -->
        <div class="form-section" id="step1-content">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-sky-100"><i class="fas fa-info-circle text-sky-600"></i></div>Basic Information</h2>
                <div class="step-circle active">1</div>
            </div>
            <div class="form-grid">
                {% for field in form %}{% if field.name in 'date shift emp_id name line group model color' %}
                    <div class="form-group"><label for="{{ field.id_for_label }}">{{ field.label }}</label>{{ field }}{% if field.errors %}<p class="mt-2 text-sm text-red-600">{{ field.errors.0 }}</p>{% endif %}</div>
                {% endif %}{% endfor %}
            </div>
        </div>

        <!-- Step 2: Personal Equipment (Clothing & Wristband) -->
        <div class="form-section" id="step2-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-blue-100"><i class="fas fa-user text-blue-600"></i></div>Personal Equipment (Clothing & Wristband)</h2>
                <div class="step-circle">2</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in 'epa_clothes forbid_wear_out no_accessories clothes_clean collar_cover all_buttons_closed clothes_length watch_expose hair_cap slipper_check wristband_check pre_line_check wrist_touch_skin'  and field.name != "line" %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<p class="mt-2 text-sm text-red-600">{{ field.errors.0 }}</p>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 3: Workbench Environment (Grounding, Material & Consumables) -->
        <div class="form-section" id="step3-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-indigo-100"><i class="fas fa-desktop text-indigo-600"></i></div>Workbench Environment (Grounding & Consumables)</h2>
                <div class="step-circle">3</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in 'trolley_grounding device_grounded grounding_points_tight ion_fan_distance ion_fan_direction esds_box table_no_source gloves_condition mat_grounded audit_label_valid' %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<p class="mt-2 text-sm text-red-600">{{ field.errors.0 }}</p>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 4: Handling Rules & Tools -->
        <div class="form-section" id="step4-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-orange-100"><i class="fas fa-wrench text-orange-600"></i></div>Handling Rules & Tools</h2>
                <div class="step-circle">4</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in 'no_touch_pcba alert_plug_out tools_audit temp_humidity tray_voltage' %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<p class="mt-2 text-sm text-red-600">{{ field.errors.0 }}</p>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 5: ESD Photo Evidence -->
        <div class="form-section" id="step5-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-purple-100"><i class="fas fa-camera text-purple-600"></i></div>ESD Photo Evidence</h2>
                <div class="step-circle">5</div>
            </div>
            <div class="form-grid">
                 <!-- Manually render the photo input to force camera capture -->
                 <div class="form-group">
                    <label for="{{ form.epa_clothes_photo.id_for_label }}">{{ form.epa_clothes_photo.label }}</label>
                    <input type="file" name="{{ form.epa_clothes_photo.name }}" id="{{ form.epa_clothes_photo.id_for_label }}"
                           accept="image/*" capture="environment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    {% if form.epa_clothes_photo.errors %}<p class="mt-2 text-sm text-red-600">{{ form.epa_clothes_photo.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.hair_cap_photo.id_for_label }}">{{ form.hair_cap_photo.label }}</label>
                    <input type="file" name="{{ form.hair_cap_photo.name }}" id="{{ form.hair_cap_photo.id_for_label }}"
                           accept="image/*" capture="environment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    {% if form.hair_cap_photo.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hair_cap_photo.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.wristband_photo.id_for_label }}">{{ form.wristband_photo.label }}</label>
                    <input type="file" name="{{ form.wristband_photo.name }}" id="{{ form.wristband_photo.id_for_label }}"
                           accept="image/*" capture="environment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    {% if form.wristband_photo.errors %}<p class="mt-2 text-sm text-red-600">{{ form.wristband_photo.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.trolley_photo.id_for_label }}">{{ form.trolley_photo.label }}</label>
                    <input type="file" name="{{ form.trolley_photo.name }}" id="{{ form.trolley_photo.id_for_label }}"
                           accept="image/*" capture="environment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    {% if form.trolley_photo.errors %}<p class="mt-2 text-sm text-red-600">{{ form.trolley_photo.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.ion_fan_photo.id_for_label }}">{{ form.ion_fan_photo.label }}</label>
                    <input type="file" name="{{ form.ion_fan_photo.name }}" id="{{ form.ion_fan_photo.id_for_label }}"
                           accept="image/*" capture="environment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    {% if form.ion_fan_photo.errors %}<p class="mt-2 text-sm text-red-600">{{ form.ion_fan_photo.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.mat_photo.id_for_label }}">{{ form.mat_photo.label }}</label>
                    <input type="file" name="{{ form.mat_photo.name }}" id="{{ form.mat_photo.id_for_label }}"
                           accept="image/*" capture="environment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    {% if form.mat_photo.errors %}<p class="mt-2 text-sm text-red-600">{{ form.mat_photo.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.table_photo.id_for_label }}">{{ form.table_photo.label }}</label>
                    <input type="file" name="{{ form.table_photo.name }}" id="{{ form.table_photo.id_for_label }}"
                           accept="image/*" capture="environment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    {% if form.table_photo.errors %}<p class="mt-2 text-sm text-red-600">{{ form.table_photo.errors.0 }}</p>{% endif %}
                </div>
            </div>
        </div>
        <!-- Step 6: Readings, Remarks & Overview -->
        <div class="form-section" id="step6-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-yellow-100"><i class="fas fa-clipboard-check text-yellow-600"></i></div>Environmental Readings & Final Validation</h2>
                <div class="step-circle">6</div>
            </div>
            <div class="form-grid">
                {% for field in form %}{% if field.name in 'temperature_value humidity_value tray_voltage_value remark' %}
                    <div class="form-group"><label for="{{ field.id_for_label }}">{{ field.label }}</label>{{ field }}{% if field.errors %}<p class="mt-2 text-sm text-red-600">{{ field.errors.0 }}</p>{% endif %}</div>
                {% endif %}{% endfor %}
                <!-- Manually render the final overview photo -->
                <div class="form-group">
                    <label for="{{ form.photo_overview.id_for_label }}">{{ form.photo_overview.label }}</label>
                    <input type="file" name="{{ form.photo_overview.name }}" id="{{ form.photo_overview.id_for_label }}"
                           accept="image/*" capture="environment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    {% if form.photo_overview.errors %}<p class="mt-2 text-sm text-red-600">{{ form.photo_overview.errors.0 }}</p>{% endif %}
                </div>
            </div>
        </div>
    </form>
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-content">
            <div class="nav-info"><div class="progress-text">Section <span id="currentSection">1</span> of 6</div></div>
            <div class="nav-buttons">
                <button type="button" onclick="previousStep()" id="prev-btn" class="nav-btn nav-btn-secondary" disabled><i class="fas fa-arrow-left"></i> Previous</button>
                <button type="button" onclick="nextStep()" id="next-btn" class="nav-btn nav-btn-primary">Next <i class="fas fa-arrow-right"></i></button>
                <button type="submit" form="esdForm" id="submit-btn" class="nav-btn nav-btn-success" disabled><i class="fas fa-check"></i> Submit</button>
            </div>
        </div>
    </div>
</div>
<script>
let currentStep = 1;
const totalSteps = 6; // Updated to 6 steps
function updateStepIndicator() {
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    document.getElementById('progressLine').style.width = progressPercentage + '%';
    document.getElementById('currentStep').textContent = currentStep;
    document.getElementById('currentSection').textContent = currentStep;
    for (let i = 1; i <= totalSteps; i++) {
        const stepCircle = document.getElementById(`step${i}`);
        const stepContent = document.getElementById(`step${i}-content`);
        if (stepCircle) {
            stepCircle.classList.remove('active', 'completed');
            if (i < currentStep) { stepCircle.classList.add('completed'); stepCircle.innerHTML = 'âœ“'; }
            else if (i === currentStep) { stepCircle.classList.add('active'); stepCircle.innerHTML = i; }
            else { stepCircle.innerHTML = i; }
        }
        if (stepContent) {
            stepContent.style.display = i === currentStep ? 'block' : 'none';
        }
    }
    document.getElementById('prev-btn').disabled = currentStep === 1;
    document.getElementById('next-btn').disabled = currentStep === totalSteps;
    document.getElementById('submit-btn').disabled = currentStep !== totalSteps;
    document.querySelector('.audit-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}
function goToStep(step) { if (step >= 1 && step <= totalSteps) { currentStep = step; updateStepIndicator(); } }
function nextStep() { if (currentStep < totalSteps) { currentStep++; updateStepIndicator(); } }
function previousStep() { if (currentStep > 1) { currentStep--; updateStepIndicator(); } }
document.addEventListener('DOMContentLoaded', function() { updateStepIndicator(); });
</script>
{% endblock content %}

transs_flow/templates/ipqc/esd_compliance_checklist_list.html

{% extends 'base.html' %}
{% load static %}

{% block title %}ESD List{% endblock title %}

{% block content %}
<!-- Page Title -->
<h1 class="text-2xl font-bold text-gray-900 mb-6">ESD Compliance Checklist Records</h1>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ today_records|default:"0" }}</div>
        <div class="metric-label">Today's Records</div>
      </div>
      <div class="w-10 h-10 bg-sky-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-day text-sky-600"></i>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ week_records|default:"0" }}</div>
        <div class="metric-label">This Week</div>
      </div>
      <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-week text-teal-600"></i>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ total_records|default:"0" }}</div>
        <div class="metric-label">Total Records</div>
      </div>
      <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-database text-gray-600"></i>
      </div>
    </div>
  </div>
</div>

<!-- Search Bar -->
<div class="bg-white shadow-md rounded-xl p-4 mb-6">
  <form method="get" class="flex flex-col sm:flex-row gap-3">
    <div class="flex-1">
      <input type="text" name="q" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" 
             placeholder="Search by Name, Employee ID, Model, Line..." value="{{ request.GET.q }}">
    </div>
    <button type="submit" class="px-6 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition">
      <i class="fas fa-search"></i> Search
    </button>
    {% if request.GET.q %}
    <a href="{% url 'esd_compliance_checklist_list' %}" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
      <i class="fas fa-times"></i> Clear
    </a>
    {% endif %}
  </form>
</div>

<!-- Records Table -->
<div class="bg-white shadow-md rounded-xl overflow-hidden">
  <div class="px-4 sm:px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between gap-3 sm:items-center">
    <h5 class="text-lg font-bold text-gray-900">Recent ESD Records</h5>
    <a href="{% url 'esd_compliance_checklist_add' %}"
      class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 text-center transition">
      <i class="fas fa-plus"></i> Add New
    </a>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shift</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Line</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Model</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for record in records %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-3 sm:px-6 py-3 text-gray-900 font-medium">{{ record.date|date:"Y-m-d" }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700">
            <span class="px-2 py-1 text-xs rounded-full bg-gray-100">{{ record.shift }}</span>
          </td>
          <td class="px-3 sm:px-6 py-3">
            <div>
              <div class="text-gray-900 font-medium">{{ record.name }}</div>
              <div class="text-xs text-gray-500">{{ record.emp_id|default:"" }}</div>
            </div>
          </td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden md:table-cell">{{ record.line }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden md:table-cell">{{ record.model }}</td>
          <td class="px-3 sm:px-6 py-3">
            {% if record.get_overall_status == 'PASS' %}
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">PASS</span>
            {% elif record.get_overall_status == 'FAIL' %}
              <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">FAIL</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">MIXED</span>
            {% endif %}
          </td>
          <td class="px-3 sm:px-6 py-3">
            <div class="flex gap-2">
              <a href="#" onclick="event.preventDefault(); showESDDetails({{ record.id }})" class="text-sky-600 font-semibold text-xs sm:text-sm hover:underline">
                <i class="fas fa-eye"></i> View
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center py-6 text-gray-500">No records found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="mt-6 flex justify-center">
  <nav class="flex items-center space-x-1">
    {% if page_obj.has_previous %}
      <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-double-left"></i>
      </a>
      <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-left"></i>
      </a>
    {% endif %}

    <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-right"></i>
      </a>
      <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-double-right"></i>
      </a>
    {% endif %}
  </nav>
</div>
{% endif %}

<!-- Details Modal -->
<div id="esdDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-xl shadow-2xl w-[95%] sm:w-[90%] md:w-[80%] lg:w-[70%] max-h-[90vh] overflow-y-auto mt-[130px]">
    <div class="flex justify-between items-center px-4 sm:px-6 py-4 border-b">
      <h2 class="text-lg sm:text-xl font-bold text-gray-800">ESD Compliance Details</h2>
      <button onclick="closeESDDetails()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <div id="esdModalBody" class="p-4 sm:p-6">
      <p class="text-gray-500 text-center">Loading...</p>
    </div>
  </div>
</div>

<!-- CSS Styles -->
<style>
.metric-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid #e5e7eb;
  transition: all 0.3s ease;
}

.metric-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.metric-value {
  font-size: 2rem;
  font-weight: 700;
  color: #111827;
  line-height: 1;
}

.metric-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-top: 0.5rem;
}
</style>
{% endblock content %}

{% block extra_js %}
<script>
  function showESDDetails(pk) {
    const modal = document.getElementById('esdDetailsModal');
    const modalBody = document.getElementById('esdModalBody');
    modal.classList.remove('hidden');
    modalBody.innerHTML = `<p class='text-gray-500 text-center'>Loading...</p>`;

    fetch(`/ipqc/esd-compliance-checklist/details/${pk}/`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(data => {
        modalBody.innerHTML = buildDetailsUI(data);
      })
      .catch(error => {
        console.error('Error fetching details:', error);
        modalBody.innerHTML = `<p class='text-red-500 text-center'>Error loading details: ${error.message}</p>`;
      });
  }

  function closeESDDetails() {
    document.getElementById('esdDetailsModal').classList.add('hidden');
  }

  function buildDetailsUI(data) {
    // Helper function to create status badge HTML
    function createStatusBadge(value, label) {
      let bgColor = 'bg-gray-100';
      let textColor = 'text-gray-700';
      let icon = '';
      const val = (value || '').toString().toUpperCase();

      if (['PASS', 'OK', 'YES'].includes(val)) {
        bgColor = 'bg-green-100'; textColor = 'text-green-700'; icon = 'âœ… ';
      } else if (['FAIL', 'NOT_OK', 'NO'].includes(val)) {
        bgColor = 'bg-red-100'; textColor = 'text-red-700'; icon = 'âŒ ';
      } else if (['NA', 'N/A'].includes(val)) {
        bgColor = 'bg-yellow-100'; textColor = 'text-yellow-700'; icon = 'âž– ';
      }
      return `<div class="${bgColor} ${textColor} p-2 rounded text-center text-xs"><div class="font-semibold">${icon}${value || 'N/A'}</div><div class="opacity-75 mt-1">${label}</div></div>`;
    }
    
    let html = '<div class="space-y-6">';

    // Overall Status Section (NEW)
    if (data.overall_status) {
      html += `
        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-sky-50 to-blue-50 rounded-lg border border-sky-200">
          <h3 class="text-lg font-bold text-gray-800">Overall Result</h3>
          <span class="px-4 py-2 rounded-full text-md font-bold shadow-sm">
            ${createStatusBadge(data.overall_status, '').replace('text-xs', 'text-md').replace('p-2 rounded text-center', '')}
          </span>
        </div>
      `;
    }
    
    // Basic Information
    if (data.basic_info) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-info-circle text-sky-500"></i> Basic Information
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">`;
      for (const key in data.basic_info) {
        const item = data.basic_info[key];
        html += `<div class="bg-gray-50 p-3 rounded"><div class="text-xs text-gray-500">${item.label}</div><div class="font-semibold text-sm">${item.value || 'N/A'}</div></div>`;
      }
      html += `</div></div>`;
    }

    // ESD Compliance Sections
    if (data.compliance) {
      for (const sectionKey in data.compliance) {
        const section = data.compliance[sectionKey];
        html += `
          <div>
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
              <i class="fas ${section.icon || 'fa-shield-alt'} text-sky-500"></i> ${section.title}
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">`;
        section.items.forEach(item => html += createStatusBadge(item.value, item.label));
        html += `</div></div>`;
      }
    }

    // Readings Section
    if (data.readings) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-tachometer-alt text-blue-500"></i> Measurements & Readings
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">`;
      for (const key in data.readings) {
        const item = data.readings[key];
        html += `<div class="bg-blue-50 p-3 rounded border border-blue-200"><div class="text-xs text-blue-600">${item.label}</div><div class="font-semibold text-blue-700">${item.value || 'N/A'}</div></div>`;
      }
      html += `</div></div>`;
    }

    // Photos Section
    if (data.photos && data.photos.length > 0) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-camera text-sky-500"></i> Evidence Photos
          </h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">`;
      data.photos.forEach(photo => {
        html += `
          <div class="border rounded-lg overflow-hidden hover:shadow-lg transition cursor-pointer" onclick="openPhotoPreview('${photo.url}', '${photo.label}')">
            <img src="${photo.url}" alt="${photo.label}" class="w-full h-40 object-cover">
            <div class="text-center py-2 text-xs text-gray-600 bg-gray-50">${photo.label}</div>
          </div>`;
      });
      html += `</div></div>`;
    }

    // Remarks Section
    if (data.remark) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-clipboard text-gray-500"></i> Remarks
          </h3>
          <p class="text-gray-700 bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm sm:text-base">${data.remark}</p>
        </div>`;
    }
    
    // Creation Timestamp
    if (data.created_at) {
      html += `<div class="text-center text-xs text-gray-500 border-t pt-3">Record Created: ${data.created_at}</div>`;
    }

    html += '</div>';
    return html;
  }

  // --- Photo Preview Utility ---
  function openPhotoPreview(url, label) {
    if (document.getElementById('photoPreviewOverlay')) return;
    document.documentElement.style.overflow = 'hidden';
    const overlay = document.createElement('div');
    overlay.id = 'photoPreviewOverlay';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
    overlay.style.backdropFilter = 'blur(4px)';
    overlay.innerHTML = `
      <div class="bg-white rounded-lg overflow-hidden shadow-xl flex flex-col max-h-[90vh] max-w-4xl w-full">
        <div class="flex items-center justify-between px-4 py-3 bg-gray-100 border-b">
          <h2 class="text-sm sm:text-base font-semibold text-gray-800 truncate">${escapeHtml(label)}</h2>
          <div class="flex items-center gap-2">
            <a href="${url}" download class="inline-flex items-center gap-2 bg-sky-600 hover:bg-sky-700 text-white px-3 py-1.5 rounded-md text-sm"><i class="fas fa-download"></i> Download</a>
            <button onclick="closePhotoPreview()" class="text-gray-700 hover:text-gray-900 text-2xl leading-none bg-transparent border-0">&times;</button>
          </div>
        </div>
        <div class="flex-1 flex items-center justify-center bg-black p-2">
          <img src="${url}" alt="${escapeHtml(label)}" class="max-h-[80vh] w-auto object-contain rounded-md" />
        </div>
      </div>`;
    document.body.appendChild(overlay);
    overlay.addEventListener('click', e => { if (e.target === overlay) closePhotoPreview(); });
    document.addEventListener('keydown', escHandler);
    function escHandler(e) { if (e.key === 'Escape') closePhotoPreview(); }
    overlay._escHandler = escHandler;
  }
  function closePhotoPreview() {
    const overlay = document.getElementById('photoPreviewOverlay');
    if (!overlay) return;
    document.removeEventListener('keydown', overlay._escHandler);
    overlay.remove();
    document.documentElement.style.overflow = '';
  }
  function escapeHtml(str) {
    return String(str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
</script>
{% endblock %}

transs_flow/templates/ipqc/home.html

{% extends 'base.html' %}
{% load static %}

{% block title %}IPQC Control Panel{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-3 sm:p-4 md:p-6">
    <!-- Welcome Header -->
    <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-8 border border-cyan-500/20">
        <div class="text-center">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-3">
                Welcome, <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-indigo-600">
                    {{ Full_Name|default:"" }}
                </span>
            </h1>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 mb-4">
                <div class="flex items-center gap-2 text-sm sm:text-lg text-gray-600">
                    <i class="fas fa-microchip text-cyan-500"></i>
                    <span>IPQC Control System</span>
                </div>
                <div class="hidden sm:block h-8 w-px bg-gray-300"></div>
                <div class="flex flex-wrap items-center justify-center gap-2">
                    <span
                        class="inline-flex items-center px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium bg-green-100 text-green-800">
                        <i class="fas fa-circle text-green-500 mr-1 sm:mr-2 text-xs"></i>
                        Online
                    </span>
                    <span
                        class="inline-flex items-center px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium bg-cyan-100 text-cyan-700">
                        <i class="fas fa-user-tag mr-1"></i>{% if user.is_superuser %}
                                Superuser
                                {% elif user.is_staff %}
                                Admin
                                {% else %}
                                {{ user.role|default:'User' }}
                                {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Access Grid -->
    <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-8 border border-gray-100">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6">Quick Access</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4">
            <!-- FAI Test -->
            <a href="{% url 'testing_fai_create' %}"
                class="group relative p-3 sm:p-4 bg-gradient-to-br from-cyan-50 to-blue-100 rounded-xl hover:shadow-lg transition-all duration-300 hover:scale-105 border border-cyan-200">
                {% if fai_today > 0 %}
                <span
                    class="absolute -top-1 -right-1 bg-cyan-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold animate-pulse">
                    {{ fai_today }}
                </span>
                {% endif %}
                <div
                    class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-xl flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-clipboard-check text-white text-lg sm:text-xl"></i>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-gray-800 text-sm sm:text-base">FAI Test</div>
                    <div class="text-xs text-gray-600">First Article</div>
                </div>
            </a>

            <!-- ESD Compliance -->
            <a href="{% url 'esd_compliance_checklist_add' %}"
                class="group p-3 sm:p-4 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl hover:shadow-lg transition-all duration-300 hover:scale-105">
                <div
                    class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-shield-alt text-white text-lg sm:text-xl"></i>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-gray-800 text-sm sm:text-base">ESD</div>
                    <div class="text-xs text-gray-600">Safety</div>
                </div>
            </a>
            
            <!-- MP Audit -->
            <a href="{% url 'operator_qualification_create' %}"
                class="group p-3 sm:p-4 bg-gradient-to-br from-yellow-50 to-orange-100 rounded-xl hover:shadow-lg transition-all duration-300 hover:scale-105">
                <div
                    class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-flask text-white text-lg sm:text-xl"></i>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-gray-800 text-sm sm:text-base">MP Audit</div>
                    <div class="text-xs text-gray-600">Manpower Check</div>
                </div>
            </a>

            <!-- Disassemble -->
            <a href="{% url 'ipqc_disassemble_add' %}"
                class="group p-3 sm:p-4 bg-gradient-to-br from-orange-50 to-red-100 rounded-xl hover:shadow-lg transition-all duration-300 hover:scale-105">
                <div
                    class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3 bg-gradient-to-br from-orange-400 to-red-500 rounded-xl flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-tools text-white text-lg sm:text-xl"></i>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-gray-800 text-sm sm:text-base">Disassemble</div>
                    <div class="text-xs text-gray-600">Checklist</div>
                </div>
            </a>

            <!-- BTB Check -->
            <a href="{% url 'btb_checksheet_create' %}"
                class="group p-3 sm:p-4 bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl hover:shadow-lg transition-all duration-300 hover:scale-105">
                <div
                    class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3 bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-clipboard-check text-white text-lg sm:text-xl"></i>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-gray-800 text-sm sm:text-base">BTB Check</div>
                    <div class="text-xs text-gray-600">Fitment Records</div>
                </div>
            </a>

            <!-- Dummy Test -->
            <a href="{% url 'ass_dummy_test_create' %}"
                class="group p-3 sm:p-4 bg-gradient-to-br from-purple-50 to-indigo-100 rounded-xl hover:shadow-lg transition-all duration-300 hover:scale-105">
                <div
                    class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-xl flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-vial text-white text-lg sm:text-xl"></i>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-gray-800 text-sm sm:text-base">Dummy Test</div>
                    <div class="text-xs text-gray-600">QA Tests</div>
                </div>
            </a>

            <!-- NC Issues -->
            <a href="{% url 'nc_issue_tracking_create' %}"
                class="group p-3 sm:p-4 bg-gradient-to-br from-red-50 to-pink-100 rounded-xl hover:shadow-lg transition-all duration-300 hover:scale-105">
                <div
                    class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3 bg-gradient-to-br from-red-400 to-pink-500 rounded-xl flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-exclamation-triangle text-white text-lg sm:text-xl"></i>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-gray-800 text-sm sm:text-base">NC Issues</div>
                    <div class="text-xs text-gray-600">Tracking</div>
                </div>
            </a>
        </div>
    </div>

    <!-- Individual Stats Cards -->
    <!-- Individual Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <!-- Work Info Card -->
        <div
            class="group relative bg-gradient-to-br from-white via-cyan-50/30 to-blue-50/20 backdrop-blur-sm rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-cyan-100/50 overflow-hidden">
            <!-- Animated Background Pattern -->
            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                <div class="absolute top-0 right-0 w-32 h-32 bg-cyan-400/10 rounded-full blur-3xl animate-pulse"></div>
                <div
                    class="absolute bottom-0 left-0 w-24 h-24 bg-blue-400/10 rounded-full blur-2xl animate-pulse delay-75">
                </div>
            </div>

            <!-- Card Header -->
            <div class="relative z-10 p-4 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-cyan-500/25 transition-all duration-300 group-hover:scale-110">
                            <i class="fas fa-clipboard-list text-white text-sm sm:text-lg"></i>
                        </div>
                        <div>
                            <h3
                                class="text-base sm:text-lg font-bold bg-gradient-to-r from-cyan-700 to-blue-700 bg-clip-text text-transparent">
                                Work Info</h3>
                        </div>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <i class="fas fa-ellipsis-v text-gray-400 hover:text-gray-600"></i>
                    </button>
                </div>

                <!-- Stats Display -->
                <div class="space-y-3">
                    <div class="relative group/item">
                        <div
                            class="flex justify-between items-center p-3 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl border border-cyan-200/50 group-hover/item:from-cyan-100 group-hover/item:to-blue-100 transition-all duration-300">
                            <div>
                                <span class="text-xs text-gray-600 font-medium">Today</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-2xl font-bold text-cyan-700">{{ work_info_today|default:"0" }}</span>
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-cyan-500/10 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-day text-cyan-600 text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200/50 hover:from-blue-100 hover:to-indigo-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Week</span>
                            <div class="text-xl font-bold text-blue-700">{{ work_info_week|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar-week text-blue-600 text-xs"></i>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-200/50 hover:from-indigo-100 hover:to-purple-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Month</span>
                            <div class="text-xl font-bold text-indigo-700">{{ work_info_month|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-indigo-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-indigo-600 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Action Buttons -->
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <a href="{% url 'ipqc_work_info' %}"
                        class="relative group/btn overflow-hidden bg-gradient-to-r from-cyan-500 to-blue-600 text-white px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-cyan-500/25 hover:scale-105 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-plus-circle group-hover/btn:rotate-90 transition-transform duration-300"></i>
                            <span>New</span>
                            <div class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div>
                        </div>
                    </a>

                    <a href="{% url 'info_dash' %}"
                        class="relative group/btn2 overflow-hidden bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-gray-400/25 hover:scale-105 hover:from-gray-200 hover:to-gray-300 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn2:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-chart-line group-hover/btn2:scale-110 transition-transform duration-300"></i>
                            <span>View All</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- FAI Stats Card -->
        <div
            class="group relative bg-gradient-to-br from-white via-orange-50/30 to-red-50/20 backdrop-blur-sm rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-orange-100/50 overflow-hidden">
            <!-- Animated Background Pattern -->
            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-400/10 rounded-full blur-3xl animate-pulse">
                </div>
                <div
                    class="absolute bottom-0 left-0 w-24 h-24 bg-red-400/10 rounded-full blur-2xl animate-pulse delay-75">
                </div>
            </div>

            <!-- Card Header -->
            <div class="relative z-10 p-4 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-orange-400 to-red-600 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-orange-500/25 transition-all duration-300 group-hover:scale-110">
                            <i class="fas fa-clipboard-check text-white text-sm sm:text-lg"></i>
                        </div>
                        <div>
                            <h3
                                class="text-base sm:text-lg font-bold bg-gradient-to-r from-orange-700 to-red-700 bg-clip-text text-transparent">
                                FAI Testing</h3>
                        </div>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <i class="fas fa-ellipsis-v text-gray-400 hover:text-gray-600"></i>
                    </button>
                </div>

                <!-- Stats Display -->
                <div class="space-y-3">
                    <div class="relative group/item">
                        <div
                            class="flex justify-between items-center p-3 bg-gradient-to-r from-orange-50 to-red-50 rounded-xl border border-orange-200/50 group-hover/item:from-orange-100 group-hover/item:to-red-100 transition-all duration-300">
                            <div>
                                <span class="text-xs text-gray-600 font-medium">Today</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-2xl font-bold text-orange-700">{{ fai_today|default:"0" }}</span>
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-orange-500/10 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-day text-orange-600 text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-red-50 to-rose-50 rounded-xl border border-red-200/50 hover:from-red-100 hover:to-rose-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Week</span>
                            <div class="text-xl font-bold text-red-700">{{ fai_week|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-red-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar-week text-red-600 text-xs"></i>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-rose-50 to-pink-50 rounded-xl border border-rose-200/50 hover:from-rose-100 hover:to-pink-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Month</span>
                            <div class="text-xl font-bold text-rose-700">{{ fai_month|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-rose-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-rose-600 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Action Buttons -->
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <a href="{% url 'testing_fai_create' %}"
                        class="relative group/btn overflow-hidden bg-gradient-to-r from-orange-500 to-red-600 text-white px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-orange-500/25 hover:scale-105 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-plus-circle group-hover/btn:rotate-90 transition-transform duration-300"></i>
                            <span>New</span>
                            <div class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div>
                        </div>
                    </a>

                    <a href="{% url 'testing_fai_list' %}"
                        class="relative group/btn2 overflow-hidden bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-gray-400/25 hover:scale-105 hover:from-gray-200 hover:to-gray-300 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn2:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-chart-line group-hover/btn2:scale-110 transition-transform duration-300"></i>
                            <span>View All</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Assembly Audit Stats Card -->
        <div
            class="group relative bg-gradient-to-br from-white via-purple-50/30 to-pink-50/20 backdrop-blur-sm rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-purple-100/50 overflow-hidden">
            <!-- Animated Background Pattern -->
            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                <div class="absolute top-0 right-0 w-32 h-32 bg-purple-400/10 rounded-full blur-3xl animate-pulse">
                </div>
                <div
                    class="absolute bottom-0 left-0 w-24 h-24 bg-pink-400/10 rounded-full blur-2xl animate-pulse delay-75">
                </div>
            </div>

            <!-- Card Header -->
            <div class="relative z-10 p-4 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-purple-400 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-purple-500/25 transition-all duration-300 group-hover:scale-110">
                            <i class="fas fa-clipboard-check text-white text-sm sm:text-lg"></i>
                        </div>
                        <div>
                            <h3
                                class="text-base sm:text-lg font-bold bg-gradient-to-r from-purple-700 to-indigo-700 bg-clip-text text-transparent">
                                Assembly Audit</h3>
                        </div>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <i class="fas fa-ellipsis-v text-gray-400 hover:text-gray-600"></i>
                    </button>
                </div>

                <!-- Stats Display -->
                <div class="space-y-3">
                    <div class="relative group/item">
                        <div
                            class="flex justify-between items-center p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200/50 group-hover/item:from-purple-100 group-hover/item:to-pink-100 transition-all duration-300">
                            <div>
                                <span class="text-xs text-gray-600 font-medium">Today</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-2xl font-bold text-purple-700">{{ audit_today|default:"0" }}</span>
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-purple-500/10 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-day text-purple-600 text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl border border-indigo-200/50 hover:from-indigo-100 hover:to-blue-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Week</span>
                            <div class="text-xl font-bold text-indigo-700">{{ audit_week|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-indigo-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar-week text-indigo-600 text-xs"></i>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-200/50 hover:from-blue-100 hover:to-cyan-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Month</span>
                            <div class="text-xl font-bold text-blue-700">{{ audit_month|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-blue-600 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Action Buttons -->
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <a href="{% url 'ipqc_assembly_audit_create' %}"
                        class="relative group/btn overflow-hidden bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/25 hover:scale-105 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-plus-circle group-hover/btn:rotate-90 transition-transform duration-300"></i>
                            <span>New</span>
                            <div class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div>
                        </div>
                    </a>

                    <a href="{% url 'ipqc_audit_list' %}"
                        class="relative group/btn2 overflow-hidden bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-gray-400/25 hover:scale-105 hover:from-gray-200 hover:to-gray-300 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn2:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-chart-line group-hover/btn2:scale-110 transition-transform duration-300"></i>
                            <span>View All</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- ESD Compliance Card -->
        <div
            class="group relative bg-gradient-to-br from-white via-cyan-50/30 to-sky-50/20 backdrop-blur-sm rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-cyan-100/50 overflow-hidden">
            <!-- Animated Background Pattern -->
            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                <div class="absolute top-0 right-0 w-32 h-32 bg-cyan-400/10 rounded-full blur-3xl animate-pulse"></div>
                <div
                    class="absolute bottom-0 left-0 w-24 h-24 bg-sky-400/10 rounded-full blur-2xl animate-pulse delay-75">
                </div>
            </div>

            <!-- Card Header -->
            <div class="relative z-10 p-4 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-cyan-400 to-sky-600 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-cyan-500/25 transition-all duration-300 group-hover:scale-110">
                            <i class="fas fa-shield-alt text-white text-sm sm:text-lg"></i>
                        </div>
                        <div>
                            <h3
                                class="text-base sm:text-lg font-bold bg-gradient-to-r from-cyan-700 to-sky-700 bg-clip-text text-transparent">
                                ESD Compliance</h3>
                        </div>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <i class="fas fa-ellipsis-v text-gray-400 hover:text-gray-600"></i>
                    </button>
                </div>

                <!-- Stats Display -->
                <div class="space-y-3">
                    <div class="relative group/item">
                        <div
                            class="flex justify-between items-center p-3 bg-gradient-to-r from-cyan-50 to-sky-50 rounded-xl border border-cyan-200/50 group-hover/item:from-cyan-100 group-hover/item:to-sky-100 transition-all duration-300">
                            <div>
                                <span class="text-xs text-gray-600 font-medium">Today</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-2xl font-bold text-cyan-700">{{ esd_today|default:"0" }}</span>
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-cyan-500/10 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-day text-cyan-600 text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-sky-50 to-blue-50 rounded-xl border border-sky-200/50 hover:from-sky-100 hover:to-blue-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Week</span>
                            <div class="text-xl font-bold text-sky-700">{{ esd_week|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-sky-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar-week text-sky-600 text-xs"></i>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200/50 hover:from-blue-100 hover:to-indigo-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Month</span>
                            <div class="text-xl font-bold text-blue-700">{{ esd_month|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-blue-600 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Action Buttons -->
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <a href="{% url 'esd_compliance_checklist_add' %}"
                        class="relative group/btn overflow-hidden bg-gradient-to-r from-cyan-500 to-sky-600 text-white px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-cyan-500/25 hover:scale-105 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-plus-circle group-hover/btn:rotate-90 transition-transform duration-300"></i>
                            <span>New</span>
                            <div class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div>
                        </div>
                    </a>

                    <a href="{% url 'esd_compliance_checklist_list' %}"
                        class="relative group/btn2 overflow-hidden bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-gray-400/25 hover:scale-105 hover:from-gray-200 hover:to-gray-300 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn2:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-chart-line group-hover/btn2:scale-110 transition-transform duration-300"></i>
                            <span>View All</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- IPQC Disassemble Card -->
        <div
            class="group relative bg-gradient-to-br from-white via-orange-50/30 to-red-50/20 backdrop-blur-sm rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-orange-100/50 overflow-hidden">
            <!-- Animated Background Pattern -->
            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-400/10 rounded-full blur-3xl animate-pulse">
                </div>
                <div
                    class="absolute bottom-0 left-0 w-24 h-24 bg-red-400/10 rounded-full blur-2xl animate-pulse delay-75">
                </div>
            </div>

            <!-- Card Header -->
            <div class="relative z-10 p-4 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-orange-400 to-red-600 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-orange-500/25 transition-all duration-300 group-hover:scale-110">
                            <i class="fas fa-tools text-white text-sm sm:text-lg"></i>
                        </div>
                        <div>
                            <h3
                                class="text-base sm:text-lg font-bold bg-gradient-to-r from-orange-700 to-red-700 bg-clip-text text-transparent">
                                Disassemble</h3>
                        </div>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <i class="fas fa-ellipsis-v text-gray-400 hover:text-gray-600"></i>
                    </button>
                </div>

                <!-- Stats Display -->
                <div class="space-y-3">
                    <div class="relative group/item">
                        <div
                            class="flex justify-between items-center p-3 bg-gradient-to-r from-orange-50 to-red-50 rounded-xl border border-orange-200/50 group-hover/item:from-orange-100 group-hover/item:to-red-100 transition-all duration-300">
                            <div>
                                <span class="text-xs text-gray-600 font-medium">Today</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-2xl font-bold text-orange-700">{{ disassemble_today|default:"0" }}</span>
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-orange-500/10 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-day text-orange-600 text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-red-50 to-rose-50 rounded-xl border border-red-200/50 hover:from-red-100 hover:to-rose-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Week</span>
                            <div class="text-xl font-bold text-red-700">{{ disassemble_week|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-red-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar-week text-red-600 text-xs"></i>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center p-3 bg-gradient-to-r from-rose-50 to-pink-50 rounded-xl border border-rose-200/50 hover:from-rose-100 hover:to-pink-100 transition-all duration-300">
                        <div>
                            <span class="text-xs text-gray-600 font-medium">This Month</span>
                            <div class="text-xl font-bold text-rose-700">{{ disassemble_month|default:"0" }}</div>
                        </div>
                        <div class="w-8 h-8 bg-rose-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-rose-600 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Action Buttons -->
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <a href="{% url 'ipqc_disassemble_add' %}"
                        class="relative group/btn overflow-hidden bg-gradient-to-r from-orange-500 to-red-600 text-white px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-orange-500/25 hover:scale-105 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-plus-circle group-hover/btn:rotate-90 transition-transform duration-300"></i>
                            <span>New</span>
                            <div class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div>
                        </div>
                    </a>

                    <a href="{% url 'ipqc_disassemble_list' %}"
                        class="relative group/btn2 overflow-hidden bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 px-3 py-2.5 rounded-xl font-semibold text-xs sm:text-sm transition-all duration-300 hover:shadow-lg hover:shadow-gray-400/25 hover:scale-105 hover:from-gray-200 hover:to-gray-300 active:scale-95">
                        <!-- Button Shimmer Effect -->
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover/btn2:translate-x-full transition-transform duration-700">
                        </div>

                        <div class="relative z-10 flex items-center justify-center gap-1.5">
                            <i
                                class="fas fa-chart-line group-hover/btn2:scale-110 transition-transform duration-300"></i>
                            <span>View All</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

transs_flow/templates/ipqc/info_dash.html

{% extends 'base.html' %}

{% block title %}Work Info Dash{% endblock title %}

{% block content %}

<!-- Page Title -->
<h1 class="text-2xl font-bold text-gray-900 mb-6">IPQC Work Information</h1>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="metric-card">
        <div class="flex items-start justify-between">
            <div>
                <div class="metric-value">{{ today_records }}</div>
                <div class="metric-label">Today's Records</div>
            </div>
            <div class="w-10 h-10 bg-sky-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-calendar-day text-sky-600"></i>
            </div>
        </div>
    </div>

    <div class="metric-card">
        <div class="flex items-start justify-between">
            <div>
                <div class="metric-value">{{ week_records }}</div>
                <div class="metric-label">This Week</div>
            </div>
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-calendar-week text-green-600"></i>
            </div>
        </div>
    </div>

    <div class="metric-card">
        <div class="flex items-start justify-between">
            <div>
                <div class="metric-value">{{ total_records }}</div>
                <div class="metric-label">Total Records</div>
            </div>
            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-database text-gray-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Recent Records Table -->
{% if recent_records %}
<div class="bg-white shadow-md rounded-xl overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
        <h5 class="text-lg font-bold text-gray-900">Recent Records</h5>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Date
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Shift
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Employee ID
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Name
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Section
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Model
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Line
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Group
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Color
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white">
                {% for record in recent_records %}
                <tr class="hover:bg-gray-50 transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ record.date|date:"Y-m-d" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        {{ record.shift }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                        {{ record.emp_id }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ record.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ record.section }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ record.model }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ record.line }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ record.group }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ record.color }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% endblock content %}

transs_flow/templates/ipqc/ipqc_assembly_audit_form.html

{% extends 'base.html' %}

{% block title %}Assembly Audit{% endblock %}

{% block content %}
<style>
/* Clean form styles */
.audit-form {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
    width: 100%;
}

/* Step indicator */
.step-indicator {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    overflow-x: auto;
}

.step-progress {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    position: relative;
    min-width: 600px; /* Ensure minimum width for proper display */
}

.step-progress::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--border);
    z-index: 0;
}

.step-progress-line {
    position: absolute;
    top: 50%;
    left: 0;
    height: 2px;
    background: var(--primary);
    z-index: 1;
    transition: width 0.3s ease;
    transform: translateY(-50%);
}

.step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    cursor: pointer;
    flex-shrink: 0;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid var(--border);
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: var(--text-light);
    transition: all 0.3s ease;
}

.step-circle.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
}

.step-circle.completed {
    background: var(--success);
    color: white;
    border-color: var(--success);
}

.step-label {
    font-size: 11px;
    color: var(--text-secondary);
    text-align: center;
    margin-top: 6px;
    font-weight: 500;
    white-space: nowrap;
}

/* Form sections */
.form-section {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 16px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
    width: 100%;
    overflow-x: hidden;
}

.form-section:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 8px;
}

.section-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    min-width: 0;
}

.section-title i {
    font-size: 20px;
}

.section-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.form-grid {
    display: grid;
    gap: 16px;
    width: 100%;
}

.form-group {
    display: flex;
    flex-direction: column;
    width: 100%;
    min-width: 0;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
    word-wrap: break-word;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    background: white;
    border: 2px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    transition: all 0.2s ease;
    font-family: inherit;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

.form-group input[readonly] {
    background: var(--bg-secondary);
    cursor: not-allowed;
    color: var(--text-secondary);
}

.form-group select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 20px;
    padding-right: 44px;
    appearance: none;
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.status-select {
    border-radius: 8px;
    font-weight: 500;
}

.status-select[value="OK"] {
    border-color: var(--success);
    background: rgba(34, 197, 94, 0.05);
}

.status-select[value="NOT_OK"] {
    border-color: var(--danger);
    background: rgba(239, 68, 68, 0.05);
}

.status-select[value="NA"] {
    border-color: var(--text-light);
    background: rgba(100, 116, 139, 0.05);
}



@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Bottom navigation */
.bottom-nav {
    position: sticky;
    bottom: 0;
    background: white;
    border-top: 1px solid var(--border);
    padding: 16px;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    margin-top: 30px;
    overflow-x: hidden;
}

.nav-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
}

.nav-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.progress-text {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
    white-space: nowrap;
}

.nav-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    flex: 1;
    min-width: 0;
}

.nav-btn {
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    flex: 1;
    min-width: 80px;
    max-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.nav-btn-secondary {
    background: white;
    color: var(--text-secondary);
    border: 2px solid var(--border);
}

.nav-btn-secondary:hover:not(:disabled) {
    background: var(--bg-secondary);
    border-color: var(--primary);
    color: var(--primary);
}

.nav-btn-primary {
    background: var(--primary);
    color: white;
}

.nav-btn-primary:hover:not(:disabled) {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}

.nav-btn-success {
    background: var(--success);
    color: white;
}

.nav-btn-success:hover:not(:disabled) {
    background: #16a34a;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

/* Loading state */
.loading {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.spinner {
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Alert styles */
.alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
    flex-wrap: wrap;
}

.alert-success {
    background: rgba(34, 197, 94, 0.1);
    color: var(--success);
    border: 1px solid rgba(34, 197, 94, 0.2);
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

/* Desktop styles */
@media (min-width: 768px) {
    .audit-form {
        padding: 20px;
    }
    
    .form-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .form-section {
        padding: 24px;
        margin-bottom: 24px;
    }
    
    .section-header {
        flex-wrap: nowrap;
        margin-bottom: 20px;
        padding-bottom: 16px;
    }
    
    .section-title {
        font-size: 20px;
    }
    
    .section-title i {
        font-size: 24px;
    }
    
    .section-icon {
        width: 40px;
        height: 40px;
    }
    
    .form-group label {
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 12px 16px;
        font-size: 15px;
    }
    
    .form-group textarea {
        min-height: 100px;
    }
    
    .nav-content {
        flex-wrap: nowrap;
        gap: 20px;
    }
    
    .nav-buttons {
        gap: 12px;
        flex: none;
        width: auto;
    }
    
    .nav-btn {
        flex: none;
        min-width: auto;
        max-width: none;
        padding: 10px 20px;
        font-size: 14px;
    }
    
    .step-indicator {
        padding: 20px;
        margin-bottom: 24px;
        overflow-x: visible;
    }
    
    .step-progress {
        min-width: auto;
    }
    
    .step-label {
        font-size: 12px;
        margin-top: 8px;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        font-size: 14px;
    }
}

/* Small mobile adjustments */
@media (max-width: 480px) {
    .audit-form {
        padding: 12px 8px;
    }
    
    .form-section {
        padding: 16px 12px;
        margin-bottom: 16px;
    }
    
    .section-header {
        padding-bottom: 10px;
        margin-bottom: 12px;
    }
    
    .section-title {
        font-size: 16px;
        gap: 8px;
    }
    
    .section-icon {
        width: 32px;
        height: 32px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 10px;
        font-size: 13px;
    }
    
    .bottom-nav {
        padding: 12px 8px;
    }
    
    .nav-btn {
        padding: 8px 12px;
        font-size: 12px;
        min-width: 70px;
    }
    
    .step-circle {
        width: 32px;
        height: 32px;
        font-size: 12px;
    }
    
    .step-label {
        font-size: 10px;
        margin-top: 4px;
    }
}

/* Touch optimizations */
@media (hover: none) and (pointer: coarse) {
    .nav-btn {
        min-height: 44px;
    }
    
    
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        min-height: 44px;
    }
}

/* Ensure no horizontal overflow */
body {
    overflow-x: hidden;
}

html {
    overflow-x: hidden;
}

main {
    overflow-x: hidden;
}

/* Fix iOS Safari viewport issue */
@supports (-webkit-touch-callout: none) {
    .audit-form {
        width: 100%;
        max-width: 100vw;
    }
}
</style>

<div class="audit-form">
    <!-- Step Progress Indicator -->
    <div class="step-indicator">
        <div class="step-progress">
            <div class="step-progress-line" id="progressLine" style="width: 0%;"></div>
            <div class="step-item" onclick="goToStep(1)">
                <div class="step-circle active" id="step1">1</div>
                <div class="step-label">Basic</div>
            </div>
            <div class="step-item" onclick="goToStep(2)">
                <div class="step-circle" id="step2">2</div>
                <div class="step-label">Machine</div>
            </div>
            <div class="step-item" onclick="goToStep(3)">
                <div class="step-circle" id="step3">3</div>
                <div class="step-label">Material</div>
            </div>
            <div class="step-item" onclick="goToStep(4)">
                <div class="step-circle" id="step4">4</div>
                <div class="step-label">Method</div>
            </div>
            <div class="step-item" onclick="goToStep(5)">
                <div class="step-circle" id="step5">5</div>
                <div class="step-label">Environment</div>
            </div>
            <div class="step-item" onclick="goToStep(6)">
                <div class="step-circle" id="step6">6</div>
                <div class="step-label">Monitor</div>
            </div>
            <div class="step-item" onclick="goToStep(7)">
                <div class="step-circle" id="step7">7</div>
                <div class="step-label">Remark</div>
            </div>
        </div>
        <div class="progress-text">Step <span id="currentStep">1</span> of 7</div>
    </div>

    <!-- Form Container -->
    <form method="post" id="auditForm">
        {% csrf_token %}
        
        <!-- Step 1: Basic Information -->
        <div class="form-section" id="step1-content">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-sky-100">
                        <i class="fas fa-info-circle text-sky-600"></i>
                    </div>
                    Basic Information
                </h2>
                <div class="step-circle active">1</div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="text" name="date" id="date" value="{{ form.date.value|default:'--' }}" readonly>
                </div>
                
                <div class="form-group">
                    <label for="shift">Shift</label>
                    <input type="text" name="shift" id="shift" value="{{ form.shift.value|default:'--' }}" readonly>
                </div>
                
                <div class="form-group">
                    <label for="emp_id">ID</label>
                    <input type="text" name="emp_id" id="emp_id" value="{{ form.emp_id.value|default:'--' }}" readonly>
                </div>

                <div class="form-group">
                    <label for="emp_id">Name</label>
                    <input type="text" name="name" id="name" value="{{ form.name.value|default:'--' }}" readonly>
                </div>
                
                <div class="form-group">
                    <label for="model">Section</label>
                    <input type="text" name="section" id="section" value="{{ form.section.value|default:'--' }}" readonly>
                </div>

                <div class="form-group">
                    <label for="model">Line</label>
                    <input type="text" name="line" id="line" value="{{ form.line.value|default:'--' }}" readonly>
                </div>

                <div class="form-group">
                    <label for="model">Group</label>
                    <input type="text" name="group" id="group" value="{{ form.group.value|default:'--' }}" readonly>
                </div>

                <div class="form-group">
                    <label for="model">Model</label>
                    <input type="text" name="model" id="model" value="{{ form.model.value|default:'--' }}" readonly>
                </div>

                <div class="form-group">
                    <label for="model">Color</label>
                    <input type="text" name="color" id="color" value="{{ form.color.value|default:'--' }}" readonly>
                </div>
            </div>
        </div>
        
        
        <!-- Step 2: Machine -->
        <div class="form-section" id="step2-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-orange-100">
                        <i class="fas fa-cogs text-orange-600"></i>
                    </div>
                    MACHINE
                </h2>
                <div class="step-circle">3</div>
            </div>
            
            <div class="form-grid">
                {% for field in machine_fields %}
                    <div class="form-group">
                        <label>{{ field.label }}</label>
                        <select name="{{ field.html_name }}" class="status-select">
                            <option value="">Select</option>
                            <option value="OK" {% if field.value == 'OK' %}selected{% endif %}>OK</option>
                            <option value="NOT_OK" {% if field.value == 'NOT_OK' %}selected{% endif %}>Not OK</option>
                            <option value="NA" {% if field.value == 'NA' %}selected{% endif %}>N/A</option>
                        </select>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Step 3: Material -->
        <div class="form-section" id="step3-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-pink-100">
                        <i class="fas fa-box text-pink-600"></i>
                    </div>
                    MATERIAL
                </h2>
                <div class="step-circle">4</div>
            </div>
            
            <div class="form-grid">
                {% for field in material_fields %}
                    <div class="form-group">
                        <label>{{ field.label }}</label>
                        <select name="{{ field.html_name }}" class="status-select">
                            <option value="">Select</option>
                            <option value="OK" {% if field.value == 'OK' %}selected{% endif %}>OK</option>
                            <option value="NOT_OK" {% if field.value == 'NOT_OK' %}selected{% endif %}>Not OK</option>
                            <option value="NA" {% if field.value == 'NA' %}selected{% endif %}>N/A</option>
                        </select>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Step 4: Method -->
        <div class="form-section" id="step4-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-yellow-100">
                        <i class="fas fa-list-ol text-yellow-600"></i>
                    </div>
                    METHOD
                </h2>
                <div class="step-circle">5</div>
            </div>
            
            <div class="form-grid">
                {% for field in method_fields %}
                    <div class="form-group">
                        <label>{{ field.label }}</label>
                        <select name="{{ field.html_name }}" class="status-select">
                            <option value="">Select</option>
                            <option value="OK" {% if field.value == 'OK' %}selected{% endif %}>OK</option>
                            <option value="NOT_OK" {% if field.value == 'NOT_OK' %}selected{% endif %}>Not OK</option>
                            <option value="NA" {% if field.value == 'NA' %}selected{% endif %}>N/A</option>
                        </select>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Step 5: Environment -->
        <div class="form-section" id="step5-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-blue-100">
                        <i class="fas fa-leaf text-blue-600"></i>
                    </div>
                    ENVIRONMENT
                </h2>
                <div class="step-circle">6</div>
            </div>
            
            <div class="form-grid">
                {% for field in environment_fields %}
                    <div class="form-group">
                        <label>{{ field.label }}</label>
                        <select name="{{ field.html_name }}" class="status-select">
                            <option value="">Select</option>
                            <option value="OK" {% if field.value == 'OK' %}selected{% endif %}>OK</option>
                            <option value="NOT_OK" {% if field.value == 'NOT_OK' %}selected{% endif %}>Not OK</option>
                            <option value="NA" {% if field.value == 'NA' %}selected{% endif %}>N/A</option>
                        </select>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Step 6: TRC/FAI/DEFECT MONITOR -->
        <div class="form-section" id="step6-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-red-100">
                        <i class="fas fa-search text-red-600"></i>
                    </div>
                    TRC/FAI/DEFECT MONITOR
                </h2>
                <div class="step-circle">7</div>
            </div>
            
            <div class="form-grid">
                {% for field in trc_fields %}
                    <div class="form-group">
                        <label>{{ field.label }}</label>
                        <select name="{{ field.html_name }}" class="status-select">
                            <option value="">Select</option>
                            <option value="OK" {% if field.value == 'OK' %}selected{% endif %}>OK</option>
                            <option value="NOT_OK" {% if field.value == 'NOT_OK' %}selected{% endif %}>Not OK</option>
                            <option value="NA" {% if field.value == 'NA' %}selected{% endif %}>N/A</option>
                        </select>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Step 7: General Remarks -->
        <div class="form-section" id="step7-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-purple-100">
                        <i class="fas fa-sticky-note text-purple-600"></i>
                    </div>
                    General Remarks
                </h2>
                <div class="step-circle active">âœ“</div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="top3_defects">Top 3 Defects</label>
                    <textarea name="top3_defects" rows="4" id="top3_defects"
                              placeholder="List top 3 defects found...">{{ form.top3_defects.value|default:'' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="ipqc_sign">IPQC Signature</label>
                    <input type="text" name="ipqc_sign" id="ipqc_sign" 
                           placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label for="pqe_tl_sign">PQE/TL Signature</label>
                    <input type="text" name="pqe_tl_sign" id="pqe_tl_sign" 
                           placeholder="Enter PQE/TL name">
                </div>
            </div>
        </div>
    </form>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-content">
            <div class="nav-info">
                <div class="progress-text">Section <span id="currentSection">1</span> of 7</div>
            </div>
            <div class="nav-buttons">
                <button type="button" onclick="previousStep()" id="prev-btn" class="nav-btn nav-btn-secondary" disabled>
                    <i class="fas fa-arrow-left"></i>
                    Previous
                </button>
                <button type="button" onclick="nextStep()" id="next-btn" class="nav-btn nav-btn-primary">
                    Next
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button type="button" onclick="submitForm()" id="complete-btn" class="nav-btn nav-btn-success" disabled>
                    <i class="fas fa-check"></i>
                    Complete
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let totalSteps = 7;
let formSubmitted = false;

// Set current date and shift on page load
function setInitialValues() {
    // Set today's date
    const today = new Date();
    const dateStr = today.getFullYear() + '-' + 
                   String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(today.getDate()).padStart(2, '0');
    document.getElementById('date').value = dateStr;
    
    // Determine shift based on time
    const hour = today.getHours();
    let shift = 'General';
    if (hour >= 6 && hour < 14) {
        shift = 'Morning';
    } else if (hour >= 14 && hour < 22) {
        shift = 'Evening';
    } else {
        shift = 'Night';
    }
    document.getElementById('shift').value = shift;
    
    // Try to get user info from Django context (if available)
    // Fallback to browser localStorage or session storage
    let userName = localStorage.getItem('userName') || sessionStorage.getItem('userName');
    let empId = localStorage.getItem('empId') || sessionStorage.getItem('empId');
    
    // If no user info stored, try to get it from Django user data
    if (!userName) {
        // Try to get from meta tags or hidden fields if Django sets them
        const userNameMeta = document.querySelector('meta[name="user-name"]');
        const empIdMeta = document.querySelector('meta[name="emp-id"]');
        
        if (userNameMeta) {
            userName = userNameMeta.getAttribute('content');
        }
        if (empIdMeta) {
            empId = empIdMeta.getAttribute('content');
        }
    }
    
    // Set employee ID and signature fields
    if (empId) {
        document.getElementById('emp_id').value = empId;
    }
    if (userName) {
        document.getElementById('ipqc_sign').value = userName;
        document.getElementById('pqe_tl_sign').value = userName;
    }
    
    // If still no user info, set placeholder to indicate manual entry needed
    if (!userName) {
        document.getElementById('ipqc_sign').placeholder = 'Please enter your name';
        document.getElementById('pqe_tl_sign').placeholder = 'Please enter PQE/TL name';
    }
}

// Update step indicator and progress
function updateStepIndicator() {
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    document.getElementById('progressLine').style.width = progressPercentage + '%';
    document.getElementById('currentStep').textContent = currentStep;
    document.getElementById('currentSection').textContent = currentStep;
    
    // Update all step circles
    for (let i = 1; i <= totalSteps; i++) {
        const stepCircle = document.getElementById(`step${i}`);
        const stepContent = document.getElementById(`step${i}-content`);
        
        if (stepCircle) {
            stepCircle.classList.remove('active', 'completed');
            if (i < currentStep) {
                stepCircle.classList.add('completed');
                stepCircle.innerHTML = 'âœ“';
            } else if (i === currentStep) {
                stepCircle.classList.add('active');
                stepCircle.innerHTML = i;
            } else {
                stepCircle.innerHTML = i;
            }
        }
        
        if (stepContent) {
            stepContent.style.display = i === currentStep ? 'block' : 'none';
        }
    }
    
    
    // Update navigation buttons
    document.getElementById('prev-btn').disabled = currentStep === 1;
    document.getElementById('next-btn').disabled = currentStep === totalSteps;
    document.getElementById('complete-btn').disabled = currentStep !== totalSteps;
    
    // Scroll to top smoothly
    if (window.innerWidth <= 768) {
        // Better scroll behavior for mobile
        const formSection = document.querySelector('.form-section:not([style*="display: none"])');
        if (formSection) {
            formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Navigate to specific step
function goToStep(step) {
    if (step >= 1 && step <= totalSteps && !formSubmitted) {
        currentStep = step;
        updateStepIndicator();
    }
}

// Navigation functions
function nextStep() {
    if (currentStep < totalSteps && !formSubmitted) {
        currentStep++;
        updateStepIndicator();
    }
}

function previousStep() {
    if (currentStep > 1 && !formSubmitted) {
        currentStep--;
        updateStepIndicator();
    }
}



// Form validation
function validateStep(step) {
    const stepContent = document.getElementById(`step${step}-content`);
    if (!stepContent) return true;
    
    const selects = stepContent.querySelectorAll('.status-select');
    let isValid = true;
    
    selects.forEach(select => {
        if (!select.value) {
            select.style.borderColor = 'var(--danger)';
            isValid = false;
        } else {
            select.style.borderColor = '';
        }
    });
    
    return isValid;
}

// Submit form
function submitForm() {
    if (formSubmitted) return;
    
    // Validate all steps before submission
    for (let i = 1; i <= totalSteps; i++) {
        if (!validateStep(i)) {
            currentStep = i;
            updateStepIndicator();
            showAlert('Please complete all required fields before submitting.', 'error');
            return;
        }
    }
    
    formSubmitted = true;
    const completeBtn = document.getElementById('complete-btn');
    
    // Show loading state
    completeBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Submitting...</div>';
    completeBtn.disabled = true;
    
    // Get form data
    const form = document.getElementById('auditForm');
    const formData = new FormData(form);
    
    // Submit via fetch
    fetch(form.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            completeBtn.innerHTML = '<i class="fas fa-check"></i> Submitted!';
            showAlert('Audit submitted successfully!', 'success');
            
            setTimeout(() => {
                window.location.href = data.redirect || '/ipqc/audit/list/';
            }, 1500);
        } else {
            formSubmitted = false;
            completeBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Try Again';
            completeBtn.disabled = false;
            showAlert(data.message || 'Submission failed. Please try again.', 'error');
        }
    })
    .catch(error => {
        formSubmitted = false;
        completeBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Try Again';
        completeBtn.disabled = false;
        console.error('Submit error:', error);
        showAlert('Network error. Please try again.', 'error');
    });
}

// Show alert message
function showAlert(message, type) {
    // Remove existing alerts
    const existingAlert = document.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // Create new alert
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
    `;
    
    // Insert at top of form
    const form = document.querySelector('.audit-form');
    form.insertBefore(alert, form.firstChild);
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}

// Get CSRF token
function getCookie(name) {
    const cookieValue = document.cookie
        .split(';')
        .find(row => row.trim().startsWith(name + '='));
    if (cookieValue) {
        return decodeURIComponent(cookieValue.split('=')[1]);
    }
    return '';
}

// Auto-save draft
let autoSaveTimer;
function autoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        const form = document.getElementById('auditForm');
        if (form) {
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            localStorage.setItem('auditFormDraft', JSON.stringify({
                step: currentStep,
                data: data,
                timestamp: new Date().toISOString()
            }));
        }
    }, 2000);
}

// Restore draft
function restoreDraft() {
    const draft = localStorage.getItem('auditFormDraft');
    if (draft) {
        const parsed = JSON.parse(draft);
        const hoursSinceSave = (new Date() - new Date(parsed.timestamp)) / (1000 * 60 * 60);
        
        if (hoursSinceSave < 24) {
            // Restore form data
            Object.entries(parsed.data).forEach(([key, value]) => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) {
                    field.value = value;
                }
            });
            
            // Restore step
            if (parsed.step && parsed.step >= 1 && parsed.step <= totalSteps) {
                currentStep = parsed.step;
            }
        }
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing form...');
    setInitialValues();
    restoreDraft();
    updateStepIndicator();
    
    // Add change listeners for auto-save
    document.addEventListener('change', autoSave);
    
    // Add change listeners for status selects
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('status-select')) {
            // Update select appearance based on value
            e.target.classList.remove('status-ok', 'status-not-ok', 'status-na');
            if (e.target.value === 'OK') {
                e.target.classList.add('status-ok');
            } else if (e.target.value === 'NOT_OK') {
                e.target.classList.add('status-not-ok');
            }
        }
    });
    
    console.log('Form initialized successfully');
});

// Prevent accidental navigation
window.addEventListener('beforeunload', function(e) {
    if (!formSubmitted && document.querySelector('.status-select[value]')) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    }
});
</script>
{% endblock %}

transs_flow/templates/ipqc/ipqc_assembly_audit_update_form.html

{% extends 'base.html' %}
{% load static %}

{% block title %}Ass Audit Update{% endblock title %}
{% block content %}
<div class="pc-container">
    <div class="pc-content">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <div class="card shadow-sm">
                    <!-- Header is updated for the Edit view -->
                    <div class="card-header bg-warning text-dark">
                        <h4 class="card-title mb-0">Edit IPQC Assembly Audit</h4>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}
                            <div class="accordion" id="auditFormAccordion">

                                <!-- BASIC INFO ACCORDION ITEM -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingBasic">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic" aria-expanded="true" aria-controls="collapseBasic">
                                            <i class="bi bi-person-badge me-2"></i> Basic Information (Read-Only)
                                        </button>
                                    </h2>
                                    <div id="collapseBasic" class="accordion-collapse collapse show" aria-labelledby="headingBasic" data-bs-parent="#auditFormAccordion">
                                        <div class="accordion-body">
                                            <span class="badge bg-secondary mb-3">This section is auto-filled from your last Work Info submission and cannot be edited.</span>
                                            <div class="row">
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">Date</label>{{ form.date }}<div class="invalid-feedback d-block">{{ form.date.errors }}</div></div></div>
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">Shift</label>{{ form.shift }}<div class="invalid-feedback d-block">{{ form.shift.errors }}</div></div></div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">Employee ID</label>{{ form.emp_id }}<div class="invalid-feedback d-block">{{ form.emp_id.errors }}</div></div></div>
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">Name</label>{{ form.name }}<div class="invalid-feedback d-block">{{ form.name.errors }}</div></div></div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">Section</label>{{ form.section }}<div class="invalid-feedback d-block">{{ form.section.errors }}</div></div></div>
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">Line</label>{{ form.line }}<div class="invalid-feedback d-block">{{ form.line.errors }}</div></div></div>
                                            </div>
                                             <div class="row">
                                                <div class="col-md-4"><div class="mb-3"><label class="form-label">Group</label>{{ form.group }}<div class="invalid-feedback d-block">{{ form.group.errors }}</div></div></div>
                                                <div class="col-md-4"><div class="mb-3"><label class="form-label">Model</label>{{ form.model }}<div class="invalid-feedback d-block">{{ form.model.errors }}</div></div></div>
                                                <div class="col-md-4"><div class="mb-3"><label class="form-label">Color</label>{{ form.color }}<div class="invalid-feedback d-block">{{ form.color.errors }}</div></div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- MAN ACCORDION ITEM -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingMan">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMan" aria-expanded="false" aria-controls="collapseMan">
                                            <i class="bi bi-people me-2"></i> MAN
                                        </button>
                                    </h2>
                                    <div id="collapseMan" class="accordion-collapse collapse" aria-labelledby="headingMan" data-bs-parent="#auditFormAccordion">
                                        <div class="accordion-body">
                                            {% for audit_field, remark_field in man_fields %}
                                                {% include 'ipqc/partials/audit_field.html' %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- MACHINE ACCORDION ITEM -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingMachine">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMachine" aria-expanded="false" aria-controls="collapseMachine">
                                            <i class="bi bi-gear me-2"></i> MACHINE
                                        </button>
                                    </h2>
                                    <div id="collapseMachine" class="accordion-collapse collapse" aria-labelledby="headingMachine" data-bs-parent="#auditFormAccordion">
                                        <div class="accordion-body">
                                            <h6 class="text-muted border-bottom pb-2 mb-3">Manufacture & Manual Inputs</h6>
                                            <div class="row">
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">{{ form.manufacture.label }}</label>{{ form.manufacture }}<div class="invalid-feedback d-block">{{ form.manufacture.errors }}</div></div></div>
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">{{ form.work_order.label }}</label>{{ form.work_order }}<div class="invalid-feedback d-block">{{ form.work_order.errors }}</div></div></div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4"><div class="mb-3"><label class="form-label">{{ form.brand.label }}</label>{{ form.brand }}<div class="invalid-feedback d-block">{{ form.brand.errors }}</div></div></div>
                                                <div class="col-md-4"><div class="mb-3"><label class="form-label">{{ form.material_code.label }}</label>{{ form.material_code }}<div class="invalid-feedback d-block">{{ form.material_code.errors }}</div></div></div>
                                                <div class="col-md-4"><div class="mb-3"><label class="form-label">{{ form.wo_input_qty.label }}</label>{{ form.wo_input_qty }}<div class="invalid-feedback d-block">{{ form.wo_input_qty.errors }}</div></div></div>
                                            </div>
                                            <hr class="my-4">
                                            <h6 class="text-muted border-bottom pb-2 mb-3">MACHINE Checks</h6>
                                            {% for audit_field, remark_field in machine_fields %}
                                                {% include 'ipqc/partials/audit_field.html' %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- MATERIAL ACCORDION ITEM -->
                                <div class="accordion-item">
                                     <h2 class="accordion-header" id="headingMaterial">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMaterial" aria-expanded="false" aria-controls="collapseMaterial">
                                            <i class="bi bi-box-seam me-2"></i> MATERIAL
                                        </button>
                                    </h2>
                                    <div id="collapseMaterial" class="accordion-collapse collapse" aria-labelledby="headingMaterial" data-bs-parent="#auditFormAccordion">
                                        <div class="accordion-body">
                                            {% for audit_field, remark_field in material_fields %}{% include 'ipqc/partials/audit_field.html' %}{% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- METHOD ACCORDION ITEM -->
                                <div class="accordion-item">
                                     <h2 class="accordion-header" id="headingMethod">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMethod" aria-expanded="false" aria-controls="collapseMethod">
                                            <i class="bi bi-list-check me-2"></i> METHOD
                                        </button>
                                    </h2>
                                    <div id="collapseMethod" class="accordion-collapse collapse" aria-labelledby="headingMethod" data-bs-parent="#auditFormAccordion">
                                        <div class="accordion-body">
                                            {% for audit_field, remark_field in method_fields %}{% include 'ipqc/partials/audit_field.html' %}{% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- ENVIRONMENT ACCORDION ITEM -->
                                <div class="accordion-item">
                                     <h2 class="accordion-header" id="headingEnvironment">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEnvironment" aria-expanded="false" aria-controls="collapseEnvironment">
                                            <i class="bi bi-tree me-2"></i> ENVIRONMENT
                                        </button>
                                    </h2>
                                    <div id="collapseEnvironment" class="accordion-collapse collapse" aria-labelledby="headingEnvironment" data-bs-parent="#auditFormAccordion">
                                        <div class="accordion-body">
                                            {% for audit_field, remark_field in environment_fields %}{% include 'ipqc/partials/audit_field.html' %}{% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- TRC ACCORDION ITEM -->
                                <div class="accordion-item">
                                     <h2 class="accordion-header" id="headingTRC">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTRC" aria-expanded="false" aria-controls="collapseTRC">
                                            <i class="bi bi-clipboard-data me-2"></i> TRC / FAI / DEFECT / SPOT CHECK
                                        </button>
                                    </h2>
                                    <div id="collapseTRC" class="accordion-collapse collapse" aria-labelledby="headingTRC" data-bs-parent="#auditFormAccordion">
                                        <div class="accordion-body">
                                            {% for audit_field, remark_field in trc_fields %}{% include 'ipqc/partials/audit_field.html' %}{% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- FINAL SUBMIT & SIGNATURES ACCORDION ITEM -->
                                <div class="accordion-item">
                                     <h2 class="accordion-header" id="headingFinal">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFinal" aria-expanded="false" aria-controls="collapseFinal">
                                            <i class="bi bi-check2-square me-2"></i> Final Review & Submission
                                        </button>
                                    </h2>
                                    <div id="collapseFinal" class="accordion-collapse collapse" aria-labelledby="headingFinal" data-bs-parent="#auditFormAccordion">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-12"><div class="mb-3"><label class="form-label">{{ form.top3_defects.label }}</label>{{ form.top3_defects }}<div class="invalid-feedback d-block">{{ form.top3_defects.errors }}</div></div></div>
                                            </div>
                                            <div class="row">
                                                <div class="col-12"><div class="mb-3"><label class="form-label">{{ form.remarks.label }}</label>{{ form.remarks }}<small class="form-text text-muted">Add any general remarks. Individual item remarks have been collected above.</small><div class="invalid-feedback d-block">{{ form.remarks.errors }}</div></div></div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">{{ form.ipqc_sign.label }}</label>{{ form.ipqc_sign }}<div class="invalid-feedback d-block">{{ form.ipqc_sign.errors }}</div></div></div>
                                                <div class="col-md-6"><div class="mb-3"><label class="form-label">{{ form.pqe_tl_sign.label }}</label>{{ form.pqe_tl_sign }}<div class="invalid-feedback d-block">{{ form.pqe_tl_sign.errors }}</div></div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="submit" class="btn btn-warning"><i class="bi bi-save me-2"></i>Update Audit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Logic to pre-populate individual remark fields from the aggregated text ---
    const allRemarksTextarea = document.getElementById('id_remarks');
    if (!allRemarksTextarea) return;

    const allRemarksText = allRemarksTextarea.value.trim();
    if (!allRemarksText) return;

    // Split the aggregated text into individual remarks and general remarks
    const parts = allRemarksText.split('\n\nGeneral Remarks:\n');
    const individualRemarksText = parts[0];
    const generalRemarksText = parts.length > 1 ? parts[1] : '';

    // Set the main remarks textarea to show only the general remarks
    allRemarksTextarea.value = generalRemarksText;

    // Create a map of label -> remark for easy lookup
    const remarkMap = {};
    individualRemarksText.split('\n').forEach(line => {
        const splitPos = line.indexOf(': ');
        if (splitPos !== -1) {
            // The label might have HTML tags from the model's verbose_name, so we strip them.
            const label = line.substring(0, splitPos).replace(/<[^>]*>/g, '').trim();
            const remark = line.substring(splitPos + 2);
            remarkMap[label] = remark;
        }
    });

    // Populate the individual remark textareas using the map
    const allRemarkTextareas = document.querySelectorAll('textarea[id^="id_remark_"]');
    allRemarkTextareas.forEach(textarea => {
        const auditFieldId = textarea.id.replace('id_remark_', ''); // e.g., 'man_job_card'
        // Find the label associated with the main audit field (e.g., for="id_man_job_card")
        const auditFieldLabel = document.querySelector(`label[for="id_${auditFieldId}"]`);

        if (auditFieldLabel) {
            const labelText = auditFieldLabel.innerText.trim();
            if (remarkMap[labelText]) {
                textarea.value = remarkMap[labelText];
            }
        }
    });
    
    // --- Initialize Tooltips and Accordions ---
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});
</script>
{% endblock extra_js %}

transs_flow/templates/ipqc/ipqc_dashboard.html

{% extends 'base.html' %}
{% load static %}
{% block title %}Work Info{% endblock title %}

{% block content %}
<div class="pc-container">
    <div class="pc-content">

        <!-- Welcome & Dashboard Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-0">Welcome back, {{ first_name }}!</h4>
                        <p class="text-muted mb-0">{{ designation }} | {% now "jS F Y, H:i" %}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar-sm bg-primary rounded">
                                    <i class="fas fa-calendar-day text-white avatar-title font-size-24"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">Today's Records</h6>
                                <h3 class="mb-0">{{ today_records }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar-sm bg-success rounded">
                                    <i class="fas fa-calendar-week text-white avatar-title font-size-24"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">This Week</h6>
                                <h3 class="mb-0">{{ week_records }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar-sm bg-info rounded">
                                    <i class="fas fa-database text-white avatar-title font-size-24"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">Total Records</h6>
                                <h3 class="mb-0">{{ total_records }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">IPQC Work Information</h4>
                        <p class="text-muted mb-0">Fill in the work information details below</p>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Employee ID</label>
                                <input type="text" class="form-control" value="{{ user_emp_id }}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" value="{{ user_name }}" readonly>
                            </div>
                        </div>

                        <form method="post">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date</label>
                                    {{ form.date }}
                                    {% if form.date.errors %}
                                    <div class="invalid-feedback d-block">{{ form.date.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Shift</label>
                                    {{ form.shift }}
                                    {% if form.shift.errors %}
                                    <div class="invalid-feedback d-block">{{ form.shift.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Section</label>
                                    {{ form.section }}
                                    {% if form.section.errors %}
                                    <div class="invalid-feedback d-block">{{ form.section.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Line</label>
                                    {{ form.line }}
                                    {% if form.line.errors %}
                                    <div class="invalid-feedback d-block">{{ form.line.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Group</label>
                                    {{ form.group }}
                                    {% if form.group.errors %}
                                    <div class="invalid-feedback d-block">{{ form.group.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Model</label>
                                    {{ form.model }}
                                    {% if form.model.errors %}
                                    <div class="invalid-feedback d-block">{{ form.model.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Color</label>
                                    {{ form.color }}
                                    {% if form.color.errors %}
                                    <div class="invalid-feedback d-block">{{ form.color.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Records -->
        {% if recent_records %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Recent Records</h5>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Shift</th>
                                    <th>Employee ID</th>
                                    <th>Name</th>
                                    <th>Model</th>
                                    <th>Color</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in recent_records %}
                                <tr>
                                    <td>{{ record.date|date:"Y-m-d" }}</td>
                                    <td>{{ record.shift }}</td>
                                    <td>{{ record.emp_id }}</td>
                                    <td>{{ record.name }}</td>
                                    <td>{{ record.model }}</td>
                                    <td>{{ record.color }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock content %}


transs_flow/templates/ipqc/ipqc_disassemble_form.html

{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}  <!-- åŠ è½½è‡ªå®šä¹‰è¿‡æ»¤å™¨ -->
{% block title %}Disassemble{% endblock %}
{% block content %}
<style>
/* Style Variables - Define these or link to a stylesheet that has them */
:root {
    --primary: #0284c7;
    --success: #22c55e;
    --danger: #ef4444;
    --border: #e5e7eb;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --text-light: #9ca3af;
    --bg-secondary: #f9fafb;
}

.audit-form { max-width: 1200px; margin: 0 auto; padding: 16px; width: 100%; }
.step-indicator { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow-x: auto; }
.step-progress { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; position: relative; min-width: 800px; }
.step-progress::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: var(--border); z-index: 0; }
.step-progress-line { position: absolute; top: 50%; left: 0; height: 2px; background: var(--primary); z-index: 1; transition: width 0.3s ease; transform: translateY(-50%); }
.step-item { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; cursor: pointer; flex-shrink: 0; }
.step-circle { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--border); background: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: var(--text-light); transition: all 0.3s ease; }
.step-circle.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
.step-circle.completed { background: var(--success); color: white; border-color: var(--success); }
.step-label { font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: 6px; font-weight: 500; white-space: nowrap; }
.form-section { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.section-title { font-size: 18px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
.section-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.form-grid { display: grid; gap: 16px; width: 100%; }
.form-group { display: flex; flex-direction: column; width: 100%; }
.form-group label { display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: white; border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; transition: all 0.2s ease; font-family: inherit; box-sizing: border-box; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
.form-group input[readonly] { background: var(--bg-secondary); cursor: not-allowed; color: var(--text-secondary); }
.status-select { border-radius: 8px; font-weight: 500; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px; padding-right: 44px; appearance: none; }
.status-select[value="OK"] { border-color: var(--success); background-color: rgba(34, 197, 94, 0.05); }
.status-select[value="Not OK"] { border-color: var(--danger); background-color: rgba(239, 68, 68, 0.05); }
.status-select[value="NA"] { border-color: var(--text-light); background-color: rgba(100, 116, 139, 0.05); }
.form-group textarea { resize: vertical; min-height: 80px; }
.bottom-nav { position: sticky; bottom: 0; background: white; border-top: 1px solid var(--border); padding: 16px; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); }
.nav-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
.progress-text { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
.nav-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
.nav-btn { padding: 10px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; border: none; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; min-width: 80px; }
.nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.nav-btn-secondary { background: white; color: var(--text-secondary); border: 2px solid var(--border); }
.nav-btn-primary { background: var(--primary); color: white; }
.nav-btn-success { background: var(--success); color: white; }
.error-message { color: var(--danger); font-size: 12px; margin-top: 4px; }
.alert { padding: 12px 16px; margin-bottom: 20px; border-radius: 8px; border: 1px solid transparent; }
.alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
.alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
.alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }
@media (min-width: 768px) {
    .form-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .form-section { padding: 24px; margin-bottom: 24px; }
    .section-title { font-size: 20px; }
}
</style>

<!-- Form Validation Messages -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- Form Errors Display -->
{% if form.non_field_errors %}
    <div class="alert alert-danger">
        <strong>Error:</strong>
        <ul>
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div class="audit-form">
    <!-- Step Progress Indicator -->
    <div class="step-indicator">
        <div class="step-progress">
            <div class="step-progress-line" id="progressLine" style="width: 0%;"></div>
            <div class="step-item" onclick="goToStep(1)"><div class="step-circle active" id="step1">1</div><div class="step-label">Basic Info</div></div>
            <div class="step-item" onclick="goToStep(2)"><div class="step-circle" id="step2">2</div><div class="step-label">Appearance</div></div>
            <div class="step-item" onclick="goToStep(3)"><div class="step-circle" id="step3">3</div><span class="step-label">Assembly</span></div>
            <div class="step-item" onclick="goToStep(4)"><div class="step-circle" id="step4">4</div><div class="step-label">Photos</div></div>
            <div class="step-item" onclick="goToStep(5)"><div class="step-circle" id="step5">5</div><div class="step-label">Glue</div></div>
            <div class="step-item" onclick="goToStep(6)"><div class="step-circle" id="step6">6</div><div class="step-label">Final</div></div>
        </div>
        <div class="progress-text">Step <span id="currentStep">1</span> of 6</div>
    </div>

    <!-- Define field groups - é‡æ–°å®šä¹‰å­—æ®µåˆ†ç»„ï¼Œç¡®ä¿ç…§ç‰‡å­—æ®µåªåœ¨Photo Evidenceæ­¥éª¤ -->
    {% with basic_fields="date shift emp_id name section line group model color"|split %}
    {% with appearance_fields="color_match cam_lens_assembly cam_lens_cleanliness key_feel key_alignment screw_missing screw_loose screw_spec front_housing_damage back_housing_damage housing_snap_fit proof_label_position"|split %}
    {% with assembly_fields="tp_sop mic_solder led_solder lcd_stick speaker_solder motor_solder key_solder sim_subboard_solder subboard_solder camera_solder receiver_solder"|split %}
    {% with component_fields="coaxial_line antenna_shrapnel antenna_fpc conductive_fabric insulation_paste ins_paste_cover lcd_fpc_defect tp_fpc_defect key_fpc_solder keypad_defect mainboard_component_ok solder_splash foam_stick cam_glue led_position"|split %}
    {% with glue_fields="jig_fixture_test glue_location glue_weight_1 glue_weight_2 glue_weight_3"|split %}
    {% with photo_fields="color_match_photo cam_lens_photo key_photo screw_photo housing_photo proof_label_photo assembly_overview_photo defect_photo"|split %}

    <!-- Form Container -->
    <form method="post" id="ipqcForm" enctype="multipart/form-data" onsubmit="return validateForm()">
        {% csrf_token %}

        <!-- Step 1: Basic Information -->
        <div class="form-section" id="step1-content">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-sky-100"><i class="fas fa-info-circle text-sky-600"></i></div>Basic Information</h2>
                <div class="step-circle active">1</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in basic_fields %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<div class="error-message">{{ field.errors.0 }}</div>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 2: Appearance / Assembly Quality (åªåŒ…å«é€‰æ‹©å­—æ®µï¼Œä¸åŒ…å«ç…§ç‰‡å­—æ®µ) -->
        <div class="form-section" id="step2-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-green-100"><i class="fas fa-eye text-green-600"></i></div>Appearance / Assembly Quality</h2>
                <div class="step-circle">2</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in appearance_fields %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<div class="error-message">{{ field.errors.0 }}</div>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 3: Assembly as per SOP -->
        <div class="form-section" id="step3-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-purple-100"><i class="fas fa-tools text-purple-600"></i></div>Assembly as per SOP</h2>
                <div class="step-circle">3</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in assembly_fields %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<div class="error-message">{{ field.errors.0 }}</div>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 4: Photo Evidence (åªåŒ…å«ç…§ç‰‡å­—æ®µ) -->
        <div class="form-section" id="step4-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-blue-100"><i class="fas fa-camera text-blue-600"></i></div>Photo Evidence</h2>
                <div class="step-circle">4</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in photo_fields %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            <input type="file" name="{{ field.name }}" id="{{ field.id_for_label }}"
                                   accept="image/*" capture="environment"
                                   class="form-control">
                            {% if field.errors %}<div class="error-message">{{ field.errors.0 }}</div>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 5: Glue / Fixture Validation -->
        <div class="form-section" id="step5-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-yellow-100"><i class="fas fa-vial text-yellow-600"></i></div>Glue / Fixture Validation</h2>
                <div class="step-circle">5</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in glue_fields %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<div class="error-message">{{ field.errors.0 }}</div>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 6: Component Check & Final -->
        <div class="form-section" id="step6-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><div class="section-icon bg-red-100"><i class="fas fa-check-circle text-red-600"></i></div>Component Check & Final</h2>
                <div class="step-circle">6</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in component_fields or field.name in "imei1 imei2"|split %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<div class="error-message">{{ field.errors.0 }}</div>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.defect_cause.id_for_label }}">{{ form.defect_cause.label }}</label>
                    {{ form.defect_cause }}
                    {% if form.defect_cause.errors %}<div class="error-message">{{ form.defect_cause.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.pqe.id_for_label }}">{{ form.pqe.label }}</label>
                    {{ form.pqe }}
                    {% if form.pqe.errors %}<div class="error-message">{{ form.pqe.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.pe.id_for_label }}">{{ form.pe.label }}</label>
                    {{ form.pe }}
                    {% if form.pe.errors %}<div class="error-message">{{ form.pe.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.apd_ll.id_for_label }}">{{ form.apd_ll.label }}</label>
                    {{ form.apd_ll }}
                    {% if form.apd_ll.errors %}<div class="error-message">{{ form.apd_ll.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>
    </form>

    <!-- End with blocks -->
    {% endwith %}
    {% endwith %}
    {% endwith %}
    {% endwith %}
    {% endwith %}
    {% endwith %}

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-content">
            <div class="nav-info">
                <div class="progress-text">Section <span id="currentSection">1</span> of 6</div>
            </div>
            <div class="nav-buttons">
                <button type="button" onclick="previousStep()" id="prev-btn" class="nav-btn nav-btn-secondary" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" onclick="nextStep()" id="next-btn" class="nav-btn nav-btn-primary">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="submit" form="ipqcForm" id="submit-btn" class="nav-btn nav-btn-success" disabled>
                    <i class="fas fa-check"></i> Submit
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 6;

function updateStepIndicator() {
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    document.getElementById('progressLine').style.width = progressPercentage + '%';
    document.getElementById('currentStep').textContent = currentStep;
    document.getElementById('currentSection').textContent = currentStep;
    
    for (let i = 1; i <= totalSteps; i++) {
        const stepCircle = document.getElementById(`step${i}`);
        const stepContent = document.getElementById(`step${i}-content`);
        if (stepCircle) {
            stepCircle.classList.remove('active', 'completed');
            if (i < currentStep) { 
                stepCircle.classList.add('completed'); 
                stepCircle.innerHTML = 'âœ“'; 
            }
            else if (i === currentStep) { 
                stepCircle.classList.add('active'); 
                stepCircle.innerHTML = i; 
            }
            else { 
                stepCircle.innerHTML = i; 
            }
        }
        if (stepContent) {
            stepContent.style.display = i === currentStep ? 'block' : 'none';
        }
    }
    
    document.getElementById('prev-btn').disabled = currentStep === 1;
    document.getElementById('next-btn').disabled = currentStep === totalSteps;
    document.getElementById('submit-btn').disabled = currentStep !== totalSteps;
    document.querySelector('.audit-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function goToStep(step) { 
    if (step >= 1 && step <= totalSteps) { 
        currentStep = step; 
        updateStepIndicator(); 
    } 
}

function nextStep() { 
    if (currentStep < totalSteps) { 
        currentStep++; 
        updateStepIndicator(); 
    } 
}

function previousStep() { 
    if (currentStep > 1) { 
        currentStep--; 
        updateStepIndicator(); 
    } 
}

// Form validation before submission
function validateForm() {
    let isValid = true;
    let errorMessage = '';
    
    // Check if any select field has 'Not OK' selected
    const selectFields = document.querySelectorAll('select[name]');
    let hasNotOk = false;
    
    selectFields.forEach(select => {
        if (select.value === 'Not OK') {
            hasNotOk = true;
        }
    });
    
    // If any field is 'Not OK', check for photos or remarks
    if (hasNotOk) {
        const fileInputs = document.querySelectorAll('input[type="file"]');
        const defectCause = document.querySelector('textarea[name="defect_cause"]');
        
        let hasPhoto = false;
        fileInputs.forEach(input => {
            if (input.files && input.files.length > 0) {
                hasPhoto = true;
            }
        });
        
        let hasRemarks = defectCause && defectCause.value.trim() !== '';
        
        if (!hasPhoto && !hasRemarks) {
            errorMessage = 'Please provide a defect photo or description for all "Not OK" items.';
            isValid = false;
        }
    }
    
    if (!isValid) {
        // Create or update error message display
        let errorDiv = document.getElementById('form-validation-error');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'form-validation-error';
            errorDiv.className = 'alert alert-danger';
            errorDiv.style.marginBottom = '20px';
            document.querySelector('.audit-form').insertBefore(errorDiv, document.querySelector('.step-indicator'));
        }
        errorDiv.innerHTML = `<strong>Error:</strong> ${errorMessage}`;
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // Remove error message if exists
        let errorDiv = document.getElementById('form-validation-error');
        if (errorDiv) {
            errorDiv.remove();
        }
    }
    
    return isValid;
}

document.addEventListener('DOMContentLoaded', function() {
    updateStepIndicator();
    
    // Apply the 'status-select' class to all select elements for styling
    document.querySelectorAll('select').forEach(el => {
        el.classList.add('status-select');
        // Add change event listener for real-time validation
        el.addEventListener('change', function() {
            // Optional: Add real-time validation feedback
        });
    });
    
    // Add input event listeners to file inputs for preview (optional enhancement)
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function(e) {
            // Optional: Add image preview functionality
            console.log('File selected:', input.name);
        });
    });
});
</script>
{% endblock content %}

transs_flow/templates/ipqc/ipqc_disassemble_list.html

{% extends 'base.html' %}
{% load static %}

{% block title %}IPQC Disassemble Checklist{% endblock title %}

{% block content %}
<!-- Page Title -->
<h1 class="text-2xl font-bold text-gray-900 mb-6">IPQC Disassemble Checklist Records</h1>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ ipqc_disassemble_stats.today|default:"0" }}</div>
        <div class="metric-label">Today's Records</div>
      </div>
      <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-day text-purple-600"></i>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ ipqc_disassemble_stats.week|default:"0" }}</div>
        <div class="metric-label">This Week</div>
      </div>
      <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-week text-indigo-600"></i>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ ipqc_disassemble_stats.total|default:"0" }}</div>
        <div class="metric-label">Total Records</div>
      </div>
      <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-database text-gray-600"></i>
      </div>
    </div>
  </div>
</div>

<!-- Search Bar -->
<div class="bg-white shadow-md rounded-xl p-4 mb-6">
  <form method="get" class="flex flex-col sm:flex-row gap-3">
    <div class="flex-1">
      <input type="text" name="q" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" 
             placeholder="Search by Name, Employee ID, Model, Color..." value="{{ request.GET.q }}">
    </div>
    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
      <i class="fas fa-search"></i> Search
    </button>
    {% if request.GET.q %}
    <a href="{% url 'ipqc_disassemble_list' %}" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
      <i class="fas fa-times"></i> Clear
    </a>
    {% endif %}
  </form>
</div>

<!-- Records Table -->
<div class="bg-white shadow-md rounded-xl overflow-hidden">
  <div class="px-4 sm:px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between gap-3 sm:items-center">
    <h5 class="text-lg font-bold text-gray-900">Recent IPQC Disassemble Records</h5>
    <a href="{% url 'ipqc_disassemble_add' %}" 
       class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-center transition">
      <i class="fas fa-plus"></i> Add New Record
    </a>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shift</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Line</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Model</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Color</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for record in records %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-3 sm:px-6 py-3 text-gray-900 font-medium">{{ record.date|date:"Y-m-d" }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700">
            <span class="px-2 py-1 text-xs rounded-full bg-gray-100">{{ record.shift }}</span>
          </td>
          <td class="px-3 sm:px-6 py-3">
            <div>
              <div class="text-gray-900 font-medium">{{ record.name }}</div>
              <div class="text-xs text-gray-500">{{ record.emp_id }}</div>
            </div>
          </td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden md:table-cell">{{ record.line }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden md:table-cell">{{ record.model }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden lg:table-cell">{{ record.color }}</td>
          <td class="px-3 sm:px-6 py-3">
            {% if record.get_overall_status == 'PASS' %}
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">PASS</span>
            {% elif record.get_overall_status == 'FAIL' %}
              <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">FAIL</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">MIXED</span>
            {% endif %}
          </td>
          <td class="px-3 sm:px-6 py-3">
            <div class="flex gap-2">
              <a href="#" onclick="event.preventDefault(); showIPQCDisassembleDetails({{ record.id }})" 
                 class="text-purple-600 font-semibold text-xs sm:text-sm hover:underline">
                <i class="fas fa-eye"></i> View
              </a>
              {% if record.defect_photo %}
              <a href="{{ record.defect_photo.url }}" target="_blank" 
                 class="text-blue-600 font-semibold text-xs sm:text-sm hover:underline" title="View Defect Photo">
                <i class="fas fa-camera"></i>
              </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center py-6 text-gray-500">No records found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="mt-6 flex justify-center">
  <nav class="flex items-center space-x-1">
    {% if page_obj.has_previous %}
      <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-double-left"></i>
      </a>
      <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-left"></i>
      </a>
    {% endif %}

    <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-right"></i>
      </a>
      <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-double-right"></i>
      </a>
    {% endif %}
  </nav>
</div>
{% endif %}

<!-- Details Modal -->
<div id="ipqcDisassembleDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-xl shadow-2xl w-[95%] sm:w-[90%] md:w-[80%] lg:w-[70%] max-h-[90vh] overflow-y-auto mt-[130px]">
    <div class="flex justify-between items-center px-4 sm:px-6 py-4 border-b">
      <h2 class="text-lg sm:text-xl font-bold text-gray-800">IPQC Disassemble Details</h2>
      <button onclick="closeIPQCDisassembleDetails()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <div id="ipqcDisassembleModalBody" class="p-4 sm:p-6">
      <p class="text-gray-500 text-center">Loading...</p>
    </div>
  </div>
</div>

<!-- CSS Styles -->
<style>
.metric-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid #e5e7eb;
  transition: all 0.3s ease;
}

.metric-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.metric-value {
  font-size: 2rem;
  font-weight: 700;
  color: #111827;
  line-height: 1;
}

.metric-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-top: 0.5rem;
}
</style>
{% endblock content %}

{% block extra_js %}
<script>
  function showIPQCDisassembleDetails(pk) {
    const modal = document.getElementById('ipqcDisassembleDetailsModal');
    const modalBody = document.getElementById('ipqcDisassembleModalBody');
    modal.classList.remove('hidden');
    modalBody.innerHTML = `<p class='text-gray-500 text-center'>Loading...</p>`;

    fetch(`/ipqc/disassemble/details/${pk}/`)
      .then(res => {
        console.log('Response status:', res.status);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        console.log('Received data:', data);
        modalBody.innerHTML = buildDetailsUI(data);
      })
      .catch(error => {
        console.error('Error details:', error);
        modalBody.innerHTML = `<p class='text-red-500 text-center'>Error loading details: ${error.message}</p>`;
      });
  }

  function closeIPQCDisassembleDetails() {
    document.getElementById('ipqcDisassembleDetailsModal').classList.add('hidden');
  }

  function buildDetailsUI(data) {
    let html = '<div class="space-y-6">';
    
    // Basic Information Section
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-info-circle text-purple-500"></i> Basic Information
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
    `;
    
    const basicFields = [
      ['date', 'Date'],
      ['shift', 'Shift'], 
      ['emp_id', 'Employee ID'],
      ['name', 'Name'],
      ['section', 'Section'],
      ['line', 'Line'],
      ['group', 'Group'],
      ['model', 'Model'],
      ['color', 'Color']
    ];
    
    basicFields.forEach(([key, label]) => {
      if (data[key]) {
        html += `
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">${label}</div>
            <div class="font-semibold text-sm">${data[key]}</div>
          </div>`;
      }
    });
    
    html += '</div></div>';

    // Quick Status Overview
    const statusFields = [
      'color_match', 'cam_lens_assembly', 'cam_lens_cleanliness', 'key_feel', 
      'key_alignment', 'screw_missing', 'screw_loose', 'screw_spec',
      'front_housing_damage', 'back_housing_damage', 'housing_snap_fit', 'proof_label_position'
    ];
    
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-eye text-green-500"></i> Appearance / Assembly Status
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
    `;
    
    statusFields.forEach(field => {
      if (data[field]) {
        const value = data[field];
        let bgColor = 'bg-gray-100';
        let textColor = 'text-gray-700';
        let icon = '';
        
        if (value === 'OK') {
          bgColor = 'bg-green-100';
          textColor = 'text-green-700';
          icon = 'âœ… ';
        } else if (value === 'Not OK') {
          bgColor = 'bg-red-100';
          textColor = 'text-red-700';
          icon = 'âŒ ';
        } else if (value === 'NA') {
          bgColor = 'bg-yellow-100';
          textColor = 'text-yellow-700';
          icon = 'âž– ';
        }
        
        const label = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `
          <div class="${bgColor} ${textColor} p-2 rounded text-center text-xs">
            <div class="font-semibold">${icon}${value}</div>
            <div class="opacity-75 mt-1">${label}</div>
          </div>`;
      }
    });
    
    html += '</div></div>';

    // Assembly SOP Status
    const assemblyFields = [
      'tp_sop', 'mic_solder', 'led_solder', 'lcd_stick', 'speaker_solder',
      'motor_solder', 'key_solder', 'sim_subboard_solder', 'subboard_solder',
      'camera_solder', 'receiver_solder'
    ];
    
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-tools text-purple-500"></i> Assembly SOP Compliance
        </h3>
        <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
    `;
    
    assemblyFields.forEach(field => {
      if (data[field]) {
        const value = data[field];
        let icon = '';
        let color = 'text-gray-600';
        
        if (value === 'OK') {
          icon = 'âœ…';
          color = 'text-green-600';
        } else if (value === 'Not OK') {
          icon = 'âŒ';
          color = 'text-red-600';
        } else if (value === 'NA') {
          icon = 'âž–';
          color = 'text-yellow-600';
        }
        
        const label = field.replace(/_/g, ' ').replace('sop', 'SOP').replace(/\b\w/g, l => l.toUpperCase());
        html += `
          <div class="text-center p-2 border rounded">
            <div class="${color} text-lg">${icon}</div>
            <div class="text-xs text-gray-600 mt-1">${label}</div>
          </div>`;
      }
    });
    
    html += '</div></div>';

    // Component Check Status
    const componentFields = [
      'coaxial_line', 'antenna_shrapnel', 'antenna_fpc', 'conductive_fabric',
      'insulation_paste', 'ins_paste_cover', 'lcd_fpc_defect', 'tp_fpc_defect',
      'key_fpc_solder', 'keypad_defect', 'mainboard_component_ok', 'solder_splash',
      'foam_stick', 'cam_glue', 'led_position'
    ];
    
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-microchip text-indigo-500"></i> Component Check
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
    `;
    
    componentFields.forEach(field => {
      if (data[field]) {
        const value = data[field];
        let bgColor = 'bg-gray-50';
        let textColor = 'text-gray-700';
        let icon = '';
        
        if (value === 'OK') {
          bgColor = 'bg-green-50';
          textColor = 'text-green-700';
          icon = 'âœ… ';
        } else if (value === 'Not OK') {
          bgColor = 'bg-red-50';
          textColor = 'text-red-700';
          icon = 'âŒ ';
        } else if (value === 'NA') {
          bgColor = 'bg-yellow-50';
          textColor = 'text-yellow-700';
          icon = 'âž– ';
        }
        
        const label = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `
          <div class="${bgColor} border rounded p-2">
            <div class="${textColor} font-semibold text-sm">${icon}${value}</div>
            <div class="text-xs text-gray-500">${label}</div>
          </div>`;
      }
    });
    
    html += '</div></div>';

    // Glue & Measurements
    if (data.glue_weight_1 || data.glue_weight_2 || data.glue_weight_3 || data.jig_fixture_test || data.glue_location) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-vial text-yellow-500"></i> Glue & Measurements
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      `;
      
      if (data.jig_fixture_test) {
        html += `<div class="bg-blue-50 p-3 rounded">
          <div class="text-xs text-blue-600">Jig/Fixture Test</div>
          <div class="font-semibold text-blue-700">${data.jig_fixture_test}</div>
        </div>`;
      }
      
      if (data.glue_location) {
        html += `<div class="bg-blue-50 p-3 rounded">
          <div class="text-xs text-blue-600">Glue Location</div>
          <div class="font-semibold text-blue-700">${data.glue_location}</div>
        </div>`;
      }
      
      ['glue_weight_1', 'glue_weight_2', 'glue_weight_3'].forEach((field, index) => {
        if (data[field]) {
          html += `<div class="bg-green-50 p-3 rounded">
            <div class="text-xs text-green-600">Glue Weight ${index + 1}</div>
            <div class="font-semibold text-green-700">${data[field]}g</div>
          </div>`;
        }
      });
      
      html += '</div></div>';
    }

    // Photos Section
    if (data.photos && data.photos.length > 0) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-camera text-blue-500"></i> Evidence Photos
          </h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
      `;
      
      data.photos.forEach(photo => {
        html += `
          <div class="border rounded-lg overflow-hidden hover:shadow-lg transition cursor-pointer"
               onclick="openPhotoPreview('${photo.url}', '${photo.label}')">
            <img src="${photo.url}" alt="${photo.label}" class="w-full h-40 object-cover">
            <div class="text-center py-2 text-xs text-gray-600 bg-gray-50">${photo.label}</div>
          </div>`;
      });
      
      html += '</div></div>';
    }

    // Additional Information
    if (data.defect_cause || data.imei1 || data.imei2 || data.pqe || data.pe || data.apd_ll) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-clipboard text-gray-500"></i> Additional Information
          </h3>
          <div class="space-y-3">
      `;
      
      if (data.imei1) {
        html += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-700">IMEI 1:</span>
          <span class="font-mono text-gray-900">${data.imei1}</span>
        </div>`;
      }
      
      if (data.imei2) {
        html += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-700">IMEI 2:</span>
          <span class="font-mono text-gray-900">${data.imei2}</span>
        </div>`;
      }
      
      if (data.pqe) {
        html += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-700">PQE:</span>
          <span class="text-gray-900">${data.pqe}</span>
        </div>`;
      }
      
      if (data.pe) {
        html += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-700">PE:</span>
          <span class="text-gray-900">${data.pe}</span>
        </div>`;
      }
      
      if (data.apd_ll) {
        html += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-700">APD LL:</span>
          <span class="text-gray-900">${data.apd_ll}</span>
        </div>`;
      }
      
      if (data.defect_cause) {
        html += `
          <div>
            <div class="font-semibold text-gray-700 mb-2">Defect Cause / Remarks:</div>
            <p class="text-gray-700 bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm">${data.defect_cause}</p>
          </div>`;
      }
      
      html += '</div></div>';
    }

    // Created timestamp
    if (data.created_at) {
      html += `
        <div class="text-center text-xs text-gray-500 border-t pt-3">
          Created: ${data.created_at}
        </div>`;
    }

    html += '</div>';
    return html;
  }

  // Photo preview functions (reuse from your working version)
  function openPhotoPreview(url, label) {
    if (document.getElementById('photoPreviewOverlay')) return;

    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';

    const overlay = document.createElement('div');
    overlay.id = 'photoPreviewOverlay';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
    overlay.style.backdropFilter = 'blur(4px)';

    const container = document.createElement('div');
    container.className = 'relative w-full max-w-4xl mx-auto';

    container.innerHTML = `
        <div class="bg-white rounded-lg overflow-hidden shadow-xl flex flex-col max-h-[90vh]">
            <div class="flex items-center justify-between px-4 py-3 bg-gray-100 border-b">
                <h2 id="photoPreviewLabel" class="text-sm sm:text-base font-semibold text-gray-800 truncate" style="max-width: 80%;">${escapeHtml(label)}</h2>
                <div class="flex items-center gap-2">
                    <a id="photoDownloadBtn" href="${url}" download class="inline-flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-md text-sm">
                        <i class="fas fa-download"></i> Download
                    </a>
                    <button id="photoCloseBtn" aria-label="Close preview" class="text-gray-700 hover:text-gray-900 text-2xl leading-none bg-transparent border-0">&times;</button>
                </div>
            </div>
            <div class="flex-1 flex items-center justify-center bg-black p-2">
                <img id="photoPreviewImg" src="${url}" alt="${escapeHtml(label)}" class="max-h-[80vh] w-auto object-contain rounded-md" />
            </div>
        </div>
    `;

    overlay.appendChild(container);
    document.body.appendChild(overlay);

    overlay.addEventListener('click', function (e) {
        if (e.target === overlay) closePhotoPreview();
    });

    const btn = document.getElementById('photoCloseBtn');
    btn.addEventListener('click', closePhotoPreview);

    function escHandler(e) {
        if (e.key === 'Escape') closePhotoPreview();
    }
    document.addEventListener('keydown', escHandler);
    overlay._escHandler = escHandler;
  }

  function closePhotoPreview() {
    const overlay = document.getElementById('photoPreviewOverlay');
    if (!overlay) return;

    if (overlay._escHandler) {
        document.removeEventListener('keydown', overlay._escHandler);
    }
    overlay.remove();
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
  }

  function escapeHtml(str) {
    if (!str && str !== 0) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
  }
</script>
{% endblock %}

transs_flow/templates/ipqc/nc_issue_tracking_form.html

{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}NC Issue{% endblock %}
{% block content %}
<style>
/* --- NC Issue Tracking Form Styles --- */
.nc-form { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 16px; 
    width: 100%; 
}

.step-indicator { 
    background: white; 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    padding: 16px 12px; 
    margin-bottom: 20px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
}

.step-progress { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 12px; 
    position: relative; 
}

.step-progress::before { 
    content: ''; 
    position: absolute; 
    top: 50%; 
    left: 0; 
    right: 0; 
    height: 2px; 
    background: var(--border); 
    z-index: 0; 
}

.step-progress-line { 
    position: absolute; 
    top: 50%; 
    left: 0; 
    height: 2px; 
    background: var(--primary); 
    z-index: 1; 
    transition: width 0.3s ease; 
    transform: translateY(-50%); 
}

.step-item { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    position: relative; 
    z-index: 2; 
    cursor: pointer; 
    flex-shrink: 0; 
}

.step-circle { 
    width: 40px; 
    height: 40px; 
    border-radius: 50%; 
    border: 3px solid var(--border); 
    background: white; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: 700; 
    font-size: 14px; 
    color: var(--text-light); 
    transition: all 0.3s ease; 
}

.step-circle.active { 
    background: var(--primary); 
    color: white; 
    border-color: var(--primary); 
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); 
}

.step-circle.completed { 
    background: var(--success); 
    color: white; 
    border-color: var(--success); 
}

.step-label { 
    font-size: 11px; 
    color: var(--text-secondary); 
    text-align: center; 
    margin-top: 6px; 
    font-weight: 500; 
    white-space: nowrap; 
}

@media (max-width: 640px) {
    .step-label { display: none; }
    .step-circle { width: 36px; height: 36px; font-size: 13px; }
    .step-item { flex-shrink: 1; }
}

.form-section { 
    background: white; 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    padding: 20px 16px; 
    margin-bottom: 20px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
}

.section-header { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    margin-bottom: 16px; 
    padding-bottom: 12px; 
    border-bottom: 1px solid var(--border); 
}

.section-title { 
    font-size: 18px; 
    font-weight: 700; 
    color: var(--text-primary); 
    display: flex; 
    align-items: center; 
    gap: 10px; 
}

.section-icon { 
    width: 36px; 
    height: 36px; 
    border-radius: 8px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
}

.form-grid { 
    display: grid; 
    gap: 16px; 
    width: 100%; 
}

.form-group { 
    display: flex; 
    flex-direction: column; 
    width: 100%; 
}

.form-group label { 
    display: block; 
    font-size: 14px; 
    font-weight: 600; 
    color: var(--text-primary); 
    margin-bottom: 6px; 
}

.form-group input, .form-group select, .form-group textarea { 
    width: 100%; 
    padding: 12px; 
    background: white; 
    border: 2px solid var(--border); 
    border-radius: 8px; 
    color: var(--text-primary); 
    font-size: 14px; 
    transition: all 0.2s ease; 
    font-family: inherit; 
    box-sizing: border-box; 
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
    outline: none; 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); 
}

.form-group input[readonly] { 
    background: var(--bg-secondary); 
    cursor: not-allowed; 
    color: var(--text-secondary); 
}

.form-group .is-invalid {
    border-color: var(--danger) !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.severity-select { 
    border-radius: 8px; 
    font-weight: 500; 
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); 
    background-repeat: no-repeat; 
    background-position: right 12px center; 
    background-size: 20px; 
    padding-right: 44px; 
    appearance: none; 
}

.severity-select[value="Critical"] { 
    border-color: var(--danger); 
    background-color: rgba(239, 68, 68, 0.05); 
}

.severity-select[value="High"] { 
    border-color: #f97316; 
    background-color: rgba(249, 115, 22, 0.05); 
}

.severity-select[value="Medium"] { 
    border-color: var(--warning); 
    background-color: rgba(245, 158, 11, 0.05); 
}

.severity-select[value="Low"] { 
    border-color: var(--success); 
    background-color: rgba(34, 197, 94, 0.05); 
}

.status-select { 
    border-radius: 8px; 
    font-weight: 500; 
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); 
    background-repeat: no-repeat; 
    background-position: right 12px center; 
    background-size: 20px; 
    padding-right: 44px; 
    appearance: none; 
}

.status-select[value="Open"] { 
    border-color: var(--danger); 
    background-color: rgba(239, 68, 68, 0.05); 
}

.status-select[value="In Progress"] { 
    border-color: var(--primary); 
    background-color: rgba(14, 165, 233, 0.05); 
}

.status-select[value="Resolved"] { 
    border-color: var(--success); 
    background-color: rgba(34, 197, 94, 0.05); 
}

.status-select[value="Closed"] { 
    border-color: var(--text-secondary); 
    background-color: rgba(100, 116, 139, 0.05); 
}

.form-group textarea { 
    resize: vertical; 
    min-height: 100px; 
}

.bottom-nav { 
    position: sticky; 
    bottom: 0; 
    background: white; 
    border-top: 1px solid var(--border); 
    padding: 16px; 
    box-shadow: 0 -2px 8px rgba(0,0,0,0.05); 
}

.nav-content { 
    max-width: 1200px; 
    margin: 0 auto; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    flex-wrap: wrap; 
    gap: 12px; 
}

.progress-text { 
    font-size: 14px; 
    color: var(--text-secondary); 
    font-weight: 500; 
}

.nav-buttons { 
    display: flex; 
    gap: 8px; 
    flex-wrap: wrap; 
}

.nav-btn { 
    padding: 10px 16px; 
    border-radius: 8px; 
    font-weight: 600; 
    font-size: 13px; 
    border: none; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    gap: 6px; 
    min-width: 80px; 
}

.nav-btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
}

.nav-btn-secondary { 
    background: white; 
    color: var(--text-secondary); 
    border: 2px solid var(--border); 
}

.nav-btn-primary { 
    background: var(--primary); 
    color: white; 
}

.nav-btn-danger { 
    background: var(--danger); 
    color: white; 
}

.error-message { 
    color: var(--danger); 
    font-size: 12px; 
    margin-top: 4px; 
}

.alert { 
    padding: 12px 16px; 
    margin-bottom: 20px; 
    border-radius: 8px; 
    border: 1px solid transparent; 
}

.alert-danger { 
    color: #721c24; 
    background-color: #f8d7da; 
    border-color: #f5c6cb; 
}

.alert-success { 
    color: #155724; 
    background-color: #d4edda; 
    border-color: #c3e6cb; 
}

.alert-warning { 
    color: #856404; 
    background-color: #fff3cd; 
    border-color: #ffeaa7; 
}

/* New styles for success section */
.success-section {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: 1px solid #c3e6cb;
    color: #155724;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 24px;
    text-align: center;
}
.success-section h2 {
    margin-bottom: 16px;
    color: #0f5132;
}
.url-display-box {
    background: white;
    border: 1px dashed #a9dcb5;
    padding: 12px;
    border-radius: 8px;
    margin-top: 16px;
    word-break: break-all;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}
.url-display-box p {
    margin: 0;
    font-size: 0.9em;
    color: #0f5132;
    flex-grow: 1;
}

/* Priority indicator styles */
.priority-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.priority-critical {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.priority-high {
    background: rgba(249, 115, 22, 0.1);
    color: #f97316;
    border: 1px solid rgba(249, 115, 22, 0.2);
}

.priority-medium {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.priority-low {
    background: rgba(34, 197, 94, 0.1);
    color: var(--success);
    border: 1px solid rgba(34, 197, 94, 0.2);
}

@media (min-width: 768px) {
    .form-grid { 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 20px; 
    }
    .form-section { 
        padding: 24px; 
        margin-bottom: 24px; 
    }
    .section-title { 
        font-size: 20px; 
    }
}
</style>

<!-- Messages and errors -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}
{% if form.non_field_errors %}
    <div class="alert alert-danger">
        <strong>Error:</strong>
        <ul>
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div class="nc-form">
    <!-- This section will only be shown after a successful POST -->
    {% if form.instance.public_url %}
    <div class="success-section">
        <h2><i class="fas fa-check-circle"></i> NC Issue Created Successfully!</h2>
        <p>The issue has been recorded. You can now share the following link with relevant personnel.</p>
        <div class="url-display-box">
            <p id="publicUrl">{{ form.instance.public_url }}</p>
            <button class="nav-btn nav-btn-primary" onclick="copyPublicUrl()">
                <i class="fas fa-copy"></i> Copy Link
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Step Progress Indicator -->
    <div class="step-indicator">
        <div class="step-progress">
            <div class="step-progress-line" id="progressLine" style="width: 0%;"></div>
            <div class="step-item" onclick="goToStep(1)">
                <div class="step-circle active" id="step1">1</div>
                <div class="step-label">Basic Info</div>
            </div>
            <div class="step-item" onclick="goToStep(2)">
                <div class="step-circle" id="step2">2</div>
                <div class="step-label">Issue Details</div>
            </div>
        </div>
        <div class="progress-text">
            Step <span id="currentStep">1</span> of 2
        </div>
    </div>

    <form method="post" id="ncIssueForm" enctype="multipart/form-data" onsubmit="return validateForm()">
        {% csrf_token %}

        <!-- STEP 1: Basic Information (Read-Only) -->
        <div class="form-section" id="step1-content">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-sky-100">
                        <i class="fas fa-info-circle text-sky-600"></i>
                    </div>
                    Basic Information
                </h2>
                <div class="step-circle active">1</div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
                    {{ form.date|attr:"readonly" }}
                    {% if form.date.errors %}<div class="error-message">{{ form.date.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.shift.id_for_label }}">{{ form.shift.label }}</label>
                    {{ form.shift|attr:"readonly" }}
                    {% if form.shift.errors %}<div class="error-message">{{ form.shift.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.emp_id.id_for_label }}">{{ form.emp_id.label }}</label>
                    {{ form.emp_id|attr:"readonly" }}
                    {% if form.emp_id.errors %}<div class="error-message">{{ form.emp_id.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                    {{ form.name|attr:"readonly" }}
                    {% if form.name.errors %}<div class="error-message">{{ form.name.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.section.id_for_label }}">{{ form.section.label }}</label>
                    {{ form.section|attr:"readonly" }}
                    {% if form.section.errors %}<div class="error-message">{{ form.section.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.line.id_for_label }}">{{ form.line.label }}</label>
                    {{ form.line|attr:"readonly" }}
                    {% if form.line.errors %}<div class="error-message">{{ form.line.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.group.id_for_label }}">{{ form.group.label }}</label>
                    {{ form.group|attr:"readonly" }}
                    {% if form.group.errors %}<div class="error-message">{{ form.group.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.model.id_for_label }}">{{ form.model.label }}</label>
                    {{ form.model|attr:"readonly" }}
                    {% if form.model.errors %}<div class="error-message">{{ form.model.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.color.id_for_label }}">{{ form.color.label }}</label>
                    {{ form.color|attr:"readonly" }}
                    {% if form.color.errors %}<div class="error-message">{{ form.color.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>

        <!-- STEP 2: Issue Tracking Details -->
        <div class="form-section" id="step2-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-red-100">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    Issue Tracking Details
                </h2>
                <div class="step-circle">2</div>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name not in 'date shift emp_id name section line group model color created_at updated_at' %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}
                                {% if 'severity' in field.name or 'priority' in field.name %}
                                    <span id="priorityIndicator" class="priority-indicator priority-low"></span>
                                {% endif %}
                            </label>
                            {% if 'severity' in field.name %}
                                {{ field|attr:"required class:severity-select" }}
                            {% elif 'status' in field.name %}
                                {{ field|attr:"required class:status-select" }}
                            {% elif 'description' in field.name or 'remarks' in field.name %}
                                {{ field|attr:"required" }}
                            {% else %}
                                {{ field|attr:"required" }}
                            {% endif %}
                            {% if field.errors %}<div class="error-message">{{ field.errors.0 }}</div>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </form>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-content">
            <div class="progress-text">
                Section <span id="currentSection">1</span> of 2
            </div>
            <div class="nav-buttons">
                <button type="button" onclick="previousStep()" id="prev-btn" class="nav-btn nav-btn-secondary" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" onclick="nextStep()" id="next-btn" class="nav-btn nav-btn-primary">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="submit" form="ncIssueForm" id="submit-btn" class="nav-btn nav-btn-danger" disabled>
                    <i class="fas fa-exclamation-circle"></i> Submit Issue
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1; 
const totalSteps = 2;

function updateStepIndicator() {
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    document.getElementById('progressLine').style.width = progressPercentage + '%';
    document.getElementById('currentStep').textContent = currentStep;
    document.getElementById('currentSection').textContent = currentStep;
    
    for (let i = 1; i <= totalSteps; i++) {
        const stepCircle = document.getElementById(`step${i}`); 
        const stepContent = document.getElementById(`step${i}-content`);
        
        if (stepCircle) { 
            stepCircle.classList.remove('active', 'completed');
            if (i < currentStep) { 
                stepCircle.classList.add('completed'); 
                stepCircle.innerHTML = 'âœ“'; 
            }
            else if (i === currentStep) { 
                stepCircle.classList.add('active'); 
                stepCircle.innerHTML = i; 
            }
            else { 
                stepCircle.innerHTML = i; 
            }
        }
        
        if (stepContent) { 
            stepContent.style.display = i === currentStep ? 'block' : 'none'; 
        }
    }
    
    document.getElementById('prev-btn').disabled = currentStep === 1;
    document.getElementById('next-btn').disabled = currentStep === totalSteps;
    document.getElementById('submit-btn').disabled = currentStep !== totalSteps;
    
    document.querySelector('.nc-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function goToStep(step) { 
    if (step >= 1 && step <= totalSteps) { 
        currentStep = step; 
        updateStepIndicator(); 
    } 
}

function nextStep() { 
    if (currentStep < totalSteps) { 
        currentStep++; 
        updateStepIndicator(); 
    } 
}

function previousStep() { 
    if (currentStep > 1) { 
        currentStep--; 
        updateStepIndicator(); 
    } 
}

function validateForm() {
    // Clear previous validation styles and messages
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    const existingErrorDiv = document.getElementById('form-validation-error');
    if (existingErrorDiv) {
        existingErrorDiv.remove();
    }

    // Validate required fields, step by step
    for (let step = 1; step <= totalSteps; step++) {
        const currentStepDiv = document.getElementById(`step${step}-content`);
        if (!currentStepDiv) continue;

        let stepHasError = false;
        const requiredFields = currentStepDiv.querySelectorAll('input[required], select[required], textarea[required]');

        for (const field of requiredFields) {
            // Skip readonly fields as they are pre-filled
            if (field.hasAttribute('readonly')) {
                continue;
            }
            
            let isEmpty = false;
            if (field.type === 'file') {
                isEmpty = !field.files || field.files.length === 0;
            } else { // Covers text, number, select, textarea
                isEmpty = !field.value || field.value.trim() === '';
            }

            if (isEmpty) {
                field.classList.add('is-invalid');
                stepHasError = true;
            }
        }

        // If current step has any errors, jump to it and stop validation
        if (stepHasError) {
            const stepName = document.querySelector(`#step${step}-content .section-title`).textContent.trim();
            const errorMessage = `Error in Step ${step}: Please fill in all required fields marked in red.`;
            
            let errorDiv = document.createElement('div'); 
            errorDiv.id = 'form-validation-error';
            errorDiv.className = 'alert alert-danger'; 
            document.querySelector('.nc-form').insertBefore(
                errorDiv, 
                document.querySelector('.step-indicator')
            );
            errorDiv.innerHTML = `<strong>${errorMessage}</strong>`; 
            
            goToStep(step);
            return false; // Stop form submission
        }
    }

    // If all validations pass
    return true; 
}

// Function to copy public URL
function copyPublicUrl() {
    const urlText = document.getElementById('publicUrl').innerText;
    navigator.clipboard.writeText(urlText).then(() => {
        alert('Public URL copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy URL: ', err);
    });
}

// Function to update priority indicator
function updatePriorityIndicator(value) {
    const indicator = document.getElementById('priorityIndicator');
    if (!indicator) return;
    
    indicator.className = 'priority-indicator';
    
    if (value === 'Critical') {
        indicator.classList.add('priority-critical');
        indicator.innerHTML = '<i class="fas fa-exclamation-circle"></i> Critical';
    } else if (value === 'High') {
        indicator.classList.add('priority-high');
        indicator.innerHTML = '<i class="fas fa-arrow-up"></i> High';
    } else if (value === 'Medium') {
        indicator.classList.add('priority-medium');
        indicator.innerHTML = '<i class="fas fa-minus"></i> Medium';
    } else if (value === 'Low') {
        indicator.classList.add('priority-low');
        indicator.innerHTML = '<i class="fas fa-arrow-down"></i> Low';
    }
}

document.addEventListener('DOMContentLoaded', function() { 
    updateStepIndicator();
    
    // Add event listener for severity/priority fields
    const severitySelects = document.querySelectorAll('select[name*="severity"], select[name*="priority"]');
    severitySelects.forEach(select => {
        updatePriorityIndicator(select.value);
        select.addEventListener('change', function() {
            updatePriorityIndicator(this.value);
        });
    });
});
</script>
{% endblock content %}

transs_flow/templates/ipqc/nc_issue_tracking_list.html

{% extends "base.html" %}
{% load static %}

{% block title %}NC Issue Tracking List{% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">NC Issue Tracking List</h4>
        <a href="{% url 'nc_issue_tracking_create' %}" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add New Record
        </a>
      </div>

      <div class="card-body">
        <!-- Search Form -->
        <form method="get" class="mb-3 d-flex gap-2">
          <input type="text" name="q" class="form-control" placeholder="Search by Name, Emp ID, Model..." value="{{ request.GET.q }}">
          <button type="submit" class="btn btn-secondary">Search</button>
        </form>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                <th>Shift</th>
                <th>Emp ID</th>
                <th>Name</th>
                <th>Section</th>
                <th>Line</th>
                <th>Group</th>
                <th>Model</th>
                <th>Color</th>
                <th>Stage</th>
                <th>Time</th>
                <th>Issue</th>
                <th>3 Why</th>
                <th>Solution</th>
                <th>Operator Name</th>
                <th>Operator ID</th>
                <th>Responsible Dept.</th>
                <th>Responsible Person</th>
                <th>Close Time</th>
                <th>Status</th>
                <th>Remark</th>
                <th>Created At</th>
              </tr>
            </thead>
            <tbody>
              {% for record in records %}
              <tr>
                <td>{{ record.date }}</td>
                <td>{{ record.shift }}</td>
                <td>{{ record.emp_id }}</td>
                <td>{{ record.name }}</td>
                <td>{{ record.section }}</td>
                <td>{{ record.line }}</td>
                <td>{{ record.group }}</td>
                <td>{{ record.model }}</td>
                <td>{{ record.color }}</td>
                <td>{{ record.stage }}</td>
                <td>{{ record.time }}</td>
                <td>{{ record.issue }}</td>
                <td>{{ record.three_why }}</td>
                <td>{{ record.solution }}</td>
                <td>{{ record.operator_name }}</td>
                <td>{{ record.operator_id }}</td>
                <td>{{ record.responsible_dept }}</td>
                <td>{{ record.responsible_person }}</td>
                <td>{{ record.close_time|date:"d-m-Y H:i" }}</td>
                <td>{{ record.status }}</td>
                <td>{{ record.remark }}</td>
                <td>{{ record.created_at|date:"d-m-Y H:i" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="22" class="text-center">No records found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <nav class="mt-3">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo; Prev</a></li>
            {% endif %}
            <li class="page-item disabled"><a class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</a></li>
            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next &raquo;</a></li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}


transs_flow/templates/ipqc/operator_qualification_form.html

{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load widget_tweaks %}
{% block title %}MP Qualification{% endblock %}
{% block content %}
<style>
    :root {
        --primary: #0EA5E9;
        --success: #22C55E;
        --danger: #EF4444;
        --warning: #F59E0B;
        --text-primary: #111827;
        --text-secondary: #6B7280;
        --text-light: #94A3B8;
        --border: #E5E7EB;
        --bg-secondary: #F9FAFB;
    }

    .audit-form {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
        width: 100%;
    }

    .step-indicator {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .step-progress {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        position: relative;
    }

    .step-progress::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--border);
        z-index: 0;
    }

    .step-progress-line {
        position: absolute;
        top: 50%;
        left: 0;
        height: 2px;
        background: var(--primary);
        z-index: 1;
        transition: width 0.3s ease;
        transform: translateY(-50%);
    }

    .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        cursor: pointer;
        flex-shrink: 0;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid var(--border);
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        color: var(--text-light);
        transition: all 0.3s ease;
    }

    .step-circle.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
    }

    .step-circle.completed {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    .step-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-align: center;
        margin-top: 6px;
        font-weight: 500;
        white-space: nowrap;
    }

    @media (max-width: 640px) {
        .step-label {
            display: none;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            font-size: 13px;
        }

        .step-item {
            flex-shrink: 1;
        }
    }

    .form-section {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px 16px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .form-grid {
        display: grid;
        gap: 16px;
        width: 100%;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        background: white;
        border: 2px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.2s ease;
        font-family: inherit;
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .form-group input[readonly] {
        background: var(--bg-secondary);
        cursor: not-allowed;
        color: var(--text-secondary);
    }

    .form-group .is-invalid {
        border-color: var(--danger) !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }

    .status-select {
        border-radius: 8px;
        font-weight: 500;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px;
        padding-right: 44px;
        appearance: none;
    }

    .status-select[value="Have"],
    .status-select[value="Done"],
    .status-select[value="Old"],
    .status-select[value="Trained"] {
        border-color: var(--success);
        background-color: rgba(34, 197, 94, 0.05);
    }

    .status-select[value="Not Have"],
    .status-select[value="Pending"],
    .status-select[value="New"],
    .status-select[value="Not Trained"],
    .status-select[value="Training Pending"] {
        border-color: var(--warning);
        background-color: rgba(245, 158, 11, 0.05);
    }

    .status-select[value="NA"],
    .status-select[value="Not Applicable"],
    .status-select[value="Rotating"],
    .status-select[value="Replace Operator"] {
        border-color: var(--text-light);
        background-color: rgba(100, 116, 139, 0.05);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    .bottom-nav {
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 1px solid var(--border);
        padding: 16px;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
    }

    .nav-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .progress-text {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .nav-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .nav-btn {
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 13px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-width: 80px;
    }

    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .nav-btn-secondary {
        background: white;
        color: var(--text-secondary);
        border: 2px solid var(--border);
    }

    .nav-btn-primary {
        background: var(--primary);
        color: white;
    }

    .nav-btn-success {
        background: var(--success);
        color: white;
    }

    .error-message {
        color: var(--danger);
        font-size: 12px;
        margin-top: 4px;
    }

    .alert {
        padding: 12px 16px;
        margin-bottom: 20px;
        border-radius: 8px;
        border: 1px solid transparent;
    }

    .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeaa7;
    }

    .alert-info {
        color: #004085;
        background-color: #cce7ff;
        border-color: #b8daff;
    }

    /* QR Scanner Section */
    #qr-scan-section {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    #qr-scan-section.hidden {
        display: none;
    }

    #reader {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
    }

    #feishu-preview {
        margin-top: 16px;
    }

    #feishu-iframe-container {
        margin-top: 16px;
    }

    #feishu-iframe {
        width: 100%;
        height: 400px;
        border: 1px solid var(--border);
        border-radius: 8px;
    }

    .scan-preview {
        position: relative;
        display: inline-block;
    }

    .scan-preview img {
        width: 100%;
        max-width: 200px;
        border-radius: 8px;
        border: 2px solid var(--success);
        margin-top: 10px;
    }

    @media (min-width: 768px) {
        .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-section {
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
        }
    }
</style>
<!-- Messages and errors -->
{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">{{ message }}</div>
{% endfor %}
{% endif %}
{% if form.non_field_errors %}
<div class="alert alert-danger">
    <strong>Error:</strong>
    <ul>
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}
<div class="audit-form">
    <!-- Step Progress Indicator -->
    <div class="step-indicator">
        <div class="step-progress">
            <div class="step-progress-line" id="progressLine" style="width: 0%;"></div>
            <div class="step-item" onclick="goToStep(1)">
                <div class="step-circle active" id="step1">1</div>
                <div class="step-label">Basic Info</div>
            </div>
            <div class="step-item" onclick="goToStep(2)">
                <div class="step-circle" id="step2">2</div>
                <div class="step-label">Job Card</div>
            </div>
            <div class="step-item" onclick="goToStep(3)">
                <div class="step-circle" id="step3">3</div>
                <div class="step-label">Verification</div>
            </div>
            <div class="step-item" onclick="goToStep(4)">
                <div class="step-circle" id="step4">4</div>
                <div class="step-label">Summary</div>
            </div>
        </div>
        <div class="progress-text">
            Step <span id="currentStep">1</span> of 4
        </div>
    </div>
    <form method="post" id="qualificationForm" enctype="multipart/form-data" onsubmit="return validateForm()">
        {% csrf_token %}
        <!-- STEP 1: Basic Information -->
        <div class="form-section" id="step1-content">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-sky-100">
                        <i class="fas fa-info-circle text-sky-600"></i>
                    </div>
                    Basic Information
                </h2>
                <div class="step-circle active">1</div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
                    {{ form.date|attr:"readonly" }}
                    {% if form.date.errors %}<div class="error-message">{{ form.date.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.shift.id_for_label }}">{{ form.shift.label }}</label>
                    {{ form.shift|attr:"readonly" }}
                    {% if form.shift.errors %}<div class="error-message">{{ form.shift.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.emp_id.id_for_label }}">{{ form.emp_id.label }}</label>
                    {{ form.emp_id|attr:"readonly" }}
                    {% if form.emp_id.errors %}<div class="error-message">{{ form.emp_id.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                    {{ form.name|attr:"readonly" }}
                    {% if form.name.errors %}<div class="error-message">{{ form.name.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.section.id_for_label }}">{{ form.section.label }}</label>
                    {{ form.section|attr:"readonly" }}
                    {% if form.section.errors %}<div class="error-message">{{ form.section.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.line.id_for_label }}">{{ form.line.label }}</label>
                    {{ form.line|attr:"readonly" }}
                    {% if form.line.errors %}<div class="error-message">{{ form.line.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.group.id_for_label }}">{{ form.group.label }}</label>
                    {{ form.group|attr:"readonly" }}
                    {% if form.group.errors %}<div class="error-message">{{ form.group.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.model.id_for_label }}">{{ form.model.label }}</label>
                    {{ form.model|attr:"readonly" }}
                    {% if form.model.errors %}<div class="error-message">{{ form.model.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.color.id_for_label }}">{{ form.color.label }}</label>
                    {{ form.color|attr:"readonly" }}
                    {% if form.color.errors %}<div class="error-message">{{ form.color.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>
        <!-- STEP 2: Job Card Scanning -->
        <div class="form-section" id="step2-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-purple-100">
                        <i class="fas fa-qrcode text-purple-600"></i>
                    </div>
                    Job Card Scanning
                </h2>
                <div class="step-circle">2</div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.key_station_name.id_for_label }}">{{ form.key_station_name.label }}</label>
                    {{ form.key_station_name|attr:"required" }}
                    {% if form.key_station_name.errors %}<div class="error-message">{{ form.key_station_name.errors.0 }}
                    </div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.key_station_job_card_status.id_for_label }}">{{ form.key_station_job_card_status.label }}</label>
                    {{ form.key_station_job_card_status|attr:"required:required"|add_class:"status-select" }}
                    {% if form.key_station_job_card_status.errors %}<div class="error-message">{{ form.key_station_job_card_status.errors.0 }}</div>{% endif %}
                </div>
            </div>
            <!-- QR Scanner Section - Initially Hidden -->
            <div id="qr-scan-section" class="hidden">
                <div class="form-group">
                    <label>ðŸ“· Scan Job Card QR/Barcode</label>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Position QR code within the frame to scan automatically
                    </div>
                    <div class="scan-preview">
                        <div id="reader"></div>
                        <div id="scanSnapshot"></div>
                    </div>
                    <!-- Use the actual form field -->
                    {{ form.scanned_barcode_text|attr:"placeholder:Scan result will appear here" }}
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.scanned_barcode_image.id_for_label }}">{{ form.scanned_barcode_image.label }}</label>
                    {{ form.scanned_barcode_image|add_class:"form-control-file" }}
                    <div id="scanStatus" class="mt-2"></div>
                    {% if form.scanned_barcode_image.errors %}<div class="error-message">{{ form.scanned_barcode_image.errors.0 }}</div>{% endif %}
                    <small class="text-muted">{{ form.scanned_barcode_image.help_text }}</small>
                </div>
            </div>
            <!-- Feishu Preview -->
            <div id="feishu-preview" class="mt-4"></div>
            <div id="feishu-iframe-container" style="display:none;">
                <h5>ðŸ”— Job Card Record Preview</h5>
                <iframe id="feishu-iframe" src=""
                    style="width:100%; height:400px; border:1px solid var(--border); border-radius:8px;"></iframe>
            </div>
        </div>
        <!-- STEP 3: Verification -->
        <div class="form-section" id="step3-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-blue-100">
                        <i class="fas fa-user-check text-blue-600"></i>
                    </div>
                    Operator Verification
                </h2>
                <div class="step-circle">3</div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.key_station_operator_status.id_for_label }}">{{ form.key_station_operator_status.label }}</label>
                    {{ form.key_station_operator_status|attr:"required:required"|add_class:"status-select" }}
                    {% if form.key_station_operator_status.errors %}<div class="error-message">{{ form.key_station_operator_status.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.new_or_rotating_operator_status.id_for_label }}">{{ form.new_or_rotating_operator_status.label }}</label>
                    {{ form.new_or_rotating_operator_status|attr:"required:required"|add_class:"status-select" }}
                    {% if form.new_or_rotating_operator_status.errors %}<div class="error-message">{{ form.new_or_rotating_operator_status.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.check_operator_work_instruction.id_for_label }}">{{ form.check_operator_work_instruction.label }}</label>
                    {{ form.check_operator_work_instruction|attr:"required:required"|add_class:"status-select" }}
                    {% if form.check_operator_work_instruction.errors %}<div class="error-message">{{ form.check_operator_work_instruction.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.pqe_training_and_verification_status.id_for_label }}">{{ form.pqe_training_and_verification_status.label }}</label>
                    {{ form.pqe_training_and_verification_status|attr:"required:required"|add_class:"status-select" }}
                    {% if form.pqe_training_and_verification_status.errors %}<div class="error-message">{{ form.pqe_training_and_verification_status.errors.0 }}</div>{% endif %}
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.operator_job_card_image.id_for_label }}">{{ form.operator_job_card_image.label }}</label>
                    {{ form.operator_job_card_image|add_class:"form-control-file" }}
                    {% if form.operator_job_card_image.errors %}<div class="error-message">{{ form.operator_job_card_image.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>
        <!-- STEP 4: Summary -->
        <div class="form-section" id="step4-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon bg-green-100">
                        <i class="fas fa-clipboard-check text-green-600"></i>
                    </div>
                    Summary & Verification
                </h2>
                <div class="step-circle">4</div>
            </div>
            <div class="form-grid">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="{{ form.job_card_verification_summary.id_for_label }}">{{ form.job_card_verification_summary.label }}</label>
                    {{ form.job_card_verification_summary|attr:"required:required" }}
                    {% if form.job_card_verification_summary.errors %}<div class="error-message">{{ form.job_card_verification_summary.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>
    </form>
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-content">
            <div class="progress-text">
                Section <span id="currentSection">1</span> of 4
            </div>
            <div class="nav-buttons">
                <button type="button" onclick="previousStep()" id="prev-btn" class="nav-btn nav-btn-secondary" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" onclick="nextStep()" id="next-btn" class="nav-btn nav-btn-primary">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="submit" form="qualificationForm" id="submit-btn" class="nav-btn nav-btn-success" disabled>
                    <i class="fas fa-check"></i> Submit
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    let currentStep = 1;
    const totalSteps = 4;
    let html5QrCode = null;
    let isScanSuccessful = false;
    
    function updateStepIndicator() {
        const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
        document.getElementById('progressLine').style.width = progressPercentage + '%';
        document.getElementById('currentStep').textContent = currentStep;
        document.getElementById('currentSection').textContent = currentStep;
        
        for (let i = 1; i <= totalSteps; i++) {
            const stepCircle = document.getElementById(`step${i}`);
            const stepContent = document.getElementById(`step${i}-content`);
            
            if (stepCircle) {
                stepCircle.classList.remove('active', 'completed');
                if (i < currentStep) {
                    stepCircle.classList.add('completed');
                    stepCircle.innerHTML = 'âœ“';
                } else if (i === currentStep) {
                    stepCircle.classList.add('active');
                    stepCircle.innerHTML = i;
                } else {
                    stepCircle.innerHTML = i;
                }
            }
            
            if (stepContent) {
                stepContent.style.display = i === currentStep ? 'block' : 'none';
            }
        }
        
        document.getElementById('prev-btn').disabled = currentStep === 1;
        document.getElementById('next-btn').disabled = currentStep === totalSteps;
        document.getElementById('submit-btn').disabled = currentStep !== totalSteps;
        
        // Start/stop QR scanner based on current step and job card status
        if (currentStep === 2) {
            checkJobCardStatus();
        } else {
            stopQRScanner();
        }
        
        document.querySelector('.audit-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function goToStep(step) {
        if (step >= 1 && step <= totalSteps) {
            currentStep = step;
            updateStepIndicator();
        }
    }
    
    function nextStep() {
        if (currentStep < totalSteps) {
            currentStep++;
            updateStepIndicator();
        }
    }
    
    function previousStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepIndicator();
        }
    }
    
    function validateForm() {
        // Clear previous validation styles and messages
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        const existingErrorDiv = document.getElementById('form-validation-error');
        if (existingErrorDiv) {
            existingErrorDiv.remove();
        }
        
        // Validate required fields, step by step
        for (let step = 1; step <= totalSteps; step++) {
            const currentStepDiv = document.getElementById(`step${step}-content`);
            if (!currentStepDiv) continue;
            
            let stepHasError = false;
            const requiredFields = currentStepDiv.querySelectorAll('input[required], select[required], textarea[required]');
            
            for (const field of requiredFields) {
                // Skip readonly fields as they are pre-filled
                if (field.hasAttribute('readonly')) {
                    continue;
                }
                
                let isEmpty = false;
                if (field.type === 'file') {
                    isEmpty = !field.files || field.files.length === 0;
                } else { // Covers text, number, select, textarea
                    isEmpty = !field.value || field.value.trim() === '';
                }
                
                if (isEmpty) {
                    field.classList.add('is-invalid');
                    stepHasError = true;
                }
            }
            
            // If current step has any errors, jump to it and stop validation
            if (stepHasError) {
                const stepName = document.querySelector(`#step${step}-content .section-title`).textContent.trim();
                const errorMessage = `Error in Step ${step}: Please fill in all required fields marked in red.`;
                
                let errorDiv = document.createElement('div');
                errorDiv.id = 'form-validation-error';
                errorDiv.className = 'alert alert-danger';
                document.querySelector('.audit-form').insertBefore(
                    errorDiv,
                    document.querySelector('.step-indicator')
                );
                errorDiv.innerHTML = `<strong>${errorMessage}</strong>`;
                
                goToStep(step);
                return false; // Stop form submission
            }
        }
        
        // If all validations pass
        return true;
    }
    
    // Check job card status and show/hide scanner
    function checkJobCardStatus() {
        const jobCardStatus = document.getElementById('id_key_station_job_card_status').value;
        const qrSection = document.getElementById('qr-scan-section');
        
        if (jobCardStatus === 'Have') {
            qrSection.classList.remove('hidden');
            startQRScanner();
        } else {
            qrSection.classList.add('hidden');
            stopQRScanner();
            // Clear scanned data if status changes
            const barcodeField = document.querySelector('[name="scanned_barcode_text"]');
            barcodeField.value = '';
            document.getElementById('scanStatus').innerHTML = '';
            document.getElementById('scanSnapshot').innerHTML = '';
            isScanSuccessful = false;
        }
    }
    
    // Detect device type
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
            (window.innerWidth <= 768);
    }
    
    // QR Scanner functions
    function startQRScanner() {
        if (html5QrCode) return;
        
        html5QrCode = new Html5Qrcode("reader");
        const barcodeField = document.querySelector('[name="scanned_barcode_text"]');
        const preview = document.getElementById('feishu-preview');
        const iframeContainer = document.getElementById('feishu-iframe-container');
        const iframe = document.getElementById('feishu-iframe');
        const scanStatus = document.getElementById('scanStatus');
        const scanSnapshot = document.getElementById('scanSnapshot');
        
        // Determine camera based on device
        const cameraConfig = isMobileDevice() ?
            { facingMode: "environment" } : // Back camera for mobile
            { facingMode: "user" };          // Front camera for desktop
            
        function showFeishuLink(url) {
            preview.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> QR/Barcode scanned successfully!
                    <br>
                    <a href="${url}" target="_blank" class="btn btn-sm btn-primary mt-2">
                        <i class="fas fa-external-link-alt"></i> Open Record
                    </a>
                </div>
            `;
            // Show iframe preview
            iframeContainer.style.display = 'block';
            iframe.src = url;
        }
        
        // Generate filename and capture snapshot from video
        function captureSnapshot() {
            const video = document.querySelector('#reader video');
            if (!video) return;
            
            // Get key station name and format it
            const keyStationName = document.getElementById('id_key_station_name').value || 'scan';
            const formattedName = keyStationName.toLowerCase().replace(/\s+/g, '');
            
            // Get current date and time
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            // Format: DDMMYYYYHHMMSS
            const timestamp = `${day}${month}${year}${hours}${minutes}${seconds}`;
            const filename = `${formattedName}${timestamp}.png`;
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Convert to blob with custom filename
            canvas.toBlob(blob => {
                const file = new File([blob], filename, { type: 'image/png' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                const fileInput = document.querySelector('[name="scanned_barcode_image"]');
                fileInput.files = dataTransfer.files;
                
                // Show preview of captured image
                scanSnapshot.innerHTML = `
                    <img src="${URL.createObjectURL(blob)}" alt="Scan Snapshot" />
                    <div class="text-sm text-gray-600 mt-2">âœ“ Scan snapshot captured (${filename})</div>
                `;
                
                scanStatus.innerHTML = `
                    <div class="alert alert-success mt-2">
                        <i class="fas fa-camera"></i> Scan snapshot automatically saved as: <strong>${filename}</strong>
                    </div>
                `;
            });
        }
        
        html5QrCode.start(
            cameraConfig,
            { fps: 10, qrbox: 250 },
            decoded => {
                // Update single form field
                barcodeField.value = decoded;
                
                // Capture snapshot before stopping
                captureSnapshot();
                
                stopQRScanner();
                showFeishuLink(decoded);
                isScanSuccessful = true;
            },
            error => {
                // Ignore scan errors
            }
        ).catch(err => {
            console.error(`Unable to start scanning: ${err}`);
            const readerDiv = document.getElementById('reader');
            readerDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Camera access denied or not available. Please enter the URL manually.
                </div>
            `;
            scanStatus.innerHTML = `
                <div class="alert alert-warning mt-2">
                    Camera not available. Please upload the scan image manually if needed.
                </div>
            `;
        });
    }
    
    function stopQRScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => {
                html5QrCode = null;
            }).catch(err => {
                console.error(`Failed to stop scanning: ${err}`);
            });
        }
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        updateStepIndicator();
        // Add event listener to job card status dropdown
        document.getElementById('id_key_station_job_card_status').addEventListener('change', checkJobCardStatus);
    });
</script>
{% endblock content %}

transs_flow/templates/ipqc/operator_qualification_list.html

{% extends 'base.html' %}
{% load static %}

{% block title %}Operator Qualification Check Records{% endblock title %}

{% block content %}
<!-- Page Title -->
<h1 class="text-2xl font-bold text-gray-900 mb-6">Operator Qualification Check Records</h1>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ stats.today|default:"0" }}</div>
        <div class="metric-label">Today's Checks</div>
      </div>
      <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-day text-blue-600"></i>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ stats.week|default:"0" }}</div>
        <div class="metric-label">This Week</div>
      </div>
      <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-week text-indigo-600"></i>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <div class="flex items-start justify-between">
      <div>
        <div class="metric-value">{{ stats.total|default:"0" }}</div>
        <div class="metric-label">Total Records</div>
      </div>
      <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-database text-gray-600"></i>
      </div>
    </div>
  </div>
</div>

<!-- Search Bar -->
<div class="bg-white shadow-md rounded-xl p-4 mb-6">
  <form method="get" class="flex flex-col sm:flex-row gap-3">
    <div class="flex-1">
      <input type="text" name="q" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
             placeholder="Search by Employee ID, Name, Model, Line..." value="{{ request.GET.q }}">
    </div>
    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
      <i class="fas fa-search"></i> Search
    </button>
    {% if request.GET.q %}
    <a href="{% url 'operator_qualification_list' %}" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
      <i class="fas fa-times"></i> Clear
    </a>
    {% endif %}
  </form>
</div>

<!-- Records Table -->
<div class="bg-white shadow-md rounded-xl overflow-hidden">
  <div class="px-4 sm:px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between gap-3 sm:items-center">
    <h5 class="text-lg font-bold text-gray-900">Qualification Check Records</h5>
    <a href="{% url 'operator_qualification_create' %}" 
       class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center transition">
      <i class="fas fa-plus"></i> New Check
    </a>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shift</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Line</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Model</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Job Card</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Operator Status</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Training</th>
          <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for record in records %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-3 sm:px-6 py-3 text-gray-900 font-medium">{{ record.date|date:"Y-m-d" }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700">
            <span class="px-2 py-1 text-xs rounded-full bg-gray-100">{{ record.shift }}</span>
          </td>
          <td class="px-3 sm:px-6 py-3">
            <div>
              <div class="text-gray-900 font-medium">{{ record.name }}</div>
              <div class="text-xs text-gray-500">{{ record.emp_id }}</div>
            </div>
          </td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden md:table-cell">{{ record.line }}</td>
          <td class="px-3 sm:px-6 py-3 text-gray-700 hidden md:table-cell">{{ record.model }}</td>
          <td class="px-3 sm:px-6 py-3 hidden lg:table-cell">
            {% if record.key_station_job_card_status == 'Have' %}
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Have</span>
            {% elif record.key_station_job_card_status == 'Not Have' %}
              <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Not Have</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">NA</span>
            {% endif %}
          </td>
          <td class="px-3 sm:px-6 py-3">
            {% if record.key_station_operator_status == 'Old' %}
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Old</span>
            {% elif record.key_station_operator_status == 'New' %}
              <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">New</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Rotating</span>
            {% endif %}
          </td>
          <td class="px-3 sm:px-6 py-3">
            {% if record.pqe_training_and_verification_status == 'Done' %}
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Done</span>
            {% elif record.pqe_training_and_verification_status == 'Training Pending' %}
              <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Pending</span>
            {% elif record.pqe_training_and_verification_status == 'Already Done' %}
              <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Done</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800">Replace</span>
            {% endif %}
          </td>
          <td class="px-3 sm:px-6 py-3">
            <div class="flex gap-2">
              <a href="#" onclick="event.preventDefault(); showDetails({{ record.pk }})" 
                 class="text-blue-600 font-semibold text-xs sm:text-sm hover:underline">
                <i class="fas fa-eye"></i> View
              </a>
              {% if record.scanned_barcode_image %}
              <a href="{{ record.scanned_barcode_image.url }}" 
                 class="text-purple-600 font-semibold text-xs sm:text-sm hover:underline" 
                 title="View Scanned Image" target="_blank">
                <i class="fas fa-qrcode"></i>
              </a>
              {% endif %}
              {% if record.scanned_barcode_text %}
              <a href="{{ record.scanned_barcode_text }}" 
                 class="text-green-600 font-semibold text-xs sm:text-sm hover:underline" 
                 title="View Feishu Record" target="_blank">
                <i class="fas fa-link"></i>
              </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center py-6 text-gray-500">No records found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="mt-6 flex justify-center">
  <nav class="flex items-center space-x-1">
    {% if page_obj.has_previous %}
      <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-double-left"></i>
      </a>
      <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-left"></i>
      </a>
    {% endif %}

    <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-right"></i>
      </a>
      <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        <i class="fas fa-angle-double-right"></i>
      </a>
    {% endif %}
  </nav>
</div>
{% endif %}

<!-- Details Modal -->
<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-xl shadow-2xl w-[95%] sm:w-[90%] md:w-[80%] lg:w-[70%] max-h-[90vh] overflow-y-auto mt-[130px]">
    <div class="flex justify-between items-center px-4 sm:px-6 py-4 border-b">
      <h2 class="text-lg sm:text-xl font-bold text-gray-800">Qualification Check Details</h2>
      <button onclick="closeDetails()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <div id="modalBody" class="p-4 sm:p-6">
      <p class="text-gray-500 text-center">Loading...</p>
    </div>
  </div>
</div>

<!-- CSS Styles -->
<style>
.metric-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid #e5e7eb;
  transition: all 0.3s ease;
}

.metric-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.metric-value {
  font-size: 2rem;
  font-weight: 700;
  color: #111827;
  line-height: 1;
}

.metric-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-top: 0.5rem;
}
</style>
{% endblock content %}

{% block extra_js %}
<script>
  function showDetails(pk) {
    const modal = document.getElementById('detailsModal');
    const modalBody = document.getElementById('modalBody');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modalBody.innerHTML = `<p class='text-gray-500 text-center'>Loading...</p>`;

    fetch(`/ipqc/operator-qualification/details/${pk}/`)
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        modalBody.innerHTML = buildDetailsUI(data);
      })
      .catch(error => {
        console.error('Error details:', error);
        modalBody.innerHTML = `<p class='text-red-500 text-center'>Error loading details: ${error.message}</p>`;
      });
  }

  function closeDetails() {
    const modal = document.getElementById('detailsModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function buildDetailsUI(data) {
    let html = '<div class="space-y-6">';
    
    // Basic Information Section
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-info-circle text-blue-500"></i> Basic Information
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
    `;
    
    const basicFields = [
      ['date', 'Date'], ['shift', 'Shift'], ['emp_id', 'Employee ID'],
      ['name', 'Name'], ['section', 'Section'], ['line', 'Line'],
      ['group', 'Group'], ['model', 'Model'], ['color', 'Color'],
    ];
    
    basicFields.forEach(([key, label]) => {
      if (data[key]) {
        html += `
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">${label}</div>
            <div class="font-semibold text-sm">${data[key]}</div>
          </div>`;
      }
    });
    
    html += '</div></div>';

    // Job Card Status
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-id-card text-purple-500"></i> Job Card Status
        </h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Key Station Name</div>
            <div class="font-semibold text-sm">${data.key_station_name}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Job Card Status</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.key_station_job_card_status)}</div>
          </div>
        </div>
      </div>
    `;

    // Operator Verification
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-user-check text-green-500"></i> Operator Verification
        </h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Operator Status</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.key_station_operator_status)}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Work Instruction</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.check_operator_work_instruction)}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">New/Rotating Status</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.new_or_rotating_operator_status)}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded">
            <div class="text-xs text-gray-500">Training Status</div>
            <div class="font-semibold text-sm">${getStatusBadge(data.pqe_training_and_verification_status)}</div>
          </div>
        </div>
      </div>
    `;

    // Summary
    html += `
      <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-clipboard-check text-indigo-500"></i> Verification Summary
        </h3>
        <div class="bg-gray-50 p-3 rounded">
          <div class="text-sm whitespace-pre-wrap">${data.job_card_verification_summary || 'No summary provided'}</div>
        </div>
      </div>
    `;

    // Photos Section
    if (data.photos && data.photos.length > 0) {
      html += `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-camera text-blue-500"></i> Evidence Photos
          </h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
      `;
      
      data.photos.forEach(photo => {
        html += `
          <div class="border rounded-lg overflow-hidden hover:shadow-lg transition cursor-pointer"
               onclick="openPhotoPreview('${photo.url}', '${photo.label}')">
            <img src="${photo.url}" alt="${photo.label}" class="w-full h-40 object-cover">
            <div class="text-center py-2 text-xs text-gray-600 bg-gray-50">${photo.label}</div>
          </div>`;
      });
      
      html += '</div></div>';
    }

    // Feishu Link
    if (data.scanned_barcode_text) {
      html += `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
            <i class="fas fa-link text-blue-500"></i> Feishu Record
          </h3>
          <div class="flex items-center justify-between">
            <a href="${data.scanned_barcode_text}" target="_blank" class="text-blue-600 underline text-sm break-all pr-2">${data.scanned_barcode_text}</a>
            <button onclick="copyToClipboard('${data.scanned_barcode_text}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition flex-shrink-0">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
      `;
    }

    html += '</div>';
    return html;
  }

  function getStatusBadge(status) {
    let colorClass = 'bg-gray-100 text-gray-800';
    if (status === 'Have' || status === 'Done' || status === 'Old' || status === 'Trained') {
      colorClass = 'bg-green-100 text-green-800';
    } else if (status === 'Not Have' || status === 'Pending' || status === 'New' || status === 'Not Trained' || status === 'Training Pending') {
      colorClass = 'bg-yellow-100 text-yellow-800';
    } else if (status === 'Rotating' || status === 'Already Done') {
      colorClass = 'bg-blue-100 text-blue-800';
    } else if (status === 'Replace Operator') {
      colorClass = 'bg-orange-100 text-orange-800';
    }
    return `<span class="px-2 py-1 text-xs rounded-full ${colorClass}">${status}</span>`;
  }

  // Photo preview functions
  function openPhotoPreview(url, label) {
    if (document.getElementById('photoPreviewOverlay')) return;

    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';

    const overlay = document.createElement('div');
    overlay.id = 'photoPreviewOverlay';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
    overlay.style.backdropFilter = 'blur(4px)';

    const container = document.createElement('div');
    container.className = 'relative w-full max-w-4xl mx-auto';

    container.innerHTML = `
        <div class="bg-white rounded-lg overflow-hidden shadow-xl flex flex-col max-h-[90vh]">
            <div class="flex items-center justify-between px-4 py-3 bg-gray-100 border-b">
                <h2 id="photoPreviewLabel" class="text-sm sm:text-base font-semibold text-gray-800 truncate" style="max-width: 80%;">${escapeHtml(label)}</h2>
                <div class="flex items-center gap-2">
                    <a id="photoDownloadBtn" href="${url}" download class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-sm">
                        <i class="fas fa-download"></i> Download
                    </a>
                    <button id="photoCloseBtn" aria-label="Close preview" class="text-gray-700 hover:text-gray-900 text-2xl leading-none bg-transparent border-0">&times;</button>
                </div>
            </div>
            <div class="flex-1 flex items-center justify-center bg-black p-2">
                <img id="photoPreviewImg" src="${url}" alt="${escapeHtml(label)}" class="max-h-[80vh] w-auto object-contain rounded-md" />
            </div>
        </div>
    `;

    overlay.appendChild(container);
    document.body.appendChild(overlay);

    overlay.addEventListener('click', function (e) {
        if (e.target === overlay) closePhotoPreview();
    });

    const btn = document.getElementById('photoCloseBtn');
    btn.addEventListener('click', closePhotoPreview);

    function escHandler(e) {
        if (e.key === 'Escape') closePhotoPreview();
    }
    document.addEventListener('keydown', escHandler);
    overlay._escHandler = escHandler;
  }

  function closePhotoPreview() {
    const overlay = document.getElementById('photoPreviewOverlay');
    if (!overlay) return;

    if (overlay._escHandler) {
        document.removeEventListener('keydown', overlay._escHandler);
    }
    overlay.remove();
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
  }

  function escapeHtml(str) {
    if (!str && str !== 0) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showToast('URL copied to clipboard!');
    }, function() {
        showToast('Failed to copy URL', 'error');
    });
  }

  function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
      toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-full`;
      toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${message}`;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
          toast.classList.remove('translate-y-full');
      }, 100);
      
      setTimeout(() => {
          toast.classList.add('translate-y-full');
          setTimeout(() => toast.remove(), 300);
      }, 3000);
  }
</script>
{% endblock %}

transs_flow/templates/ipqc/scan.html

<!DOCTYPE html>
<html>
<head>
  <title>Live QR / Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; text-align: center; }
    #preview { border: 2px solid #ccc; padding: 10px; margin-top: 20px; }
    #result { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ðŸ“· Live QR / Barcode Scanner</h2>
  <div id="reader" style="width: 300px; margin: auto;"></div>
  <div id="preview"></div>

  <script>
    function onScanSuccess(decodedText) {
      document.getElementById("preview").innerHTML =
        `<p>ðŸ”— ${decodedText}</p><p>Fetching record data...</p>`;

      fetch(`/ipqc/fetch-feishu-record/?url=${encodeURIComponent(decodedText)}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            document.getElementById("preview").innerHTML =
              `<p>âŒ Error: ${data.error}</p><pre>${JSON.stringify(data.details || data, null, 2)}</pre>`;
          } else {
            const fields = data.fields || {};
            let html = "<h3>âœ… Employee Data</h3><table border='1' style='margin:auto;'>";
            for (const [key, value] of Object.entries(fields)) {
              html += `<tr><td><b>${key}</b></td><td>${value}</td></tr>`;
            }
            html += "</table>";
            document.getElementById("preview").innerHTML = html;
          }
        })
        .catch(err => {
          document.getElementById("preview").innerHTML = `<p>âŒ Fetch error: ${err}</p>`;
        });
    }

    new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 })
      .render(onScanSuccess);
  </script>
</body>
</html>


transs_flow/templates/ipqc/testing_fai_detail.html

{% extends 'base.html' %}
{% load static %}
{% block title %}FAI Record Detail{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6">
            <h1 class="text-2xl font-bold">FAI Record: {{ fai_record.model }} ({{ fai_record.color }})</h1>
            <p class="text-blue-100 mt-2">Inspection Date: {{ fai_record.date|date:"Y-m-d" }} | Inspector: {{
                fai_record.inspector_name }}</p>
        </div>
        <!-- Body -->
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Basic Information -->
                <div class="col-span-full">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Basic Information</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div><strong>Date:</strong> {{ fai_record.date }}</div>
                        <div><strong>Shift:</strong> {{ fai_record.shift }}</div>
                        <div><strong>Emp ID:</strong> {{ fai_record.emp_id }}</div>
                        <div><strong>Name:</strong> {{ fai_record.name }}</div>
                        <div><strong>Section:</strong> {{ fai_record.section }}</div>
                        <div><strong>Line:</strong> {{ fai_record.line }}</div>
                        <div><strong>Model:</strong> {{ fai_record.model }}</div>
                        <div><strong>Color:</strong> {{ fai_record.color }}</div>
                        <div><strong>Work Order:</strong> {{ fai_record.production_work_order_no }}</div>
                        <div><strong>FAI Type:</strong> {{ fai_record.get_first_article_type_display }}</div>
                    </div>
                </div>
                <!-- Check Results -->
                <div>
                    <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Order & Software</h2>
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.software_ver_check
                    label="Software Version Check" %}
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.android_ver_check label="Android
                    Version Check" %}
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.memory_inbuilt_check
                    label="Memory Check" %}
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.order_confirm_check label="Order
                    Confirmation Check" %}
                </div>
                <div>
                    <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Visual & Labels</h2>
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.label_check label="Label Check"
                    %}
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.label_position_check
                    label="Label Position Check" %}
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.visual_inspection_handset
                    label="Visual Handset" %}
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.logo_check label="Logo Check" %}
                    {% include 'ipqc/partials/field_display.html' with field=fai_record.assembly_battery_check
                    label="Assembly Check" %}
                </div>
                <div>
                    <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Final Results</h2>
                    <div><strong>Visual & Functional Result:</strong>
                        <span class="px-2 py-1 text-xs rounded-full 
	                            {% if fai_record.visual_functional_result == 'QUALIFIED' %}bg-green-100 text-green-800
	                            {% elif fai_record.visual_functional_result == 'UNQUALIFIED' %}bg-red-100 text-red-800
	                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {{ fai_record.visual_functional_result }}
                        </span>
                    </div>
                    <div class="mt-2"><strong>Reliability Result:</strong>
                        <span class="px-2 py-1 text-xs rounded-full 
	                            {% if fai_record.reliability_result == 'QUALIFIED' %}bg-green-100 text-green-800
	                            {% elif fai_record.reliability_result == 'UNQUALIFIED' %}bg-red-100 text-red-800
	                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {{ fai_record.reliability_result }}
                        </span>
                    </div>
                    <div class="mt-2"><strong>Inspector Name:</strong> {{ fai_record.inspector_name }}</div>
                    <div class="mt-2"><strong>QE Name:</strong> {{ fai_record.qe_confirm_name|default:"N/A" }}</div>
                    <div class="mt-2"><strong>QE Status:</strong> {{ fai_record.qe_confirm_status|default:"N/A" }}</div>
                </div>
                <!-- Photos -->
                {% if fai_record.imei_photo or fai_record.label_check_evidence %}
                <div class="col-span-full">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Evidence Photos</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {% if fai_record.imei_photo %}
                        <div><strong>IMEI:</strong><a href="{{ fai_record.imei_photo.url }}" target="_blank"><img
                                    src="{{ fai_record.imei_photo.url }}" alt="IMEI Photo"
                                    class="w-full h-32 object-cover rounded"></a></div>
                        {% endif %}
                        {% if fai_record.label_check_evidence %}
                        <div><strong>Label:</strong><a href="{{ fai_record.label_check_evidence.url }}"
                                target="_blank"><img src="{{ fai_record.label_check_evidence.url }}" alt="Label Photo"
                                    class="w-full h-32 object-cover rounded"></a></div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% comment %}
Create a partial template for cleaner code at ipqc/templates/ipqc/partials/field_display.html:
{% endcomment %}
{% if field %}
<div class="flex justify-between items-center py-2 border-b">
    <span class="text-gray-600">{{ label }}:</span>
    <span class="font-semibold 
	            {% if field == 'OK' %}text-green-600
	            {% elif field == 'Not OK' %}text-red-600
	            {% else %}text-gray-500{% endif %}">
        {{ field }}
    </span>
</div>
{% endif %}
{% endblock content %}

transs_flow/templates/ipqc/testing_fai_public_qe_update.html

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QE Confirmation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
         /* General Styles */
    .data-section {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
    }
    .section-title {
        font-size: 1.25rem; /* 20px */
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .section-title i {
        color: #3b82f6;
    }
    .field-grid {
        display: grid;
        gap: 16px;
        /* 2 columns on medium screens, 3 on large */
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    .field-item {
        display: flex;
        flex-direction: column;
    }
    .field-label {
        font-size: 0.875rem; /* 14px */
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
    }
    .field-value {
        font-size: 0.875rem; /* 14px */
        color: #111827;
        word-break: break-all;
    }

    /* Status Badge Styles */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 9999px; /* Fully rounded */
        font-size: 0.75rem; /* 12px */
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .status-ok {
        background-color: #dcfce7;
        color: #166534;
    }
    .status-not-ok {
        background-color: #fecaca;
        color: #991b1b;
    }
    .status-na {
        background-color: #f3f4f6;
        color: #6b7280;
    }

    /* Evidence Gallery Styles */
    .evidence-gallery {
        margin-top: 32px;
    }
    .evidence-gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 16px;
    }
    .evidence-item {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
    }
    .evidence-item:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .evidence-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
    }
    .evidence-item figcaption {
        background: #f9fafb;
        padding: 8px 12px;
        font-size: 0.875rem; /* 14px */
        color: #374151;
        text-align: center;
        border-top: 1px solid #e5e7eb;
    }

    /* Photo Overlay Styles */
    .photo-preview-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        padding: 20px;
        backdrop-filter: blur(4px);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .photo-preview-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    .photo-preview-container {
        background: white;
        border-radius: 12px;
        max-width: 90vw;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
    }
    .photo-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    .photo-preview-header h2 {
        font-size: 1.125rem; /* 18px */
        font-weight: 600;
        color: #111827;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 80%;
    }
    .photo-preview-body {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 16px;
        background: #111827;
        flex-grow: 1;
    }
    .photo-preview-body img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
    }
    .preview-btn {
        background: #3b82f6;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .preview-btn:hover {
        background: #1d4ed8;
    }
    </style>
</head>
<body>
<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 shadow-lg">
        <div class="container mx-auto flex flex-col items-center justify-center text-center py-6">
        <h1 class="text-2xl font-bold">FAI Record Review & Confirmation</h1>
        <p class="text-blue-100">First Article Inspection - Quality Engineering Approval</p>
    </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- Record Summary Bar -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 flex flex-wrap justify-around items-center text-center gap-4">
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">IPQC</p>
                <p class="text-xl font-bold text-gray-900">{{ fai_record.name }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">Model</p>
                <p class="text-xl font-bold text-gray-900">{{ fai_record.model }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">Color</p>
                <p class="text-xl font-bold text-gray-900">{{ fai_record.color }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">Line</p>
                <p class="text-xl font-bold text-gray-900">{{ fai_record.line }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">Inspection Date</p>
                <p class="text-xl font-bold text-gray-900">{{ fai_record.date|date:"Y-m-d" }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">Status</p>
                <p class="text-xl font-bold {% if fai_record.qe_confirm_status == 'Approved' %}text-green-600{% elif fai_record.qe_confirm_status == 'Not Approved' %}text-red-600{% else %}text-gray-600{% endif %}">
                    {% if fai_record.qe_confirm_status %}{{ fai_record.qe_confirm_status }}{% else %}Pending{% endif %}
                </p>
            </div>
        </div>

        <!-- INSPECTION DATA -->
        <div class="space-y-8">
            <!-- Order & Software Section -->
            <div class="data-section">
                <h3 class="section-title">
                    <i class="fas fa-cogs text-green-600"></i>
                    Order & Software Checks
                </h3>
                <div class="field-grid">
                    <div class="field-item">
                        <span class="field-label">First Article Type</span>
                        <span class="field-value">{{ fai_record.get_first_article_type_display }}</span>
                    </div>
                    <div class="field-item">
                        <span class="field-label">Software Version Check</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.software_ver_check == 'OK' %}status-ok{% elif fai_record.software_ver_check == 'Not OK' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.software_ver_check|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                    <div class="field-item">
                        <span class="field-label">OS Version Check</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.android_ver_check == 'OK' %}status-ok{% elif fai_record.android_ver_check == 'Not OK' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.android_ver_check|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                    <div class="field-item">
                        <span class="field-label">Memory Check</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.memory_inbuilt_check == 'OK' %}status-ok{% elif fai_record.memory_inbuilt_check == 'Not OK' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.memory_inbuilt_check|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                    <div class="field-item">
                        <span class="field-label">Order Confirmation</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.order_confirm_check == 'OK' %}status-ok{% elif fai_record.order_confirm_check == 'Not OK' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.order_confirm_check|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visual & Labels Section -->
            <div class="data-section">
                <h3 class="section-title">
                    <i class="fas fa-eye text-purple-600"></i>
                    Visual & Label Checks
                </h3>
                <div class="field-grid">
                    <div class="field-item"><span class="field-label">Visual Inspection</span><div class="field-value">{{ fai_record.visual_inspection_handset|default:"N/A" }}</div></div>
                    <div class="field-item"><span class="field-label">Label Check</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.label_check == 'OK' %}status-ok{% elif fai_record.label_check == 'Not OK' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.label_check|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                    <div class="field-item"><span class="field-label">Label Position</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.label_position_check == 'OK' %}status-ok{% elif fai_record.label_position_check == 'Not OK' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.label_position_check|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                    <div class="field-item"><span class="field-label">Logo Check</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.logo_check == 'OK' %}status-ok{% elif fai_record.logo_check == 'Not OK' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.logo_check|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                    <div class="field-item"><span class="field-label">Assembly Check</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.assembly_battery_check == 'OK' %}status-ok{% elif fai_record.assembly_battery_check == 'Not OK' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.assembly_battery_check|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Functional Tests Section (Sample - you can expand this with all fields) -->
             <div class="data-section">
                <h3 class="section-title">
                    <i class="fas fa-mobile-alt text-blue-600"></i>
                    Functional Tests
                </h3>
                <div class="field-grid">
                  <div class="field-item"><span class="field-label">TP with Charge Test</span><div class="field-value">{{ fai_record.tp_with_charge_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">15min Charging Test</span><div class="field-value">{{ fai_record.charge_15min_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Boot Time Test</span><div class="field-value">{{ fai_record.boot_time_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Init Settings Test</span><div class="field-value">{{ fai_record.init_settings_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Buttons/Keys Test</span><div class="field-value">{{ fai_record.buttons_keys_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Touch Screen Pen Test</span><div class="field-value">{{ fai_record.touch_screen_pen_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Calling Test</span><div class="field-value">{{ fai_record.calling_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Bluetooth Test</span><div class="field-value">{{ fai_record.bluetooth_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Flashlight Test</span><div class="field-value">{{ fai_record.flashlight_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Camera Flash Test</span><div class="field-value">{{ fai_record.camera_flash_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Camera Photo Test</span><div class="field-value">{{ fai_record.camera_photo_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Long Distance Check</span><div class="field-value">{{ fai_record.camera_long_distance_check|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">High-Light Defect Check</span><div class="field-value">{{ fai_record.highlight_defect_check|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Multimedia Play Test</span><div class="field-value">{{ fai_record.multimedia_play_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">FM Play Test</span><div class="field-value">{{ fai_record.fm_play_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">TV Function Test</span><div class="field-value">{{ fai_record.tv_fn_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Taping Function Test</span><div class="field-value">{{ fai_record.taping_fn_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Shaking Screen Test</span><div class="field-value">{{ fai_record.shaking_screen_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">WiFi Test</span><div class="field-value">{{ fai_record.wifi_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Gravity Sensor Test</span><div class="field-value">{{ fai_record.gravity_sensor_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Light/Distance Sensor Test</span><div class="field-value">{{ fai_record.light_distance_sensor_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Hall Function Test</span><div class="field-value">{{ fai_record.hall_fn_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">QR Scan Test</span><div class="field-value">{{ fai_record.qr_scan_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">RAM/ROM Capacity Test</span><div class="field-value">{{ fai_record.ram_rom_cap_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Mode Switch Test</span><div class="field-value">{{ fai_record.mode_switch_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">Touch in Dev Options Test</span><div class="field-value">{{ fai_record.touch_in_dev_opt_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">MAC Address Test</span><div class="field-value">{{ fai_record.mac_add_test|default:"N/A" }}</div></div>
                  <div class="field-item"><span class="field-label">OTG Function Test</span><div class="field-value">{{ fai_record.otg_fn_test|default:"N/A" }}</div></div>
              </div>
            </div>

            <!-- Final Results Section -->
            <div class="data-section">
                <h3 class="section-title">
                    <i class="fas fa-clipboard-check text-red-600"></i>
                    Final Results & Details
                </h3>
                <div class="field-grid">
                    <div class="field-item"><span class="field-label">Sample S/N</span><div class="field-value font-mono">{{ fai_record.sample_serial_number }}</div></div>
                    <div class="field-item"><span class="field-label">IMEI Number</span><div class="field-value font-mono">{{ fai_record.imei_number }}</div></div>
                    <div class="field-item"><span class="field-label">Visual Result</span>
                         <div class="field-value">
                            <span class="status-badge {% if fai_record.visual_functional_result == 'QUALIFIED' %}status-ok{% elif fai_record.visual_functional_result == 'UNQUALIFIED' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.visual_functional_result }}
                            </span>
                        </div>
                    </div>
                    <div class="field-item"><span class="field-label">Reliability Result</span>
                        <div class="field-value">
                            <span class="status-badge {% if fai_record.reliability_result == 'QUALIFIED' %}status-ok{% elif fai_record.reliability_result == 'UNQUALIFIED' %}status-not-ok{% else %}status-na{% endif %}">
                                {{ fai_record.reliability_result }}
                            </span>
                        </div>
                </div>
            </div>

            <!-- EVIDENCE PHOTOS GALLERY -->
            <div class="evidence-gallery">
                <h3 class="section-title">
                    <i class="fas fa-images text-indigo-600"></i>
                    Evidence Photos
                </h3>
                <div class="evidence-gallery-grid">
                    {% if fai_record.label_check_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.label_check_evidence.url }}', 'Label Check Evidence')">
                        <img src="{{ fai_record.label_check_evidence.url }}" alt="Label Check">
                        <figcaption>Label Check</figcaption>
                    </div>
                    {% endif %}
                    {% if fai_record.label_position_check_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.label_position_check_evidence.url }}', 'Label Position Evidence')">
                        <img src="{{ fai_record.label_position_check_evidence.url }}" alt="Label Position">
                        <figcaption>Label Position</figcaption>
                    </div>
                    {% endif %}
                    {% if fai_record.logo_check_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.logo_check_evidence.url }}', 'Logo Evidence')">
                        <img src="{{ fai_record.logo_check_evidence.url }}" alt="Logo">
                        <figcaption>Logo</figcaption>
                    </div>
                    {% endif %}
                    {% if fai_record.assembly_battery_check_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.assembly_battery_check_evidence.url }}', 'Assembly Evidence')">
                        <img src="{{ fai_record.assembly_battery_check_evidence.url }}" alt="Assembly">
                        <figcaption>Assembly</figcaption>
                    </div>
                    {% endif %}
                     {% if fai_record.boot_time_test_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.boot_time_test_evidence.url }}', 'Boot Time Video')">
                        <img src="{{ fai_record.boot_time_test_evidence.url }}" alt="Boot Time">
                        <figcaption>Boot Time Video</figcaption>
                    </div>
                    {% endif %}
                    {% if fai_record.camera_front_test_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.camera_front_test_evidence.url }}', 'Front Camera Photo')">
                        <img src="{{ fai_record.camera_front_test_evidence.url }}" alt="Front Camera">
                        <figcaption>Front Camera</figcaption>
                    </div>
                    {% endif %}
                    {% if fai_record.camera_back_test_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.camera_back_test_evidence.url }}', 'Back Camera Photo')">
                        <img src="{{ fai_record.camera_back_test_evidence.url }}" alt="Back Camera">
                        <figcaption>Back Camera</figcaption>
                    </div>
                    {% endif %}
                    {% if fai_record.camera_dark_test_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.camera_dark_test_evidence.url }}', 'Low Light Camera')">
                        <img src="{{ fai_record.camera_dark_test_evidence.url }}" alt="Low Light Camera">
                        <figcaption>Dark/Low Light</figcaption>
                    </div>
                    {% endif %}
                    {% if fai_record.high_temp_camera_test_evidence %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.high_temp_camera_test_evidence.url }}', 'High Temp Camera')">
                        <img src="{{ fai_record.high_temp_camera_test_evidence.url }}" alt="High Temp Camera">
                        <figcaption>High Temp Test</figcaption>
                    </div>
                    {% endif %}
                    {% if fai_record.imei_photo %}
                    <div class="evidence-item" onclick="openPhotoPreview('{{ fai_record.imei_photo.url }}', 'IMEI Verification Photo')">
                        <img src="{{ fai_record.imei_photo.url }}" alt="IMEI Photo">
                        <figcaption>IMEI Photo</figcaption>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- QE CONFERENCE FORM -->
        <div class="mt-12 bg-white rounded-lg shadow-md p-8">
             <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-3">Quality Engineering Confirmation</h3>
            <form method="post" id="qeForm" class="space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="qe_confirm_name" class="block text-sm font-medium text-gray-700">QE Name</label>
                        <input type="text" id="qe_confirm_name" name="qe_confirm_name" value="{{ fai_record.qe_confirm_name }}" 
                               {% if fai_record.qe_confirm_name %}readonly{% endif %}
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 {% if fai_record.qe_confirm_name %}bg-gray-100{% endif %}" 
                               required>
                    </div>
                    <div>
                        <label for="qe_confirm_status" class="block text-sm font-medium text-gray-700">Approval Status</label>
                        <select id="qe_confirm_status" name="qe_confirm_status" 
                                {% if fai_record.qe_confirm_status %}disabled{% endif %}
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 {% if fai_record.qe_confirm_status %}bg-gray-100{% endif %}" 
                                required>
                            <option value="">-- Select Status --</option>
                            <option value="Approved" {% if fai_record.qe_confirm_status == 'Approved' %}selected{% endif %}>Approved</option>
                            <option value="Not Approved" {% if fai_record.qe_confirm_status == 'Not Approved' %}selected{% endif %}>Not Approved</option>
                            <option value="NA" {% if fai_record.qe_confirm_status == 'NA' %}selected{% endif %}>NA</option>
                        </select>
                    </div>
                </div>
                 <div class="mt-8">
                    {% if fai_record.qe_confirm_name %}
                    <button type="button" disabled class="w-full bg-gray-400 border border-transparent rounded-md shadow-sm py-3 px-4 text-sm font-medium text-gray-500 cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-lock mr-2"></i> Already Submitted
                    </button>
                    {% else %}
                    <button type="submit" class="w-full bg-blue-600 border border-transparent rounded-md shadow-sm py-3 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center justify-center">
                         <i class="fas fa-check mr-2"></i> Submit Confirmation
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>

    </div>
</div>

<!-- Photo Preview Overlay -->
<div id="photoPreviewOverlay" class="photo-preview-overlay">
    <div class="photo-preview-container">
        <div class="photo-preview-header">
            <h2 id="photoPreviewLabel">Photo Preview</h2>
            <div class="flex gap-3">
                <a id="photoDownloadBtn" href="#" target="_blank" download class="preview-btn">
                    <i class="fas fa-download"></i> Download
                </a>
                <button id="photoCloseBtn" class="preview-btn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        <div class="photo-preview-body">
            <img id="photoPreviewImg" src="" alt="">
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 z-50 transform transition-all duration-300 translate-y-full opacity-0 pointer-events-none">
    <div class="bg-gray-800 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center space-x-3">
        <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
        <span id="toastMessage"></span>
    </div>
</div>

<!-- Django Messages -->
{% if messages %}
    {% for message in messages %}
        <div class="fixed top-4 right-4 z-50 p-4 max-w-sm w-full bg-green-50 border border-green-200 text-green-800 rounded-lg shadow-lg transition-all duration-300">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<script>
// Photo Viewer Functions
function openPhotoPreview(url, label) {
    const overlay = document.getElementById('photoPreviewOverlay');
    const img = document.getElementById('photoPreviewImg');
    const labelEl = document.getElementById('photoPreviewLabel');
    const downloadBtn = document.getElementById('photoDownloadBtn');

    img.src = url;
    img.alt = label;
    labelEl.textContent = label;
    downloadBtn.href = url;
    
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden'; // Prevent background scroll
}

function closePhotoPreview() {
    const overlay = document.getElementById('photoPreviewOverlay');
    overlay.classList.remove('active');
    document.body.style.overflow = 'auto'; // Restore background scroll
}

// Attach event listeners
document.addEventListener('DOMContentLoaded', function() {
    const closeBtn = document.getElementById('photoCloseBtn');
    const overlay = document.getElementById('photoPreviewOverlay');

    if (closeBtn && overlay) {
        closeBtn.addEventListener('click', closePhotoPreview);
        // Close on overlay click
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                closePhotoPreview();
            }
        });
        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePhotoPreview();
            }
        });
    }

    // Form submission handling
    const qeForm = document.getElementById('qeForm');
    if (qeForm) {
        qeForm.addEventListener('submit', function() {
            const submitBtn = qeForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-pulse mr-2"></i> Submitting...';
            }
        });
    }
});

// Toast Notification Function
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');

    toastMessage.textContent = message;
    
    // Reset classes
    toast.className = 'fixed bottom-4 right-4 z-50 transform transition-all duration-300 flex items-center space-x-3 px-6 py-4 rounded-lg shadow-2xl max-w-sm w-full';
    
    if (type === 'success') {
        toast.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
        toastIcon.className = 'fas fa-check-circle text-green-400';
    } else if (type === 'error') {
        toast.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
        toastIcon.className = 'fas fa-exclamation-circle text-red-400';
    }
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-y-full', 'opacity-0', 'pointer-events-none');
        toast.classList.add('translate-y-0', 'opacity-1', 'pointer-events-auto');
    }, 100);

    // Animate out
    setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0', 'pointer-events-none');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

// Auto-hide Django messages
document.addEventListener('DOMContentLoaded', function(){
    setTimeout(() => {
        const messages = document.querySelectorAll('[class*="bg-green-50"]');
        messages.forEach(msg => {
            msg.style.opacity = '0';
            msg.style.transform = 'translateY(20px)';
            setTimeout(() => msg.remove(), 500);
        });
    }, 5000);
});
</script>
</body>
</html>

transs_flow/templates/ipqc/work_info.html

	{% extends 'base.html' %}
	{% load static %}
	{% block title %}Work Info{% endblock %}
	{% block content %}
	<style>
	/* Clean form styles */
	.work-info-form {
	    max-width: 1200px;
	    margin: 0 auto;
	    padding: 20px;
	}
	/* Header section */
	.page-header {
	    background: white;
	    border: 1px solid var(--border);
	    border-radius: 12px;
	    padding: 24px;
	    margin-bottom: 24px;
	 Box-Shadow: 0 2px 8px rgba(0,0,0,0.05);
	}
	.page-title {
	    font-size: 28px;
	    font-weight: 700;
	    color: var(--text-primary);
	    display: flex;
	    align-items: center;
	    gap: 12px;
	    margin-bottom: 8px;
	}
	.page-subtitle {
	    color: var(--text-secondary);
	    font-size: 16px;
	}
	/* Stats cards */
	.stats-grid {
	    display: grid;
	    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	    gap: 20px;
	    margin-bottom: 24px;
	}
	.stat-card {
	    background: white;
	    border: 1px solid var(--border);
	    border-radius: 12px;
	    padding: 20px;
	    display: flex;
	    align-items: center;
	    gap: 16px;
	    transition: all 0.2s ease;
	}
	.stat-card:hover {
	 Box-Shadow: 0 4px 16px rgba(0,0,0,0.08);
	    transform: translateY(-2px);
	}
	.stat-icon {
	    width: 48px;
	    height: 48px;
	    border-radius: 10px;
	    display: flex;
	    align-items: center;
	    justify-content: center;
	    flex-shrink: 0;
	}
	.stat-content {
	    flex: 1;
	}
	.stat-value {
	    font-size: 28px;
	    font-weight: 700;
	    color: var(--text-primary);
	    line-height: 1;
	    margin-bottom: 4px;
	}
	.stat-label {
	    font-size: 14px;
	    color: var(--text-secondary);
	    font-weight: 500;
	}
	/* Form section */
	.form-section {
	    background: white;
	    border: 1px solid var(--border);
	    border-radius: 12px;
	    padding: 24px;
	    margin-bottom: 24px;
	    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
	}
	.section-title {
	    font-size: 20px;
	    font-weight: 700;
	    color: var(--text-primary);
	    display: flex;
	    align-items: center;
	    gap: 12px;
	    margin-bottom: 24px;
	    padding-bottom: 16px;
	    border-bottom: 1px solid var(--border);
	}
	.form-grid {
	    display: grid;
	    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
	    gap: 20px;
	}
	.form-group {
	    display: flex;
	    flex-direction: column;
	    position: relative;
	}
	.form-group label {
	    font-size: 14px;
	    font-weight: 600;
	    color: var(--text-primary);
	    margin-bottom: 8px;
	    display: flex;
	    align-items: center;
	    gap: 8px;
	}
	.form-group label i {
	    width: 16px;
	    text-align: center;
	    color: var(--primary);
	}
	.form-group input,
	.form-group select {
	    width: 100%;
	    padding: 12px 16px;
	    background: white;
	    border: 2px solid var(--border);
	    border-radius: 8px;
	    color: var(--text-primary);
	    font-size: 15px;
	    transition: all 0.2s ease;
	    font-family: inherit;
	    box-sizing: border-box;
	}
	.form-group input:focus,
	.form-group select:focus {
	    outline: none;
	    border-color: var(--primary);
	    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
	}
	.form-group input[readonly] {
	    background: var(--bg-secondary);
	    color: var(--text-secondary);
	    cursor: not-allowed;
	}
	/* Search suggestions */
	.suggestions-box {
	    position: absolute;
	    top: 100%;
	    left: 0;
	    right: 0;
	    background: white;
	    border: 1px solid var(--border);
	    border-radius: 8px;
	    margin-top: 4px;
	    z-index: 1000;
	    max-height: 200px;
	    overflow-y: auto;
	    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
	    display: none;
	}
	.suggestions-box.show {
	    display: block;
	}
	.suggestion-item {
	    padding: 12px 16px;
	    cursor: pointer;
	    border-bottom: 1px solid #f1f5f9;
	    transition: background 0.2s ease;
	}
	.suggestion-item:last-child {
	    border-bottom: none;
	}
	.suggestion-item:hover {
	    background: var(--bg-secondary);
	    color: var(--primary);
	}
	/* Buttons */
	.btn {
	    padding: 12px 24px;
	    border-radius: 8px;
	    font-weight: 600;
	    font-size: 15px;
	    border: none;
	    cursor: pointer;
	    transition: all 0.2s ease;
	    display: inline-flex;
	    align-items: center;
	    gap: 8px;
	    text-decoration: none;
	    min-height: 48px;
	}
	.btn-primary {
	    background: var(--primary);
	    color: white;
	    box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2);
	}
	.btn-primary:hover {
	    background: var(--primary-dark);
	    transform: translateY(-1px);
	    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
	}
	.btn-primary:disabled {
	    opacity: 0.6;
	    cursor: not-allowed;
	    transform: none;
	}
	.btn-secondary {
	    background: white;
	    color: var(--text-secondary);
	    border: 2px solid var(--border);
	}
	.btn-secondary:hover {
	    background: var(--bg-secondary);
	    border-color: var(--primary);
	    color: var(--primary);
	}
	/* Submit section */
	.submit-section {
	    display: flex;
	    justify-content: center;
	    margin-top: 32px;
	    padding-top: 24px;
	    border-top: 1px solid var(--border);
	}
	/* Recent records table */
	.table-section {
	    background: white;
	    border: 1px solid var(--border);
	    border-radius: 12px;
	    padding: 24px;
	    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
	}
	.table-header {
	    font-size: 20px;
	    font-weight: 700;
	    color: var(--text-primary);
	    display: flex;
	    align-items: center;
	    gap: 12px;
	    margin-bottom: 20px;
	    padding-bottom: 16px;
	    border-bottom: 1px solid var(--border);
	}
	.data-table {
	    width: 100%;
	    border-collapse: collapse;
	    font-size: 14px;
	}
	.data-table thead {
	    background: var(--bg-secondary);
	}
	.data-table th {
	    padding: 12px 16px;
	    text-align: left;
	    font-weight: 600;
	    color: var(--text-primary);
	    border-bottom: 2px solid var(--border);
	    font-size: 13px;
	    text-transform: uppercase;
	    letter-spacing: 0.5px;
	}
	.data-table td {
	    padding: 12px 16px;
	    border-bottom: 1px solid #f1f5f9;
	    color: var(--text-primary);
	}
	.data-table tbody tr {
	    transition: background 0.2s ease;
	}
	.data-table tbody tr:hover {
	    background: var(--bg-secondary);
	}
	.data-table .no-records {
	    text-align: center;
	    color: var(--text-secondary);
	    padding: 32px 16px;
	    font-style: italic;
	}
	/* Action buttons */
	.action-btn {
	    background: transparent;
	    border: none;
	    color: var(--primary);
	    cursor: pointer;
	    padding: 8px;
	    border-radius: 4px;
	    transition: all 0.2s ease;
	    display: inline-flex;
	    align-items: center;
	    justify-content: center;
	}
	.action-btn:hover {
	    background: rgba(14, 165, 233, 0.1);
	    color: var(--primary-dark);
	}
	/* Loading state */
	.loading {
	    display: inline-flex;
	    align-items: center;
	    gap: 8px;
	}
	.spinner {
	    width: 16px;
	    height: 16px;
	    border: 2px solid rgba(255,255,255,0.3);
	    border-top-color: white;
	    border-radius: 50%;
	    animation: spin 0.6s linear infinite;
	}
	@keyframes spin {
	    to { transform: rotate(360deg); }
	}
	/* Alert styles */
	.alert {
	    padding: 12px 16px;
	    border-radius: 8px;
	    margin-bottom: 20px;
	    display: flex;
	    align-items: center;
	    gap: 12px;
	    font-weight: 500;
	}
	.alert-success {
	    background: rgba(34, 197, 94, 0.1);
	    color: var(--success);
	    border: 1px solid rgba(34, 197, 94, 0.2);
	}
	.alert-error {
	    background: rgba(239, 68, 68, 0.1);
	    color: var(--danger);
	    border: 1px solid rgba(239, 68, 68, 0.2);
	}
	/* Responsive adjustments */
	@media (max-width: 768px) {
	    .work-info-form {
	        padding: 16px;
	    }
	    .page-header,
	    .form-section,
	    .table-section {
	        padding: 16px;
	        margin-bottom: 16px;
	    }
	    .form-grid {
	        grid-template-columns: 1fr;
	        gap: 16px;
	    }
	    .stats-grid {
	        grid-template-columns: 1fr;
	        gap: 12px;
	    }
	    .page-title {
	        font-size: 24px;
	    }
	    .stat-card {
	        padding: 16px;
	    }
	    .stat-icon {
	        width: 40px;
	        height: 40px;
	    }
	    .stat-value {
	        font-size: 24px;
	    }
	    .data-table {
	        font-size: 12px;
	    }
	    .data-table th,
	    .data-table td {
	        padding: 8px 12px;
	    }
	    /* Mobile table scroll */
	    .table-container {
	        overflow-x: auto;
	        -webkit-overflow-scrolling: touch;
	    }
	}
	/* Touch optimizations */
	@media (hover: none) and (pointer: coarse) {
	    .btn {
	        min-height: 44px;
	    }
	    .action-btn {
	        min-height: 44px;
	        min-width: 44px;
	    }
	}
	/* Print friendly */
	@media print {
	    .submit-section,
	    .action-btn {
	        display: none !important;
	    }
	    .page-header,
	    .form-section,
	    .table-section {
	        box-shadow: none;
	        border: 1px solid #000;
	    }
	}
	</style>
	<div class="work-info-form">
	    <!-- Header -->
	    <div class="page-header">
	        <h1 class="page-title">
	            <i class="fas fa-clipboard-list" style="color: var(--primary);"></i>
	            Work Information Entry
	        </h1>
	        <p class="page-subtitle">Record daily manufacturing work details</p>
	    </div>
	    <!-- Stats Cards -->
	    <div class="stats-grid">
	        <div class="stat-card">
	            <div class="stat-icon bg-sky-100">
	                <i class="fas fa-calendar-day text-sky-600 text-xl"></i>
	            </div>
	            <div class="stat-content">
	                <div class="stat-value">{{ today_records|default:"0" }}</div>
	                <div class="stat-label">Today</div>
	            </div>
	        </div>
	        <div class="stat-card">
	            <div class="stat-icon bg-purple-100">
	                <i class="fas fa-calendar-week text-purple-600 text-xl"></i>
	            </div>
	            <div class="stat-content">
	                <div class="stat-value">{{ week_records|default:"0" }}</div>
	                <div class="stat-label">This Week</div>
	            </div>
	        </div>
	        <div class="stat-card">
	            <div class="stat-icon bg-pink-100">
	                <i class="fas fa-calendar text-pink-600 text-xl"></i>
	            </div>
	            <div class="stat-content">
	                <div class="stat-value">{{ total_records|default:"0" }}</div>
	                <div class="stat-label">Total Records</div>
	            </div>
	        </div>
	    </div>
	    <!-- Form Section -->
	    <div class="form-section">
	        <h2 class="section-title">
	            <i class="fas fa-edit" style="color: var(--primary);"></i>
	            Work Details
	        </h2>
	        <form method="post" id="workInfoForm">
	            {% csrf_token %}
	            <!-- Employee Info and Date -->
	            <div class="form-grid">
	                <div class="form-group">
	                    <label for="emp_id">
	                        <i class="fas fa-id-badge"></i>
	                        Employee ID
	                    </label>
	                    <input type="text" id="emp_id" name="emp_id" 
	                           value="{{ user_emp_id|default:'' }}" readonly>
	                </div>
	                <div class="form-group">
	                    <label for="emp_name">
	                        <i class="fas fa-user"></i>
	                        Employee Name
	                    </label>
	                    <input type="text" id="emp_name" name="emp_name" 
	                           value="{{ user_name|default:'' }}" readonly>
	                </div>
	                <div class="form-group">
	                    <label for="date">
	                        <i class="fas fa-calendar"></i>
	                        Date
	                    </label>
	                    <input type="date" id="date" name="date" required>
	                </div>
	            </div>
	            <!-- Line, Section and Shift -->
	            <div class="form-grid">
	                <div class="form-group">
	                    <label for="shift">
	                        <i class="fas fa-clock"></i>
	                        Shift
	                    </label>
	                    <select id="shift" name="shift" required>
	                        <option value="">Select Shift</option>
	                        <option value="Day" {% if form.shift.value == 'Day' %}selected{% endif %}>Day</option>
	                        <option value="Night" {% if form.shift.value == 'Night' %}selected{% endif %}>Night</option>
	                    </select>
	                </div>
	                <div class="form-group">
	                    <label for="section">
	                        <i class="fas fa-industry"></i>
	                        Section
	                    </label>
	                    <select id="section" name="section" required>
	                        <option value="">Select Section</option>
	                        <option value="Assembly" {% if form.section.value == 'Assembly' %}selected{% endif %}>Assembly</option>
	                        <option value="NT" {% if form.section.value == 'NT' %}selected{% endif %}>NT</option>
	                        <option value="SMT" {% if form.section.value == 'SMT' %}selected{% endif %}>SMT</option>
	                    </select>
	                </div>
	                <div class="form-group">
	                    <label for="line">
	                        <i class="fas fa-sitemap"></i>
	                        Line
	                    </label>
	                    <input type="text" id="line" name="line" 
	                           placeholder="Type to search line..." autocomplete="off" required>
	                    <div id="line-suggestions" class="suggestions-box"></div>
	                </div>
	            </div>
	            <!-- Group, Model and Color -->
	            <div class="form-grid">
	                <div class="form-group">
	                    <label for="group">
	                        <i class="fas fa-users"></i>
	                        Group
	                    </label>
	                    <input type="text" id="group" name="group" 
	                           placeholder="Type to search group..." autocomplete="off" required>
	                    <div id="group-suggestions" class="suggestions-box"></div>
	                </div>
	                <div class="form-group">
	                    <label for="model">
	                        <i class="fas fa-cube"></i>
	                        Model
	                    </label>
	                    <input type="text" id="model" name="model" 
	                           placeholder="Type to search model..." autocomplete="off" required>
	                    <div id="model-suggestions" class="suggestions-box"></div>
	                </div>
	                <div class="form-group">
	                    <label for="color">
	                        <i class="fas fa-palette"></i>
	                        Color
	                    </label>
	                    <input type="text" id="color" name="color" 
	                           value="{{ form.color.value|default:'' }}" required
	                           placeholder="Enter color code">
	                </div>
	            </div>
	            <!-- Submit Button -->
	            <div class="submit-section">
	                <button type="submit" class="btn btn-primary" id="submitBtn">
	                    <i class="fas fa-save"></i>
	                    Submit Work Information
	                </button>
	            </div>
	        </form>
	    </div>
	    <!-- Recent Records Table -->
	    <div class="table-section">
	        <h2 class="table-header">
	            <i class="fas fa-history" style="color: var(--primary);"></i>
	            Recent Records
	        </h2>
	        <div class="table-container">
	            <table class="data-table">
	                <thead>
	                    <tr>
	                        <th>Date</th>
	                        <th>Shift</th>
	                        <th>Section</th>
	                        <th>Line</th>
	                        <th>Model</th>
	                        <th>Color</th>
	                        <th>Actions</th>
	                    </tr>
	                </thead>
	                <tbody>
	                    {% for record in recent_records %}
	                    <tr>
	                        <td>{{ record.date }}</td>
	                        <td>{{ record.shift }}</td>
	                        <td>{{ record.section }}</td>
	                        <td>{{ record.line }}</td>
	                        <td>{{ record.model }}</td>
	                        <td>{{ record.color }}</td>
	                        <td>
	                            <button class="action-btn" title="Edit Record">
	                                <i class="fas fa-edit"></i>
	                            </button>
	                        </td>
	                    </tr>
	                    {% empty %}
	                    <tr>
	                        <td colspan="7" class="no-records">No recent records found.</td>
	                    </tr>
	                    {% endfor %}
	                </tbody>
	            </table>
	        </div>
	    </div>
	</div>
	<script>
	// Set current date on page load
	function setCurrentDate() {
	    const today = new Date();
	    const dateStr = today.getFullYear() + '-' + 
	                   String(today.getMonth() + 1).padStart(2, '0') + '-' + 
	                   String(today.getDate()).padStart(2, '0');
	    document.getElementById('date').value = dateStr;
	}
	// Search suggestions functionality
	function setupSearchBox(inputId, suggestionsId, apiUrl) {
	    const input = document.getElementById(inputId);
	    const suggestionsBox = document.getElementById(suggestionsId);
	    let debounceTimer;
	    input.addEventListener('input', function() {
	        const query = this.value.trim();
	        clearTimeout(debounceTimer);
	        if (query.length < 1) {
	            hideSuggestions();
	            return;
	        }
	        debounceTimer = setTimeout(async () => {
	            try {
	                const response = await fetch(`${apiUrl}?q=${encodeURIComponent(query)}`);
	                const data = await response.json();
	                showSuggestions(data, suggestionsId, inputId);
	            } catch (error) {
	                console.error('Error fetching suggestions:', error);
	                hideSuggestions();
	            }
	        }, 300);
	    });
	    // Hide suggestions when clicking outside
	    document.addEventListener('click', function(e) {
	        if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
	            hideSuggestions();
	        }
	    });
	    function showSuggestions(data, suggestionsId, inputId) {
	        const box = document.getElementById(suggestionsId);
	        box.innerHTML = '';
	        if (data.length === 0) {
	            box.classList.remove('show');
	            return;
	        }
	        data.forEach(item => {
	            const div = document.createElement('div');
	            div.className = 'suggestion-item';
	            div.textContent = item.text || item.name || item;
	            div.onclick = function() {
	                document.getElementById(inputId).value = item.text || item.name || item;
	                hideSuggestions();
	            };
	            box.appendChild(div);
	        });
	        box.classList.add('show');
	    }
	    function hideSuggestions() {
	        document.querySelectorAll('.suggestions-box').forEach(box => {
	            box.classList.remove('show');
	        });
	    }
	}
	// Form submission with loading state
	function setupFormSubmission() {
	    const form = document.getElementById('workInfoForm');
	    const submitBtn = document.getElementById('submitBtn');
	    form.addEventListener('submit', function(e) {
	        e.preventDefault();
	        // Show loading state
	        submitBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Submitting...</div>';
	        submitBtn.disabled = true;
	        // Submit form normally (or via AJAX if needed)
	        setTimeout(() => {
	            form.submit();
	        }, 1000);
	    });
	}
	// Show alert messages
	function showAlert(message, type = 'success') {
	    // Remove existing alerts
	    const existingAlert = document.querySelector('.alert');
	    if (existingAlert) {
	        existingAlert.remove();
	    }
	    // Create new alert
	    const alert = document.createElement('div');
	    alert.className = `alert alert-${type}`;
	    alert.innerHTML = `
	        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
	        ${message}
	    `;
	    // Insert at top of form
	    const formSection = document.querySelector('.form-section');
	    formSection.insertBefore(alert, formSection.firstChild);
	    // Remove after 5 seconds
	    setTimeout(() => {
	        if (alert.parentElement) {
	            alert.remove();
	        }
	    }, 5000);
	}
	// Initialize on page load
	document.addEventListener('DOMContentLoaded', function() {
	    setCurrentDate();
	    // Setup search boxes
	    setupSearchBox('line', 'line-suggestions', '{% url "ajax_get_lines" %}');
	    setupSearchBox('group', 'group-suggestions', '{% url "ajax_get_groups" %}');
	    setupSearchBox('model', 'model-suggestions', '{% url "ajax_get_models" %}');
	    // Setup form submission
	    setupFormSubmission();
	    // Add keyboard navigation for suggestions
	    document.addEventListener('keydown', function(e) {
	        if (e.key === 'Escape') {
	            document.querySelectorAll('.suggestions-box').forEach(box => {
	                box.classList.remove('show');
	            });
	        }
	    });
	});
	// Mobile optimizations
	if ('ontouchstart' in window) {
	    document.body.classList.add('touch-device');
	}
	</script>
	{% endblock %}

transs_flow/transs_flow/asgi.py

import os
import django
from channels.routing import ProtocolTypeRouter, URLRouter
from channels.auth import AuthMiddlewareStack
from django.core.asgi import get_asgi_application
import chat.routing

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "transs_flow.settings")
django.setup()

application = ProtocolTypeRouter({
    "http": get_asgi_application(),
    "websocket": AuthMiddlewareStack(
        URLRouter(chat.routing.websocket_urlpatterns)
    ),
})


transs_flow/transs_flow/settings.py

"""
Django settings for transs_flow project.

Generated by 'django-admin startproject' using Django 5.2.7.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path
import os
# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-*dl&t7!4eu%antq@qp!*t$#h4&8#rinibme#@29budotu5zfgu'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'accounts',
    'core',
    'factories.assembly.departments.qa.ipqc',
    'factories.assembly.departments.qa',
    'factories.assembly.departments',
    'factories.assembly',
    'factories',
    
    'widget_tweaks',
    
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'transs_flow.urls'

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [os.path.join(BASE_DIR, "templates")],  # Add your templates folder here
        "APP_DIRS": True,  # This still keeps app templates discoverable
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]

WSGI_APPLICATION = 'transs_flow.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

# ---------------------- MYSQL (Aiven) ----------------------
MYSQL_HOST = "mysql-rty-rty.d.aivencloud.com"
MYSQL_PORT = 16775
MYSQL_USER = "avnadmin"
MYSQL_PASSWORD = "AVNS_COcv7nfPnntH_BeZ84u"
MYSQL_DB = "transs_flow_final"
MYSQL_DB_MODEL = "defaultdb"
MYSQL_DB_CHAT = "chatdb"
MYSQL_CA = os.path.join(BASE_DIR, "certs", "aiven-ca.pem")

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': MYSQL_DB,
        'USER': MYSQL_USER,
        'PASSWORD': MYSQL_PASSWORD,
        'HOST': MYSQL_HOST,
        'PORT': MYSQL_PORT,
        'OPTIONS': {
            'ssl': {
                'ca': MYSQL_CA,
            },
        },
    },
    
    'defaultdb': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': MYSQL_DB_MODEL,
        'USER': MYSQL_USER,
        'PASSWORD': MYSQL_PASSWORD,
        'HOST': MYSQL_HOST,
        'PORT': MYSQL_PORT,
        'OPTIONS': {
            'ssl': {
                'ca': MYSQL_CA,
            },
        },
    },
    'chatdb': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': MYSQL_DB_CHAT,
        'USER': MYSQL_USER,
        'PASSWORD': MYSQL_PASSWORD,
        'HOST': MYSQL_HOST,
        'PORT': MYSQL_PORT,
        'OPTIONS': {
            'ssl': {
                'ca': MYSQL_CA,
            },
        },
    },
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'Asia/Kolkata'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


LOGIN_URL = '/login/'

# Lark Open Platform credentials
LARK_APP_ID = "cli_a802ed86e438d028"          # Your Lark App ID
LARK_APP_SECRET = "mfbtudMamxM9nKq5tUoh43AJNJT7iJWu"  # Your Lark App Secret

# Bitable App token
LARK_BITABLE_APP_TOKEN_QA = "UbZRbYrtqaDGwMsY9WmlqhAmgGf"  # Your Bitable App Token

# Feishu App ID for IPQC Department
FEISHU_APP_ID = "cli_a83144a175fad00c"
FEISHU_APP_SECRET = "btMHmH3lAqIPQrX5RdIPRcAqn066kCmj"
FEISHU_TABLE_ID  = "tblMZ9PkpgS4cmrq"

# Table IDs for different types of records
LARK_TABLE_IPQC_WORK_INFO = "tblVIUGu6K3bLdJa"                 # For normal work info
LARK_TABLE_BTB_FITMENT_CHECKSHEET = "tbl2t96Qr6eA0jiA"
LARK_TABLE_BUMMY_CHECKSHEET = "tblVei5hahB9MWrV"
LARK_TABLE_DESSEMBLE_CHECKLIST = "tbloHbXh3fhRCskF"
LARK_TABLE_ASSEMBLY_AUDIT = "tbl4ZmtcKC8F6zre"
LARK_TABLE_NC_ISSUE_TRACKING = "tblhQaAEQfwuzWpu"
LARK_TABLE_ESD_COMPLIANCE = "tblZbqVZw4X3HCzA"
LARK_TABLE_DUST_MEASUREMENT = "tblq4hfUqiEnnAYn"
LARK_TABLE_TESTING_FAI = "tblckPOHzkHQGbFN"


AUTH_USER_MODEL = 'accounts.Employee'


DATABASE_ROUTERS = ["chat.db_router.ChatRouter"]

# Channels setup
INSTALLED_APPS += ["channels", "chat"]

ASGI_APPLICATION = "transs_flow.asgi.application"

CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        "CONFIG": {"hosts": [("127.0.0.1", 6379)]},
    },
}

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

transs_flow/transs_flow/urls.py

from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path("admin/", admin.site.urls),
    path("", include("accounts.urls")),
    
    path('ipqc/', include('factories.assembly.departments.qa.ipqc.urls')),  # <--- nested app
    path("chat/", include("chat.urls", namespace="chat")),
]


if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

transs_flow/transs_flow/manage.py

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'transs_flow.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


